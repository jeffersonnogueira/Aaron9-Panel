<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>AARON 9 – Painel Institucional em Tempo Real </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --card: #020617;
      --card-border: #1f2937;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.12);
      --danger: #f97373;
      --success: #4ade80;
      --text-soft: #9ca3af;
      --text-main: #e5e7eb;
      --error: #f97373;
    }

    * {
      box-sizing: border-box;
    }

   body {
  margin: 0;
  padding: 0;
  background: #020617;
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  overflow-x: hidden;
}


/* wrapper principal da página */
.app-shell {
  min-height: 100vh;
  display: flex;
  justify-content: flex-start;  /* fica encostado à esquerda */
}

.app-inner {
  width: 100%;
  max-width: 100%;              /* tira o limite de 1680px */
  margin: 16px 24px 32px 24px;  /* margens finas só pra não colar na borda */
}


 .page{
  min-height: 100vh;
  width: 100%;
  max-width: none;            /* remove o limite (some o vazio lateral) */
  margin: 0;                  /* para de centralizar com “auto” */
  padding: 16px 24px 32px 24px; /* mantém respiro nas bordas */
  display: flex;
  flex-direction: column;
  gap: 10px;
}




    /* TOPO / HEADER */

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(34, 211, 238, 0.12), transparent 55%);
      border: 1px solid rgba(31, 41, 55, 0.95);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.85);
      position: relative;
      overflow: hidden;
    }

    .top-bar::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0 0, rgba(34, 211, 238, 0.3), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(59, 130, 246, 0.25), transparent 60%);
      opacity: 0.75;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .top-left,
    .top-right {
      position: relative;
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 14px;
      align-items: center;
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--text-soft);
    }

    .brand-title span {
      color: var(--accent);
    }

        /* === The Six Seats – logo no topo === */
    .brand-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .brand-logo-img {
      height: 34px;        /* aumenta/diminui o tamanho aqui */
      width: auto;
      filter: drop-shadow(0 0 12px rgba(248, 250, 252, 0.85));
    }

    .brand-logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
    }

    .brand-logo-main {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .brand-logo-sub {
      font-size: 9px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--text-soft);
    }


    .status-dot-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(248, 113, 113, 0.12);
      border: 1px solid rgba(248, 113, 113, 0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #fecaca;
    }

    .status-dot-live::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97373;
      box-shadow: 0 0 14px rgba(239, 68, 68, 0.9);
    }

    .pill-small {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .pill-small strong {
      color: var(--text-main);
      font-weight: 500;
      margin-left: 3px;
    }

    .pill-state {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.8);
      background: rgba(8, 47, 73, 0.85);
      color: #e0f2fe;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-state::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22d3ee;
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.9);
    }

    .pill-soft {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.85);
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .pill-soft strong {
      color: var(--text-main);
      font-weight: 500;
      margin-left: 4px;
    }

    .pill-soft-accent {
      border-color: rgba(34, 211, 238, 0.85);
      color: #e0f2fe;
    }

    .btn-refresh {
      position: relative;
      z-index: 1;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.7);
      background: radial-gradient(circle at top, rgba(34, 211, 238, 0.2), rgba(15, 23, 42, 0.9));
      color: #e0f2fe;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      cursor: pointer;
    }

    .btn-refresh::before {
      content: "⟳";
      font-size: 12px;
    }

    .btn-refresh[disabled] {
      opacity: 0.5;
      cursor: default;
    }
        .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      margin-right: 6px;
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 999px;
      cursor: pointer;
    }

    .lang-btn.active {
      background: rgba(34, 211, 238, 0.16);
      color: #e0f2fe;
    }


    /* BANNER ERRO */

    .error-banner {
      display: none;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(248, 113, 113, 0.8);
      background: rgba(127, 29, 29, 0.3);
      color: #fecaca;
      font-size: 12px;
    }

    .error-banner strong {
      color: #fee2e2;
    }

    /* LAYOUT PRINCIPAL */

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 12px;
      align-items: flex-start;
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      position: relative;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(3, 7, 18, 0.98));
      border: 1px solid rgba(30, 64, 175, 0.9);
      box-shadow:
        0 18px 42px rgba(15, 23, 42, 0.95),
        0 0 28px rgba(15, 23, 42, 0.9);
      padding: 12px 14px;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(34, 211, 238, 0.12), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card-header {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge-outline {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      gap: 6px;
    }

    .badge-outline.green {
      border-color: rgba(74, 222, 128, 0.8);
      color: #bbf7d0;
    }

    .badge-outline.red {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    .badge-outline span.dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: currentColor;
      box-shadow: 0 0 10px currentColor;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 10px;
    }

    .panel-section {
      position: relative;
      z-index: 1;
      padding: 10px 10px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(30, 64, 175, 0.8);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      margin-bottom: 8px;
    }

    .panel-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .panel-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }
/* ====== AARON CHART + STUDIES (ALPACA) ====== */
.aaron-studies{
  margin-top: 8px;
  padding: 8px;
  border-radius: 12px;
  border: 1px solid rgba(148, 163, 184, 0.18);
  background: rgba(2, 6, 23, 0.55);
}

.aaron-studies-title{
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: var(--text-soft);
  margin-bottom: 8px;
}

.aaron-studies-pills{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.pill-toggle{
  display: inline-flex;
  align-items: center;
  cursor: pointer;
  user-select: none;
}

.pill-toggle input{
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.pill-toggle span{
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.75);
  color: var(--text-soft);
  font-size: 11px;
  letter-spacing: 0.06em;
  transition: transform .08s ease, background .15s ease, border-color .15s ease, color .15s ease;
}

.pill-toggle span:hover{
  transform: translateY(-1px);
  border-color: rgba(34, 211, 238, 0.55);
  color: var(--text-main);
}

.pill-toggle input:checked + span{
  border-color: rgba(34, 211, 238, 0.85);
  background: rgba(34, 211, 238, 0.12);
  color: #e0f2fe;
  box-shadow: 0 0 18px rgba(34, 211, 238, 0.22);
}
/* ===== A10 TIMEFRAMES (chart header) ===== */
.a10-chart-head-right{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}

.a10-tf{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.a10-tf-btn{
  appearance:none;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.75);
  color: var(--text-soft);
  font-size: 11px;
  letter-spacing: 0.06em;
  padding: 6px 10px;
  border-radius: 999px;
  cursor:pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease, color .15s ease;
}

.a10-tf-btn:hover{
  transform: translateY(-1px);
  border-color: rgba(34, 211, 238, 0.55);
  color: var(--text-main);
}

.a10-tf-btn.active{
  border-color: rgba(34, 211, 238, 0.85);
  background: rgba(34, 211, 238, 0.12);
  color: #e0f2fe;
  box-shadow: 0 0 18px rgba(34, 211, 238, 0.22);
}

/* shell do chart */
.aaron10-chart-shell{
  position: relative;
  margin-top: 10px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(15, 23, 42, 0.9);
  min-height: 420px;
  background: #020617;
}

.aaron10-chart{
  width: 100%;
  height: 430px;
}

.aaron10-chart-overlay{
  position: absolute;
  top: 10px;
  right: 10px;
  pointer-events: none;
  opacity: 0.95;
}

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      color: var(--text-main);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .pill-green {
      border-color: rgba(74, 222, 128, 0.8);
      color: var(--success);
    }

    .pill-red {
      border-color: rgba(248, 113, 113, 0.8);
      color: var(--danger);
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      margin-bottom: 2px;
    }

    /* === DIREÇÃO COM FLECHA === */
    .direction-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .arrow-badge {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px rgba(34, 211, 238, 0.7);
      font-size: 24px;
      font-weight: 700;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .arrow-badge.arrow-up {
      border-color: rgba(74, 222, 128, 0.9);
      box-shadow: 0 0 22px rgba(74, 222, 128, 0.8);
      color: #4ade80;
    }

    .arrow-badge.arrow-down {
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 0 22px rgba(248, 113, 113, 0.85);
      color: #f97373;
    }

    .direction-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    .direction-text strong {
      font-size: 13px;
    }

    .text-soft {
      color: var(--text-soft);
    }
    /* ====== AARON 9 – COLUNA DIREITA (DECISION PANEL) ====== */

.decision-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.decision-card {
  background: var(--card, #020617);
  border-radius: 18px;
  border: 1px solid var(--card-border, #1f2937);
  padding: 16px 18px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.75);
}

/* títulos e textos pequenos */
.decision-title {
  font-size: 0.75rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-soft, #9ca3af);
  margin-bottom: 8px;
}

.decision-label-strong {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-main, #e5e7eb);
}

/* radar de direção */
.radar-header {
  display: flex;
  align-items: center;
  gap: 12px;
}

.radar-circle {
  width: 54px;
  height: 54px;
  border-radius: 999px;
  border: 2px solid #f97373;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
}

.radar-circle.buy {
  border-color: var(--accent, #22d3ee);
}

.radar-percent {
  font-size: 0.9rem;
  color: var(--text-soft, #9ca3af);
}

/* barrinhas horizontal (a favor x contra, etc.) */
.decision-bar {
  position: relative;
  width: 100%;
  height: 6px;
  border-radius: 999px;
  background: rgba(148, 163, 184, 0.18);
  overflow: hidden;
}

.decision-bar-fill {
  position: absolute;
  inset: 0;
  width: 70%; /* será ajustado depois com JS ou no backend */
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
}

.decision-bar-fill-danger {
  position: absolute;
  inset: 0;
  width: 30%;
  border-radius: inherit;
  background: linear-gradient(90deg, #f97373, #facc15);
}

/* pill do estado (NO TRADE / GO FULL etc.) */
.decision-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.16em;
  text-transform: uppercase;
}

.decision-pill.go-full {
  background: rgba(248, 113, 113, 0.16);
  color: #fecaca;
}

.decision-pill.scalp {
  background: rgba(56, 189, 248, 0.16);
  color: #bae6fd;
}

.decision-pill.wait {
  background: rgba(234, 179, 8, 0.16);
  color: #facc15;
}

.decision-pill.no-trade {
  background: rgba(148, 163, 184, 0.16);
  color: #cbd5f5;
}

/* checklist de padrões */
.checklist-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.check-pill {
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 0.8rem;
  border: 1px solid rgba(148, 163, 184, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.check-pill.on {
  border-color: rgba(45, 212, 191, 0.9);
  background: rgba(34, 197, 94, 0.12);
  color: #bbf7d0;
}

/* pattern radar + pullback */
.pattern-layout {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
  gap: 12px;
}

.pattern-box {
  border-radius: 14px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  padding: 8px 10px;
  font-size: 0.78rem;
}

.pattern-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.pullback-highlight {
  font-size: 0.78rem;
  margin-top: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(34, 197, 94, 0.08);
  border: 1px solid rgba(34, 197, 94, 0.4);
}

/* responsivo: em telas estreitas essa coluna vira full-width */
@media (max-width: 1024px) {
  .decision-column {
    margin-top: 16px;
  }
}
/* ====== HERO STATUS (MODO CEGO) ====== */

.status-hero {
  background: radial-gradient(circle at top left, rgba(34,197,94,0.18), rgba(15,23,42,1));
  border-radius: 20px;
  border: 1px solid rgba(34,197,94,0.7);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
}

.status-hero-label {
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(148,163,184,0.9);
}

/* ===== AUTOPILOT (simulador) ===== */
.trade-autopilot { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.ap-switch { position:relative; width:42px; height:22px; display:inline-block; }
.ap-switch input { opacity:0; width:0; height:0; }
.ap-slider {
  position:absolute; cursor:pointer; inset:0;
  background: rgba(148,163,184,0.25);
  border:1px solid rgba(148,163,184,0.35);
  transition:.2s; border-radius:999px;
}
.ap-slider:before {
  content:""; position:absolute; height:16px; width:16px; left:3px; top:2px;
  background: rgba(226,232,240,0.9);
  transition:.2s; border-radius:999px;
}
.ap-switch input:checked + .ap-slider {
  background: rgba(34,197,94,0.25);
  border-color: rgba(34,197,94,0.45);
}
.ap-switch input:checked + .ap-slider:before { transform: translateX(19px); }

.ap-btn {
  border:1px solid rgba(148,163,184,0.25);
  background: rgba(15,23,42,0.35);
  color:#e2e8f0; font-weight:800; letter-spacing:.4px;
  padding:7px 10px; border-radius:12px; cursor:pointer;
}
.ap-btn:hover { filter:brightness(1.08); }

.ap-meta { opacity:.85; font-size:0.86rem; }

#ap-state { padding:4px 10px; border-radius:999px; font-weight:800; }
#ap-state.ap-on { border-color: rgba(34,197,94,0.55); }
#ap-state.ap-off { border-color: rgba(148,163,184,0.35); opacity:.8; }
#ap-state.ap-buy { border-color: rgba(56,189,248,0.55); }
#ap-state.ap-sell { border-color: rgba(248,113,113,0.55); }

/* ===== AUTOPILOT UI v2 (premium) ===== */
#autopilot-panel.autopilot-v2{
  padding: 14px;
  border: 1px solid rgba(148,163,184,0.18);
  background:
    radial-gradient(1200px 500px at 20% 0%, rgba(56,189,248,0.10), transparent 60%),
    radial-gradient(900px 420px at 85% 10%, rgba(34,197,94,0.08), transparent 55%),
    rgba(2,6,23,0.35);
}

#autopilot-panel .ap2-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}

#autopilot-panel .ap2-sub{
  margin-top:2px;
  font-size:0.78rem;
  opacity:0.75;
}

#autopilot-panel .ap2-controls{
  display:flex;
  align-items:center;
  gap:10px;
}

#autopilot-panel .ap2-bottom{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

#autopilot-panel .ap-btn{
  min-width: 98px;
  border-radius: 14px;
  padding: 9px 12px;
  letter-spacing: .6px;
}

#autopilot-panel .ap-btn:active{
  transform: translateY(1px);
}

#autopilot-panel .ap2-ico{
  display:inline-block;
  margin-right:7px;
  opacity:.85;
  font-weight:900;
}

#autopilot-panel #ap-meta{
  margin-left:auto;
  padding-left:10px;
  opacity:0.85;
  font-size:0.86rem;
}

/* Deixa o estado mais "badge premium" */
#autopilot-panel #ap-state{
  padding: 6px 12px;
  border-radius: 999px;
  font-weight: 900;
  letter-spacing: .6px;
}

/* ===== AUTOPILOT 2.0 (cores fortes + sizing) ===== */
#autopilot-panel .ap-btn.ap-buy{
  background: linear-gradient(135deg, rgba(34,197,94,0.22), rgba(34,197,94,0.08));
  border-color: rgba(34,197,94,0.55);
  color: rgba(236,253,245,0.98);
}
#autopilot-panel .ap-btn.ap-sell{
  background: linear-gradient(135deg, rgba(248,113,113,0.22), rgba(248,113,113,0.08));
  border-color: rgba(248,113,113,0.62);
  color: rgba(255,241,242,0.98);
}
#autopilot-panel .ap-btn.ap-close{
  background: rgba(15,23,42,0.25);
  border-color: rgba(148,163,184,0.28);
}
#autopilot-panel .ap-btn:disabled{
  opacity: .45;
  cursor: not-allowed;
}

#autopilot-panel .ap2-sizing{
  margin: 10px 0 12px 0;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid rgba(148,163,184,0.16);
  background: rgba(0,0,0,0.18);
  box-shadow: inset 0 0 0 1px rgba(2,6,23,0.15);
}

#autopilot-panel .ap2-price-row{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

#autopilot-panel .ap2-quote{
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.18);
  background: rgba(2,6,23,0.28);
}

#autopilot-panel .ap2-quote-sell{
  border-color: rgba(248,113,113,0.30);
}
#autopilot-panel .ap2-quote-buy{
  border-color: rgba(34,197,94,0.30);
}

#autopilot-panel .ap2-quote-label{
  font-size: 0.72rem;
  opacity: .78;
  letter-spacing: .08em;
  text-transform: uppercase;
}

#autopilot-panel .ap2-quote-price{
  margin-top: 2px;
  font-size: 1.05rem;
  font-weight: 900;
}

#autopilot-panel .ap2-quote-mid{
  padding: 0 4px;
  text-align:center;
  opacity: .82;
}
#autopilot-panel .ap2-quote-mid-label{
  font-size: 0.70rem;
  letter-spacing: .08em;
  text-transform: uppercase;
}
#autopilot-panel .ap2-quote-mid-price{
  margin-top: 2px;
  font-weight: 800;
}

#autopilot-panel .ap2-input-row{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
@media (max-width: 520px){
  #autopilot-panel .ap2-input-row{ grid-template-columns: 1fr; }
  #autopilot-panel .ap2-price-row{ grid-template-columns: 1fr; }
  #autopilot-panel .ap2-quote-mid{ display:none; }
}

#autopilot-panel .ap2-field{
  display:flex;
  flex-direction: column;
  gap: 6px;
}

#autopilot-panel .ap2-label{
  font-size: 0.72rem;
  opacity: .78;
  letter-spacing: .08em;
  text-transform: uppercase;
}

#autopilot-panel .ap2-input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148,163,184,0.20);
  background: rgba(2,6,23,0.35);
  color: rgba(226,232,240,0.96);
  outline: none;
}
#autopilot-panel .ap2-input:focus{
  border-color: rgba(34,211,238,0.45);
  box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
}


.status-hero-main {
  font-size: 1.35rem;
  font-weight: 500; /* <-- aqui para de deixar tudo bold */
  color: #e5e7eb;
}

/* mantém os labels (strong) com destaque */
.status-hero-main strong {
  font-weight: 800;
}

/* Comentário do AARON formatado em linhas */
.comment-lines {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 6px;
}

.comment-line {
  font-weight: 500;
  line-height: 1.35;
  font-size: 0.92rem;
}

.comment-line strong {
  font-weight: 800;
}


.status-hero-sub {
  font-size: 0.8rem;
  color: var(--text-soft, #9ca3af);
}

/* bolha da direita (GO FULL / WAIT etc.) */
.status-hero-badge {
  min-width: 88px;
  text-align: center;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.18em;
  text-transform: uppercase;
}

/* cores por estado */
.status-buy {
  background: radial-gradient(circle at top left, rgba(34,197,94,0.22), #020617);
  border-color: rgba(34,197,94,0.8);
}

.status-sell {
  background: radial-gradient(circle at top left, rgba(248,113,113,0.22), #020617);
  border-color: rgba(248,113,113,0.9);
}

.status-wait {
  background: radial-gradient(circle at top left, rgba(234,179,8,0.22), #020617);
  border-color: rgba(234,179,8,0.9);
}

.status-no-trade {
  background: radial-gradient(circle at top left, rgba(148,163,184,0.22), #020617);
  border-color: rgba(148,163,184,0.9);
}

/* cores da badge */
.status-hero-badge.buy { background: rgba(34,197,94,0.18); color:#bbf7d0; }
.status-hero-badge.sell { background: rgba(248,113,113,0.18); color:#fecaca; }
.status-hero-badge.wait { background: rgba(234,179,8,0.18); color:#facc15; }
.status-hero-badge.no-trade { background: rgba(148,163,184,0.18); color:#e5e7eb; }

/* piscando leve para EXECUTAR AGORA */
.blink-hero {
  animation: heroPulse 1.4s ease-in-out infinite;
}

@keyframes heroPulse {
  0%   { transform: scale(1); box-shadow: 0 0 0 0 rgba(248,113,113,0.7); }
  50%  { transform: scale(1.01); box-shadow: 0 0 0 12px rgba(248,113,113,0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(248,113,113,0); }
}

/* ====== PATTERN DRAWINGS (PADRÃO DO DIA / MOMENTO) ====== */

.pattern-canvas {
  background: rgba(15,23,42,0.9);
  border-radius: 10px;
  padding: 4px 6px;
  margin-bottom: 6px;
  border: 1px solid rgba(148,163,184,0.35);
}

.pattern-svg {
  width: 100%;
  height: 34px;
}

.prob-phrase {
  font-size: 0.76rem;
  margin-top: 4px;
  color: var(--text-soft, #9ca3af);
}

.prob-phrase.favor {
  color: #bbf7d0;
}

.prob-phrase.contra {
  color: #fecaca;
}
    /* ====== ESTRUTURA RECENTE — HH / HL / LH / LL ====== */

.structure-wrapper {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.structure-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.structure-chip {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.55);
  background: rgba(15, 23, 42, 0.95);
  font-size: 0.78rem;
}

.structure-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: var(--text-soft);
}

.structure-status {
  font-weight: 500;
  color: var(--text-main);
}

.structure-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: #4b5563;
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 1);
  margin-left: 6px;
}

.structure-dot.on {
  background: #fb7185;
  box-shadow: 0 0 10px rgba(248, 113, 113, 0.85);
}

/* ZigZag / Market Structure */

.structure-zigzag-title {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.structure-zigzag-box {
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.96);
  padding: 4px 6px;
}

.structure-zigzag-svg {
  width: 100%;
  height: 40px;
}

/* ====== GERENCIADOR DE RISCO · ATR ====== */

.risk-card {
  background: var(--card);
  border-radius: 18px;
  border: 1px solid var(--card-border);
  padding: 14px 16px;
  margin-bottom: 14px;
  box-shadow: 0 18px 40px rgba(15,23,42,0.7);
}

.risk-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.risk-title {
  font-size: 0.9rem;
  font-weight: 600;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-soft);
}

.risk-subtitle {
  font-size: 0.75rem;
  color: var(--text-soft);
}

.risk-toggle {
  border-radius: 999px;
  padding: 4px 12px;
  border: 1px solid var(--accent);
  background: transparent;
  color: var(--accent);
  font-size: 0.75rem;
  cursor: pointer;
}

.risk-toggle:hover {
  background: var(--accent-soft);
}

.risk-body {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 12px;
}

.risk-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.risk-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-soft);
}

.risk-group input,
.risk-group select {
  background: #020617;
  border-radius: 10px;
  border: 1px solid #1f2937;
  padding: 6px 8px;
  font-size: 0.78rem;
  color: var(--text-main);
}

.risk-group input:focus,
.risk-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(34,211,238,0.35);
}

.risk-actions {
  grid-column: 1 / -1;
  display: flex;
  justify-content: flex-start;
  margin-top: 4px;
}

.risk-actions button {
  border-radius: 999px;
  padding: 6px 16px;
  border: none;
  background: var(--accent);
  color: #020617;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
}

.risk-results {
  grid-column: 1 / -1;
  margin-top: 8px;
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 12px;
}

.risk-result-label {
  font-size: 0.72rem;
  color: var(--text-soft);
}

.risk-result-value {
  font-size: 0.9rem;
  font-weight: 600;
}

.risk-result-value.small {
  font-size: 0.78rem;
  opacity: 0.8;
}
    /* ====== TOGGLE DE IDIOMA PT / EN ====== */
    .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.45);
      margin-right: 12px;
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .lang-btn.active {
      background: rgba(34, 211, 238, 0.18);
      color: var(--accent);
    }
    /* ====== PULLBACK BRAIN – UX AVANÇADO ====== */

.pullback-header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 6px;
}

.pullback-status-block {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.pullback-status-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
}

.pullback-status-main {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-main);
}

.pullback-meta-block {
  text-align: right;
  font-size: 0.76rem;
  color: var(--text-soft);
}

.pullback-tag-row {
  display: flex;
  gap: 6px;
  margin-top: 4px;
  justify-content: flex-end;
}

.pullback-tag {
  border-radius: 999px;
  padding: 3px 8px;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  border: 1px solid rgba(148,163,184,0.5);
  background: rgba(15,23,42,0.9);
  white-space: nowrap;
}

.pullback-tag.side-buy {
  border-color: rgba(34,197,94,0.9);
  color: #bbf7d0;
}

.pullback-tag.side-sell {
  border-color: rgba(248,113,113,0.9);
  color: #fecaca;
}

.pullback-tag.side-neutral {
  border-color: rgba(148,163,184,0.8);
  color: #e5e7eb;
}

.pullback-tag.stage {
  border-color: rgba(56,189,248,0.9);
  color: #bae6fd;
}

/* termômetro horizontal */

.pullback-meter {
  margin-top: 8px;
  margin-bottom: 8px;
}

.pullback-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.pullback-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.pullback-meter-fill {
  position: absolute;
  inset: 0;
  width: 40%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

.pullback-meter-fill.neutral {
  background: linear-gradient(90deg, #eab308, #f97316);
}

.pullback-meter-fill.danger {
  background: linear-gradient(90deg, #f97373, #fb7185);
}

/* já existia, mas este bloco usa muito: */
.pullback-highlight {
  font-size: 0.78rem;
  margin-top: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(34, 197, 94, 0.08);
  border: 1px solid rgba(34, 197, 94, 0.4);
}

    /* === SIZING BRAIN – GERENCIADOR DE RISCO (OFFLINE) – EXTRA UI === */

/* Stop e Take bem destacados */
#sb-stop-price {
  color: var(--danger);
  font-weight: 600;
  font-size: 0.95rem;
}

#sb-take-price {
  color: var(--success);
  font-weight: 600;
  font-size: 0.95rem;
}

/* Termômetro offline */
.sb-meter {
  margin-top: 10px;
}

.sb-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.sb-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.sb-meter-fill {
  position: absolute;
  inset: 0;
  width: 0%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

/* variações de cor conforme o risco usado */
.sb-meter-fill.safe {
  background: linear-gradient(90deg, #22c55e, #22d3ee);
}

.sb-meter-fill.warn {
  background: linear-gradient(90deg, #facc15, #fb923c);
}

.sb-meter-fill.danger {
  background: linear-gradient(90deg, #f97373, #fb7185);
}

    /* ====== SIZING BRAIN – GESTÃO DE CAPITAL DO DIA ====== */

.sizing-header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 6px;
}

.sizing-main-numbers {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.sizing-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
}

.sizing-target-value {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--accent);
}

.sizing-secondary-numbers {
  font-size: 0.76rem;
  color: var(--text-soft);
  text-align: right;
}

.sizing-tag-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
  margin-bottom: 6px;
}

.sizing-tag {
  border-radius: 999px;
  padding: 3px 9px;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  border: 1px solid rgba(148,163,184,0.6);
  background: rgba(15,23,42,0.9);
  white-space: nowrap;
}

.sizing-tag.profile-conservative {
  border-color: rgba(56,189,248,0.9);
  color: #bae6fd;
}

.sizing-tag.profile-normal {
  border-color: rgba(34,197,94,0.9);
  color: #bbf7d0;
}

.sizing-tag.profile-aggressive {
  border-color: rgba(234,179,8,0.9);
  color: #fef9c3;
}

.sizing-tag.style-daytrade {
  border-color: rgba(94,234,212,0.9);
  color: #a5f3fc;
}

.sizing-tag.style-swing {
  border-color: rgba(129,140,248,0.9);
  color: #e0e7ff;
}

.sizing-tag.style-momentum {
  border-color: rgba(251,146,60,0.9);
  color: #fed7aa;
}

.sizing-tag.style-noedge {
  border-color: rgba(148,163,184,0.9);
  color: #e5e7eb;
}

.sizing-meter {
  margin-top: 4px;
  margin-bottom: 6px;
}

.sizing-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.sizing-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.sizing-meter-fill {
  position: absolute;
  inset: 0;
  width: 40%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

.sizing-comment {
  margin-top: 4px;
  font-size: 0.78rem;
  color: var(--text-main);
  background: rgba(15,23,42,0.85);
  border-radius: 10px;
  padding: 6px 8px;
  border: 1px dashed rgba(148,163,184,0.6);
}

    /* --- SIZING BRAIN · inputs de capital/risco/stop + frases --- */

.sizing-inputs {
  margin-top: 6px;
  margin-bottom: 6px;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
}

.sizing-input {
  display: flex;
  flex-direction: column;
  gap: 3px;
  font-size: 0.75rem;
}

.sizing-input label {
  color: var(--text-soft);
  text-transform: none;
  letter-spacing: 0.02em;
}

.sizing-input input {
  border-radius: 999px;
  border: 1px solid rgba(31,41,55,0.9);
  background: #020617;
  padding: 5px 10px;
  font-size: 0.8rem;
  color: var(--text-main);
}

.sizing-input input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

.sizing-phrase {
  margin-top: 2px;
  margin-bottom: 6px;
  font-size: 0.8rem;
  line-height: 1.35;
}

.sizing-phrase-main {
  color: var(--text-main);
}

.sizing-phrase-detail {
  color: var(--text-soft);
  margin-top: 2px;
}

/* responsivo */
@media (max-width: 900px) {
  .sizing-inputs {
    grid-template-columns: 1fr;
  }
}

/* === SIZING BRAIN – GERENCIADOR DE RISCO === */
.sizing-brain-card {
  border: 1px solid var(--card-border);
  border-radius: 16px;
  padding: 16px 20px;
  background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.4));
  box-shadow: 0 0 40px rgba(15, 23, 42, 0.8);
}

.sizing-brain-card .card-header h2 {
  margin: 0;
  font-size: 1.1rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.sizing-brain-card .card-subtitle {
  margin: 4px 0 0;
  font-size: 0.75rem;
  color: var(--text-soft);
}

.sb-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px 16px;
  margin-top: 12px;
}

.sb-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sb-field label {
  font-size: 0.8rem;
  color: var(--text-soft);
}

.sb-field input {
  background: #020617;
  border-radius: 10px;
  border: 1px solid var(--card-border);
  padding: 6px 8px;
  color: var(--text-main);
  font-size: 0.9rem;
}

.sb-field input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.3);
}

.sb-hint {
  font-size: 0.7rem;
  color: var(--text-soft);
}

.sb-divider {
  margin: 14px 0;
  border: none;
  border-top: 1px dashed rgba(148, 163, 184, 0.4);
}

.sb-side-toggle {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.8rem;
}

.sb-side-toggle label {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.sb-side-toggle input[type="radio"] {
  accent-color: var(--accent);
}

.sb-results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-top: 8px;
}

.sb-result-block h3 {
  margin: 0 0 6px;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-soft);
}

.sb-result-main {
  font-size: 1rem;
  font-weight: 600;
  margin: 2px 0;
}

.sb-result-sub {
  font-size: 0.8rem;
  margin: 2px 0;
  color: var(--text-soft);
}

.sb-actions {
  margin-top: 14px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.primary-btn {
  border-radius: 999px;
  padding: 6px 14px;
  border: 1px solid var(--accent);
  background: radial-gradient(circle at top, var(--accent-soft), transparent);
  color: var(--accent);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
}

.primary-btn:hover {
  filter: brightness(1.1);
}

.sb-status {
  font-size: 0.75rem;
  color: var(--text-soft);
}

/* ================== GARIMPO DE HOJE ================== */
.garimpo-banner {
  width: 100%;
  /* menos espaço em cima e embaixo, encaixa melhor entre o header e o painel */
  margin: 8px auto 12px auto;
  display: flex;
  justify-content: center;
}

.garimpo-container {
  width: 100%;
  max-width: 100%;         /* agora acompanha a largura inteira da .page */
  padding: 14px 24px;      /* um pouco mais de “respiro” nas laterais */
  border-radius: 18px;
  background: radial-gradient(circle at top left, rgba(80, 220, 255, 0.25), transparent 55%),
              linear-gradient(135deg, rgba(7, 16, 40, 0.95), rgba(10, 26, 70, 0.98));
  border: 1px solid rgba(120, 220, 255, 0.35);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  display: flex;
  flex-direction: column;
  gap: 10px;
}


.garimpo-badge {
  display: inline-flex;
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background: rgba(9, 189, 140, 0.18);
  color: #5df2c8;
  border: 1px solid rgba(93, 242, 200, 0.5);
}

.garimpo-main {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.garimpo-header-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

    .garimpo-header-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
}

/* Botão "Ver página do garimpo" no painel principal */
.garimpo-link-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 14px;
  border-radius: 999px;
  border: 1px solid rgba(120, 200, 255, 0.5);
  background: rgba(3, 10, 25, 0.85);
  color: #e5f2ff;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  text-decoration: none;
  cursor: pointer;
  transition:
    background 0.18s ease,
    transform 0.18s ease,
    box-shadow 0.18s ease,
    color 0.18s ease;
}

.garimpo-link-btn:hover {
  background: linear-gradient(135deg, #04d9ff, #22ff88);
  color: #02101f;
  box-shadow: 0 0 12px rgba(34, 211, 238, 0.6);
  transform: translateY(-1px);
}


    .garimpo-right-block {
  display: flex;
  align-items: center;
  gap: 10px;       /* espaço entre o botão e o chip de confiança */
}


.garimpo-title-block {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.garimpo-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #a5b4fc;
}

.garimpo-ticker-line {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.garimpo-ticker {
  font-size: 26px;
  font-weight: 700;
  color: #e5e7ff;
}

.garimpo-profile-tag {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 4px 9px;
  border-radius: 999px;
  background: rgba(59, 130, 246, 0.15);
  color: #bfdbfe;
  border: 1px solid rgba(129, 199, 255, 0.5);
}

.garimpo-confidence-chip {
  display: inline-flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 3px;
  padding: 6px 10px;
  border-radius: 12px;
  background: rgba(15, 118, 110, 0.24);
  border: 1px solid rgba(45, 212, 191, 0.6);
}

.garimpo-confidence-chip .chip-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #a7f3d0;
}

.garimpo-confidence-chip .chip-value {
  font-size: 16px;
  font-weight: 700;
  color: #ecfeff;
}

.garimpo-metrics-row {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  margin-top: 4px;
}

.garimpo-metric {
  min-width: 120px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.garimpo-metric .metric-label {
  font-size: 11px;
  color: #9ca3af;
}

.garimpo-metric .metric-value {
  font-size: 14px;
  font-weight: 600;
  color: #e5e7eb;
}

.garimpo-comment {
  margin-top: 4px;
  font-size: 12px;
  color: #d1d5db;
  max-width: 800px;
}

/* Responsivo */
@media (max-width: 768px) {
  .garimpo-container {
    padding: 12px 12px;
  }
  .garimpo-ticker {
    font-size: 22px;
  }

  .garimpo-right-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Botão para abrir a página completa do garimpo */
.garimpo-page-btn {
  border-radius: 999px;
  padding: 6px 14px;
  border: 1px solid rgba(120, 220, 255, 0.6);
  background: radial-gradient(circle at top, rgba(56, 189, 248, 0.35), transparent);
  color: #e0f2fe;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  cursor: pointer;
  white-space: nowrap;
  transition:
    background 0.2s ease,
    transform 0.15s ease,
    box-shadow 0.15s ease;
}

.garimpo-page-btn:hover {
  background: radial-gradient(circle at top, rgba(56, 189, 248, 0.55), transparent);
  box-shadow: 0 0 18px rgba(56, 189, 248, 0.6);
  transform: translateY(-1px);
}

.garimpo-page-btn:active {
  transform: translateY(0);
  box-shadow: none;
}

  
}
/* ================== FIM GARIMPO DE HOJE ================== */

/* ====== PATTERN REFERENCE (ABAIXO DO SIZING BRAIN) ====== */
.ref-card { margin-top: 14px; }

.ref-details { margin-top: 8px; }

.ref-summary {
  list-style: none;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(56, 189, 248, 0.28);
  background: rgba(10, 18, 35, 0.55);
  cursor: pointer;
  user-select: none;
}

.ref-summary::-webkit-details-marker { display: none; }

.ref-summary-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.ref-summary-title {
  font-weight: 700;
  letter-spacing: 0.2px;
}

.ref-summary-mini {
  font-size: 12px;
  opacity: 0.75;
}

.ref-summary-right {
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.22);
  background: rgba(2, 6, 23, 0.35);
  opacity: 0.9;
}

.ref-details[open] .ref-summary-right { content: "Fechar"; }

.ref-body { padding-top: 12px; }

.ref-grid {
  display: grid;
  grid-template-columns: 1.25fr 1fr;
  gap: 12px;
}

@media (max-width: 980px) {
  .ref-grid { grid-template-columns: 1fr; }
}

.ref-img-wrap {
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(148, 163, 184, 0.18);
  background: rgba(2, 6, 23, 0.55);
}

.ref-img-wrap img {
  width: 100%;
  height: auto;
  display: block;
}

.ref-text {
  border-radius: 16px;
  border: 1px solid rgba(148, 163, 184, 0.14);
  background: rgba(2, 6, 23, 0.35);
  padding: 12px;
}

.ref-line { margin-bottom: 10px; }

.ref-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(56, 189, 248, 0.25);
  text-decoration: none;
}
/* ====== /PATTERN REFERENCE ====== */
/* =========================
   TRADE CARD • RESPONDER OUTPUT (panel/ui/digest)
   ========================= */
.resp-snap{
  margin-top: 10px;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid rgba(80,120,200,.35);
  background: rgba(15,20,40,.55);
  box-shadow: 0 10px 28px rgba(0,0,0,.28);
}

.resp-snap-title{
  font-size: 11px;
  letter-spacing: .22em;
  opacity: .8;
  margin-bottom: 8px;
}

/* KPI row */
.resp-kpis{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid rgba(120,170,255,.18);
  background: rgba(10,14,28,.55);
  margin-bottom: 10px;
}

.resp-kpi{
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(120,170,255,.12);
  background: rgba(8,10,22,.55);
}

.resp-kpi-label{
  font-size: 10px;
  letter-spacing: .16em;
  text-transform: uppercase;
  opacity: .75;
  margin-bottom: 4px;
}

.resp-kpi-value{
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .02em;
}

/* 3 col output */
.resp-snap-grid{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.resp-snap-col{
  border-radius: 12px;
  border: 1px solid rgba(120,170,255,.12);
  background: rgba(8,10,22,.45);
  overflow: hidden;
}

.resp-snap-head{
  padding: 8px 10px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  background: rgba(255,255,255,.03);
  border-bottom: 1px solid rgba(120,170,255,.12);
}

.resp-snap-body{
  padding: 10px;
  max-height: 340px; /* mais alto p/ ficar “na cara” */
  overflow: auto;
}

.resp-snap-row{
  display: grid;
  grid-template-columns: 1fr 1.25fr;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px dashed rgba(255,255,255,.07);
}

.resp-snap-row:last-child{ border-bottom: none; }

.resp-snap-key{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  opacity: .85;
}

.resp-snap-val{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  text-align: right;
  opacity: .95;
  word-break: break-word;
}

.resp-snap-null{ opacity: .55; font-style: italic; }

.resp-snap-strong .resp-snap-key{ opacity: 1; font-weight: 800; }
.resp-snap-strong .resp-snap-val{ opacity: 1; font-weight: 700; }

.resp-bool{
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  font-size: 11px;
}
.resp-bool-true{ background: rgba(60,190,120,.16); }
.resp-bool-false{ background: rgba(220,80,90,.14); }

/* flash quando muda */
.resp-snap-flash{
  animation: respSnapFlash .55s ease-out;
}
@keyframes respSnapFlash{
  from { background: rgba(80,160,255,.18); }
  to   { background: transparent; }
}

@media (max-width: 980px){
  .resp-kpis{ grid-template-columns: repeat(2,1fr); }
  .resp-snap-grid{ grid-template-columns: 1fr; }
  .resp-snap-row{ grid-template-columns: 1fr; }
  .resp-snap-val{ text-align: left; }
}



  </style>
</head>

<body>
    <div class="page">
    <!-- ====== TOPO ====== -->
    <header class="top-bar">
      <div class="top-left">

        <!-- Logo The Six Seats Investments -->
        <div class="brand-logo">
          <img
            src="six-seats-logo.png"
            alt="The Six Seats Investments"
            class="brand-logo-img"
          />
          <div class="brand-logo-text">
            <div class="brand-logo-main">THE SIX SEATS</div>
            <div class="brand-logo-sub">INVESTMENTS</div>
          </div>
        </div>

        <!-- Título do painel AARON 9 -->
        <div class="brand-title">
          <span>AARON 9</span>&nbsp;INSTITUTIONAL PANEL
        </div>


    <div class="status-dot-live" data-i18n="top.live_feed">
      LIVE FEED
    </div>

    <div class="pill-small">
      <span data-i18n="top.symbol">Símbolo</span>
      <strong id="symbol-label">—</strong>
    </div>

    <div class="pill-small">
      <span data-i18n="top.timeframe">Timeframe</span>
      <strong id="timeframe-label">—</strong>
    </div>

    <div class="pill-small">
      <span data-i18n="top.session">Sessão</span>
      <strong id="session-label">—</strong>
    </div>
  </div>

  <div class="top-right">
    <!-- TOGGLE PT / EN -->
    <div id="lang-toggle" class="lang-toggle">
      <button type="button" class="lang-btn active" data-lang="pt">PT</button>
      <button type="button" class="lang-btn" data-lang="en">EN</button>
    </div>

    <div class="pill-state" id="state-pill">
      AGUARDANDO
    </div>

    <div class="pill-soft">
      <span data-i18n="top.last_update">Última atualização:</span>
      <strong id="last-update-label">—</strong>
    </div>

    <button class="btn-refresh" id="btn-refresh" data-i18n="top.refresh">
      ATUALIZAR
    </button>
  </div>
</header>

    <!-- ================== GARIMPO DE HOJE / BEST STOCK TO TRADE ================== -->
<section id="garimpo-today" class="garimpo-banner">
  <div class="garimpo-container">
    <div class="garimpo-badge" data-i18n="garimpo_badge">
      Garimpo de Hoje
    </div>

        <div class="garimpo-main">
      <div class="garimpo-header-row">
        <div class="garimpo-title-block">
          <span class="garimpo-label" data-i18n="garimpo_best_label">
            Melhor ativo para hoje
          </span>
          <div class="garimpo-ticker-line">
            <span id="garimpo-ticker" class="garimpo-ticker">NVDA</span>
            <span id="garimpo-profile" class="garimpo-profile-tag">
              Day Trade Momentum
            </span>
          </div>
        </div>

        <div class="garimpo-header-right">
          <!-- BOTÃO PARA IR AO GARIMPO -->
          <a
            href="garimpo.html"
            class="garimpo-link-btn"
            data-i18n="garimpo_view_page"
          >
            Ver página do garimpo
          </a>

          <!-- CHIP DE CONFIANÇA DO CÉREBRO -->
          <div class="garimpo-confidence-chip">
            <span class="chip-label" data-i18n="garimpo_metric_confidence">
              Confiança do cérebro
            </span>
            <span id="garimpo-confidence" class="chip-value">91%</span>
          </div>
        </div>
      </div>




      <div class="garimpo-metrics-row">
        <div class="garimpo-metric">
          <div class="metric-label" data-i18n="garimpo_metric_gap">Gap</div>
          <div id="garimpo-gap" class="metric-value">+2.3%</div>
        </div>
        <div class="garimpo-metric">
          <div class="metric-label" data-i18n="garimpo_metric_premarket">
            Pré-market vs média
          </div>
          <div id="garimpo-premarket" class="metric-value">1.8×</div>
        </div>
        <div class="garimpo-metric">
          <div class="metric-label" data-i18n="garimpo_metric_atr">
            ATR% (volatilidade)
          </div>
          <div id="garimpo-atr" class="metric-value">2.1%</div>
        </div>
      </div>

      <p class="garimpo-comment" data-i18n="garimpo_comment">
        Hoje este é o ativo com melhor combinação de fluxo, liquidez e
        volatilidade para o seu perfil.
      </p>
    </div>
  </div>
</section>
<!-- ================== FIM GARIMPO DE HOJE ================== -->


    <div id="error-banner" class="error-banner">
      <strong>Erro ao carregar painel.</strong> Verifique o n8n / webhook e tente novamente.
    </div>

    <!-- ====== LAYOUT PRINCIPAL ====== -->
    <main class="layout">
      <!-- ====== COLUNA ESQUERDA: TV + PADRÕES ====== -->
      <section class="column">
           <!-- ====== GERENCIADOR DE RISCO · ATR ====== -->
<section class="risk-card" id="atr-risk-panel">
  <div class="risk-header">
    <div>
      <div class="risk-title" data-i18n="risk.title">
        Gerenciador de risco · ATR
      </div>
      <div class="risk-subtitle" data-i18n="risk.subtitle">
        Ajuste os parâmetros do ATR e calcule risco / reward da operação.
      </div>
    </div>

    <button
      type="button"
      class="risk-toggle"
      id="atr-risk-toggle"
      data-i18n="risk.toggle_open"
    >
      Abrir
    </button>
  </div>



  <div class="risk-body" id="atr-risk-body" style="display:none;">
    <div class="risk-group">
      <div class="risk-label">Length</div>
      <input id="atr-length-input" type="number" value="14" min="1" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Smoothing</div>
      <select id="atr-smoothing-input">
        <option value="RMA" selected>RMA</option>
        <option value="SMA">SMA</option>
        <option value="EMA">EMA</option>
        <option value="WMA">WMA</option>
      </select>
    </div>

    <div class="risk-group">
      <div class="risk-label">Multiplier</div>
      <input id="atr-multiplier-input" type="number" step="0.1" value="2.3" />
    </div>

    <div class="risk-group">
      <div class="risk-label">ATR atual</div>
      <input id="atr-value-input" type="number" step="0.01" placeholder="ex: 1.25" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Capital da posição ($)</div>
      <input id="atr-capital-input" type="number" step="100" placeholder="ex: 100000" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Preço de entrada</div>
      <input id="atr-entry-input" type="number" step="0.01" placeholder="ex: 177" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Risco por trade (%)</div>
      <input id="atr-riskpct-input" type="number" step="0.1" value="1" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Lado</div>
      <select id="atr-side-input">
        <option value="buy">Compra</option>
        <option value="sell">Venda</option>
      </select>
    </div>

    <div class="risk-actions">
      <button id="atr-calc-btn" type="button">Calcular risco</button>
    </div>

    <div class="risk-results">
      <div>
        <div class="risk-result-label">Distância do stop (ATR × mult)</div>
        <div class="risk-result-value" id="atr-stop-distance">—</div>
      </div>
      <div>
        <div class="risk-result-label">Qtd. sugerida de ações</div>
        <div class="risk-result-value" id="atr-shares">—</div>
      </div>
      <div>
        <div class="risk-result-label">Risco aproximado</div>
        <div class="risk-result-value" id="atr-risk-money">—</div>
      </div>
      <div>
        <div class="risk-result-label">Alvo 2R · 3R (aprox.)</div>
        <div class="risk-result-value" id="atr-reward-2r">—</div>
        <div class="risk-result-value small" id="atr-reward-3r">—</div>
      </div>
    </div>
  </div>
</section>

      <!-- SIZING BRAIN – GERENCIADOR DE RISCO -->


      
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="card.tv_title">Painel de Preço em Tempo Real</div>
<div class="card-subtitle" data-i18n="card.tv_sub">Alpaca PRO + Estrutura do Dia</div>


            </div>
            <div class="badge-outline green">
              <span class="dot"></span>
              Fluxo
              <span id="flow-label">Neutro</span>
            </div>
          </div>

         




          <!-- AARON CHART (ALPACA) -->
<div class="panel-section">
  <div class="panel-section-header">
  <div class="panel-section-title">Gráfico em Tempo Real</div>

  <div class="a10-chart-head-right">
    <div class="a10-tf" id="a10-tf" aria-label="Timeframes">
      <button type="button" class="a10-tf-btn" data-tf="1m">1m</button>
      <button type="button" class="a10-tf-btn" data-tf="5m">5m</button>
      <button type="button" class="a10-tf-btn" data-tf="15m">15m</button>
      <button type="button" class="a10-tf-btn" data-tf="1h">1h</button>
      <button type="button" class="a10-tf-btn" data-tf="4h">4h</button>
    </div>

    <div class="pill-soft pill-soft-accent" id="a10-feed-pill">Fonte: Alpaca PRO (SIP)</div>
  </div>
</div>


  <!-- AARON Studies (módulos) -->
  <div class="aaron-studies">
    <div class="aaron-studies-title">AARON Studies</div>

    <div class="aaron-studies-pills">
      <label class="pill-toggle">
        <input id="st-session-hl" type="checkbox" checked />
        <span>Session H/L</span>
      </label>

      <label class="pill-toggle">
        <input id="st-prevday" type="checkbox" checked />
        <span>Prev Day</span>
      </label>

      <label class="pill-toggle">
        <input id="st-orb" type="checkbox" />
        <span>ORB 5m</span>
      </label>

      <label class="pill-toggle">
        <input id="st-vwap" type="checkbox" checked />
        <span>VWAP</span>
      </label>

      <label class="pill-toggle">
        <input id="st-ema21" type="checkbox" checked />
        <span>EMA 21</span>
      </label>
    </div>
  </div>

  <div class="aaron10-chart-shell">
    <div id="aaron10-chart" class="aaron10-chart"></div>

    <!-- overlay discreto (meta do chart) -->
    <div class="aaron10-chart-overlay">
      <div class="pill-small" id="chart-meta">—</div>
    </div>
  </div>
</div>

        </div>
                  <div class="resp-snap" id="resp-snap">
  <div class="resp-snap-title">RESPONDER OUTPUT</div>

  <div class="resp-kpis">
    <div class="resp-kpi">
      <div class="resp-kpi-label">PATTERN</div>
      <div class="resp-kpi-value" id="resp-kpi-pattern">—</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">CONFIDENCE</div>
      <div class="resp-kpi-value" id="resp-kpi-confidence">—</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">BIAS</div>
      <div class="resp-kpi-value" id="resp-kpi-bias">—</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">DIRECTION</div>
      <div class="resp-kpi-value" id="resp-kpi-direction">—</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">SR (L—H)</div>
      <div class="resp-kpi-value" id="resp-kpi-sr">—</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">BARS</div>
      <div class="resp-kpi-value" id="resp-kpi-bars">—</div>
    </div>
  </div>

  <div class="resp-snap-grid">
    <div class="resp-snap-col">
      <div class="resp-snap-head">panel</div>
      <div class="resp-snap-body" id="resp-snap-panel">—</div>
    </div>

    <div class="resp-snap-col">
      <div class="resp-snap-head">ui</div>
      <div class="resp-snap-body" id="resp-snap-ui">—</div>
    </div>

    <div class="resp-snap-col">
      <div class="resp-snap-head">digest</div>
      <div class="resp-snap-body" id="resp-snap-digest">—</div>
    </div>
  </div>
</div>

                  <!-- ===== NOVO: Estrutura recente + Market Structure ===== -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Estrutura recente</div>
            </div>

            <div class="structure-wrapper">
              <!-- Chips HH / HL / LH / LL -->
              <div class="structure-grid">
                <div class="structure-chip" id="structure-hh">
                  <span class="structure-label">HH</span>
                  <span>
                    <span class="structure-status" id="structure-hh-status">off</span>
                    <span class="structure-dot" id="structure-hh-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-hl">
                  <span class="structure-label">HL</span>
                  <span>
                    <span class="structure-status" id="structure-hl-status">off</span>
                    <span class="structure-dot" id="structure-hl-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-lh">
                  <span class="structure-label">LH</span>
                  <span>
                    <span class="structure-status" id="structure-lh-status">ativo</span>
                    <span class="structure-dot on" id="structure-lh-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-ll">
                  <span class="structure-label">LL</span>
                  <span>
                    <span class="structure-status" id="structure-ll-status">ativo</span>
                    <span class="structure-dot on" id="structure-ll-dot"></span>
                  </span>
                </div>
              </div>

              <!-- ZigZag / Market Structure -->
              <div class="structure-zigzag">
                <div class="structure-zigzag-title">
                  Market structure · últimos candles
                </div>
                <div class="structure-zigzag-box">
                  <svg
                    id="structure-zigzag-svg"
                    class="structure-zigzag-svg"
                    viewBox="0 0 100 40"
                    preserveAspectRatio="none"
                  >
                    <polyline
                      id="structure-zigzag-poly"
                      points="0,30 15,12 30,26 45,10 60,24 75,8 90,22 100,14"
                      fill="none"
                      stroke="rgba(248,113,113,0.9)"
                      stroke-width="2.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </div>
            </div>
          </div>
          <!-- ===== /Estrutura recente ===== -->


       <!-- ===== SIZING BRAIN – ABAIXO DO TRADEVIEW ===== -->

<!-- ===== SIZING BRAIN – GERENCIADOR + CAPITAL DO DIA (ABAIXO DO TRADEVIEW) ===== -->
<section class="card sizing-brain-card" id="sizing-brain-card">
  <div class="card-header">
    <h2>Sizing Brain – Gerenciador de Risco & Gestão de capital do dia</h2>
    <p class="card-subtitle">
      ATR • Capital em uso • Stop • Take Profit • Qtd sugerida · Gestão de capital do dia
    </p>
  </div>

  <div class="card-body">
    <!-- BLOCO 1 · GERENCIADOR DE RISCO (MESMO DE CIMA) -->
    <div class="sb-grid">
      <div class="sb-field">
        <label for="sb-account-balance">Capital real da conta (USD)</label>
        <input id="sb-account-balance" type="number" step="0.01" value="25000" />
      </div>

      <div class="sb-field">
        <label for="sb-leverage">Alavancagem (buying power x)</label>
        <input id="sb-leverage" type="number" step="0.1" value="4" />
        <small id="sb-buying-power-info" class="sb-hint">Buying power ≈ $100.000</small>
      </div>

      <div class="sb-field">
        <label for="sb-trade-capital">Capital em uso neste trade (USD)</label>
        <input id="sb-trade-capital" type="number" step="0.01" value="50000" />
        <small class="sb-hint">Pode ser menor que o buying power se quiser ser conservador.</small>
      </div>

      <div class="sb-field">
        <label for="sb-risk-percent">Risco máx. por trade (% da conta)</label>
        <input id="sb-risk-percent" type="number" step="0.1" value="1" />
        <small class="sb-hint">Ex: 1% em uma conta de 25k = $250 de risco.</small>
      </div>
    </div>

    <hr class="sb-divider" />

    <div class="sb-grid">
      <div class="sb-field">
        <label for="sb-entry-price">Preço de entrada</label>
        <input id="sb-entry-price" type="number" step="0.01" value="100" />
      </div>

      <div class="sb-field">
        <label for="sb-atr-value">ATR atual ($)</label>
        <input id="sb-atr-value" type="number" step="0.01" value="1.2" />
      </div>

      <div class="sb-field">
        <label for="sb-atr-mult-stop">Multiplicador ATR STOP</label>
        <input id="sb-atr-mult-stop" type="number" step="0.1" value="1.5" />
        <small class="sb-hint">Stop em ATR (ex: 1.5x ATR).</small>
      </div>

      <div class="sb-field">
        <label for="sb-atr-mult-take">Multiplicador ATR TAKE</label>
        <input id="sb-atr-mult-take" type="number" step="0.1" value="3" />
        <small class="sb-hint">Take profit em ATR (ex: 3x ATR).</small>
      </div>

      <div class="sb-field">
        <label>Direção</label>
        <div class="sb-side-toggle">
          <label>
            <input type="radio" name="sb-side" value="long" checked />
            <span>Compra / CALL</span>
          </label>
          <label>
            <input type="radio" name="sb-side" value="short" />
            <span>Venda / PUT</span>
          </label>
        </div>
      </div>
    </div>

    <hr class="sb-divider" />

    <div class="sb-results-grid">
  <div class="sb-result-block">
    <h3>Stop &amp; Alvo (ATR)</h3>
    <p id="sb-stop-distance" class="sb-result-main">Distância do STOP: –</p>
    <p id="sb-stop-price" class="sb-result-sub">Stop Loss sugerido: –</p>
    <p id="sb-take-price" class="sb-result-sub">Take Profit sugerido: –</p>
  </div>

  <div class="sb-result-block">
    <h3>Qtd &amp; Risco</h3>
    <p id="sb-position-size" class="sb-result-main">Qtd sugerida: –</p>
    <p id="sb-risk-dollar" class="sb-result-sub">Risco aprox.: –</p>
    <p id="sb-risk-percent" class="sb-result-sub">Risco % trade / conta: –</p>
  </div>
</div>

<!-- NOVO · TERMÔMETRO DO GERENCIADOR DE RISCO (OFFLINE) -->
<div class="sb-meter">
  <div class="sb-meter-label">
    <span>Conservador</span>
    <span id="sb-meter-label">Uso de risco 0%</span>
    <span>Agressivo</span>
  </div>
  <div class="sb-meter-bar">
    <div id="sb-meter-fill" class="sb-meter-fill safe"></div>
  </div>
</div>

<div class="sb-actions">
  <button id="sb-calcular" class="primary-btn">Recalcular Sizing</button>
  <span id="sb-status" class="sb-status">
    Ajuste os valores e clique em “Recalcular Sizing”.
  </span>
</div>


    <!-- DIVISOR ENTRE GERENCIADOR E CAPITAL DO DIA -->
    <hr class="sb-divider" />

    <!-- BLOCO 2 · GESTÃO DE CAPITAL DO DIA (O MESMO QUE FICAVA ABAIXO DO TRADEVIEW) -->

    <div class="decision-title" data-i18n="sizing.title">
      Sizing Brain · Gestão de capital do dia
    </div>

    <!-- HEADER: números principais -->
    <div class="sizing-header-row">
      <div class="sizing-main-numbers">
        <div class="sizing-label">
          <span data-i18n="sizing.target_label">Alvo razoável hoje</span>
        </div>
        <div class="sizing-target-value" id="sizing-target">
          0.8–1.4%
        </div>
      </div>

      <div class="sizing-secondary-numbers">
        <div>
          <span data-i18n="sizing.max_dd">Máx. perda</span>:
          <strong id="sizing-max-dd">0.8%</strong>
        </div>
        <div>
          <span data-i18n="sizing.risk_trade">Risco / trade</span>:
          <strong id="sizing-risk-trade">0.25%</strong>
        </div>
        <div>
          <span data-i18n="sizing.trades">Trades A+</span>:
          <strong id="sizing-trades-count">3</strong>
        </div>
      </div>
    </div>

    <!-- TAGS: perfil + estilo -->
    <div class="sizing-tag-row">
      <span id="sizing-profile-tag" class="sizing-tag profile-normal">
        Normal
      </span>
      <span id="sizing-style-tag" class="sizing-tag style-daytrade">
        Day trade tendencial
      </span>
    </div>

    <!-- TERMÔMETRO -->
    <div class="sizing-meter">
      <div class="sizing-meter-label">
        <span data-i18n="sizing.conservative">Conservador</span>
        <span id="sizing-meter-label">Uso de risco 40%</span>
        <span data-i18n="sizing.aggressive">Agressivo</span>
      </div>
      <div class="sizing-meter-bar">
        <div
          id="sizing-meter-fill"
          class="sizing-meter-fill"
          style="width:40%;"
        ></div>
      </div>
    </div>

    <!-- Inputs tipo Aaron Pine -->
    <div class="sizing-inputs">
      <div class="sizing-input">
        <label for="sizing-account-real-input">
          Capital REAL da conta (USD)
        </label>
        <input
          id="sizing-account-real-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 10000"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-use-input">
          Capital EM USO neste trade (USD)
        </label>
        <input
          id="sizing-use-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 10000"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-leverage-input">
          Alavancagem (×)
        </label>
        <input
          id="sizing-leverage-input"
          type="number"
          inputmode="decimal"
          step="0.1"
          placeholder="ex: 4"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-risk-input">
          Risco por trade (%)
        </label>
        <input
          id="sizing-risk-input"
          type="number"
          inputmode="decimal"
          step="0.1"
          placeholder="ex: 0.5"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-stop-input">
          Distância do stop (USD por share)
        </label>
        <input
          id="sizing-stop-input"
          type="number"
          inputmode="decimal"
          step="0.01"
          placeholder="ex: 1.20"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-fixedqty-input">
          Qtd fixa (ações) – opcional
        </label>
        <input
          id="sizing-fixedqty-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 100"
        />
      </div>
    </div>

    <!-- Frases + comentário -->
    <div class="sizing-phrase">
      <div id="sizing-phrase-main" class="sizing-phrase-main">
        Digite Capital REAL, EM USO, risco % e stop para ver o tamanho sugerido
        da posição.
      </div>
      <div id="sizing-phrase-detail" class="sizing-phrase-detail"></div>
    </div>

    <div class="sizing-comment" id="sizing-comment">
      Hoje o fluxo permite buscar algo em torno de 0.8–1.2% se você focar em 2–3
      trades A+. Acima disso já entra zona de ganância; abaixo disso ainda é um
      dia ok se você seguiu o plano.
    </div>
  </div>
</section>

<!-- ====== ABA DE REFERÊNCIA (ABAIXO DO SIZING BRAIN) ====== -->
<section class="card ref-card" id="pattern-reference-card">
  <div class="card-header">
    <div>
      <div class="card-title">Referência de Padrão</div>
      <div class="card-subtitle">Abra para ver a imagem que o THE EYE está usando.</div>
    </div>
    <span class="pill neutral">REF</span>
  </div>

  <details class="ref-details" id="refDetails">
    <summary class="ref-summary">
      <span class="ref-summary-left">
        <span class="ref-summary-title" id="refSummaryTitle">Abrir referência</span>
        <span class="ref-summary-mini" id="refPatternMini">—</span>
      </span>
      <span class="ref-summary-right" id="refSummaryRight">Abrir</span>
    </summary>

    <div class="ref-body">
      <div class="ref-grid">
        <div class="ref-img-wrap">
          <img
            id="refPatternImg"
            src="assets/patterns/F%20(1).jpg"
            alt="Referência do padrão"
            loading="lazy"
          />
        </div>

        <div class="ref-text">
          <div class="ref-line">
            <span class="muted">Padrão:</span>
            <strong id="refPatternLabel">—</strong>
          </div>

          <div class="ref-line">
            <span class="muted">Setup:</span>
            <span id="refPatternSetup">—</span>
          </div>

          <div class="ref-line">
            <span class="muted">Notas:</span>
            <span id="refPatternNotes">—</span>
          </div>

          <a
            id="refPatternLink"
            class="ref-link"
            href="assets/patterns/F%20(1).jpg"
            target="_blank"
            rel="noopener"
          >
            Ver imagem em tamanho real
          </a>
        </div>
      </div>
    </div>
  </details>
</section>
<!-- ====== /ABA DE REFERÊNCIA ====== -->





      </section>

      <!-- ====== COLUNA DIREITA: RESUMO + RISCO ====== -->
      <section class="column">
        <div class="card">
  <div class="card-header">
    <div>
      <div class="card-title" data-i18n="summary.title">Resumo institucional</div>
      <div class="card-subtitle" data-i18n="summary.subtitle">Leitura consolidada do AARON 9</div>
    </div>
    <div class="badge-outline">
      <span class="dot"></span>
      <span data-i18n="summary.risk_mgmt">Gestão de risco</span>
    </div>
  </div>

<!-- ====== AARON 9 – COLUNA DIREITA (DECISION PANEL) ====== -->
<div class="decision-column">

    <!-- AUTO PILOT (fora do Citadel, dentro do Resumo Institucional) -->
<section class="decision-card autopilot-v2" id="autopilot-panel">
  <div class="ap2-top">
    <div>
      <div class="decision-title">AUTO PILOT</div>
      <div class="ap2-sub">Execução rápida (simulador)</div>
    </div>

    <div class="ap2-controls">
      <span id="ap-state" class="badge-outline ap-off">OFF</span>

      <label class="ap-switch ap2-switch" title="Liga/desliga o Autopilot (simulador)">
        <input type="checkbox" id="ap-toggle" />
        <span class="ap-slider"></span>
      </label>
    </div>
  </div>

  <!-- ====== MODO 2.0: capital -> units (shares) ====== -->
  <div class="ap2-sizing">
    <div class="ap2-price-row">
      <div class="ap2-quote ap2-quote-sell">
        <div class="ap2-quote-label">Sell</div>
        <div id="ap-price-sell" class="ap2-quote-price">—</div>
      </div>

      <div class="ap2-quote-mid">
        <div class="ap2-quote-mid-label">Price</div>
        <div id="ap-price-mid" class="ap2-quote-mid-price">—</div>
      </div>

      <div class="ap2-quote ap2-quote-buy">
        <div class="ap2-quote-label">Buy</div>
        <div id="ap-price-buy" class="ap2-quote-price">—</div>
      </div>
    </div>

    <div class="ap2-input-row">
      <div class="ap2-field">
        <label class="ap2-label">Units (shares)</label>
        <input id="ap-units" class="ap2-input" type="text" value="—" readonly />
      </div>

      <div class="ap2-field">
        <label class="ap2-label">Capital USD</label>
        <input id="ap-capital" class="ap2-input" type="number" step="100" value="25000" />
      </div>
    </div>
  </div>

  <div class="ap2-bottom">
    <button id="ap-buy" class="ap-btn ap-buy"><span class="ap2-ico">▲</span>BUY</button>
    <button id="ap-sell" class="ap-btn ap-sell"><span class="ap2-ico">▼</span>SELL</button>
    <button id="ap-close" class="ap-btn ap-close"><span class="ap2-ico">✕</span>CLOSE</button>

    <span id="ap-meta" class="ap-meta">—</span>
  </div>
</section>




  <!-- CARTÃO CITADEL · CARTÃO DE TRADE ATUAL -->
  <section id="trade-card" class="status-hero status-sell blink-hero">
    <div>
      <!-- TÍTULO -->
      <div class="status-hero-label" data-i18n="trade_card.title">
        AARON – Cartão de Trade Atual
      </div>

      <!-- BLOCO PRINCIPAL DO CARTÃO -->
      <div class="status-hero-main">
        <div class="trade-line">
          <strong data-i18n="trade_card.status_label">Status:</strong>
          <span id="trade-status-text">✅ Setup válido | ❌ Sem trade</span>
        </div>

<div class="trade-line">
  <strong>Pulse:</strong>
  <span id="pulseLine">—</span>
</div>


        <div class="trade-line" id="trade-stats-top-line" style="display:none;">
  <strong data-i18n="trade_card.stats_label">Estatística:</strong>
  <span id="trade-stats-top">—</span>
</div>




        <!-- NOVO: Estatística (7y) no topo -->
      
        <div class="trade-line">
          <strong data-i18n="trade_card.asset_label">Ativo:</strong>
          <span id="trade-symbol">NVDA</span>
          <span class="trade-sep">|</span>
          <strong data-i18n="trade_card.timeframe_label">Timeframe:</strong>
          <span id="trade-timeframe">1m</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.stats_label">Estatística:</strong>
          <span id="trade-stats">—</span>
        </div>


        <div class="trade-line">
          <strong data-i18n="trade_card.mode_label">Modo:</strong>
          <span id="trade-mode">Reversão em Resistência</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.against_label">Contra:</strong>
          <span id="trade-against">57% (base 7 anos)</span>
        </div>

        <hr class="trade-divider" />

        <div class="trade-line">
          <strong data-i18n="trade_card.dir_label">Direção sugerida:</strong>
          <span id="trade-direction">VENDA</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.entry_label">Entrada:</strong>
          <span id="trade-entry">492.80 – 493.10</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.stop_label">Stop:</strong>
          <span id="trade-stop">494.20</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.tp_label">TP1:</strong>
          <span id="trade-tp1">490.00</span>
          <span class="trade-sep">|</span>
          <strong>TP2:</strong>
          <span id="trade-tp2">487.50</span>
        </div>

        <hr class="trade-divider" />

        <div class="trade-line">
          <strong data-i18n="trade_card.size_label">Tamanho:</strong>
          <span id="trade-size">227 shares</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.risk_label">Risco:</strong>
          <span id="trade-risk">US$ 250 (1% do risk budget)</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.thermo_label">Termômetro:</strong>
          <span id="trade-thermo">Agressivo moderado</span>
        </div>

        <hr class="trade-divider" />

        <div class="trade-line trade-comment">
          <strong data-i18n="trade_card.comment_label">Comentário do AARON:</strong>
          <span id="trade-comment">
            “Reversão estatisticamente forte após falso rompimento.
            Se executar, não mova stop contra a posição.”
          </span>
        </div>
               


      </div>
    </div>

    <!-- BADGE LATERAL IGUAL AO COMPRA EM CONTINUAÇÃO -->
    <div id="trade-badge" class="status-hero-badge sell">
      GO FULL
    </div>
  </section>



  <!-- RESUMO INSTITUCIONAL / VEREDITO -->
<section class="right-col">

  <div class="decision-card hero-mode-card" id="hero-block">
    <div class="decision-row">
      <div>
        <div class="decision-title">RESUMO INSTITUCIONAL</div>
        <button class="decision-pill go-full" id="hero-mode-pill">GO FULL</button>
      </div>
      <div class="decision-verdict" id="hero-side-label">—</div>
    </div>

    <div class="decision-text" id="hero-summary-text">
      Carregando leitura institucional do mercado...
    </div>

    <div class="decision-title" style="margin-bottom:2px;">A favor</div>
    <div class="decision-subtitle" id="hero-favor-label">A favor: —%</div>
    <div class="decision-bar">
      <div class="decision-bar-fill" id="hero-favor-bar" style="width:0%"></div>
    </div>
    <div class="prob-phrase" id="hero-favor-phrase">—</div>

    <div style="height:10px"></div>

    <div class="decision-title" style="margin-bottom:2px;">Contra</div>
    <div class="decision-subtitle" id="hero-contra-label">Contra: —%</div>
    <div class="decision-bar">
      <div class="decision-bar-fill-danger" id="hero-contra-bar" style="width:0%"></div>
    </div>
    <div class="prob-phrase prob-phrase-danger" id="hero-contra-phrase">—</div>

    <div class="decision-grid3">
      <div>
        <div class="decision-mini-title">RISCO</div>
        <div class="decision-mini-text" id="hero-mini-risk">—</div>
      </div>
      <div>
        <div class="decision-mini-title">CONTEXTO</div>
        <div class="decision-mini-text" id="hero-mini-context">—</div>
      </div>
      <div>
        <div class="decision-mini-title">EXECUÇÃO</div>
        <div class="decision-mini-text" id="hero-mini-execution">—</div>
      </div>
    </div>
  </div>

</section>

    <!-- PULLBACK BRAIN · CÉREBRO ESPECIAL DE PULLBACK -->
  <section class="decision-card" id="pullback-brain-card">
    <div class="decision-title" data-i18n="pullback.title">
      Pullback Brain · Zona de respiro
    </div>

    <!-- HEADER: status + tags -->
    <div class="pullback-header-row">
      <div class="pullback-status-block">
        <div class="pullback-status-label">Status</div>
        <div id="pullback-status" class="pullback-status-main">
          Aguardando pullback...
        </div>
      </div>

      <div class="pullback-meta-block">
        <div>
          <span data-i18n="pullback.depth">Profundidade</span>:
          <strong id="pullback-depth">—</strong>
        </div>
        <div>
          <span data-i18n="pullback.quality">Qualidade</span>:
          <strong id="pullback-quality">—</strong>
        </div>

        <div class="pullback-tag-row">
          <span id="pullback-side-tag" class="pullback-tag side-neutral">
            NEUTRO
          </span>
          <span id="pullback-stage-tag" class="pullback-tag stage">
            Aguardando
          </span>
        </div>
      </div>
    </div>

    <!-- TERMÔMETRO / CONFIANÇA DO PULLBACK -->
    <div class="pullback-meter">
      <div class="pullback-meter-label">
        <span>Somente respiro</span>
        <span id="pullback-meter-label">Confiança 40%</span>
        <span>Reversão forte</span>
      </div>
      <div class="pullback-meter-bar">
        <div
          id="pullback-meter-fill"
          class="pullback-meter-fill neutral"
          style="width:40%;"
        ></div>
      </div>
    </div>

    <!-- TEXTO "HUMANO" DO CÉREBRO DE PULLBACK -->
    <div class="pullback-highlight" id="pullback-highlight-box">
      <div id="pullback-headline" style="font-weight:600; margin-bottom:4px;">
        Pullback ainda saudável dentro da tendência.
      </div>
      <div id="pullback-text" style="font-size:0.8rem;">
        Ainda não há um pullback claro.  
        O mercado ainda não ofereceu um pullback limpo na direção principal.
        Deixe o preço respirar e espere estrutura.
      </div>
    </div>
  </section>

   


  <!-- CHECKLIST DE PADRÕES -->
  <section class="decision-card">
    <div class="decision-title">Checklist de padrões</div>
    <div class="checklist-grid">
      <div class="check-pill on">Rompimento</div>
      <div class="check-pill">Continuação</div>
      <div class="check-pill">Reversão (ausente)</div>
      <div class="check-pill on">Divergência</div>
      <div class="check-pill">Exaustão</div>
      <div class="check-pill">Volume normal</div>
    </div>
  </section>

  <!-- PATTERN RADAR + CHECK PULLBACK -->
  <section class="decision-card">
  <div class="decision-title">Pattern radar · estrutura</div>

  <div class="pattern-layout" style="margin-top:6px;">

    <!-- PADRÃO DO DIA -->
    <div class="pattern-box">
      <div class="decision-title" style="margin-bottom:4px;">Padrão do dia</div>

      <div class="pattern-canvas">
        <!-- Desenho simbólico do padrão do dia (ex.: canal de baixa) -->
        <svg class="pattern-svg" viewBox="0 0 100 36">
          <polyline
            points="0,10 20,16 40,20 60,24 80,28 100,32"
            fill="none"
            stroke="rgba(248,113,113,0.9)"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

           <div id="pattern-day-label" class="pattern-name">Canal de baixa moderada</div>
      <div id="pattern-day-detail">
        Preço respeitando topos e fundos descendentes durante o dia. Favorece operações a favor da tendência de baixa.
      </div>


    <!-- PADRÃO DO MOMENTO (últimos 50 candles) -->
    <div class="pattern-box">
      <div class="decision-title" style="margin-bottom:4px;">Padrão do momento · últimos 50 candles</div>

      <div class="pattern-canvas">
        <!-- Desenho simbólico do padrão do momento (ex.: range / zigue-zague) -->
        <svg class="pattern-svg" viewBox="0 0 100 36">
          <polyline
            points="0,26 15,10 30,24 45,12 60,22 75,8 90,20 100,14"
            fill="none"
            stroke="rgba(56,189,248,0.9)"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

           <div id="pattern-now-label" class="pattern-name">Range / consolidação ativa</div>
      <div id="pattern-now-detail">
        Mercado alternando entre suporte e resistência nos últimos candles. Melhor aguardar rompimento ou pullback bem claro.
      </div>

    </div>

  </div>


    <!-- Check de pullback / respiro -->
    <div class="pullback-highlight">
      <div style="font-weight:600; margin-bottom:4px;">Check de pullback</div>
      <div style="font-size:0.78rem;">
        ATR do candle atual: <strong>0.85</strong> · Profundidade: <strong>0.96 ATR</strong><br />
        Tendência: <strong>Baixa forte</strong> · Estrutura: <strong>LH</strong><br />
        Pullback dentro da faixa ideal. Continuação provável se o contexto se mantiver.
      </div>
    </div>
  </section>

</div>

          <!-- Comentário principal -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Comentário do Painel</div>
            </div>
            <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
              <div id="summary-text" style="font-size: 12px; line-height: 1.5; color: var(--text-main);">
                Aguardando primeiro alerta do TradingView para montar o painel...
              </div>
            </div>
          </div>

          <!-- Risco + Contexto -->
          <div class="grid-2">
            <div class="panel-section">
              <div class="panel-section-header">
                <div class="panel-section-title">Risco</div>
              </div>
              <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                <div class="pill" id="risk-pill">Neutro</div>
                <div id="risk-text" style="font-size: 12px; color: var(--text-soft);">
                  —
                </div>
              </div>
            </div>

            <div class="panel-section">
              <div class="panel-section-header">
                <div class="panel-section-title">Contexto</div>
              </div>
              <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                <div id="context-text" style="font-size: 12px; color: var(--text-soft);">
                  —
                </div>
              </div>
            </div>
          </div>

          <!-- Execução -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Execução</div>
            </div>
            <div id="execution-text" style="font-size: 12px; color: var(--text-soft);">
              —
            </div>
          </div>
        </div>
      </section>
    </main>
      </div> <!-- /.page -->
    </div>   <!-- /.app-inner -->
  </div>     <!-- /.app-shell -->

  <script>
// ======= CONFIG PAINEL (JSON) =======
const PANEL_URL = 'https://jjjnogueira.app.n8n.cloud/webhook/aaron10_panel_json';
const REFRESH_MS = 60000; // painel (cards) a cada 1 minuto

// ======= CONFIG A10 REALTIME (WEBSOCKET RELAY) =======
// ⚠️ Não conecte direto no WebSocket do Alpaca no browser (exporia sua API KEY).
// Você vai rodar um RELAY (Alpaca WS -> seu WS) e apontar o painel para ele.
const A10_FEED = 'sip'; // 'sip' (PRO) ou 'iex'
const A10_RELAY_WS_URL = 'wss://SEU-RELAY-DOMINIO/ws'; // <<< TROQUE AQUI (quando o relay estiver online)

// Timeframe padrão do chart
const A10_DEFAULT_TF = '1m';

// ======= AARON10 (FASE 1) — Dropdown -> n8n WEBHOOK (symbol) =======
// OPÇÃO 2 (direto)
const MATCHER_WEBHOOK_URL_PROD = "https://jjjnogueira.app.n8n.cloud/webhook/aaron10_matcher_request";
const MATCHER_WEBHOOK_URL_TEST = "https://jjjnogueira.app.n8n.cloud/webhook-test/aaron10_matcher_request";
const MATCHER_WEBHOOK_URL = MATCHER_WEBHOOK_URL_PROD; // default


// chama o n8n e atualiza o painel com o retorno
// ==========================
// TRADE CARD • RESPONDER OUTPUT renderer
// ==========================
// chama o n8n e atualiza o painel com o retorno
// ==========================
// RESPONDER OUTPUT helpers
// ==========================
function setRespSnapMessage(msg){
  const html = `<div class="resp-snap-null">${String(msg || "—")}</div>`;
  ["resp-snap-panel","resp-snap-ui","resp-snap-digest"].forEach((id)=>{
    const el = document.getElementById(id);
    if (el) el.innerHTML = html;
  });
  // KPIs (se existirem)
  ["resp-kpi-pattern","resp-kpi-conf","resp-kpi-bias","resp-kpi-dir","resp-kpi-sr","resp-kpi-bars","resp-kpi-price"]
    .forEach((id)=>{
      const el = document.getElementById(id);
      if (el) el.textContent = "—";
    });
}

// ==========================
// TRADE CARD • RESPONDER OUTPUT renderer
// ==========================
function renderTradeResponderOutput(data){
  data = Array.isArray(data) ? (data[0] ?? {}) : (data ?? {});
  const elPanel  = document.getElementById("resp-snap-panel");
  const elUI     = document.getElementById("resp-snap-ui");
  const elDigest = document.getElementById("resp-snap-digest");
  if (!elPanel || !elUI || !elDigest) return;

  const panel  = data?.panel  || {};
  const ui     = data?.ui     || {};
  const digest = data?.digest || {};

  // ====== KPI row (WOW "na cara") ======
  const sf = digest?.shape_focus || {};
  const sr = digest?.sr_proxy || {};

  const setK = (id, v) => {
    const el = document.getElementById(id);
    if (!el) return;
    const out = (v === undefined || v === null || v === "") ? "—" : String(v);
    el.textContent = out;
  };

  setK("resp-kpi-pattern", sf.label || ui.structure_line || "—");
  setK("resp-kpi-conf", ui.confidence_label || (sf.confidence_pct != null ? `${sf.confidence_pct}%` : "—"));
  setK("resp-kpi-bias", sf.bias || "—");
  setK("resp-kpi-dir",  sf.direction || sr.direction || "—");
  setK("resp-kpi-sr",   (sr.recent_low != null || sr.recent_high != null) ? `${sr.recent_low ?? "—"} — ${sr.recent_high ?? "—"}` : "—");
  setK("resp-kpi-bars", digest.intraday_bars ?? "—");
  setK("resp-kpi-price", (panel.price_now ?? ui.price_now ?? digest.price_now) ?? "—");

  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");

  const fmt = (v) => {
    if (v === null || v === undefined) return { html:`<span class="resp-snap-null">null</span>`, plain:"null" };
    if (typeof v === "boolean") {
      return {
        html: `<span class="resp-bool ${v ? "resp-bool-true" : "resp-bool-false"}">${v}</span>`,
        plain: String(v)
      };
    }
    if (Array.isArray(v)) {
      const p = v.map(x => (x === null || x === undefined) ? "null" : String(x));
      const plain = p.join(", ");
      return { html: esc(plain), plain };
    }
    if (typeof v === "object") {
      const plain = JSON.stringify(v);
      return { html: `<span class="resp-snap-null">${esc(plain)}</span>`, plain };
    }
    const plain = String(v);
    return { html: esc(plain), plain };
  };

  const flatten = (obj, prefix = "", out = [], depth = 0) => {
    if (!obj || typeof obj !== "object") return out;
    for (const [k,v] of Object.entries(obj)){
      const key = prefix ? `${prefix}.${k}` : k;
      const isObj = v && typeof v === "object" && !Array.isArray(v);
      if (isObj && depth < 2) flatten(v, key, out, depth+1);
      else out.push([key, v]);
    }
    return out;
  };

  // prioridades p/ ficar "na cara" primeiro
  const P_PANEL  = ["symbol","timeframe","session","flow_label","status.label","updated_at","price_now","last_price","reference_price"];
  const P_UI     = ["confidence_pct","confidence_label","headline","structure_line","tactical_line","market_structure_line","pullback_line","detector_key","price_now"];
  const P_DIGEST = [
    "shape_focus.pattern_id","shape_focus.label","shape_focus.name_pt","shape_focus.family_en",
    "shape_focus.bias","shape_focus.direction","shape_focus.confidence_pct",
    "sr_proxy.recent_high","sr_proxy.recent_low","intraday_bars","features_true","price_now"
  ];

  const renderCol = (title, obj, priorities, el) => {
    const rows = flatten(obj);

    // mapa p/ ordenar prioridades
    const idx = new Map();
    priorities.forEach((k,i)=> idx.set(k, i));

    rows.sort((a,b)=>{
      const ak = a[0], bk = b[0];
      const ai = idx.has(ak) ? idx.get(ak) : 9999;
      const bi = idx.has(bk) ? idx.get(bk) : 9999;
      if (ai !== bi) return ai - bi;
      return ak.localeCompare(bk);
    });

    const prev = window.__RESP_SNAP_PREV__ || {};
    const next = {};

    let html = "";
    for (const [k,v] of rows){
      const { html:vh, plain:vp } = fmt(v);
      const keyFull = `${title}.${k}`;
      const was = prev[keyFull];
      const changed = (was !== undefined && was !== vp);
      next[keyFull] = vp;

      const strong = idx.has(k) ? "resp-snap-strong" : "";
      const flash  = changed ? "resp-snap-flash" : "";

      html += `
        <div class="resp-snap-row ${strong} ${flash}">
          <div class="resp-snap-key">${esc(k)}</div>
          <div class="resp-snap-val">${vh}</div>
        </div>
      `;
    }

    window.__RESP_SNAP_PREV__ = { ...prev, ...next };
    el.innerHTML = html || "—";
  };

  renderCol("panel",  panel,  P_PANEL,  elPanel);
  renderCol("ui",     ui,     P_UI,     elUI);
  renderCol("digest", digest, P_DIGEST, elDigest);
}

function escapeHtml(v){
  const s = (v===null || v===undefined) ? "" : String(v);
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function safe(v, fallback="—"){
  return (v===null || v===undefined || v==="") ? fallback : String(v);
}
function mapDir(dir){
  const d = String(dir||"").toLowerCase();
  if (d==="up" || d==="bull" || d==="long") return "COMPRA";
  if (d==="down" || d==="bear" || d==="short") return "VENDA";
  if (!d) return "—";
  return d.toUpperCase();
}

// <<< isso cria um “resumo” DENTRO do trade card (sem aquele grid de cards)
function ensureRespInlineSlot(){
  const anchor = document.getElementById("resp-snap-msg") || document.getElementById("resp-out-panel");
  if (!anchor || !anchor.parentElement) return null;

  let box = document.getElementById("resp-inline");
  if (box) return box;

  box = document.createElement("div");
  box.id = "resp-inline";
  box.style.margin = "10px 0 6px 0";
  box.style.padding = "10px 12px";
  box.style.border = "1px solid rgba(255,255,255,.08)";
  box.style.borderRadius = "12px";
  box.style.background = "rgba(10,14,22,.35)";

  anchor.parentElement.insertBefore(box, anchor);
  return box;
}

function renderResponderInline(data){
  const box = ensureRespInlineSlot();
  if (!box) return;

  const ui = data?.ui || {};
  const digest = data?.digest || {};
  const sf = digest?.shape_focus || {};
  const sr = digest?.sr_proxy || {};

  const conf = safe(ui.confidence_label || (sf.confidence_pct!=null ? `${sf.confidence_pct}%` : ""), "—");

  box.innerHTML = `
    <div style="font-weight:700; letter-spacing:.14em; font-size:10px; opacity:.85; margin-bottom:6px;">
      RESPONDER
    </div>
    <div style="font-size:12px; line-height:1.35;">
      <div><span style="opacity:.7;">Pattern:</span> ${escapeHtml(safe(ui.headline || sf.label))}</div>
      <div><span style="opacity:.7;">Bias:</span> ${escapeHtml(safe(sf.bias))} · <span style="opacity:.7;">Dir:</span> ${escapeHtml(mapDir(sf.direction))} · <span style="opacity:.7;">Conf:</span> ${escapeHtml(conf)}</div>
      <div><span style="opacity:.7;">Estrutura:</span> ${escapeHtml(safe(ui.market_structure_line))}</div>
      <div><span style="opacity:.7;">Pullback:</span> ${escapeHtml(safe(ui.pullback_line))}</div>
      <div><span style="opacity:.7;">SR:</span> H ${escapeHtml(safe(sr.recent_high))} · L ${escapeHtml(safe(sr.recent_low))} · <span style="opacity:.7;">Bars:</span> ${escapeHtml(safe(digest.intraday_bars || ""))}</div>
    </div>
  `;
}

let __AARON_MATCHER_REQ_ID = 0;

function applyResponderIntoTradeCard(data){
  data = Array.isArray(data) ? (data[0] ?? {}) : (data ?? {});
  const panel  = data?.panel  || {};
  const ui     = data?.ui     || {};
  const digest = data?.digest || {};
  const sf = digest?.shape_focus || {};
  const sr = digest?.sr_proxy || {};

  const set = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    const v = (val === null || val === undefined || val === "") ? "—" : String(val);
    el.textContent = v;
  };

  const fmt2 = (n) => (typeof n === "number" && isFinite(n)) ? n.toFixed(2) : (n ?? "—");

  // Estatística “na cara”
  const stats = ui.headline || ui.structure_line || sf.label || "—";
  set("trade-stats", stats);
  set("trade-stats-top", stats);

  // Direção (só pra exibir o output do responder)
  const dirRaw = String(sf.direction || "").toLowerCase();
  const dirPT  = (dirRaw === "up") ? "COMPRA" : (dirRaw === "down") ? "VENDA" : "NEUTRO";
  set("trade-direction", dirPT);

  // Modo / contexto (pra aparecer dentro do Trade Card)
  const mode = ui.pullback_line || ui.market_structure_line || ui.tactical_line || "—";
  set("trade-mode", mode);

  // Contra (resumo do digest)
  const against = [
    sf.family_en || sf.family || "",
    sf.bias ? `bias:${sf.bias}` : "",
    (Array.isArray(digest.features_true) && digest.features_true.length)
      ? `feat:${digest.features_true.join(", ")}`
      : ""
  ].filter(Boolean).join(" • ") || "—";
  set("trade-against", against);

  // Entrada: usa o range SR proxy (se existir)
  if (sr.recent_low != null || sr.recent_high != null) {
    set("trade-entry", `${fmt2(sr.recent_low)} – ${fmt2(sr.recent_high)}`);
  }

  // Comentário do AARON (mostra as linhas do ui)
  const comment = [
    ui.structure_line ? `Estrutura: ${ui.structure_line}` : "",
    ui.tactical_line ? `Tático: ${ui.tactical_line}` : "",
    ui.market_structure_line ? `MS: ${ui.market_structure_line}` : "",
    ui.pullback_line ? `Pullback: ${ui.pullback_line}` : "",
  ].filter(Boolean).join(" | ");

  if (comment) set("trade-comment", comment);
}

async function requestMatcher(symbol) {
  symbol = String(symbol || "").trim().toUpperCase();
  if (!symbol) return;

  const reqId = ++__AARON_MATCHER_REQ_ID;

  const ctxEl = document.getElementById("context-text");
  const exeEl = document.getElementById("execution-text");
  if (ctxEl) ctxEl.textContent = `Carregando matcher para ${symbol}...`;
  if (exeEl) exeEl.textContent = "—";
  if (typeof setRespSnapMessage === "function") setRespSnapMessage(`Carregando ${symbol}...`);

  async function fetchOne(baseUrl){
    const url = `${baseUrl}?symbol=${encodeURIComponent(symbol)}&_=${Date.now()}`;
    const res = await fetch(url, { method: "GET", cache: "no-store" }); // ✅ GET
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status}${t ? ` • ${t.slice(0,160)}` : ""}`);
    }
    return await res.json();
  }

  let raw;
  try {
    // 1) tenta PROD
    raw = await fetchOne(MATCHER_WEBHOOK_URL);
  } catch (errProd) {
    // 2) fallback TEST (quando workflow não está Active ou você está no editor)
    try {
      raw = await fetchOne(MATCHER_WEBHOOK_URL_TEST);
    } catch (errTest) {
      if (reqId !== __AARON_MATCHER_REQ_ID) return;
      const msg = `Matcher fetch falhou: ${errTest?.message || errTest || "Failed to fetch"}`;
      if (ctxEl) ctxEl.textContent = msg;
      if (exeEl) exeEl.textContent = "—";
      if (typeof setRespSnapMessage === "function") setRespSnapMessage(msg);
      return;
    }
  }

  if (reqId !== __AARON_MATCHER_REQ_ID) return;

  const data = Array.isArray(raw) ? (raw[0] ?? {}) : (raw ?? {});
  window.__AARON_MATCHER_LAST__ = data; // debug

  // ✅ preenche o bloco “RESPONDER OUTPUT” de baixo
  if (typeof renderTradeResponderOutput === "function") {
    renderTradeResponderOutput(data);
  }

  // ✅ e também injeta o output dentro do Trade Card (em cima)
  applyResponderIntoTradeCard(data);

  if (ctxEl) ctxEl.textContent = `Matcher OK: ${symbol}`;
  if (exeEl) exeEl.textContent = data?.panel?.updated_at || "—";
  if (typeof setRespSnapMessage === "function") setRespSnapMessage("");
}







// ✅ Isso aqui é a “conversa”: o seu dropdown já dispara esse evento.
window.addEventListener("aaron:symbolSelected", (ev) => {
  const symbol = String(ev?.detail?.symbol || '').toUpperCase().trim();
  if (!symbol) return;

  // garante timeframe default 1x
  if (!localStorage.getItem("aaron_selected_tf")) {
    localStorage.setItem("aaron_selected_tf", (typeof A10_DEFAULT_TF === "string" ? A10_DEFAULT_TF : "1m"));
  }

  // 0) AutoPilot amarrado ao símbolo atual
  if (typeof apOnSymbolChange === 'function') apOnSymbolChange(symbol);

  // 1) chama o matcher
  requestMatcher(symbol);

  // 2) atualiza o painel JSON imediatamente
  loadPanel(true);

  // 3) chart em tempo real (relay WS)
  if (typeof a10StartStream === "function") a10StartStream(true);
});

// ✅ Timeframe mudou
window.addEventListener("aaron:timeframeSelected", (ev) => {
  const tf = String(ev?.detail?.timeframe || '').trim();
  if (!tf) return;

  loadPanel(true);
  if (typeof a10StartStream === "function") a10StartStream(true);
});

// ✅ Ao abrir a página, dispara 1x com o último símbolo salvo
setTimeout(() => {
  const symbol =
    window.AARON_SELECTED_SYMBOL ||
    localStorage.getItem("aaron_selected_symbol") ||
    "NVDA";

  window.dispatchEvent(new CustomEvent("aaron:symbolSelected", { detail: { symbol } }));
}, 200);



// ======= LANG GLOBAL (precisa vir ANTES do AutoPilot / loadPanel) =======
var currentLang = (function(){
  try { return localStorage.getItem('AARON_LANG') || 'pt'; } catch(e) { return 'pt'; }
})();
window.currentLang = currentLang;


const els = {
  errorBanner: document.getElementById('error-banner'),
  btnRefresh: document.getElementById('btn-refresh'),
  state: document.getElementById('state-pill'),
  symbol: document.getElementById('symbol-label'),
  timeframe: document.getElementById('timeframe-label'),
  pulseLine: document.getElementById('pulseLine'),
    // AUTOPILOT
  apToggle: document.getElementById('ap-toggle'),
  apState: document.getElementById('ap-state'),
  apBuy: document.getElementById('ap-buy'),
  apSell: document.getElementById('ap-sell'),
  apClose: document.getElementById('ap-close'),
  apMeta: document.getElementById('ap-meta'),
    // AUTOPILOT 2.0 (sizing / quotes)
  apCapital: document.getElementById('ap-capital'),
  apUnits: document.getElementById('ap-units'),
  apPriceSell: document.getElementById('ap-price-sell'),
  apPriceMid: document.getElementById('ap-price-mid'),
  apPriceBuy: document.getElementById('ap-price-buy'),


  session: document.getElementById('session-label'),
  lastUpdate: document.getElementById('last-update-label'),
  flow: document.getElementById('flow-label'),
  trendDayPill: document.getElementById('trend-day-pill'),
  trendNowPill: document.getElementById('trend-now-pill'),
  dirDayArrow: document.getElementById('direction-day-arrow'),
  dirNowArrow: document.getElementById('direction-now-arrow'),
  patternDayLabel: document.getElementById('pattern-day-label'),
  patternDayDetail: document.getElementById('pattern-day-detail'),
  patternNowLabel: document.getElementById('pattern-now-label'),
  patternNowDetail: document.getElementById('pattern-now-detail'),
  summary: document.getElementById('summary-text'),
  riskPill: document.getElementById('risk-pill'),
  riskText: document.getElementById('risk-text'),
  contextText: document.getElementById('context-text'),
  executionText: document.getElementById('execution-text'),
  directionDayText: document.getElementById('direction-day-text'),
  directionNowText: document.getElementById('direction-now-text'),

    // Pattern Reference (ABA)
  refDetails: document.getElementById('refDetails'),
  refSummaryTitle: document.getElementById('refSummaryTitle'),
  refSummaryRight: document.getElementById('refSummaryRight'),
  refPatternMini: document.getElementById('refPatternMini'),
  refPatternImg: document.getElementById('refPatternImg'),
  refPatternLabel: document.getElementById('refPatternLabel'),
  refPatternSetup: document.getElementById('refPatternSetup'),
  refPatternNotes: document.getElementById('refPatternNotes'),
  refPatternLink: document.getElementById('refPatternLink'),


  // HERO / MODO CEGO
  heroBlock: document.getElementById('hero-block'),
  heroMain: document.getElementById('hero-main'),
  heroSub: document.getElementById('hero-sub'),
  heroBadge: document.getElementById('hero-badge'),
  heroModePill: document.getElementById('hero-mode-pill'),
  heroSideLabel: document.getElementById('hero-side-label'),
  heroSummary: document.getElementById('hero-summary-text'),
  heroFavorLabel: document.getElementById('hero-favor-label'),
  heroFavorBar: document.getElementById('hero-favor-bar'),
  heroFavorPhrase: document.getElementById('hero-favor-phrase'),

  heroContraLabel: document.getElementById('hero-contra-label'),
  heroContraBar: document.getElementById('hero-contra-bar'),
  heroContraPhrase: document.getElementById('hero-contra-phrase'),

  heroMiniRisk: document.getElementById('hero-mini-risk'),
  heroMiniContext: document.getElementById('hero-mini-context'),
  heroMiniExecution: document.getElementById('hero-mini-execution'),

    // RESUMO INSTITUCIONAL (barras)
  heroFavorLabel: document.getElementById('hero-favor-label'),
  heroFavorBar: document.getElementById('hero-favor-bar'),
  heroFavorPhrase: document.getElementById('hero-favor-phrase'),

  heroContraLabel: document.getElementById('hero-contra-label'),
  heroContraBar: document.getElementById('hero-contra-bar'),
  heroContraPhrase: document.getElementById('hero-contra-phrase'),

  heroMiniRisk: document.getElementById('hero-mini-risk'),
  heroMiniContext: document.getElementById('hero-mini-context'),
  heroMiniExecution: document.getElementById('hero-mini-execution'),


    // --- Cartão de Trade (Citadel) ---
  tradeCard: document.getElementById('trade-card'),
  tradeStatusText: document.getElementById('trade-status-text'),
  // NOVO (topo)
  tradeStatsTopLine: document.getElementById('trade-stats-top-line'),
  tradeStatsTop: document.getElementById('trade-stats-top'),
  tradeStatsTopLine: document.getElementById('trade-stats-top-line'),
  tradeStatsTop: document.getElementById('trade-stats-top'),
  tradeStats: document.getElementById('trade-stats'),
  tradeSymbol: document.getElementById('trade-symbol'),
  tradeTimeframe: document.getElementById('trade-timeframe'),
  tradeMode: document.getElementById('trade-mode'),
  tradeAgainst: document.getElementById('trade-against'),
  tradeDirection: document.getElementById('trade-direction'),
  tradeEntry: document.getElementById('trade-entry'),
  tradeStop: document.getElementById('trade-stop'),
  tradeTP1: document.getElementById('trade-tp1'),
  tradeTP2: document.getElementById('trade-tp2'),
  tradeSize: document.getElementById('trade-size'),
  tradeRisk: document.getElementById('trade-risk'),
  tradeThermo: document.getElementById('trade-thermo'),
  tradeComment: document.getElementById('trade-comment'),
  tradeBadge: document.getElementById('trade-badge'),


  // Estrutura recente (HH / HL / LH / LL)
  structureHHStatus: document.getElementById('structure-hh-status'),
  structureHLStatus: document.getElementById('structure-hl-status'),
  structureLHStatus: document.getElementById('structure-lh-status'),
  structureLLStatus: document.getElementById('structure-ll-status'),
  structureHHDot: document.getElementById('structure-hh-dot'),
  structureHLDot: document.getElementById('structure-hl-dot'),
  structureLHDot: document.getElementById('structure-lh-dot'),
  structureLLDot: document.getElementById('structure-ll-dot'),

  // Pullback Brain
  pullbackStatus: document.getElementById('pullback-status'),
  pullbackDepth: document.getElementById('pullback-depth'),
  pullbackQuality: document.getElementById('pullback-quality'),
  pullbackHeadline: document.getElementById('pullback-headline'),
  pullbackText: document.getElementById('pullback-text'),
  pullbackHighlightBox: document.getElementById('pullback-highlight-box'),
  pullbackSideTag: document.getElementById('pullback-side-tag'),
  pullbackStageTag: document.getElementById('pullback-stage-tag'),
  pullbackMeterFill: document.getElementById('pullback-meter-fill'),
  pullbackMeterLabel: document.getElementById('pullback-meter-label'),

       // Sizing Brain
  sizingTarget: document.getElementById('sizing-target'),
  sizingMaxDD: document.getElementById('sizing-max-dd'),
  sizingRiskTrade: document.getElementById('sizing-risk-trade'),
  sizingTradesCount: document.getElementById('sizing-trades-count'),
  sizingProfileTag: document.getElementById('sizing-profile-tag'),
  sizingStyleTag: document.getElementById('sizing-style-tag'),
  sizingMeterFill: document.getElementById('sizing-meter-fill'),
  sizingMeterLabel: document.getElementById('sizing-meter-label'),
  sizingComment: document.getElementById('sizing-comment'),

  // Sizing Brain – inputs e frases (lógica tipo Aaron Pine)
  sizingAccountRealInput: document.getElementById('sizing-account-real-input'),
  sizingUseInput: document.getElementById('sizing-use-input'),
  sizingLeverageInput: document.getElementById('sizing-leverage-input'),
  sizingRiskInput: document.getElementById('sizing-risk-input'),
  sizingStopInput: document.getElementById('sizing-stop-input'),
  sizingFixedQtyInput: document.getElementById('sizing-fixedqty-input'),
  sizingPhraseMain: document.getElementById('sizing-phrase-main'),
  sizingPhraseDetail: document.getElementById('sizing-phrase-detail'),

};

// ===============================
// AUTOPILOT v1 (simulação local)
// ===============================
const AP_KEY = 'AARON_AUTOPILOT_V1';
let lastTradeCard = null;

function apLoad() {
  try {
    const raw = localStorage.getItem(AP_KEY);
    const obj = raw ? JSON.parse(raw) : null;

    const capital =
      (typeof obj?.capital === 'number' && isFinite(obj.capital)) ? obj.capital : 25000;

    const base = {
      enabled: !!obj?.enabled,
      active:  !!obj?.active,
      side:    (obj?.side === 'buy' || obj?.side === 'sell') ? obj.side : null,
      entry:   (obj?.entry != null && isFinite(Number(obj.entry))) ? Number(obj.entry) : null,
      startedAt: (obj?.startedAt != null && isFinite(Number(obj.startedAt))) ? Number(obj.startedAt) : null,

      // 2.0
      capital,
      units: (obj?.units != null && isFinite(Number(obj.units))) ? Number(obj.units) : null,
      priceNow: (obj?.priceNow != null && isFinite(Number(obj.priceNow))) ? Number(obj.priceNow) : null,

      // ===== CONTRATO (state + snapshot + regra de conflito) =====
      state: (typeof obj?.state === 'string') ? obj.state : null, // FLAT | LONG_ACTIVE | SHORT_ACTIVE | EXIT_PENDING
      snapshot: (obj?.snapshot && typeof obj.snapshot === 'object') ? obj.snapshot : null,
      marketNow: (obj?.marketNow === 'buy' || obj?.marketNow === 'sell' || obj?.marketNow === 'wait')
        ? obj.marketNow
        : 'wait',
      exitPending: !!obj?.exitPending,
      current_price: (obj?.current_price != null && isFinite(Number(obj.current_price))) ? Number(obj.current_price) : null,
      pnl: (obj?.pnl != null && isFinite(Number(obj.pnl))) ? Number(obj.pnl) : null,
      rMultiple: (obj?.rMultiple != null && isFinite(Number(obj.rMultiple))) ? Number(obj.rMultiple) : null,
      lastUpdate: (obj?.lastUpdate != null && isFinite(Number(obj.lastUpdate))) ? Number(obj.lastUpdate) : null,
    };

    // Normaliza state legado
    const valid = ['FLAT', 'LONG_ACTIVE', 'SHORT_ACTIVE', 'EXIT_PENDING'];
    if (!valid.includes(base.state)) {
      if (base.active && base.side === 'buy') base.state = 'LONG_ACTIVE';
      else if (base.active && base.side === 'sell') base.state = 'SHORT_ACTIVE';
      else base.state = 'FLAT';
    }

    // Se state diz que tem posição, mas falta snapshot, cria snapshot mínimo
    if (base.state !== 'FLAT' && !base.snapshot) {
      const posSide = (base.state === 'SHORT_ACTIVE') ? 'short' : 'long';
      base.snapshot = {
        opened_at_timestamp: base.startedAt ?? null,
        side: posSide,
        entry_price: base.entry,
        stop: null,
        tp1: null,
        tp2: null,
        capital: base.capital,
        units: base.units,
      };
    }

    // Se FLAT, limpa
    if (base.state === 'FLAT') {
      base.active = false;
      base.side = null;
      base.entry = null;
      base.startedAt = null;
      base.snapshot = null;
      base.exitPending = false;
    } else {
      base.active = true;
      base.side = (base.snapshot?.side === 'short') ? 'sell' : 'buy';

      if (base.entry == null && base.snapshot?.entry_price != null) {
        const e = Number(base.snapshot.entry_price);
        if (isFinite(e)) base.entry = e;
      }
      if (base.units == null && base.snapshot?.units != null) {
        const u = Number(base.snapshot.units);
        if (isFinite(u)) base.units = u;
      }
    }

    return base;
  } catch (e) {
    return {
      enabled: false, active: false, side: null, entry: null, startedAt: null,
      capital: 25000, units: null, priceNow: null,
      state: 'FLAT', snapshot: null, marketNow: 'wait', exitPending: false,
      current_price: null, pnl: null, rMultiple: null, lastUpdate: null,
    };
  }
}



function apSave(state) {
  localStorage.setItem(AP_KEY, JSON.stringify(state));
}
let autopilot = apLoad();
let apMarketPrice = null;

function apExtractPriceFromPayload(payload){
  if (!payload) return null;

  const panel  = payload.panel  || payload || {};
  const ui     = payload.ui     || {};
  const digest = payload.digest || {};
  const raw    = payload.raw || payload.raw_eye || payload.data || {};

  const candidates = [
    // painel
    panel.price_now, panel.last_price, panel.price, panel.current_price,
    // ui
    ui.price, ui.last_price, ui.current_price,
    // raw/candle (quando existir)
    raw?.candle?.close, raw?.candle?.c, raw?.last?.close,
    // digest (se você decidir mandar preço pra cá no futuro)
    digest.price, digest.last_price
  ];

  for (const c of candidates){
    const n = apParseNumber(c);
    if (typeof n === "number") return n;
  }
  return null;
}

function apUpdateMarketPriceFromPayload(payload){
  const px = apExtractPriceFromPayload(payload);

  if (typeof px === "number") {
    apMarketPrice = px;
    autopilot.priceNow = px;
    autopilot.current_price = px;
  } else {
    apMarketPrice = null;
    autopilot.priceNow = null;
    autopilot.current_price = null;
  }

  apRenderSizing();
}


function apOnSymbolChange(symbol){
  try {
    symbol = String(symbol || '').toUpperCase().trim();
    if (!symbol) return;

    // corta “preço velho” do ativo anterior
    apMarketPrice = null;

    // remove panel antigo do contexto (pra UI não mostrar símbolo velho)
    if (window.apCtx) window.apCtx.panel = null;

    // carrega estado atual
    autopilot = apLoad();

    // ✅ fallback de símbolo (porque snapshot.symbol pode vir vazio)
    const prevSymRaw =
      (autopilot?.snapshot?.symbol) ??
      (autopilot?.lastSymbol) ??
      (localStorage.getItem("aaron_selected_symbol")) ??
      null;

    const prevSym = prevSymRaw ? String(prevSymRaw).toUpperCase().trim() : null;

    const inTrade = !!autopilot?.snapshot && autopilot?.state && autopilot.state !== 'FLAT';

    // ✅ se mudou símbolo, zera preço cacheado pra não “vazar”
    if (prevSym && prevSym !== symbol) {
      autopilot.priceNow = null;
      autopilot.current_price = null;
    }

    // ✅ se estiver em trade e mudar símbolo, reseta contrato
    if (inTrade && prevSym && prevSym !== symbol) {
      autopilot.enabled = false;
      autopilot.active = false;
      autopilot.side = null;
      autopilot.entry = null;
      autopilot.startedAt = null;

      autopilot.state = 'FLAT';
      autopilot.snapshot = null;
      autopilot.exitPending = false;

      autopilot.marketNow = 'wait';
      autopilot.priceNow = null;
      autopilot.current_price = null;
      autopilot.pnl = null;
      autopilot.rMultiple = null;
      autopilot.lastUpdate = null;

      apSave(autopilot);
      if (els?.apToggle) els.apToggle.checked = false;
    }

    // ✅ sempre salva qual é o símbolo “atual” pro próximo ciclo (fallback)
    autopilot.lastSymbol = symbol;
    apSave(autopilot);

    // atualiza UI imediatamente (mesmo antes do loadPanel terminar)
    if (typeof apSyncUI === 'function') apSyncUI();
  } catch (e) {
    console.error('[AARON][AP] apOnSymbolChange error', e);
  }
}


// ======================== AUTOPILOT CONTRACT ENGINE (state + snapshot + conflict) ========================
const AP_STATES = {
  FLAT: 'FLAT',
  LONG_ACTIVE: 'LONG_ACTIVE',
  SHORT_ACTIVE: 'SHORT_ACTIVE',
  EXIT_PENDING: 'EXIT_PENDING',
};

window.apCtx = window.apCtx || {
  panel: null,
  executionPlan: '',
  riskLevel: '',
  finalSummary: '',
  marketNow: 'wait',
};
const apCtx = window.apCtx;


function apToNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function apFmtPx(v){
  const n = apToNum(v);
  if(n == null) return '—';
  return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
}

function apFmtMoney(v){
  const n = apToNum(v);
  if(n == null) return '—';
  const sign = n >= 0 ? '+' : '-';
  const abs = Math.abs(n);
  return `${sign}$${abs.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
}

function apParseMarketNow(executionPlan){
  const s = String(executionPlan || '').toLowerCase();

  // WAIT primeiro (se aparecer explicitamente)
  if (/\bwait\b/.test(s) || /aguarde|espera|no trade|stand by/.test(s)) return 'wait';

  // GO FULL BUY / GO FULL SELL
  if (/go\s*full.*buy|full.*buy/.test(s)) return 'buy';
  if (/go\s*full.*sell|full.*sell/.test(s)) return 'sell';

  // BUY / SELL
  const hasBuy  = /\bbuy\b|compra|\blong\b/.test(s);
  const hasSell = /\bsell\b|venda|\bshort\b/.test(s);

  if (hasBuy && !hasSell) return 'buy';
  if (hasSell && !hasBuy) return 'sell';

  // ambíguo => WAIT (mais seguro)
  return 'wait';
}

function apConsensusScores(panel){
  const c = panel?.ai_consensus || panel?.consensus || panel?.consenso || {};
  const buy  = apToNum(c.buy ?? c.buy_pct ?? c.long ?? c.up ?? c.bull) ?? 0;
  const sell = apToNum(c.sell ?? c.sell_pct ?? c.short ?? c.down ?? c.bear) ?? 0;
  return { buy, sell };
}

function apConsensusDominant(scores, side){
  const buy = scores.buy ?? 0;
  const sell = scores.sell ?? 0;

  // “dominante” = diferença clara OU >60/40
  if(side === 'sell'){
    return (sell - buy) >= 15 || (sell >= 60 && buy <= 40) || (buy > 0 && (sell / buy) >= 1.25);
  }
  if(side === 'buy'){
    return (buy - sell) >= 15 || (buy >= 60 && sell <= 40) || (sell > 0 && (buy / sell) >= 1.25);
  }
  return false;
}

function apStructureConfirm(panel){
  return !!(
    panel?.estrutura_mercado?.confirma ??
    panel?.market_structure?.confirma ??
    panel?.structure_confirm ??
    false
  );
}

function apDidHitStop(px, snap){
  const p = apToNum(px);
  const stop = apToNum(snap?.stop);
  if(p == null || stop == null) return false;

  if(snap?.side === 'long') return p <= stop;
  if(snap?.side === 'short') return p >= stop;
  return false;
}

function apIsStrongContra(panel, marketNow, snap, px){
  if(!snap) return false;

  // “contra” só importa quando MarketNow aponta pro lado oposto do trade
  if(snap.side === 'long' && marketNow !== 'sell') return false;
  if(snap.side === 'short' && marketNow !== 'buy') return false;

  const hitStop = apDidHitStop(px, snap);
  const structure = apStructureConfirm(panel);
  const scores = apConsensusScores(panel);
  const dom = (snap.side === 'long')
    ? apConsensusDominant(scores, 'sell')
    : apConsensusDominant(scores, 'buy');

  return !!(hitStop || structure || dom);
}

function apBuildSnapshot(side){
  const panel = apCtx.panel;

  // tenta pegar stop/tps do último tradeCard (se existir)
  const tc = (typeof lastTradeCard !== 'undefined') ? lastTradeCard : null;

  const entry = apPickEntryFromUI() ?? apGetMarketPrice();

  return {
    opened_at_timestamp: Date.now(),
    side: (side === 'buy') ? 'long' : 'short',
    entry_price: apToNum(entry),

    stop: apToNum(tc?.stop),
    tp1: apToNum(tc?.tp1),
    tp2: apToNum(tc?.tp2),

    // extras (se tiver)
    symbol: panel?.symbol ?? panel?.ticker ?? null,
    timeframe: panel?.timeframe ?? null,
    pattern_id: panel?.pattern_id ?? panel?.pattern ?? null,
    setup_id: panel?.setup_id ?? panel?.setup ?? null,
  };
}

function apUpdatePnLAndR(autopilotObj, px){
  const snap = autopilotObj.snapshot;
  if(!snap) return;

  const entry = apToNum(snap.entry_price);
  const p = apToNum(px);
  if(entry == null || p == null) return;

  autopilotObj.current_price = p;

  // PnL (simples): usa units se existir; se não, PnL em “por unidade”
  const units = apToNum(autopilotObj.units) ?? apToNum(snap.size);
  const delta = (snap.side === 'long') ? (p - entry) : (entry - p);
  autopilotObj.pnl = (units != null && units > 0) ? (delta * units) : delta;

  // R multiple: precisa de stop
  const stop = apToNum(snap.stop);
  if(stop == null) { autopilotObj.rMultiple = null; return; }

  const risk = (snap.side === 'long') ? (entry - stop) : (stop - entry);
  if(!Number.isFinite(risk) || risk <= 0) { autopilotObj.rMultiple = null; return; }

  autopilotObj.rMultiple = delta / risk;
}

function apOnPanelUpdate(panel, meta){
  autopilot = apLoad();

  apCtx.panel = panel ?? null;
  apCtx.executionPlan = meta?.executionPlan ?? '';
  apCtx.riskLevel = meta?.riskLevel ?? '';
  apCtx.finalSummary = meta?.finalSummary ?? '';

  const marketNow = apParseMarketNow(apCtx.executionPlan);
  apCtx.marketNow = marketNow;

  autopilot.marketNow = marketNow;

  const px = apGetMarketPrice();
  if(px != null) apUpdatePnLAndR(autopilot, px);

  // regra de conflito → EXIT_PENDING (e relaxa se parar de ser forte)
  if(autopilot.state !== AP_STATES.FLAT && autopilot.snapshot){
    const strongContra = apIsStrongContra(panel, marketNow, autopilot.snapshot, autopilot.current_price ?? px);

    if(strongContra){
      autopilot.state = AP_STATES.EXIT_PENDING;
      autopilot.exitPending = true;
    }else{
      autopilot.state = (autopilot.snapshot.side === 'short') ? AP_STATES.SHORT_ACTIVE : AP_STATES.LONG_ACTIVE;
      autopilot.exitPending = false;
    }
  }

  autopilot.lastUpdate = Date.now();
  apSave(autopilot);

  if(typeof apSyncUI === 'function') apSyncUI();
}


function apMoneyEN(n){
  return (typeof n === 'number' && isFinite(n))
    ? '$' + n.toLocaleString('en-US', { maximumFractionDigits: 0 })
    : '—';
}
function apMoneyPT(n){
  return (typeof n === 'number' && isFinite(n))
    ? 'US$ ' + n.toLocaleString('pt-BR', { maximumFractionDigits: 0 })
    : '—';
}

function apGetMarketPrice(){
  if (typeof apMarketPrice === 'number' && isFinite(apMarketPrice) && apMarketPrice > 0) return apMarketPrice;
  if (typeof autopilot.priceNow === 'number' && isFinite(autopilot.priceNow) && autopilot.priceNow > 0) return autopilot.priceNow;

  const entry = apPickEntryFromUI();
  if (typeof entry === 'number' && isFinite(entry) && entry > 0) return entry;

  return null;
}

function apComputeUnits(capital, price){
  const cap = Number(capital);
  const p = Number(price);
  if (!isFinite(cap) || cap <= 0 || !isFinite(p) || p <= 0) return null;
  return Math.floor(cap / p);
}

function apRenderSizing(){
  // mantém state sempre “2.0-ready”
  // NÃO re-hidratar aqui (apLoad), senão apActivate() perde enabled/active/side recém-setados
  if (!autopilot) autopilot = apLoad();

  // capital vem do input (se existir)
  if (els.apCapital) {
    const cap = Number(String(els.apCapital.value || '').replace(',', '.'));
    if (isFinite(cap) && cap > 0) autopilot.capital = cap;
  }

  const price = apGetMarketPrice();
  autopilot.priceNow = (price != null) ? Number(price) : autopilot.priceNow;

  const inPos = (autopilot.state && autopilot.state !== AP_STATES.FLAT && autopilot.snapshot);
const frozenUnits = inPos ? (apToNum(autopilot.snapshot?.units ?? autopilot.snapshot?.size)) : null;

const units = (frozenUnits != null)
  ? frozenUnits
  : apComputeUnits(autopilot.capital, price);

autopilot.units = units;


  if (els.apUnits) {
    els.apUnits.value = (units != null) ? units.toLocaleString('en-US') : '—';
  }

  const px = (price != null) ? Number(price) : null;
  if (els.apPriceSell) els.apPriceSell.textContent = (px != null) ? px.toFixed(2) : '—';
  if (els.apPriceBuy)  els.apPriceBuy.textContent  = (px != null) ? px.toFixed(2) : '—';
  if (els.apPriceMid)  els.apPriceMid.textContent  = (px != null) ? px.toFixed(2) : '—';

  apSave(autopilot);
}



function apSideLabel(side, lang) {
  if (lang === 'en') return side === 'buy' ? 'BUY' : 'SELL';
  return side === 'buy' ? 'COMPRA' : 'VENDA';
}
function apPickEntryFromUI() {
  const txt = (els.tradeEntry?.textContent || '').replace(',', '.');
  const m = txt.match(/(\d+(\.\d+)?)/);
  return m ? Number(m[1]) : null;
}
function apSyncUI() {
  if (!els.apToggle || !els.apState || !els.apMeta) return;

  autopilot = apLoad();

  const selSym = (localStorage.getItem('aaron_selected_symbol') || '').trim().toUpperCase() || '—';
  const panelSym = apCtx?.panel?.symbol || apCtx?.panel?.ticker;
  const sym = String(autopilot?.snapshot?.symbol || panelSym || selSym || '—').toUpperCase();
  const tf = String(autopilot?.snapshot?.timeframe || apCtx?.panel?.timeframe || '—');
  const symTf = `${sym} | ${tf}`;


  els.apToggle.checked = !!autopilot.enabled;

  // garante que o 2.0 (capital/units) está sempre renderizado
  if (els.apCapital) els.apCapital.value = String(autopilot.capital ?? 25000);
  apRenderSizing();

  // contrato (state/marketNow) com fallback seguro
  const st = (typeof autopilot.state === 'string')
    ? autopilot.state
    : (autopilot.active ? (autopilot.side === 'sell' ? 'SHORT_ACTIVE' : 'LONG_ACTIVE') : 'FLAT');

  const mn = (autopilot.marketNow === 'buy' || autopilot.marketNow === 'sell' || autopilot.marketNow === 'wait')
    ? autopilot.marketNow
    : 'wait';

  const mnTxt = String(mn).toUpperCase();

  els.apState.classList.remove('ap-on', 'ap-off', 'ap-buy', 'ap-sell');

  if (!autopilot.enabled) {
    els.apState.classList.add('ap-off');
    els.apState.textContent = 'OFF';
    els.apMeta.textContent = `${symTf} • ${st} • MN ${mnTxt}`;
    return;
  }

  els.apState.classList.add('ap-on');

  // Se está em posição
  if (autopilot.active && (autopilot.side === 'buy' || autopilot.side === 'sell')) {
    els.apState.classList.add(autopilot.side === 'buy' ? 'ap-buy' : 'ap-sell');

    // Se contrato mandou EXIT_PENDING, mostra EXIT no label
    const isExit = (st === 'EXIT_PENDING') || !!autopilot.exitPending;
    els.apState.textContent = isExit ? 'EXIT' : (autopilot.side === 'buy' ? 'BUY' : 'SELL');

    const entry = (autopilot.entry != null && isFinite(autopilot.entry)) ? Number(autopilot.entry).toFixed(2) : '—';
    const started = autopilot.startedAt
      ? new Date(autopilot.startedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : '—';

    const capTxt = (currentLang === 'en') ? apMoneyEN(autopilot.capital) : apMoneyPT(autopilot.capital);
    const unitsTxt = (autopilot.units != null) ? `${autopilot.units.toLocaleString('en-US')} sh` : '—';

    // P/L e R (se existirem)
    const pnl = (autopilot.pnl != null && isFinite(autopilot.pnl)) ? Number(autopilot.pnl) : null;
    const r = (autopilot.rMultiple != null && isFinite(autopilot.rMultiple)) ? Number(autopilot.rMultiple) : null;

    const pnlTxt = (pnl == null) ? '' : ` • P/L ${(pnl >= 0 ? '+' : '')}${pnl.toFixed(2)}`;
    const rTxt = (r == null) ? '' : ` • R ${r.toFixed(2)}`;

    els.apMeta.textContent =
      `${symTf} • @ ${entry} • ${started} • ${capTxt} • ${unitsTxt} • ${st} • MN ${mnTxt}${pnlTxt}${rTxt}`;
    return;
  }

  // ON mas sem posição
  els.apState.textContent = 'ON';
  els.apMeta.textContent = `${symTf} • armado (sem posição) • ${st} • MN ${mnTxt}`;
}


function apActivate(side) {
  autopilot = apLoad(); // re-hidrata

  autopilot.enabled = true;
  autopilot.active = true;
  autopilot.side = side;

  const entry = apPickEntryFromUI() ?? apGetMarketPrice();
  autopilot.entry = (entry != null && isFinite(entry)) ? Number(entry) : autopilot.entry;

  // atualiza sizing 2.0 quando entra em posição
  apRenderSizing();
  autopilot.startedAt = Date.now();

  // ===== CONTRATO (Snapshot congelado) =====
  const panel = (typeof apCtx !== 'undefined' && apCtx && apCtx.panel) ? apCtx.panel : null;

  // 1) Base snapshot (já traz symbol/timeframe/pattern_id/setup_id)
  const snap = apBuildSnapshot(side);

  // 2) Congelar size/units no momento da entrada
  const unitsAtEntry = apComputeUnits(autopilot.capital, snap.entry_price);
  autopilot.units = unitsAtEntry;

  snap.size = unitsAtEntry;
  snap.size_text = (unitsAtEntry != null) ? unitsAtEntry.toLocaleString('en-US') : null;

  // 3) Congelar capital/units também (ajuda em reload e PnL)
  snap.capital = autopilot.capital;
  snap.units = unitsAtEntry;

  // 4) Contexto congelado (safe)
  const scores = apConsensusScores(panel);
  snap.contexto = {
    tendencia: panel?.status_geral?.tendencia ?? null,
    estrutura_confirma: panel?.estrutura_mercado?.confirma ?? null,
    ai_consensus: (scores.sell > scores.buy) ? 'sell' : (scores.buy > scores.sell) ? 'buy' : 'neutral',
    pullback_ativo: panel?.pullback_brain?.pullback_ativo ?? null,
    regime: panel?.regime ?? panel?.tags ?? null,
  };

  autopilot.snapshot = snap;

  // estado
  autopilot.state = (side === 'sell') ? AP_STATES.SHORT_ACTIVE : AP_STATES.LONG_ACTIVE;
  autopilot.exitPending = false;

  apSave(autopilot);
  apSyncUI();

  // força re-render do painel no estado "travado"
  if (typeof loadPanel === 'function') loadPanel(false);
}

function apClose() {
  autopilot = apLoad();

  // ✅ contrato: Close = apaga snapshot + OFF + FLAT (reset total)
  autopilot.enabled = false;
  autopilot.active = false;
  autopilot.side = null;
  autopilot.entry = null;
  autopilot.startedAt = null;

  autopilot.state = AP_STATES.FLAT;
  autopilot.snapshot = null;
  autopilot.exitPending = false;

  autopilot.marketNow = 'wait';
  autopilot.current_price = null;
  autopilot.pnl = null;
  autopilot.rMultiple = null;
  autopilot.lastUpdate = null;

  apSave(autopilot);

  if (els?.apToggle) els.apToggle.checked = false;
  if (typeof apSyncUI === 'function') apSyncUI();
  if (typeof loadPanel === 'function') loadPanel(false);
}




   // ====== SIZING BRAIN – CAMPOS DO CARD COMPLETO ======
const sbEls = {
  card: document.getElementById('sizing-brain-card'),
  accountBalance: document.getElementById('sb-account-balance'),
  leverage: document.getElementById('sb-leverage'),
  tradeCapital: document.getElementById('sb-trade-capital'),
  riskPercentInput: document.querySelector('input#sb-risk-percent'),
  entryPrice: document.getElementById('sb-entry-price'),
  atrValue: document.getElementById('sb-atr-value'),
  atrMultStop: document.getElementById('sb-atr-mult-stop'),
  atrMultTake: document.getElementById('sb-atr-mult-take'),
  sideRadios: document.querySelectorAll('input[name="sb-side"]'),

  outStopDistance: document.getElementById('sb-stop-distance'),
  outStopPrice: document.getElementById('sb-stop-price'),
  outTakePrice: document.getElementById('sb-take-price'),
  outPositionSize: document.getElementById('sb-position-size'),
  outRiskDollar: document.getElementById('sb-risk-dollar'),
  outRiskPercent: document.querySelector('p#sb-risk-percent'),

  calcBtn: document.getElementById('sb-calcular'),
  status: document.getElementById('sb-status'),
};

    // ====== SIZING BRAIN OFFLINE – CÁLCULO COMPLETO ======
function sbNum(el) {
  if (!el) return 0;
  const raw = (el.value || '').toString().replace(',', '.');
  const n = Number(raw);
  return Number.isFinite(n) ? n : 0;
}

function recalcSizingBrainOffline() {
  if (!sbEls.accountBalance) return;

  const account    = sbNum(sbEls.accountBalance);   // capital real da conta
  const leverage   = sbNum(sbEls.leverage);         // alavancagem (x)
  const tradeInput = sbNum(sbEls.tradeCapital);     // capital em uso neste trade
  const riskPct    = sbNum(sbEls.riskPercentInput); // risco % por trade (da conta)
  const entry      = sbNum(sbEls.entryPrice);       // preço de entrada
  const atr        = sbNum(sbEls.atrValue);         // ATR $
  const multStop   = sbNum(sbEls.atrMultStop);      // mult stop
  const multTake   = sbNum(sbEls.atrMultTake);      // mult take

  const sideRadio  = Array.from(sbEls.sideRadios || []).find(r => r.checked);
  const side       = sideRadio ? sideRadio.value : 'long';

  const statusEl   = sbEls.status;

  // validações básicas
  if (!account || !entry || !atr || !multStop || !riskPct) {
    if (statusEl) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en')
          ? 'Fill account, risk %, entry price and ATR to calculate.'
          : 'Preencha conta, risco %, preço de entrada e ATR para calcular.';
    }
    return;
  }

  // buying power = conta * alavancagem
  const lev = leverage > 0 ? leverage : 1;
  const buyingPower = account * lev;

  // capital em uso: se não preencher, usamos o buying power
  let tradeCapital = tradeInput > 0 ? tradeInput : buyingPower;
  if (tradeCapital > buyingPower) tradeCapital = buyingPower;

  const stopDist = atr * multStop; // distância do stop em dólar
  if (!stopDist) {
    if (statusEl) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en')
          ? 'Stop distance (ATR × mult) is zero. Check ATR and multiplier.'
          : 'Distância do stop (ATR × mult) está zero. Confira ATR e multiplicador.';
    }
    return;
  }

  // risco máximo permitido pela regra (risco % da conta)
  const riskAllowedDollar = account * (riskPct / 100);

  // limite por capital e por risco
  const maxSharesByCapital = tradeCapital / entry;
  const maxSharesByRisk    = riskAllowedDollar / stopDist;
  let shares               = Math.floor(Math.max(0, Math.min(maxSharesByCapital, maxSharesByRisk)));

  if (!Number.isFinite(shares) || shares <= 0) {
    shares = 0;
  }

  const riskUsedDollar       = shares * stopDist;
  const riskUsedPctAccount   = account > 0 ? (riskUsedDollar / account) * 100 : 0;

  // preços de stop e alvo
  let stopPrice, takePrice;
  if (side === 'short') {
    stopPrice = entry + stopDist;
    takePrice = entry - (atr * multTake);
  } else {
    stopPrice = entry - stopDist;
    takePrice = entry + (atr * multTake);
  }

  // ====== escreve nos campos ======
  if (sbEls.outStopDistance) {
    sbEls.outStopDistance.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Stop distance: '
        : 'Distância do STOP: ') +
      stopDist.toFixed(2) +
      ' USD';
  }

  if (sbEls.outStopPrice) {
    sbEls.outStopPrice.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Suggested Stop Loss: '
        : 'Stop Loss sugerido: ') +
      '$ ' +
      stopPrice.toFixed(2);
  }

  if (sbEls.outTakePrice) {
    sbEls.outTakePrice.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Suggested Take Profit: '
        : 'Take Profit sugerido: ') +
      '$ ' +
      takePrice.toFixed(2);
  }

  if (sbEls.outPositionSize) {
    sbEls.outPositionSize.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Suggested size: '
        : 'Qtd sugerida: ') +
      (shares > 0 ? shares + ' shares' : '—');
  }

  if (sbEls.outRiskDollar) {
    sbEls.outRiskDollar.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Approx. risk: '
        : 'Risco aprox.: ') +
      '$ ' +
      riskUsedDollar.toFixed(2);
  }

  if (sbEls.outRiskPercent) {
    sbEls.outRiskPercent.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Risk % trade / account: '
        : 'Risco % trade / conta: ') +
      riskUsedPctAccount.toFixed(2) +
      '%';
  }

  // ====== termômetro do Sizing Brain offline ======
  const meterFill  = document.getElementById('sb-meter-fill');
  const meterLabel = document.getElementById('sb-meter-label');

  if (meterFill && meterLabel) {
    // uso de risco = quanto do risco permitido (riskAllowedDollar) você está usando
    let usage = riskAllowedDollar > 0
      ? (riskUsedDollar / riskAllowedDollar) * 100
      : 0;

    // clamp
    usage = Math.max(0, Math.min(usage, 150));
    const width = Math.max(0, Math.min(usage, 100));

    meterFill.style.width = width.toFixed(0) + '%';
    meterFill.classList.remove('safe', 'warn', 'danger');

    let modeClass = 'safe';
    if (usage <= 60) {
      modeClass = 'safe';
    } else if (usage <= 100) {
      modeClass = 'warn';
    } else {
      modeClass = 'danger';
    }
    meterFill.classList.add(modeClass);

    meterLabel.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Risk usage '
        : 'Uso de risco ') +
      usage.toFixed(0) +
      '%';
  }

  // ====== status em texto ======
  if (statusEl) {
    if (!shares) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en'
          ? 'Position too small or zero. Check risk %, ATR and stop distance.'
          : 'Posição muito pequena ou zero. Confira risco %, ATR e distância do stop.');
    } else if (usage > 100) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en'
          ? 'You are using more than 100% of the risk you defined. Consider reducing size or widening the base capital.'
          : 'Você está usando mais de 100% do risco que definiu. Considere reduzir o tamanho ou ajustar o capital base.');
    } else {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en'
          ? 'Sizing calculated. Size stays within your defined risk. Execute only if setup is A+.'
          : 'Sizing calculado. Tamanho dentro do risco que você definiu. Execute apenas se o setup for A+.');
    }
  }
}

// liga o botão "Recalcular Sizing"
if (sbEls.calcBtn) {
  sbEls.calcBtn.addEventListener('click', function (e) {
    e.preventDefault();
    recalcSizingBrainOffline();
  });
}


// dados atuais do "cérebro de pullback" para re-renderizar quando trocar PT/EN
let lastPullbackBrain = null;
let lastSizingBrain = null;


// ====== GERENCIADOR DE RISCO · ATR (FRONTEND) ======
const atrEls = {
  panel: document.getElementById('atr-risk-panel'),
  toggleBtn: document.getElementById('atr-risk-toggle'),
  body: document.getElementById('atr-risk-body'),
  length: document.getElementById('atr-length-input'),
  smoothing: document.getElementById('atr-smoothing-input'),
  mult: document.getElementById('atr-multiplier-input'),
  atrValue: document.getElementById('atr-value-input'),
  capital: document.getElementById('atr-capital-input'),
  entry: document.getElementById('atr-entry-input'),
  riskPercent: document.getElementById('atr-riskpct-input'),
  side: document.getElementById('atr-side-input'),
  outDistance: document.getElementById('atr-stop-distance'),
  outShares: document.getElementById('atr-shares'),
  outRisk: document.getElementById('atr-risk-money'),
  outReward2R: document.getElementById('atr-reward-2r'),
  outReward3R: document.getElementById('atr-reward-3r'),
  calcBtn: document.getElementById('atr-calc-btn'),
};

// abre / fecha o card
if (atrEls.toggleBtn && atrEls.body) {
  atrEls.toggleBtn.addEventListener('click', () => {
    const hidden =
      atrEls.body.style.display === 'none' || atrEls.body.style.display === '';
    atrEls.body.style.display = hidden ? 'grid' : 'none';
    atrEls.toggleBtn.textContent = hidden ? 'Fechar' : 'Abrir';
  });
}

// cálculo do risco baseado no ATR digitado
function updateAtrRisk() {
  if (!atrEls.atrValue || !atrEls.capital || !atrEls.entry) return;

  const atr = parseFloat(atrEls.atrValue.value || '0');
  const mult = parseFloat(atrEls.mult.value || '1');
  const capital = parseFloat(atrEls.capital.value || '0');
  const entry = parseFloat(atrEls.entry.value || '0');
  const riskPct = parseFloat(atrEls.riskPercent.value || '1');

  if (!atr || !capital || !entry) return;

  const stopDist = atr * mult;
  const riskPerShare = stopDist;

  const sharesByCapital = capital / entry;
  const sharesByRisk = (capital * (riskPct / 100)) / riskPerShare;
  const shares = Math.min(sharesByCapital, sharesByRisk);

  const riskMoney = shares * riskPerShare;
  const reward2R = riskMoney * 2;
  const reward3R = riskMoney * 3;

  if (atrEls.outDistance) atrEls.outDistance.textContent = stopDist.toFixed(2);
  if (atrEls.outShares) atrEls.outShares.textContent = shares.toFixed(0);
  if (atrEls.outRisk) atrEls.outRisk.textContent = '$ ' + riskMoney.toFixed(2);
  if (atrEls.outReward2R)
    atrEls.outReward2R.textContent = '$ ' + reward2R.toFixed(2);
  if (atrEls.outReward3R)
    atrEls.outReward3R.textContent = '$ ' + reward3R.toFixed(2);
}

if (atrEls.calcBtn) {
  atrEls.calcBtn.addEventListener('click', (e) => {
    e.preventDefault();
    updateAtrRisk();
  });
}

// Preenche ATR + preço de entrada a partir do JSON (panel + raw)
function prefillAtrFromPanel(panel, raw) {
  if (!panel || !atrEls) return;

  const atrBlock = panel.atr || panel.atr_info;
  const indicators = raw && raw.indicators ? raw.indicators : {};

  // ATR
  if (atrBlock && atrBlock.value != null && atrEls.atrValue) {
    atrEls.atrValue.value = Number(atrBlock.value).toFixed(2);
  } else if (typeof indicators.atr === 'number' && atrEls.atrValue) {
    atrEls.atrValue.value = indicators.atr.toFixed(2);
  }

  if (atrBlock && atrBlock.length != null && atrEls.length) {
    atrEls.length.value = atrBlock.length;
  }
  if (atrBlock && atrBlock.smoothing && atrEls.smoothing) {
    atrEls.smoothing.value = atrBlock.smoothing;
  }
  if (atrBlock && atrBlock.multiplier != null && atrEls.mult) {
    atrEls.mult.value = atrBlock.multiplier;
  }

  // PREÇO DE ENTRADA
  let entry =
    panel.entry_price ||
    panel.reference_price ||
    panel.price_now ||
    panel.last_price ||
    (raw && raw.candle && raw.candle.close);

  if (entry != null && atrEls.entry) {
    atrEls.entry.value = Number(entry).toFixed(2);
  }
}

function safeText(el, value, fallback = '—') {
  if (!el) return;
  el.textContent =
    value === undefined || value === null || value === ''
      ? fallback
      : String(value);
}

function escapeHTML(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

// Puxa "Estatística: ...." de dentro do comentário (PT/EN) e remove do comentário
function splitStatsFromComment(raw) {
  const out = { stats: '', comment: '' };
  if (raw === undefined || raw === null) return out;

  let s = String(raw);

  // remove aspas bonitas do começo/fim se vierem
  s = s.replace(/^[“"]+/, '').replace(/[”"]+$/, '');

  // pega a LINHA INTEIRA: "📊 Estatística (7y): ...." (PT/EN) sem remover do comentário
  const rx =
    /(?:^|\n)\s*(?:📊\s*)?(?:estat[ií]stica(?:\s*\([^)]*\))?|statistics(?:\s*\([^)]*\))?|stats(?:\s*\([^)]*\))?)\s*:\s*.+?(?=\n|$)/i;

  const m = s.match(rx);
  if (m) out.stats = m[0].trim();

  out.comment = s.trim(); // mantém intacto
  return out;
}


function formatCommentToHTML(raw) {
  if (raw === undefined || raw === null) return '<div class="comment-lines"><div class="comment-line">—</div></div>';

  let s = String(raw).trim();
  s = s.replace(/^[“"]+/, '').replace(/[”"]+$/, '');

  // quebra por linhas / bullets
  let lines = s
    .split(/\r?\n|•|\u2022/g)
    .map(x => x.trim())
    .filter(Boolean);

  // se veio tudo numa frase gigante, quebra por sentenças
  if (lines.length <= 1 && s.length > 90) {
    lines = s
      .split(/(?<=[.!?])\s+/g)
      .map(x => x.trim())
      .filter(Boolean);
  }

  const html = lines.map(line => {
    const idx = line.indexOf(':');
    // Se parecer "Título: texto", deixa o título em bold
    if (idx > 0 && idx <= 28) {
      const key = line.slice(0, idx + 1);
      const val = line.slice(idx + 1).trim();
      return `<div class="comment-line"><strong>${escapeHTML(key)}</strong> ${escapeHTML(val)}</div>`;
    }
    return `<div class="comment-line">${escapeHTML(line)}</div>`;
  }).join('');

  return `<div class="comment-lines">${html || '<div class="comment-line">—</div>'}</div>`;
}

function setFormattedComment(el, raw) {
  if (!el) return;
  el.innerHTML = formatCommentToHTML(raw);
}


function setArrow(el, dir) {
  if (!el) return;
  el.classList.remove('arrow-up', 'arrow-down');
  let symbol = '↕';
  if (dir === 'up' || dir === 'UP' || dir === 'alta' || dir === 'ALTA') {
    el.classList.add('arrow-up');
    symbol = '↑';
  } else if (dir === 'down' || dir === 'DOWN' || dir === 'baixa' || dir === 'BAIXA') {
    el.classList.add('arrow-down');
    symbol = '↓';
  }
  el.textContent = symbol;
}

function setPillTrend(el, dir, label) {
  if (!el) return;
  el.classList.remove('pill-green', 'pill-red');
  let txt = label || 'Neutro';

  if (!dir) {
    el.textContent = txt;
    return;
  }

  const d = String(dir).toLowerCase();

  if (d.includes('alta') || d === 'up') {
    el.classList.add('pill-green');
    if (!label) txt = 'Fluxo de alta';
  } else if (d.includes('baixa') || d === 'down') {
    el.classList.add('pill-red');
    if (!label) txt = 'Fluxo de baixa';
  }

  el.textContent = txt;
}

function setRiskPill(level) {
  if (!els.riskPill) return;
  const el = els.riskPill;
  el.classList.remove('pill-green', 'pill-red');
  let txt = 'Neutro';

  if (!level) {
    el.textContent = txt;
    return;
  }

  const l = String(level).toLowerCase();

  if (l.includes('alto') || l.includes('high')) {
    el.classList.add('pill-red');
    txt = 'Risco Alto';
  } else if (l.includes('baixo') || l.includes('low')) {
    el.classList.add('pill-green');
    txt = 'Risco Baixo';
  } else {
    txt = level;
  }

  el.textContent = txt;
}

// === ATUALIZAR CARTÃO DE TRADE (CITADEL) ===
function updateTradeCard(trade) {
  // se o HTML ainda não carregou, sai
  if (!els.tradeStatusText) return;

  const t = trade || {};
    lastTradeCard = t;

  const lang = currentLang === 'en' ? 'en' : 'pt';

  // helpers para pegar PT/EN
  const pick = (obj, baseKey) => {
    if (!obj) return null;
    if (lang === 'en') return obj[baseKey + '_en'] || obj[baseKey];
    return obj[baseKey + '_pt'] || obj[baseKey];
  };

  // ===== texto de status (linha de cima) =====
  const statusText =
    pick(t, 'status_text') ||
    pick(t, 'status') ||
    (lang === 'en'
      ? '✅ Valid setup | ❌ No trade'
      : '✅ Setup válido | ❌ Sem trade');

  els.tradeStatusText.textContent = statusText;

  // ===== campos “neutros” (sem idioma) =====
  safeText(els.tradeSymbol,    t.symbol   || t.ticker || '—');
  safeText(els.tradeTimeframe, t.timeframe || t.tf    || '—');
  safeText(els.tradeEntry,     t.entry_text || t.entry_range || t.entry || '—');
  safeText(els.tradeStop,      t.stop      != null ? t.stop      : '—');
  safeText(els.tradeTP1,       t.tp1       != null ? t.tp1       : '—');
  safeText(els.tradeTP2,       t.tp2       != null ? t.tp2       : '—');
  safeText(els.tradeSize,      t.size_text || t.size || '—');
  safeText(els.tradeRisk,      t.risk_text || t.risk || '—');
  safeText(els.pulseLine, pick(t, 'pulse_line') || '—');


  // ===== textos com PT/EN =====
  const modeText =
    pick(t, 'mode') ||
    (lang === 'en' ? 'Reversal at resistance' : 'Reversão em Resistência');

  const againstText =
    pick(t, 'against') ||
    (t.against_text || t.against_pct) ||
    (lang === 'en' ? '—' : '—');

  const directionText =
    pick(t, 'direction') ||
    (lang === 'en' ? 'SELL' : 'VENDA');

  const thermoText =
    pick(t, 'thermo') ||
    pick(t, 'thermometer') ||
    (lang === 'en' ? 'Moderately aggressive' : 'Agressivo moderado');

  const commentText =
    pick(t, 'comment') ||
    (lang === 'en'
      ? 'Statistically strong reversal after false breakout. If you execute, do not move the stop against the position.'
      : 'Reversão estatisticamente forte após falso rompimento. Se executar, não mova o stop contra a posição.');

  safeText(els.tradeMode,    modeText);
  safeText(els.tradeAgainst, againstText);
  safeText(els.tradeDirection, directionText);
    // ===== AUTOPILOT override (trava o card no estado da posição) =====
  autopilot = apLoad();
  apSyncUI();

  if (autopilot.enabled && autopilot.active && (autopilot.side === 'buy' || autopilot.side === 'sell')) {
    const sideLabel = apSideLabel(autopilot.side, lang);
    const entry = autopilot.entry != null ? autopilot.entry.toFixed(2) : '—';

    // status no topo
    els.tradeStatusText.textContent = (lang === 'en')
      ? `🧠 AUTOPILOT ON | Simulating position: ${sideLabel} @ ${entry}`
      : `🧠 AUTOPILOT ON | Simulando posição: ${sideLabel} @ ${entry}`;

    // força direção do card
    safeText(els.tradeDirection, sideLabel);

        // 2.0: empurra capital/units pro Cartão Citadel
    const px = apGetMarketPrice() ?? autopilot.entry;
    const units = apComputeUnits(autopilot.capital, px);

    if (els.tradeSize) {
      if (lang === 'en') {
        const capTxt = apMoneyEN(autopilot.capital);
        const uTxt = (units != null) ? `${units.toLocaleString('en-US')} shares` : '—';
        els.tradeSize.textContent = `${capTxt} · ${uTxt}`;
      } else {
        const capTxt = apMoneyPT(autopilot.capital);
        const uTxt = (units != null) ? `${units.toLocaleString('pt-BR')} ações` : '—';
        els.tradeSize.textContent = `${capTxt} · ${uTxt}`;
      }
    }


    // troca “skin” buy/sell do card
    if (els.tradeCard) {
      els.tradeCard.classList.remove('status-buy','status-sell','status-neutral');
      els.tradeCard.classList.add(autopilot.side === 'buy' ? 'status-buy' : 'status-sell');
    }

    // badge vira “HOLD / EM POSIÇÃO”
    if (els.tradeBadge) {
      els.tradeBadge.classList.remove('buy','sell');
      els.tradeBadge.classList.add(autopilot.side === 'buy' ? 'buy' : 'sell');
      els.tradeBadge.textContent = (lang === 'en') ? 'IN POSITION' : 'EM POSIÇÃO';
    }
  }

  safeText(els.tradeThermo, thermoText);

// --- estatística: pega do JSON (normal) ---
const parsed = splitStatsFromComment(commentText);

// Estatística “normal” do campo do cartão (não usa a linha do comentário)
const setupStatsText =
  pick(t, 'stats_text') ||
  pick(t, 'statistics_text') ||
  pick(t, 'stats') ||
  pick(t, 'statistics') ||
  '—';

safeText(els.tradeStats, setupStatsText, '—');

// NOVO: Estatística (7y) no topo — vem do comentário (ou cai pro JSON)
const topStatsText = parsed.stats || setupStatsText || '—';

if (els.tradeStatsTop) safeText(els.tradeStatsTop, topStatsText, '—');

if (els.tradeStatsTopLine) {
  const s = (topStatsText || '').trim();
  const hasStats = s && s !== '—' && s !== '-';
  els.tradeStatsTopLine.style.display = hasStats ? '' : 'none';

  // garante "Com estatística" no Status quando existir
  if (hasStats && els.tradeStatusText) {
    const token = (lang === 'en') ? 'With stats' : 'Com estatística';
    const cur = els.tradeStatusText.textContent || '';
    if (!cur.toLowerCase().includes(token.toLowerCase())) {
      els.tradeStatusText.textContent = `${cur} | ${token}`;
    }
  }
}

// Comentário: NÃO remove nada
setFormattedComment(els.tradeComment, parsed.comment || commentText);



  // ===== visual do cartão (cor / badge) =====
  const card  = els.tradeCard;
  const badge = els.tradeBadge;

  if (card) {
    card.classList.remove('status-buy', 'status-sell', 'status-wait', 'status-no-trade');

    const side = (t.side || t.direction || '').toString().toLowerCase();
    const state = (t.state || t.trade_state || '').toString().toLowerCase();

    let modeClass = 'status-wait';

    if (state.includes('no') || state.includes('sem')) {
      modeClass = 'status-no-trade';
    } else if (side.includes('buy') || side.includes('compra')) {
      modeClass = 'status-buy';
    } else if (side.includes('sell') || side.includes('venda')) {
      modeClass = 'status-sell';
    }

    card.classList.add(modeClass);
  }

  if (badge) {
    const rawBadge = (t.badge || t.mode_badge || '').toString().toLowerCase();

    let text;
    if (rawBadge.includes('wait') || rawBadge.includes('aguardar')) {
      text = 'WAIT';
    } else if (rawBadge.includes('no')) {
      text = 'NO TRADE';
    } else if (rawBadge) {
      text = rawBadge.toUpperCase();
    } else {
      text = 'GO FULL';
    }

    badge.textContent = text;
  }
}


function applyHeroDecision(executionPlan, riskLevel, finalSummary) {
  const lang = (typeof currentLang !== 'undefined' ? currentLang : 'pt');

  // ✅ Suporta IDs antigos (camelCase) e os da sua UI nova (kebab-case)
  const heroModePill =
    document.getElementById('heroModePill') ||
    document.getElementById('hero-mode-pill');

  const heroMain =
    document.getElementById('heroMain') ||
    document.getElementById('hero-main') ||
    null;

  const heroSummary =
    document.getElementById('heroSummary') ||
    document.getElementById('hero-summary-text') ||
    null;

  const heroSideLabel =
    document.getElementById('heroSideLabel') ||
    document.getElementById('hero-side-label') ||
    null;

  const heroSecondary =
    document.getElementById('heroSecondary') ||
    document.getElementById('hero-mini-context') ||
    null;

  const heroBadge =
    document.getElementById('status-hero-badge') ||
    document.querySelector('.status-hero-badge') ||
    null;

  // ✅ Se a UI não tiver esses elementos, simplesmente não faz nada (NUNCA quebra o painel)
  if (!heroModePill && !heroSummary && !heroSideLabel && !heroBadge && !heroMain && !heroSecondary) {
    return;
  }

  // --- Market Now / direção (com fallback seguro)
  const marketNow =
    (apCtx && apCtx.panel && (apCtx.panel.market_now || apCtx.panel.marketNow)) ||
    autopilot.marketNow ||
    null;

  const mn =
    (marketNow === 'buy' || marketNow === 'BUY') ? 'buy' :
    (marketNow === 'sell' || marketNow === 'SELL') ? 'sell' :
    'wait';

  const mnText = (mn === 'buy') ? 'BUY' : (mn === 'sell') ? 'SELL' : 'WAIT';

  // Texto principal/summary
  const summaryText = String(finalSummary || executionPlan || '—');

  // Side label (PT/EN)
  const sideLabel =
    (mn === 'buy') ? (lang === 'en' ? 'BUY' : 'COMPRA') :
    (mn === 'sell') ? (lang === 'en' ? 'SELL' : 'VENDA') :
    'WAIT';

  // ✅ Aplica sem quebrar (tudo com guard)
  if (heroSummary) heroSummary.textContent = summaryText;
  if (heroSideLabel) heroSideLabel.textContent = sideLabel;

  if (heroModePill) {
    heroModePill.textContent = mnText;
    // classes esperadas no seu CSS atual
    heroModePill.classList.remove('go-full', 'wait', 'buy', 'sell');
    if (mn === 'wait') heroModePill.classList.add('wait');
    else heroModePill.classList.add('go-full');
  }

  if (heroBadge) {
    // se for wait -> badge WAIT, senão GO FULL (como seu layout)
    heroBadge.textContent = (mn === 'wait') ? 'WAIT' : 'GO FULL';
  }

  // Se existir “main/secondary” no layout antigo, preenche também
  if (heroMain) heroMain.textContent = mnText;
  if (heroSecondary) heroSecondary.textContent = summaryText;
}



  

function applyInstitutionalDecision(panel, executionPlan, riskLevel) {
  // se o HTML não existe (ou não é essa página), sai
  if (!els.heroFavorBar || !els.heroContraBar) return;

  const baseText = executionPlan || '—';
  const t = (baseText || '').toLowerCase();

  let mode = 'wait';
  if (t.includes('compra') || t.includes('buy')) mode = 'buy';
  else if (t.includes('venda') || t.includes('sell')) mode = 'sell';

  // pega consensus real do JSON
  const c =
    (panel && (panel.ai_consensus || panel.consensus || panel.aiConsensus)) || {};

  const normPct = (v) => {
  if (v === null || v === undefined) return NaN;

  if (typeof v === 'string') {
    v = v.replace('%', '').trim().replace(',', '.');
  }

  const n = parseFloat(v);
  if (!Number.isFinite(n)) return NaN;

  // aceita 0–1 OU 0–100
  if (n >= 0 && n <= 1) return n * 100;
  return n;
};


  const buyRaw = c.buy ?? c.BUY ?? c.long ?? c.LONG ?? c.compra ?? c.call ?? c.bull ?? c.bullish ?? c.up;
const sellRaw = c.sell ?? c.SELL ?? c.short ?? c.SHORT ?? c.venda ?? c.put ?? c.bear ?? c.bearish ?? c.down;
const neuRaw  = c.neutral ?? c.NEUTRAL ?? c.flat ?? c.wait ?? c.hold ?? c.aguardar ?? c.sideways ?? c.range;

let buy = normPct(buyRaw);
let sell = normPct(sellRaw);
let neu = normPct(neuRaw);


  buy = Number.isFinite(buy) ? buy : 0;
  sell = Number.isFinite(sell) ? sell : 0;
  neu = Number.isFinite(neu) ? neu : 0;

    // transforma 3-way em 2 barras (buy vs sell) de forma “institucional”
  const dirTotal = buy + sell;
  const total = buy + sell + neu;

  let favorPct = 0;
  let contraPct = 0;

  if (dirTotal > 0) {
    const favorRaw =
      mode === 'sell' ? sell :
      mode === 'buy'  ? buy  :
      Math.max(buy, sell); // wait -> mostra o lado mais forte (entre buy/sell)

    favorPct = Math.round((favorRaw / dirTotal) * 100);
    favorPct = Math.max(0, Math.min(100, favorPct));
    contraPct = 100 - favorPct;

  } else if (total > 0) {
    // ✅ Se não há BUY/SELL (só NEUTRAL), não existe “vantagem” direcional
    // então mostramos equilíbrio (50/50) em vez de 100%
    favorPct = 50;
    contraPct = 50;
  }

  // labels + barras
  if (els.heroFavorLabel) els.heroFavorLabel.textContent = `A favor: ${favorPct}%`;
  if (els.heroContraLabel) els.heroContraLabel.textContent = `Contra: ${contraPct}%`;

  // ✅ SAFE: nunca deixa isso quebrar o resto do painel (e o TradingView)
  if (els.heroFavorBar) els.heroFavorBar.style.width = `${favorPct}%`;
  if (els.heroContraBar) els.heroContraBar.style.width = `${contraPct}%`;


  // frases (realistas, mas derivadas de dado real)
  const favorPhrase =
    favorPct >= 70
      ? 'Continuação muito provável. Fluxo bem alinhado com a direção atual. Operar a favor é mais seguro que contra.'
      : favorPct >= 55
        ? 'Leve vantagem a favor. Fluxo parcialmente alinhado; reduza tamanho e exija confirmação.'
        : 'Sem vantagem clara. A favor e contra estão equilibrados; prefira esperar ou operar menor.';

  const contraPhrase =
    contraPct >= 35
      ? 'Probabilidade moderada de reação contra ainda existe; evite alavancagem exagerada e respeite o stop.'
      : 'Contra-movimento menos provável, mas sempre possível; disciplina de stop obrigatória.';

  if (els.heroFavorPhrase) els.heroFavorPhrase.textContent = favorPhrase;
  if (els.heroContraPhrase) els.heroContraPhrase.textContent = contraPhrase;

  // minis (RISCO / CONTEXTO / EXECUÇÃO)
  if (els.heroMiniRisk) els.heroMiniRisk.textContent = riskLevel || '—';

  const ctx =
    panel?.context_tag ||
    panel?.context_short ||
    panel?.trade_window ||
    panel?.session_window ||
    panel?.session ||
    panel?.window ||
    panel?.time_window ||
    panel?.trade_style ||
    panel?.style_today ||
    panel?.style_label_pt ||
    panel?.style_label_en ||
    '—';

  if (els.heroMiniContext) els.heroMiniContext.textContent = ctx;
  if (els.heroMiniExecution) els.heroMiniExecution.textContent = baseText;
}


// Atualiza os chips HH/HL/LH/LL a partir do JSON
function updateStructureUI(struct) {
  const map = [
    { key: 'hh', status: els.structureHHStatus, dot: els.structureHHDot },
    { key: 'hl', status: els.structureHLStatus, dot: els.structureHLDot },
    { key: 'lh', status: els.structureLHStatus, dot: els.structureLHDot },
    { key: 'll', status: els.structureLLStatus, dot: els.structureLLDot },
  ];

  map.forEach(({ key, status, dot }) => {
    if (!status || !dot) return;

    let rawVal =
      struct &&
      (struct[key] ??
        struct[key.toUpperCase()] ??
        struct['recent_' + key] ??
        struct['last_' + key]);

    let label = 'off';
    let active = false;

    if (typeof rawVal === 'string') {
      const v = rawVal.toLowerCase();
      if (
        v.includes('ativo') ||
        v.includes('on') ||
        v.includes('true') ||
        v.includes('active')
      ) {
        active = true;
      }
      if (v) label = rawVal;
    } else if (typeof rawVal === 'boolean') {
      active = rawVal;
      label = rawVal ? 'ativo' : 'off';
    }

    status.textContent = label;
    if (active) dot.classList.add('on');
    else dot.classList.remove('on');
  });
}

// Atualiza o desenho do ZigZag, se o JSON mandar pontos
function updateStructureZigzag(panel) {
  const poly = document.getElementById('structure-zigzag-poly');
  if (!poly || !panel) return;

  const pts =
    panel.structure_points ||
    panel.zigzag_points ||
    panel.market_structure_points;

  if (!Array.isArray(pts) || pts.length === 0) return;

  const n = pts.length;
  const step = n > 1 ? 100 / (n - 1) : 100;

  const svgPoints = pts.map((v, i) => {
    const yNorm = Math.max(0, Math.min(1, Number(v))); // 0–1
    const x = (step * i).toFixed(2);
    const y = (30 - yNorm * 20).toFixed(2); // faixa 10–30 no SVG
    return `${x},${y}`;
  });

  poly.setAttribute('points', svgPoints.join(' '));
}

// ====== PULLBACK BRAIN – FUNÇÃO GLOBAL ======
function updatePullbackBrain(data) {
  lastPullbackBrain = data || null;

  if (!els.pullbackStatus) return;

  // helpers para classe do termômetro
  function setMeter(score, tone) {
    const fill = els.pullbackMeterFill;
    const label = els.pullbackMeterLabel;
    if (!fill || !label) return;

    let v = score;

if (typeof v === 'string') {
  v = v.replace('%', '').trim().replace(',', '.');
}
v = parseFloat(v);

if (!Number.isFinite(v)) v = 40; // fallback (só quando não vem dado)
v = Math.max(0, Math.min(100, v));


    fill.style.width = v.toFixed(0) + '%';

    fill.classList.remove('neutral', 'danger');
    if (tone === 'red' || tone === 'danger') {
      fill.classList.add('danger');
    } else if (tone === 'yellow' || tone === 'neutral') {
      fill.classList.add('neutral');
    }

    label.textContent =
      (currentLang === 'en' ? 'Confidence ' : 'Confiança ') +
      v.toFixed(0) +
      '%';
  }

  function setSideTag(side) {
    const tag = els.pullbackSideTag;
    if (!tag) return;

    const s = (side || '').toString().toLowerCase();
    tag.classList.remove('side-buy', 'side-sell', 'side-neutral');

    if (s === 'buy' || s === 'compra') {
      tag.classList.add('side-buy');
      tag.textContent = currentLang === 'en' ? 'BUY PULLBACK' : 'COMPRA';
    } else if (s === 'sell' || s === 'venda') {
      tag.classList.add('side-sell');
      tag.textContent = currentLang === 'en' ? 'SELL PULLBACK' : 'VENDA';
    } else {
      tag.classList.add('side-neutral');
      tag.textContent = currentLang === 'en' ? 'NEUTRAL' : 'NEUTRO';
    }
  }

  function setStageTag(stageTitle) {
    const tag = els.pullbackStageTag;
    if (!tag) return;

    const txt =
      stageTitle ||
      (currentLang === 'en' ? 'Waiting' : 'Aguardando');
    tag.textContent = txt;
  }

  // ===== CASO SEM DADOS (estado neutro) =====
  if (!data || Object.keys(data).length === 0) {
    els.pullbackStatus.textContent =
      currentLang === 'en' ? 'Waiting for pullback...' : 'Aguardando pullback...';

    if (els.pullbackDepth) els.pullbackDepth.textContent = '—';
    if (els.pullbackQuality) els.pullbackQuality.textContent = '—';

    if (els.pullbackHeadline) {
      els.pullbackHeadline.textContent =
        currentLang === 'en'
          ? 'No clear pullback yet.'
          : 'Ainda não há um pullback claro.';
    }

    if (els.pullbackText) {
      els.pullbackText.textContent =
        currentLang === 'en'
          ? 'The market has not offered a clean pullback in the main direction yet. Let price breathe and wait for structure.'
          : 'O mercado ainda não ofereceu um pullback limpo na direção principal. Deixe o preço respirar e espere estrutura.';
    }

    if (els.pullbackHighlightBox) {
      els.pullbackHighlightBox.style.background = 'rgba(15,23,42,0.7)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(148,163,184,0.4)';
    }

    setSideTag(null);
    setStageTag(null);
    setMeter(40, 'neutral');
    return;
  }

  // ===== campos numéricos / status =====
  const depthAtr = data.depth_atr ?? data.atr_depth ?? null;
  const quality = data.quality ?? data.grade ?? null;
  const tone = (data.tone || '').toLowerCase();
  const side = data.side || data.direction || null;
  const score = data.score ?? data.confidence ?? 40;

  // título principal (usa state_title_pt/en se tiver)
  const statusTitle =
    (currentLang === 'en'
      ? (data.state_title_en || data.status_en || data.state_title || data.status)
      : (data.state_title_pt || data.status_pt || data.state_title || data.status)) ||
    (currentLang === 'en'
      ? 'Pullback detected'
      : 'Pullback detectado');

  els.pullbackStatus.textContent = statusTitle;

  if (els.pullbackDepth) {
    els.pullbackDepth.textContent =
      depthAtr != null ? depthAtr.toFixed(2) + ' ATR' : '—';
  }

  if (els.pullbackQuality) {
    els.pullbackQuality.textContent = quality || '—';
  }

  setSideTag(side);

  // estágio (1..7 – aquelas frases que fizemos: tendência, pullback fraco, reversão, etc.)
  const stageTitle =
    (currentLang === 'en'
      ? (data.stage_title_en || data.stage_title)
      : (data.stage_title_pt || data.stage_title)) || null;
  setStageTag(stageTitle);

  // ===== textos em PT / EN vindos do backend =====
  const headline =
    (currentLang === 'en'
      ? (data.headline_en || data.headline)
      : (data.headline_pt || data.headline)) ||
    (currentLang === 'en'
      ? 'Healthy pullback inside the main trend.'
      : 'Pullback saudável dentro da tendência principal.');

  const body =
    (currentLang === 'en'
      ? (data.text_en || data.text)
      : (data.text_pt || data.text)) ||
    (currentLang === 'en'
      ? 'AARON 9 sees this pullback as aligned with the main direction. Focus on trades with the trend and avoid fighting the move.'
      : 'O AARON 9 vê este pullback como alinhado com a direção principal. Foque em operações a favor e evite brigar com o movimento.');

  if (els.pullbackHeadline) els.pullbackHeadline.textContent = headline;
  if (els.pullbackText) els.pullbackText.textContent = body;

  // ===== cor do bloco (verde / amarelo / vermelho) =====
  if (els.pullbackHighlightBox) {
    if (tone === 'red' || tone === 'danger') {
      els.pullbackHighlightBox.style.background = 'rgba(248,113,113,0.06)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(248,113,113,0.6)';
    } else if (tone === 'yellow' || tone === 'neutral') {
      els.pullbackHighlightBox.style.background = 'rgba(234,179,8,0.06)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(234,179,8,0.6)';
    } else {
      // default = saudável / ok
      els.pullbackHighlightBox.style.background = 'rgba(34,197,94,0.08)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(34,197,94,0.4)';
    }
  }

  // termômetro de confiança / “risco de reversão”
  setMeter(score, tone);
}

  


// ====== SIZING BRAIN – frases baseadas em Capital EM USO + Alavancagem ======
function updateSizingPhrase() {
  const accEl = els.sizingAccountRealInput;
  const useEl = els.sizingUseInput;
  const levEl = els.sizingLeverageInput;
  const riskEl = els.sizingRiskInput;
  const stopEl = els.sizingStopInput;
  const fixedEl = els.sizingFixedQtyInput;
  const mainEl = els.sizingPhraseMain;
  const detailEl = els.sizingPhraseDetail;

  if (!accEl || !useEl || !levEl || !riskEl || !stopEl || !mainEl || !detailEl) {
    return;
  }

  function numFromInput(el) {
    if (!el) return 0;
    const raw = (el.value || '').toString().replace(',', '.');
    const n = Number(raw);
    return Number.isFinite(n) ? n : 0;
  }

  const capitalReal = numFromInput(accEl);
  const capitalUso  = numFromInput(useEl);
  const leverage    = numFromInput(levEl);
  const riskPct     = numFromInput(riskEl);
  const stopUsd     = numFromInput(stopEl);
  const fixedQty    = Math.floor(numFromInput(fixedEl));

  // === LÓGICA TIPO AARON PINE ===
  // 1) Se Capital EM USO > 0 → base = EM USO
  // 2) Senão, se Capital REAL > 0 e alavancagem > 0 → base = REAL × alavancagem
  // 3) Senão, se Capital REAL > 0 → base = REAL
  let baseCapital = 0;

  if (capitalUso > 0) {
    baseCapital = capitalUso;
  } else if (capitalReal > 0 && leverage > 0) {
    baseCapital = capitalReal * leverage;
  } else if (capitalReal > 0) {
    baseCapital = capitalReal;
  }

  const baseMsg =
    currentLang === 'en'
      ? 'Type account capital, capital in use, risk % and stop distance to see the suggested position size.'
      : 'Digite capital real, capital em uso, risco % e stop para ver o tamanho sugerido da posição.';

  if (!baseCapital || !riskPct || !stopUsd) {
    mainEl.textContent = baseMsg;
    detailEl.textContent = '';
    return;
  }

  const riskMoney  = baseCapital * (riskPct / 100);
  const sharesRisk = Math.floor(riskMoney / stopUsd);

  if (!Number.isFinite(sharesRisk) || sharesRisk <= 0) {
    mainEl.textContent =
      currentLang === 'en'
        ? 'Check the values. The risk in dollars must be greater than the stop distance.'
        : 'Verifique os valores. O risco em dólares precisa ser maior que a distância do stop.';
    detailEl.textContent = '';
    return;
  }

  function fmtUSD(v) {
    return v.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    });
  }

  // Mensagem principal
  if (currentLang === 'en') {
    mainEl.textContent =
      'Base capital: ' +
      fmtUSD(baseCapital) +
      '. With ' +
      riskPct.toFixed(2) +
      '% risk per trade, max risk is about ' +
      fmtUSD(riskMoney) +
      ' per trade.';
  } else {
    mainEl.textContent =
      'Base de cálculo: ' +
      fmtUSD(baseCapital) +
      '. Com risco de ' +
      riskPct.toFixed(2) +
      '% por trade, o risco máximo por trade é de aproximadamente ' +
      fmtUSD(riskMoney) +
      '.';
  }

  // Detalhe – comparação com Qtd fixa (se existir)
  if (fixedQty > 0) {
    const aboveSafe = fixedQty > sharesRisk;

    if (currentLang === 'en') {
      detailEl.textContent =
        'With a stop at ' +
        stopUsd.toFixed(2) +
        ' USD per share, the risk-based safe size is around ' +
        sharesRisk +
        ' shares. Your fixed size is ' +
        fixedQty +
        ' shares, which is ' +
        (aboveSafe ? 'ABOVE' : 'within') +
        ' the safe size.';
    } else {
      detailEl.textContent =
        'Com o stop a ' +
        stopUsd.toFixed(2) +
        ' USD por share, o tamanho seguro pelo risco fica em torno de ' +
        sharesRisk +
        ' shares. Sua quantidade fixa é ' +
        fixedQty +
        ' shares, o que está ' +
        (aboveSafe ? 'ACIMA' : 'dentro') +
        ' do tamanho considerado seguro.';
    }
  } else {
    if (currentLang === 'en') {
      detailEl.textContent =
        'With a stop at ' +
        stopUsd.toFixed(2) +
        ' USD per share, the suggested position size is around ' +
        sharesRisk +
        ' shares. You can round down if you want to be more conservative.';
    } else {
      detailEl.textContent =
        'Com o stop a ' +
        stopUsd.toFixed(2) +
        ' USD por share, o tamanho de posição sugerido é de cerca de ' +
        sharesRisk +
        ' shares. Você pode arredondar para baixo se quiser ser mais conservador.';
    }
  }
}

// Eventos para recalcular quando digitar
['input', 'change'].forEach(function (evt) {
  if (els.sizingAccountRealInput)
    els.sizingAccountRealInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingUseInput)
    els.sizingUseInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingLeverageInput)
    els.sizingLeverageInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingRiskInput)
    els.sizingRiskInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingStopInput)
    els.sizingStopInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingFixedQtyInput)
    els.sizingFixedQtyInput.addEventListener(evt, updateSizingPhrase);
});


// ====== SIZING BRAIN – FUNÇÃO GLOBAL ======
function updateSizingBrain(data) {
  lastSizingBrain = data || null;

  if (!els.sizingTarget) return;

  function fmtPct(v) {
  if (v === null || v === undefined) return null;
  if (typeof v === 'string') v = v.replace('%', '').trim().replace(',', '.');

  const n = parseFloat(v);
  if (!Number.isFinite(n)) return null;
  return n.toFixed(1) + '%';
}


  // sempre que chegar dado novo (ou trocar idioma), recalcula frase
  updateSizingPhrase();

  function setProfileTag(profile) {
    const tag = els.sizingProfileTag;
    if (!tag) return;

    const p = (profile || '').toString().toLowerCase();
    tag.classList.remove(
      'profile-conservative',
      'profile-normal',
      'profile-aggressive'
    );

    if (p.includes('conserv')) {
      tag.classList.add('profile-conservative');
      tag.textContent =
        currentLang === 'en' ? 'Conservative' : 'Conservador';
    } else if (p.includes('agress') || p.includes('aggress')) {
      tag.classList.add('profile-aggressive');
      tag.textContent =
        currentLang === 'en' ? 'Aggressive' : 'Agressivo';
    } else {
      tag.classList.add('profile-normal');
      tag.textContent =
        currentLang === 'en' ? 'Normal' : 'Normal';
    }
  }

  function setStyleTag(style, labelPt, labelEn) {
    const tag = els.sizingStyleTag;
    if (!tag) return;

    const s = (style || '').toString().toLowerCase();
    tag.classList.remove(
      'style-daytrade',
      'style-swing',
      'style-momentum',
      'style-noedge'
    );

    let txt =
      currentLang === 'en'
        ? (labelEn || '')
        : (labelPt || '');

    if (!txt) {
      if (s.includes('day')) {
        txt =
          currentLang === 'en'
            ? 'Trend day trade'
            : 'Day trade tendencial';
      } else if (s.includes('swing')) {
        txt =
          currentLang === 'en'
            ? 'Swing trade'
            : 'Swing trade';
      } else if (s.includes('momentum') || s.includes('scalp')) {
        txt =
          currentLang === 'en'
            ? 'Momentum / scalp'
            : 'Momentum / scalp';
      } else {
        txt =
          currentLang === 'en'
            ? 'No clear edge'
            : 'Sem edge claro';
      }
    }

    if (s.includes('day')) {
      tag.classList.add('style-daytrade');
    } else if (s.includes('swing')) {
      tag.classList.add('style-swing');
    } else if (s.includes('momentum') || s.includes('scalp')) {
      tag.classList.add('style-momentum');
    } else {
      tag.classList.add('style-noedge');
    }

    tag.textContent = txt;
  }

  function setMeter(score) {
    const fill = els.sizingMeterFill;
    const label = els.sizingMeterLabel;
    if (!fill || !label) return;

    let v = score;
if (typeof v === 'string') v = v.replace('%', '').trim().replace(',', '.');
v = parseFloat(v);
if (!Number.isFinite(v)) v = 40;


    fill.style.width = v.toFixed(0) + '%';
    label.textContent =
      (currentLang === 'en' ? 'Risk usage ' : 'Uso de risco ') +
      v.toFixed(0) +
      '%';
  }

  // ===== estado neutro (sem dados do backend) =====
  if (!data || Object.keys(data).length === 0) {
    if (els.sizingTarget) els.sizingTarget.textContent = '0.8–1.2%';
    if (els.sizingMaxDD) els.sizingMaxDD.textContent = '0.8%';
    if (els.sizingRiskTrade) els.sizingRiskTrade.textContent = '0.25%';
    if (els.sizingTradesCount) els.sizingTradesCount.textContent = '3';

    setProfileTag('normal');
    setStyleTag('day_trade', null, null);
    setMeter(40);

    if (els.sizingComment) {
      els.sizingComment.textContent =
        currentLang === 'en'
          ? 'Today you can think in terms of a realistic 0.8–1.2% if you focus on 2–3 A+ trades and respect your max daily loss.'
          : 'Hoje você pode pensar em algo em torno de 0.8–1.2% se focar em 2–3 trades A+ e respeitar sua perda máxima do dia.';
    }

    return;
  }

  // ===== com dados do backend (sizing_brain) =====
  const profile      = data.profile;
  const style        = data.style_today;
  const styleLabelPt = data.style_label_pt;
  const styleLabelEn = data.style_label_en;

  const tMin    = data.target_min_pct   ?? data.recommended_target_min_pct;
  const tMax    = data.target_max_pct   ?? data.recommended_target_max_pct;
  const tSingle = data.target_pct       ?? data.recommended_target_pct;

  const maxDD        = data.max_dd_pct         ?? data.recommended_max_dd_pct;
  const riskPerTrade = data.risk_per_trade_pct ?? data.recommended_risk_per_trade_pct;
  const tradesCount  = data.trades_count       ?? data.recommended_trades_count;
  const score        = data.score              ?? data.risk_usage_score ?? 40;

  // alvo
  let targetText = '';
  const tMinFmt    = fmtPct(tMin);
  const tMaxFmt    = fmtPct(tMax);
  const tSingleFmt = fmtPct(tSingle);

  if (tMinFmt && tMaxFmt) targetText = `${tMinFmt}–${tMaxFmt}`;
  else if (tSingleFmt)    targetText = tSingleFmt;

  if (!targetText) {
    targetText = currentLang === 'en' ? 'Auto' : 'Automático';
  }

  if (els.sizingTarget) els.sizingTarget.textContent = targetText;
  if (els.sizingMaxDD && fmtPct(maxDD)) {
    els.sizingMaxDD.textContent = fmtPct(maxDD);
  }
  if (els.sizingRiskTrade && fmtPct(riskPerTrade)) {
    els.sizingRiskTrade.textContent = fmtPct(riskPerTrade);
  }
  if (els.sizingTradesCount && tradesCount != null) {
    els.sizingTradesCount.textContent = String(tradesCount);
  }

  setProfileTag(profile);
  setStyleTag(style, styleLabelPt, styleLabelEn);
  setMeter(score);

  const comment =
    currentLang === 'en'
      ? (data.comment_en || data.comment || '')
      : (data.comment_pt || data.comment || '');

  if (els.sizingComment) {
    if (comment) {
      els.sizingComment.textContent = comment;
    } else {
      els.sizingComment.textContent =
        currentLang === 'en'
          ? 'Sizing Brain suggests focusing on A+ setups only, with a realistic target for the day and a strict daily loss limit.'
          : 'O Sizing Brain sugere focar apenas em setups A+, com alvo realista para o dia e limite de perda diária bem definido.';
    }
  }
}

function uniq(list) {
  return Array.from(new Set(list.filter(Boolean)));
}

function buildPatternFileCandidates(file) {
  const f = String(file || '').trim();
  if (!f) return [];

  const cand = [f];

  const hasExt = /\.[a-z0-9]{2,5}$/i.test(f);
  if (!hasExt) {
    // tenta extensões comuns
    cand.push(`${f}.jpg`, `${f}.png`, `${f}.jpeg`, `${f}.webp`);
  } else {
    // se veio jpg, tenta png equivalente (e vice-versa)
    if (f.toLowerCase().endsWith('.jpg')) cand.push(f.replace(/\.jpg$/i, '.png'));
    if (f.toLowerCase().endsWith('.png')) cand.push(f.replace(/\.png$/i, '.jpg'));

    // casos “F(1).jpg” vs “F (1).jpg”
    if (/^F\(\d+\)\./i.test(f)) cand.push(f.replace(/^F\(/i, 'F ('));
    if (/^F \(\d+\)\./i.test(f)) cand.push(f.replace(/^F \(/i, 'F('));

    // Tentativas genéricas: com e sem espaço antes do "("
    if (f.includes('(')) cand.push(f.replace('(', ' ('));
    if (f.includes(' (')) cand.push(f.replace(' (', '('));
  }

  return uniq(cand);
}


function setRefImageWithFallback(file) {
  if (!els.refPatternImg) return;

  const candidates = buildPatternFileCandidates(file);
  if (!candidates.length) return;

  let idx = 0;

  const tryLoad = () => {
    const base = encodeURI(`assets/patterns/${candidates[idx]}`);
    const bust = `${base}${base.includes('?') ? '&' : '?'}t=${Date.now()}`;

    els.refPatternImg.src = bust;
    if (els.refPatternLink) els.refPatternLink.href = base;
  };

  els.refPatternImg.onerror = () => {
    idx += 1;
    if (idx < candidates.length) tryLoad();
  };

  tryLoad();
}


function updatePatternReference(panel, patterns) {
  if (!els.refPatternImg || !els.refPatternLabel) return;

  const trade = panel.trade_card || panel.tradeCard || {};
  const ref = panel.pattern_reference || panel.pattern_ref || {};
  const day = (patterns && patterns.day) ? patterns.day : {};

  const pid = trade.pattern_id || ref.id || '';

  const namePt = ref.name_pt || ref.name || (pid ? `Padrão ${pid}` : '') || panel.pattern_day || day.name || '—';
  const nameEn = ref.name_en || ref.name || (pid ? `Pattern ${pid}` : '') || panel.pattern_day || day.name || '—';

  const setupPt = ref.setup_pt || ref.setup || day.desc || '—';
  const setupEn = ref.setup_en || ref.setup || day.desc || '—';

  const notesPt = ref.notes_pt || ref.notes || '—';
  const notesEn = ref.notes_en || ref.notes || '—';

  // imagem: prioriza o que veio do n8n; senão monta pelo pattern_id
  let img =
    ref.image_url ||
    ref.image ||
    ref.img ||
    ref.file ||
    ref.filename ||
    panel.pattern_image ||
    panel.pattern_img ||
    trade.pattern_image ||
    (pid ? pid : '') ||
    '';

  if (!img) img = 'F(1).jpg';

  // textos
  if (els.refPatternLabel) els.refPatternLabel.textContent = (currentLang === 'en') ? nameEn : namePt;
  if (els.refPatternSetup) els.refPatternSetup.textContent = (currentLang === 'en') ? setupEn : setupPt;
  if (els.refPatternNotes) els.refPatternNotes.textContent = (currentLang === 'en') ? notesEn : notesPt;
  if (els.refPatternMini) els.refPatternMini.textContent = (currentLang === 'en') ? nameEn : namePt;

  const isUrl = /^https?:\/\//i.test(img);

  if (isUrl) {
    const finalSrc = `${img}${img.includes('?') ? '&' : '?'}t=${Date.now()}`;
    els.refPatternImg.src = finalSrc;
    if (els.refPatternLink) els.refPatternLink.href = img;
  } else {
    setRefImageWithFallback(img);
  }

  // Abrir/Fechar
  if (els.refDetails && els.refSummaryRight) {
    els.refSummaryRight.textContent = els.refDetails.open
      ? (currentLang === 'en' ? 'Close' : 'Fechar')
      : (currentLang === 'en' ? 'Open' : 'Abrir');
  }
}

// ===============================
// ADAPTER: panel_json -> trade card model (Citadel)
// (não mexe no dropdown, não mexe no autopilot)
// ===============================
function adaptPanelToTradeCard(panel, raw, fallbackSymbol){
  if (!panel || typeof panel !== "object") return null;

  const statusGeral = panel.status_geral || {};
  const ai = panel.ai_advisor || panel.aiAdvisor || {};
  const meta = panel.meta || {};

  const sym = String(panel.symbol || raw?.symbol || fallbackSymbol || "").toUpperCase().trim() || "—";
  const tf  = String(panel.timeframe || raw?.timeframe || panel.timeframe_label || "").trim() || "—";

  const parseBoolish = (v) => {
    if (typeof v === "boolean") return v;
    if (typeof v === "number") return v > 0;
    const s = String(v ?? "").trim().toLowerCase();
    if (!s) return false;
    if (/(false|não|nao|no|0)/.test(s)) return false;
    if (/(true|sim|yes|1|válido|valido|valid)/.test(s)) return true;
    return false;
  };

  const setupOk = parseBoolish(statusGeral.setup_valido ?? statusGeral.setupValido ?? statusGeral.setup);

  const actionRaw = String(ai.acao_recomendada || ai.action || ai.recommendation || "").toLowerCase();
  const dirInfo =
    (actionRaw.includes("buy") || actionRaw.includes("compra")) ? { pt:"COMPRA", en:"BUY",  cls:"status-buy",  side:"buy" } :
    (actionRaw.includes("sell")|| actionRaw.includes("venda"))  ? { pt:"VENDA",  en:"SELL", cls:"status-sell", side:"sell"} :
    (actionRaw.includes("close")|| actionRaw.includes("fechar"))? { pt:"FECHAR", en:"CLOSE",cls:"status-wait", side:"close"} :
    (actionRaw.includes("wait")|| actionRaw.includes("aguard")) ? { pt:"AGUARDAR",en:"WAIT", cls:"status-wait", side:"wait"} :
                                                                 { pt:"NEUTRO", en:"NEUTRAL",cls:"status-wait", side:"neutral" };

  const updatedAt =
    panel.updated_at || panel.updated || meta.panel_ts || meta.timestamp || panel.timestamp || raw?.time || "—";
  const session = panel.session || raw?.session || "—";
  const flow =
    panel.flow_label || panel.flow || statusGeral.tendencia || "—";

  const status_text_pt = setupOk ? `✅ Setup válido | ${dirInfo.pt}` : `⏳ Aguardando | ${dirInfo.pt}`;
  const status_text_en = setupOk ? `✅ Valid setup | ${dirInfo.en}` : `⏳ Waiting | ${dirInfo.en}`;

  const pulse_line_pt = `${session} • ${flow} • atualizado: ${updatedAt}`;
  const pulse_line_en = `${session} • ${flow} • updated: ${updatedAt}`;

  const mode_pt =
    String(ai.modo_pt || ai.modo || ai.motivo || "").trim() || (setupOk ? "Setup identificado" : "Aguardando confirmação");
  const mode_en =
    String(ai.modo_en || ai.mode || ai.motivo_en || ai.motivo || "").trim() || (setupOk ? "Setup identified" : "Waiting confirmation");

  const entry_text = ai.gatilho_entrada || ai.entry || ai.entrada || "—";

  const firstNum = (x) => {
    if (x == null) return null;
    if (typeof x === "number" && isFinite(x)) return x;
    const m = String(x).match(/-?\d+(?:\.\d+)?/);
    return m ? Number(m[0]) : null;
  };

  const stopRaw = (ai.stop_loss_plano ?? ai.stop_loss ?? ai.stop);
  const stopNum = firstNum(stopRaw);
  const stop = (stopNum != null) ? stopNum.toFixed(2) : (stopRaw || "—");

  const tpPlan = (ai.take_profit_plano ?? ai.take_profit ?? ai.tp);
  let tp1 = "—", tp2 = "—";
  if (tpPlan != null) {
    const s = String(tpPlan);
    const m1 = s.match(/TP1\s*[:=]?\s*(-?\d+(?:\.\d+)?)/i);
    const m2 = s.match(/TP2\s*[:=]?\s*(-?\d+(?:\.\d+)?)/i);
    if (m1) tp1 = Number(m1[1]).toFixed(2);
    if (m2) tp2 = Number(m2[1]).toFixed(2);

    if (!m1 && !m2) {
      const nums = s.match(/-?\d+(?:\.\d+)?/g);
      if (nums && nums.length) tp1 = Number(nums[0]).toFixed(2);
      if (nums && nums.length > 1) tp2 = Number(nums[1]).toFixed(2);
      if (!nums || !nums.length) tp1 = s; // mantém texto se não tiver número
    }
  }

  const size_text = ai.size_text || "—";
  const risk_text = ai.risk_text || "—";

  const comment_pt = [
    ai.motivo ? `Motivo: ${ai.motivo}` : null,
    ai.gatilho_entrada ? `Entrada: ${ai.gatilho_entrada}` : null,
    ai.stop_loss_plano ? `Stop: ${ai.stop_loss_plano}` : null,
    ai.take_profit_plano ? `TP: ${ai.take_profit_plano}` : null,
    ai.manejo_posicao ? `Manejo: ${ai.manejo_posicao}` : null,
  ].filter(Boolean).join("\n") || "—";

  const comment_en = [
    ai.motivo_en ? `Reason: ${ai.motivo_en}` : (ai.motivo ? `Reason: ${ai.motivo}` : null),
    ai.gatilho_entrada_en ? `Entry: ${ai.gatilho_entrada_en}` : (ai.gatilho_entrada ? `Entry: ${ai.gatilho_entrada}` : null),
    ai.stop_loss_plano_en ? `Stop: ${ai.stop_loss_plano_en}` : (ai.stop_loss_plano ? `Stop: ${ai.stop_loss_plano}` : null),
    ai.take_profit_plano_en ? `TP: ${ai.take_profit_plano_en}` : (ai.take_profit_plano ? `TP: ${ai.take_profit_plano}` : null),
    ai.manejo_posicao_en ? `Management: ${ai.manejo_posicao_en}` : (ai.manejo_posicao ? `Management: ${ai.manejo_posicao}` : null),
  ].filter(Boolean).join("\n") || "—";

  return {
    symbol: sym,
    timeframe: tf,

    status_text_pt,
    status_text_en,

    pulse_line_pt,
    pulse_line_en,

    mode_pt,
    mode_en,

    against_pt: "—",
    against_en: "—",

    direction_pt: dirInfo.pt,
    direction_en: dirInfo.en,

    // garante cor do card
    side: dirInfo.side,
    direction: dirInfo.side,

    entry_text,
    stop,
    tp1,
    tp2,

    size_text,
    risk_text,

    thermo_pt: setupOk ? "Agressivo moderado" : "Neutro",
    thermo_en: setupOk ? "Moderately aggressive" : "Neutral",

    comment_pt,
    comment_en,

    badge: setupOk ? "WAIT" : "NO TRADE",
    status_class: dirInfo.cls,
    trade_state: String(ai.trade_state || "").toUpperCase() || undefined,
  };
}


// ====== LOAD PANEL (agora usando data.panel + data.raw) ======
async function loadPanel(showSpinner) {
  if (!PANEL_URL) return;
  try {
    if (els.errorBanner) els.errorBanner.style.display = 'none';
    if (els.btnRefresh && showSpinner) els.btnRefresh.disabled = true;

   const sym = (localStorage.getItem('aaron_selected_symbol') || '').trim() || 'NVDA';
const tfSel =
  (localStorage.getItem('aaron_selected_tf') || '').trim() ||
  (typeof A10_DEFAULT_TF === 'string' ? A10_DEFAULT_TF : '1m');

const url = `${PANEL_URL}${PANEL_URL.includes('?') ? '&' : '?'}symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tfSel)}&t=${Date.now()}`;
const res = await fetch(url, { cache: 'no-store' });


    if (!res.ok) throw new Error('HTTP ' + res.status);

const data = await res.json();

// n8n pode devolver: {panel, raw, ui, digest}  OU  [ { json: {...} } ]  OU  [ {...} ]
const root = Array.isArray(data) ? (data[0] || {}) : (data || {});
const payload =
  (root && typeof root === 'object' && root.json && typeof root.json === 'object')
    ? root.json
    : root;

// salva debug
window.__AARON_LAST_PAYLOAD__ = payload;

// ✅ 1) Preenche o bloco “RESPONDER OUTPUT” (KPI + colunas panel/ui/digest)
if (typeof renderTradeResponderOutput === "function") {
  renderTradeResponderOutput(payload);
}

// ✅ 2) Injeta dentro do Trade Card (campos “na sua cara”)
if (typeof applyResponderIntoTradeCard === "function") {
  applyResponderIntoTradeCard(payload);
}

// ✅ 3) Mini-resumo dentro do Trade Card (se o anchor existir)
if (typeof renderResponderInline === "function") {
  renderResponderInline(payload);
}

window.dispatchEvent(new Event("aaron:panelUpdated"));

// segue o fluxo normal do seu loadPanel

const panel = payload.panel || payload;
const raw = payload.raw || payload.raw_eye || {};

// alimenta Autopilot 2.0 com o preço atual (sem inventar)
const pxNow =
  panel.price_now ||
  panel.last_price ||
  panel.reference_price ||
  (raw && raw.candle && raw.candle.close);

if (pxNow != null && isFinite(Number(pxNow))) {
  apMarketPrice = Number(pxNow);
}
apRenderSizing();

// ✅ SYNC do dropdown PREÇO (Matcher Picker) + fonte de quote
try {
  const pxNum = (pxNow != null && isFinite(Number(pxNow))) ? Number(pxNow) : null;

  // alimenta o getQuote() do dropdown
  window.__AARON_LAST_PANEL_JSON__ = {
    symbol: panel?.symbol || raw?.symbol || sym,
    price: pxNum,
    last_price: pxNum,
  };

  // atualiza o campo "PREÇO" do dropdown
  const mpEl = document.getElementById("mp-price");
  if (mpEl) mpEl.value = (pxNum != null) ? pxNum.toFixed(2) : "—";
} catch (e) {}



    updateGarimpoTodayCard(panel?.garimpo_today || null);


    // Preenche ATR + preço de entrada
    prefillAtrFromPanel(panel, raw);

    const statusGeral = panel.status_geral || {};
    const aiAdvisor = panel.ai_advisor || {};
    const patterns = panel.patterns || {};
    const patternDay = patterns.day || {};
    const patternShort = patterns.short || {};
    const meta = panel.meta || {};

    // "cérebro" de pullback vindo do n8n
    const pullbackBrain =
      panel.pullback_brain ||
      panel.pullbackBrain ||
      panel.pullback ||
      {};
    updatePullbackBrain(pullbackBrain);

        const sizingBrain =
      panel.sizing_brain ||
      panel.sizingBrain ||
      panel.capital_brain ||
      {};
    updateSizingBrain(sizingBrain);

            // Cartão de trade (Citadel / cartão atual)
const tradeCard =
  panel.trade_card ||
  panel.current_trade ||
  panel.citadel_card ||
  panel.trade ||
  null;

// 1) Se o backend já trouxe um cartão pronto, usa ele
if (tradeCard && typeof tradeCard === "object" && Object.keys(tradeCard).length) {
  updateTradeCard(tradeCard);
} else {
  // 2) Senão, ADAPTA do panel.ai_advisor + panel.status_geral (sem inventar)
  const adapted = adaptPanelToTradeCard(panel, raw, sym);
  if (adapted) {
    window.__AARON_TRADE_FROM_PANEL__ = adapted; // debug (opcional)
    updateTradeCard(adapted);
  }
}

// ✅ GARANTIA: depois que o loadPanel atualizar o cartão, re-aplica o output do RESPONDER
try {
  if (typeof applyResponderIntoTradeCard === "function") {
    applyResponderIntoTradeCard(payload);
  }
  if (typeof renderResponderInline === "function") {
    renderResponderInline(payload);
  }
} catch (e) {}



    // Cabeçalho
const tfSel =
  (localStorage.getItem('aaron_selected_tf') || '').trim() ||
  (typeof A10_DEFAULT_TF === 'string' ? A10_DEFAULT_TF : '1m');

safeText(els.symbol, panel.symbol || raw.symbol || '—');
safeText(
  els.timeframe,
  panel.timeframe ||
    raw.timeframe ||
    panel.timeframe_label ||
    tfSel ||
    '—'
);

    safeText(
      els.session,
      panel.session || raw.session || panel.session_label || '—'
    );

    const micro = panel.microcontexto || {};
    const flowLabel = panel.flow_label || panel.flow || micro.direcao;
    safeText(els.flow, flowLabel || 'Neutro');

    const stateText =
      (panel.status && (panel.status.label || panel.status.state)) ||
      statusGeral.tendencia ||
      'ONLINE';
    safeText(els.state, stateText);

    const ts = meta.panel_ts || meta.timestamp || panel.timestamp || raw.time;
    if (els.lastUpdate) {
      if (!ts) {
        els.lastUpdate.textContent = 'sem timestamp';
      } else {
        try {
          const d =
            typeof ts === 'number'
              ? new Date(ts)
              : new Date(String(ts));
          els.lastUpdate.textContent = d.toLocaleString('pt-BR', {
            timeZone: 'America/Denver',
          });
        } catch (e) {
          els.lastUpdate.textContent = String(ts);
        }
      }
    }

    // Padrões / Direções
    const patternDayName =
      panel.pattern_day ||
      panel.pattern_of_day ||
      patternDay.name;
    const patternDayDesc =
      panel.pattern_day_detail ||
      panel.pattern_of_day_detail ||
      patternDay.desc;

    const patternNowName =
      panel.pattern_now ||
      panel.pattern_of_moment ||
      patternShort.name;
    const patternNowDesc =
      panel.pattern_now_detail ||
      panel.pattern_of_moment_detail ||
      patternShort.desc;

    safeText(els.patternDayLabel, patternDayName || '-');
    safeText(els.patternDayDetail, patternDayDesc || '—');
    safeText(els.patternNowLabel, patternNowName || '-');
    safeText(els.patternNowDetail, patternNowDesc || '—');

    setArrow(
      els.dirDayArrow,
      panel.direction_day ||
        panel.direction_of_day ||
        micro.direcao
    );
    setArrow(
      els.dirNowArrow,
      panel.direction_now ||
        panel.direction_of_moment ||
        micro.direcao
    );

    setPillTrend(
      els.trendDayPill,
      panel.direction_day || panel.direction_of_day || micro.direcao,
      panel.trend_day_label
    );
    setPillTrend(
      els.trendNowPill,
      panel.direction_now ||
        panel.direction_of_moment ||
        micro.direcao,
      panel.trend_now_label
    );

        // Atualiza aba de referência (imagem + textos)
    updatePatternReference(panel, patterns);

    // Listener do abre/fecha (pra atualizar o texto "Abrir/Fechar")
    if (els.refDetails && !els.refDetails.__bound) {
      els.refDetails.__bound = true;
      els.refDetails.addEventListener('toggle', () => {
        if (els.refSummaryRight) {
          els.refSummaryRight.textContent = els.refDetails.open
            ? (currentLang === 'en' ? 'Close' : 'Fechar')
            : (currentLang === 'en' ? 'Open' : 'Abrir');
        }
      });
    }


    // =======================================================
    // TEXTO DINÂMICO: DIREÇÃO DO DIA / 1–3 CANDLES
    // =======================================================

    let dayProb   = panel.direction_day_prob;
    let dayDetail = panel.direction_day_detail;
    let nowProb   = panel.direction_now_prob;
    let nowDetail = panel.direction_now_detail;

    // fallback usando prob_favor / prob_contra
    if ((!dayProb && !dayDetail) || (!nowProb && !nowDetail)) {
      const forecast = panel.ai_forecast || {};
      const probFavor  = Number(panel.prob_favor  ?? forecast.prob_continuacao ?? NaN);
      const probContra = Number(panel.prob_contra ?? forecast.prob_contra      ?? NaN);

      if (!Number.isNaN(probFavor) && !Number.isNaN(probContra)) {
        // --- DIA ---
        if (!dayProb && !dayDetail) {
          if (probFavor >= probContra) {
            dayProb = probFavor;
            dayDetail =
              `Continuação a favor: ${probFavor}% · Contra: ${probContra}%.`;
          } else {
            dayProb = probContra;
            dayDetail =
              `Maior chance de contra-movimento: ${probContra}% · Continuação: ${probFavor}%.`;
          }
        }

        // --- MOMENTO (1–3 candles) ---
        if (!nowProb && !nowDetail) {
          if (probFavor >= probContra) {
            nowProb = probFavor;
            nowDetail =
              `Curto prazo favorece continuação (${probFavor}% vs ${probContra}% de contra).`;
          } else {
            nowProb = probContra;
            nowDetail =
              `Curto prazo favorece contra-movimento (${probContra}% vs ${probFavor}% de continuação).`;
          }
        }
      }
    }

    if (els.directionDayText && (dayProb || dayDetail)) {
      els.directionDayText.textContent =
        (dayProb ? dayProb + '% · ' : '') + (dayDetail || '');
    }

    if (els.directionNowText && (nowProb || nowDetail)) {
      els.directionNowText.textContent =
        (nowProb ? nowProb + '% · ' : '') + (nowDetail || '');
    }

    // Estrutura recente: HH / HL / LH / LL
    const structureRecent =
      panel.structure_recent ||
      panel.recent_structure ||
      panel.market_structure ||
      (panel.structure && panel.structure.recent) ||
      null;

    updateStructureUI(structureRecent);
    updateStructureZigzag(panel);

    // Textos principais
    const finalSummary =
      panel.summary ||
      panel.painel_terminal ||
      '—';

    const riskLevel =
  panel.risk_level ||
  aiAdvisor.risk_text ||
  aiAdvisor.risco ||
  panel.trade_card?.risk_text ||
  '—';

const riskComment =
  panel.risk_comment ||
  aiAdvisor.motivo ||
  aiAdvisor.motivo_pt ||
  panel.trade_card?.comment_pt ||
  panel.painel_terminal ||
  '—';


    const contextComment =
      panel.context_comment ||
      panel.painel_terminal ||
      '—';

    const executionPlan =
  panel.execution_plan ||
  aiAdvisor.acao_recomendada ||
  panel.trade_card?.direction_pt ||
  panel.trade_card?.direction_en ||
  '—';


    safeText(els.summary, finalSummary);
    setRiskPill(riskLevel);
    safeText(els.riskText, riskComment);
    safeText(els.contextText, contextComment);
    safeText(els.executionText, executionPlan);

    // AUTOPILOT CONTRACT: PANEL_UPDATE (MarketNow + P/L + R + EXIT_PENDING)
if (typeof apOnPanelUpdate === 'function') {
  apOnPanelUpdate(panel, { executionPlan, riskLevel, finalSummary });
}


    // MODO CEGO usa os mesmos textos (NUNCA pode quebrar o loadPanel)
try {
  applyHeroDecision(executionPlan, riskLevel, finalSummary);
} catch (e) {
  console.warn('[HERO] applyHeroDecision falhou, mas o painel continua:', e);
}

applyInstitutionalDecision(panel, executionPlan, riskLevel);



  } catch (err) {
    console.error('Erro ao carregar painel', err);
    if (els.errorBanner) {
      els.errorBanner.style.display = 'block';
      els.errorBanner.innerHTML =
        '<strong>Erro ao carregar painel.</strong> Verifique o webhook "aaron10_panel_json" no n8n e tente novamente.';
    }
  } finally {
    if (els.btnRefresh) els.btnRefresh.disabled = false;
  }
}

// ====== INICIALIZAÇÃO ======
// ========= AARON 10 – ALPACA CHART + STUDIES =========
let a10Chart = null;
let a10CandleSeries = null;
let a10Ema21Series = null;
let a10VwapSeries = null;
let a10PriceLines = {};
let a10LastPayloadKey = '';
// ========= A10 REALTIME STREAM (RELAY) =========
let a10Ws = null;
let a10WsRetryTimer = null;
let a10StreamSource = "payload"; // "payload" | "stream"
let a10LiveCandles = [];
let a10LastStudyRedrawMs = 0;

function a10GetSelSymbol(){
  return (localStorage.getItem('aaron_selected_symbol') || 'NVDA').toUpperCase().trim() || 'NVDA';
}
function a10GetSelTF(){
  return (localStorage.getItem('aaron_selected_tf') || A10_DEFAULT_TF || '1m').trim() || '1m';
}

function a10SetChartMeta(symbol, tf, extra){
  const metaEl = document.getElementById('chart-meta');
  const pill = document.getElementById('a10-feed-pill');
  if (pill) pill.textContent = `Fonte: Alpaca PRO (${String(A10_FEED || 'sip').toUpperCase()})`;
  if (metaEl) metaEl.textContent = `${symbol} · ${tf} · Alpaca ${String(extra||'').trim()}`.trim();
}

function a10ApplyCandlesSnapshot(candles, symbol, tf){
  a10InitChart();
  if (!a10Chart || !a10CandleSeries) return;

  a10StreamSource = "stream";
  a10LiveCandles = Array.isArray(candles) ? candles : [];
  a10CandleSeries.setData(a10LiveCandles);
  a10SetChartMeta(symbol, tf, "(live)");
  a10RedrawStudiesFromLive();
}

function a10UpsertCandle(bar){
  if (!bar || !Number.isFinite(bar.time)) return;

  const last = a10LiveCandles.length ? a10LiveCandles[a10LiveCandles.length-1] : null;
  if (!last || bar.time > last.time){
    a10LiveCandles.push(bar);
  } else if (bar.time === last.time){
    a10LiveCandles[a10LiveCandles.length-1] = bar;
  } else {
    return; // fora de ordem
  }

  if (a10CandleSeries) a10CandleSeries.update(bar);

  // redraw leve (no máx 1x por ~0.9s)
  const now = Date.now();
  if (now - a10LastStudyRedrawMs >= 900){
    a10LastStudyRedrawMs = now;
    a10RedrawStudiesFromLive();
  }
}

function a10RedrawStudiesFromLive(){
  try{
    if (!a10LiveCandles || !a10LiveCandles.length) return;
    const candles = a10LiveCandles;
    const t = a10ToggleState();

    if (a10Ema21Series){
      a10Ema21Series.applyOptions({ visible: t.ema21 });
      if (t.ema21) a10Ema21Series.setData(a10ComputeEMA(candles, 21));
    }

    if (a10VwapSeries){
      a10VwapSeries.applyOptions({ visible: t.vwap });
      if (t.vwap) a10VwapSeries.setData(a10ComputeVWAP(candles));
    }

    if (t.sessionHL){
      const hl = a10ComputeSessionHL(candles);
      if (hl){
        a10SetPriceLine('sessionHi', hl.hi, 'Session High', 'rgba(74,222,128,0.85)', 2);
        a10SetPriceLine('sessionLo', hl.lo, 'Session Low',  'rgba(248,113,113,0.85)', 2);
      }
    } else {
      a10ClearPriceLine('sessionHi');
      a10ClearPriceLine('sessionLo');
    }

    if (t.orb){
      const orb = a10ComputeORB(candles, 5);
      if (orb){
        a10SetPriceLine('orbHi', orb.hi, 'ORB High', 'rgba(34,211,238,0.85)', 1);
        a10SetPriceLine('orbLo', orb.lo, 'ORB Low',  'rgba(34,211,238,0.85)', 1);
      }
    } else {
      a10ClearPriceLine('orbHi');
      a10ClearPriceLine('orbLo');
    }
  }catch(e){}
}

function a10StopStream(){
  if (a10Ws){ try{ a10Ws.close(); }catch(e){} }
  a10Ws = null;
  if (a10WsRetryTimer){ clearTimeout(a10WsRetryTimer); a10WsRetryTimer = null; }
}

function a10StartStream(force){
  const symbol = a10GetSelSymbol();
  const tf = a10GetSelTF();

  // se ainda não tem relay online, não quebra o painel
  if (!A10_RELAY_WS_URL || A10_RELAY_WS_URL.includes('SEU-RELAY-DOMINIO')){
    a10SetChartMeta(symbol, tf, "(relay pendente)");
    return;
  }

  const url = `${A10_RELAY_WS_URL}?symbol=${encodeURIComponent(symbol)}&tf=${encodeURIComponent(tf)}&feed=${encodeURIComponent(A10_FEED || 'sip')}`;

  if (!force && a10Ws && a10Ws.readyState === 1) return;

  a10StopStream();
  a10SetChartMeta(symbol, tf, "conectando…");

  try{
    a10Ws = new WebSocket(url);
  }catch(e){
    a10SetChartMeta(symbol, tf, "WS inválido");
    return;
  }

  a10Ws.addEventListener('open', () => {
    a10SetChartMeta(symbol, tf, "(live)");
  });

  a10Ws.addEventListener('message', (ev) => {
    try{
      const msg = JSON.parse(ev.data);

      if (msg?.type === 'snapshot' && Array.isArray(msg.candles)){
        a10ApplyCandlesSnapshot(msg.candles, symbol, tf);
        return;
      }

      if (msg?.type === 'bar' && msg.bar){
        a10UpsertCandle(msg.bar);
        return;
      }
    }catch(e){}
  });

  a10Ws.addEventListener('close', () => {
    a10SetChartMeta(symbol, tf, "reconectando…");
    a10WsRetryTimer = setTimeout(() => a10StartStream(true), 1200);
  });

  a10Ws.addEventListener('error', () => {
    try{ a10Ws.close(); }catch(e){}
  });
}

function a10UnixSec(t) {
  if (typeof t === 'number') {
    if (t > 1e12) return Math.floor(t / 1000); // ms
    if (t > 1e10) return Math.floor(t / 1000); // ms (só garantia)
    return Math.floor(t); // sec
  }
  if (typeof t === 'string') {
    const ms = Date.parse(t);
    if (!Number.isNaN(ms)) return Math.floor(ms / 1000);
  }
  return null;
}

function a10ExtractCandles(payload) {
  const raw = payload?.raw || payload?.data || payload || {};
  const panel = payload?.panel || raw?.panel || {};

  const candidates = [
    raw?.intraday?.candles,
    raw?.intraday?.bars,
    raw?.candles,
    raw?.bars,
    panel?.intraday?.candles,
    panel?.candles,
    panel?.recent_candles,
    payload?.candles,
    payload?.bars,
  ];

  const arr = candidates.find((x) => Array.isArray(x)) || [];
  const out = [];

  for (const c of arr) {
    const time = a10UnixSec(c?.t ?? c?.time ?? c?.timestamp ?? c?.datetime);
    const open = Number(c?.o ?? c?.open);
    const high = Number(c?.h ?? c?.high);
    const low  = Number(c?.l ?? c?.low);
    const close= Number(c?.c ?? c?.close);
    const volume = Number(c?.v ?? c?.volume ?? 0);

    if (!time || !Number.isFinite(open) || !Number.isFinite(high) || !Number.isFinite(low) || !Number.isFinite(close)) continue;

    out.push({ time, open, high, low, close, volume });
  }

  out.sort((a, b) => a.time - b.time);
  return out;
}

function a10ComputeEMA(candles, period) {
  const alpha = 2 / (period + 1);
  let ema = null;
  const out = [];
  for (const c of candles) {
    ema = (ema == null) ? c.close : (c.close - ema) * alpha + ema;
    out.push({ time: c.time, value: ema });
  }
  return out;
}

function a10ComputeVWAP(candles) {
  let cumPV = 0;
  let cumV = 0;
  const out = [];

  for (const c of candles) {
    const v = c.volume || 0;
    if (!v) continue;

    const tp = (c.high + c.low + c.close) / 3;
    cumPV += tp * v;
    cumV += v;

    if (cumV > 0) out.push({ time: c.time, value: cumPV / cumV });
  }

  return out;
}

function a10IsETAfterOpen(unixSec) {
  // 09:30 ET (aprox via Intl)
  const d = new Date(unixSec * 1000);
  const parts = new Intl.DateTimeFormat('en-US', {
    timeZone: 'America/New_York',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).formatToParts(d);

  const hh = Number(parts.find(p => p.type === 'hour')?.value || 0);
  const mm = Number(parts.find(p => p.type === 'minute')?.value || 0);
  return (hh > 9) || (hh === 9 && mm >= 30);
}

function a10ComputeSessionHL(candles) {
  const sessionCandles = candles.filter(c => a10IsETAfterOpen(c.time));
  if (!sessionCandles.length) return null;

  let hi = -Infinity, lo = Infinity;
  for (const c of sessionCandles) {
    if (c.high > hi) hi = c.high;
    if (c.low  < lo) lo = c.low;
  }
  if (!Number.isFinite(hi) || !Number.isFinite(lo)) return null;
  return { hi, lo };
}

function a10ComputeORB(candles, minutes = 5) {
  // ORB: primeiros X minutos após 09:30 ET (assumindo 1m candles)
  const afterOpen = candles.filter(c => a10IsETAfterOpen(c.time));
  if (afterOpen.length < minutes) return null;

  const slice = afterOpen.slice(0, minutes);
  let hi = -Infinity, lo = Infinity;
  for (const c of slice) {
    if (c.high > hi) hi = c.high;
    if (c.low  < lo) lo = c.low;
  }
  if (!Number.isFinite(hi) || !Number.isFinite(lo)) return null;
  return { hi, lo };
}

function a10ToggleState() {
  return {
    sessionHL: !!document.getElementById('st-session-hl')?.checked,
    prevDay:   !!document.getElementById('st-prevday')?.checked,
    orb:       !!document.getElementById('st-orb')?.checked,
    vwap:      !!document.getElementById('st-vwap')?.checked,
    ema21:     !!document.getElementById('st-ema21')?.checked,
  };
}

function a10ClearPriceLine(key) {
  try {
    if (a10PriceLines[key] && a10CandleSeries) {
      a10CandleSeries.removePriceLine(a10PriceLines[key]);
    }
  } catch (e) {}
  a10PriceLines[key] = null;
}

function a10SetPriceLine(key, price, title, color, style) {
  a10ClearPriceLine(key);
  if (!a10CandleSeries || !Number.isFinite(price)) return;

  a10PriceLines[key] = a10CandleSeries.createPriceLine({
    price,
    title,
    color,
    lineWidth: 1,
    lineStyle: style, // 0 solid | 1 dotted | 2 dashed | 3 large dashed
    axisLabelVisible: true,
  });
}

function a10InitChart() {
  const el = document.getElementById('aaron10-chart');
  if (!el) return;
  if (a10Chart) return;
  if (!window.LightweightCharts) {
    console.warn('[A10] LightweightCharts não carregou.');
    return;
  }

     a10Chart = LightweightCharts.createChart(el, {
     layout: {
       attributionLogo: false, // <<< REMOVE o "TV" do canto
       background: { type: 'solid', color: '#020617' },
       textColor: '#e5e7eb',
     },
     grid: {
       vertLines: { color: 'rgba(148,163,184,0.08)' },
       horzLines: { color: 'rgba(148,163,184,0.08)' },
     },
     rightPriceScale: { borderColor: 'rgba(148,163,184,0.22)' },
     timeScale: { timeVisible: true, secondsVisible: false },
     crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
   });


  a10CandleSeries = a10Chart.addCandlestickSeries({
    upColor: '#4ade80',
    downColor: '#f97373',
    borderUpColor: '#4ade80',
    borderDownColor: '#f97373',
    wickUpColor: '#4ade80',
    wickDownColor: '#f97373',
  });

  a10Ema21Series = a10Chart.addLineSeries({ lineWidth: 2 });
  a10VwapSeries  = a10Chart.addLineSeries({ lineWidth: 2 });

  // Resize automático
  const ro = new ResizeObserver(() => {
    try {
      a10Chart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
    } catch (e) {}
  });
  ro.observe(el);
}

function a10UpdateChartFromPayload(payload) {
  try {
    // se o stream já está mandando candle live, não sobrescreve
    if (typeof a10StreamSource !== 'undefined' && a10StreamSource === 'stream') return;

    if (!payload) return;
    a10InitChart();
    if (!a10Chart || !a10CandleSeries) return;

    const panel = payload.panel || payload.raw?.panel || {};
    const symbol = panel.symbol || panel.ticker || payload.symbol || '—';
    const tfSel =
      (localStorage.getItem('aaron_selected_tf') || '').trim() ||
      panel.timeframe || panel.tf || panel.interval ||
      (typeof A10_DEFAULT_TF === 'string' ? A10_DEFAULT_TF : '1m');

    const metaEl = document.getElementById('chart-meta');
    if (metaEl) metaEl.textContent = `${symbol} · ${tfSel} · Alpaca`;

    const candles = a10ExtractCandles(payload);
    if (!candles.length) return;

    // evita reprocessar sem necessidade
    const last = candles[candles.length - 1];
    const key = `${symbol}|${tfSel}|${last?.time}|${last?.close}`;
    if (key === a10LastPayloadKey) return;
    a10LastPayloadKey = key;

    a10CandleSeries.setData(candles);

    const t = a10ToggleState();

    if (a10Ema21Series) {
      a10Ema21Series.applyOptions({ visible: t.ema21 });
      if (t.ema21) a10Ema21Series.setData(a10ComputeEMA(candles, 21));
    }

    if (a10VwapSeries) {
      a10VwapSeries.applyOptions({ visible: t.vwap });
      if (t.vwap) a10VwapSeries.setData(a10ComputeVWAP(candles));
    }

    if (t.sessionHL) {
      const hl = a10ComputeSessionHL(candles);
      if (hl) {
        a10SetPriceLine('sessionHi', hl.hi, 'Session High', 'rgba(74,222,128,0.85)', 2);
        a10SetPriceLine('sessionLo', hl.lo, 'Session Low',  'rgba(248,113,113,0.85)', 2);
      }
    } else {
      a10ClearPriceLine('sessionHi');
      a10ClearPriceLine('sessionLo');
    }

    if (t.orb) {
      const orb = a10ComputeORB(candles, 5);
      if (orb) {
        a10SetPriceLine('orbHi', orb.hi, 'ORB High', 'rgba(34,211,238,0.85)', 1);
        a10SetPriceLine('orbLo', orb.lo, 'ORB Low',  'rgba(34,211,238,0.85)', 1);
      }
    } else {
      a10ClearPriceLine('orbHi');
      a10ClearPriceLine('orbLo');
    }
  } catch (e) {
    console.warn('[A10] updateChart falhou (mas o painel continua):', e);
  }
}


function a10RefreshChart() {
  if (typeof a10StreamSource !== 'undefined' && a10StreamSource === 'stream') {
    a10RedrawStudiesFromLive();
    return;
  }
  a10LastPayloadKey = '';
  a10UpdateChartFromPayload(window.__AARON_LAST_PAYLOAD__);
}

function a10BindStudiesUI() {
  document.querySelectorAll('.pill-toggle input').forEach((el) => {
    el.addEventListener('change', () => a10RefreshChart());
  });
}

function a10BindTimeframesUI() {
  const wrap = document.getElementById('a10-tf');
  if (!wrap) return;

  const btns = Array.from(wrap.querySelectorAll('.a10-tf-btn'));
  const current =
    (localStorage.getItem('aaron_selected_tf') || A10_DEFAULT_TF || '1m').trim() || '1m';

  localStorage.setItem('aaron_selected_tf', current);
  btns.forEach(b => b.classList.toggle('active', b.dataset.tf === current));

  btns.forEach((b) => {
    b.addEventListener('click', () => {
      const tf = String(b.dataset.tf || '').trim();
      if (!tf) return;

      localStorage.setItem('aaron_selected_tf', tf);
      btns.forEach(x => x.classList.toggle('active', x.dataset.tf === tf));
      window.dispatchEvent(new CustomEvent('aaron:timeframeSelected', { detail: { timeframe: tf } }));
    });
  });
}


// ====== INICIALIZAÇÃO ======
function initAaron9() {
  // liga chart + estudos
  a10InitChart();
  a10BindStudiesUI();
  a10BindTimeframesUI();

  // sempre que o painel atualizar, atualiza o chart
  window.addEventListener('aaron:panelUpdated', () => {
    a10UpdateChartFromPayload(window.__AARON_LAST_PAYLOAD__);
  });

  // botão ATUALIZAR
  if (els.btnRefresh) {
    els.btnRefresh.addEventListener('click', function () {
      loadPanel(true);
    });
  }

  loadPanel(false);
  setInterval(() => loadPanel(false), REFRESH_MS);
}




// AUTOPILOT init
autopilot = apLoad();
apSyncUI();

function apArmFromButton(side) {
  // força o toggle visual ficar ON também
  if (els.apToggle && !els.apToggle.checked) {
    els.apToggle.checked = true;
  }

  apActivate(side); // seta enabled=true, salva e sincroniza UI

  // garante que o resto do painel atualiza imediatamente
  if (typeof loadPanel === 'function') loadPanel(false);
}


if (els.apToggle) {
  els.apToggle.addEventListener('change', () => {
    const turningOn = !!els.apToggle.checked;

    if (!turningOn) {
      apClose();          // ✅ contrato: OFF = reset total
      return;
    }

    // ON (armado, sem posição)
    autopilot = apLoad();
    autopilot.enabled = true;
    autopilot.active = false;
    autopilot.side = null;
    autopilot.entry = null;
    autopilot.startedAt = null;

    // ✅ garante “sem resquícios”
    autopilot.state = AP_STATES.FLAT;
    autopilot.snapshot = null;
    autopilot.exitPending = false;
    autopilot.marketNow = autopilot.marketNow ?? 'wait';

    apSave(autopilot);
    apSyncUI();
    if (typeof loadPanel === 'function') loadPanel(false);
  });
}


// ===== AUTOPILOT: handlers robustos (BUY/SELL armam o toggle e ativam) =====
const arm = (side) => {
  try {
    // liga o toggle (se existir)
    if (els.apToggle && !els.apToggle.checked) els.apToggle.checked = true;

    // ativa o autopilot no lado escolhido
    if (typeof apActivate === 'function') apActivate(side);

    // se você usa a função do contrato, pode chamar também:
    if (typeof apArmFromButton === 'function') apArmFromButton(side);

    // reflete na UI
    if (typeof apSyncUI === 'function') apSyncUI();

    // atualiza painel (se existir)
    if (typeof loadPanel === 'function') loadPanel(false);
  } catch (e) {
    console.error('[AP] erro ao armar:', e);
  }
};

if (els.apBuy) {
  els.apBuy.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    arm('buy');
  });
}

if (els.apSell) {
  els.apSell.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    arm('sell');
  });
}

if (els.apClose) {
  els.apClose.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    try {
      if (typeof apClose === 'function') apClose();
      if (els.apToggle) els.apToggle.checked = false;
      if (typeof apSyncUI === 'function') apSyncUI();
      if (typeof loadPanel === 'function') loadPanel(false);
    } catch (err) {
      console.error('[AP] erro no close:', err);
    }
  });
}


// AUTOPILOT 2.0: quando muda capital, recalcula units e reflete no Citadel
if (els.apCapital) {
  els.apCapital.addEventListener('input', () => {
    apRenderSizing();
    apSyncUI();
    if (typeof loadPanel === 'function') loadPanel(false);
  });
 }

// ================ TOGGLE DE IDIOMA PT / EN ==================

const I18N = {
  pt: {
    // TOPO
    'top.live_feed': 'FEED AO VIVO',
    'top.symbol': 'Símbolo',
    'top.timeframe': 'Timeframe',
    'top.session': 'Sessão',
    'top.last_update': 'Última atualização:',
    'top.refresh': 'ATUALIZAR',

        // GARIMPO DE HOJE
    'garimpo_badge': 'Garimpo de Hoje',
    'garimpo_best_label': 'Melhor ativo para hoje',
    'garimpo_metric_confidence': 'Confiança do cérebro',
    'garimpo_metric_gap': 'Gap',
    'garimpo_metric_premarket': 'Pré-market vs média',
    'garimpo_metric_atr': 'ATR% (volatilidade)',
    'garimpo_comment':
      'Hoje este é o ativo com melhor combinação de fluxo, liquidez e volatilidade para o seu perfil.',
    'garimpo_view_page': 'Ver página do garimpo',


    // RISCO · ATR
    'risk.title': 'Gerenciador de risco · ATR',
    'risk.subtitle': 'Ajuste os parâmetros do ATR e calcule risco / reward da operação.',
    'risk.toggle_open': 'Abrir',
    'risk.toggle_close': 'Fechar',

    // CARD TRADINGVIEW
    'card.tv_title': 'Painel de Preço em Tempo Real',
    'card.tv_sub': 'Alpaca PRO + Estrutura do Dia',


    // RESUMO INSTITUCIONAL
    'summary.title': 'Resumo institucional',
    'summary.subtitle': 'Leitura consolidada do AARON 9',
    'summary.risk_mgmt': 'Gestão de risco',

    // RADAR
    'radar.day_title': 'Direção geral do dia',
    'radar.now_title': 'Direção prevista · 1–3 candles',

    // OUTROS
    'comment.title': 'Comentário do Painel',
    'panel.risk_title': 'Risco',
    'panel.context_title': 'Contexto',
    'panel.execution_title': 'Execução',

    // PULLBACK
    'pullback.title': 'Pullback Brain · Zona de respiro',
    'pullback.depth': 'Profundidade',
    'pullback.quality': 'Qualidade',

        // SIZING BRAIN
    'sizing.title': 'Sizing Brain · Gestão de capital do dia',
    'sizing.target_label': 'Alvo razoável hoje',
    'sizing.max_dd': 'Máx. perda',
    'sizing.risk_trade': 'Risco / trade',
    'sizing.trades': 'Trades A+',
    'sizing.conservative': 'Conservador',
    'sizing.aggressive': 'Agressivo',

        // CARTÃO DE TRADE CITADEL
    'trade_card.title': 'AARON – Cartão de Trade Atual',
    'trade_card.status_label': 'Status:',
    'trade_card.stats_label': 'Estatística:',
    'trade_card.asset_label': 'Ativo:',
    'trade_card.timeframe_label': 'Timeframe:',
    'trade_card.mode_label': 'Modo:',
    'trade_card.against_label': 'Contra:',
    'trade_card.dir_label': 'Direção sugerida:',
    'trade_card.entry_label': 'Entrada:',
    'trade_card.stop_label': 'Stop:',
    'trade_card.tp_label': 'TP1:',
    'trade_card.size_label': 'Tamanho:',
    'trade_card.risk_label': 'Risco:',
    'trade_card.thermo_label': 'Termômetro:',
    'trade_card.comment_label': 'Comentário do AARON:',


  },

  en: {
    // TOP
    'top.live_feed': 'LIVE FEED',
    'top.symbol': 'Symbol',
    'top.timeframe': 'Timeframe',
    'top.session': 'Session',
    'top.last_update': 'Last update:',
    'top.refresh': 'REFRESH',

        // GARIMPO TODAY
    'garimpo_badge': 'Garimpo Today',
    'garimpo_best_label': 'Best asset for today',
    'garimpo_metric_confidence': 'Brain confidence',
    'garimpo_metric_gap': 'Gap',
    'garimpo_metric_premarket': 'Pre-market vs average',
    'garimpo_metric_atr': 'ATR% (volatility)',
    'garimpo_comment':
      'Today this is the asset with the best combination of flow, liquidity and volatility for your profile.',
    'garimpo_view_page': 'View Garimpo page',


    // RISK · ATR
    'risk.title': 'Risk manager · ATR',
    'risk.subtitle': 'Adjust ATR parameters and calculate trade risk / reward.',
    'risk.toggle_open': 'Open',
    'risk.toggle_close': 'Close',

    // TRADINGVIEW CARD
    'card.tv_title': 'Real-Time Price Panel',
    'card.tv_sub': 'Alpaca PRO + Daily Structure',

    // SUMMARY
    'summary.title': 'Institutional summary',
    'summary.subtitle': 'Consolidated reading from AARON 9',
    'summary.risk_mgmt': 'Risk management',

    // RADAR
    'radar.day_title': 'Overall direction of the day',
    'radar.now_title': 'Expected direction · 1–3 candles',

    // OTHERS
    'comment.title': 'Panel commentary',
    'panel.risk_title': 'Risk',
    'panel.context_title': 'Context',
    'panel.execution_title': 'Execution',

    // PULLBACK
    'pullback.title': 'Pullback Brain · Pullback zone',
    'pullback.depth': 'Depth',
    'pullback.quality': 'Quality',

        // SIZING BRAIN
    'sizing.title': 'Sizing Brain · Daily capital plan',
    'sizing.target_label': 'Reasonable target today',
    'sizing.max_dd': 'Max loss',
    'sizing.risk_trade': 'Risk / trade',
    'sizing.trades': 'A+ trades',
    'sizing.conservative': 'Conservative',
    'sizing.aggressive': 'Aggressive',

        // CITADEL TRADE CARD
    'trade_card.title': 'AARON – Current Trade Card',
    'trade_card.status_label': 'Status:',
    'trade_card.stats_label': 'Statistics:',
    'trade_card.asset_label': 'Asset:',
    'trade_card.timeframe_label': 'Timeframe:',
    'trade_card.mode_label': 'Mode:',
    'trade_card.against_label': 'Against:',
    'trade_card.dir_label': 'Suggested direction:',
    'trade_card.entry_label': 'Entry:',
    'trade_card.stop_label': 'Stop:',
    'trade_card.tp_label': 'TP1:',
    'trade_card.size_label': 'Size:',
    'trade_card.risk_label': 'Risk:',
    'trade_card.thermo_label': 'Thermometer:',
    'trade_card.comment_label': 'AARON\'s comment:',


  },
};

// currentLang já foi definido no topo do <script> (ANTES de qualquer apSyncUI/loadPanel)
currentLang = window.currentLang || currentLang || 'pt';


function applyLang(lang) {
  const dict = I18N[lang] || I18N.pt;
  currentLang = lang;
  window.currentLang = currentLang;
  try { localStorage.setItem('AARON_LANG', currentLang); } catch(e) {}


  // troca TODO elemento com data-i18n
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    const txt = dict[key];
    if (txt) el.textContent = txt;
  });

  // pill de estado (AGUARDANDO / WAITING)
  const statePill = document.getElementById('state-pill');
  if (statePill) {
    statePill.textContent = lang === 'en' ? 'WAITING' : 'AGUARDANDO';
  }

  // botão refresh
  const btnRefresh = document.getElementById('btn-refresh');
  if (btnRefresh) {
    btnRefresh.textContent =
      dict['top.refresh'] || (lang === 'en' ? 'REFRESH' : 'ATUALIZAR');
  }

  // texto de "Abrir / Fechar" do card ATR, se já estiver aberto
  const atrToggle = document.getElementById('atr-risk-toggle');
  const atrBody = document.getElementById('atr-risk-body');
  if (atrToggle && atrBody) {
    const isOpen = atrBody.style.display && atrBody.style.display !== 'none';
    if (isOpen) {
      atrToggle.textContent =
        dict['risk.toggle_close'] || (lang === 'en' ? 'Close' : 'Fechar');
    } else {
      atrToggle.textContent =
        dict['risk.toggle_open'] || (lang === 'en' ? 'Open' : 'Abrir');
    }
  }

  // re-renderiza o Pullback Brain no idioma atual
  if (typeof updatePullbackBrain === 'function') {
    updatePullbackBrain(lastPullbackBrain);
  }
  if (typeof updateSizingBrain === 'function') {
    updateSizingBrain(lastSizingBrain);
  }
  if (typeof updateSizingPhrase === 'function') {
    updateSizingPhrase();
  }

  // re-renderiza o Garimpo de Hoje no idioma atual (PT / EN)
  if (typeof updateGarimpoTodayCard === 'function' &&
      typeof garimpoTodayData !== 'undefined') {
    updateGarimpoTodayCard(garimpoTodayData);
  }
}


 // ====== SIZING BRAIN – CÁLCULO LOCAL DO GERENCIADOR DE RISCO ======
function recalcSizingBrainLocal() {
  if (!sbEls.card) return;

  function num(el) {
    if (!el) return 0;
    const raw = (el.value || '').toString().replace(',', '.');
    const v = Number(raw);
    return Number.isFinite(v) ? v : 0;
  }

  const account = num(sbEls.accountBalance);    // Capital real da conta
  const lev     = num(sbEls.leverage);         // Alavancagem x
  const tradeCap= num(sbEls.tradeCapital);     // Capital em uso neste trade
  const riskPct = num(sbEls.riskPercentInput); // Risco máx. por trade (% conta)
  const entry   = num(sbEls.entryPrice);       // Preço de entrada
  const atr     = num(sbEls.atrValue);         // ATR atual ($)
  const multStop= num(sbEls.atrMultStop) || 1; // Mult ATR STOP
  const multTake= num(sbEls.atrMultTake) || (multStop * 2); // Mult ATR TAKE

  // lado: long / short
  let side = 'long';
  if (sbEls.sideRadios && sbEls.sideRadios.length) {
    sbEls.sideRadios.forEach(r => {
      if (r.checked) side = r.value;
    });
  }

  const statusEl = sbEls.status;
  function setStatus(msg) {
    if (statusEl) statusEl.textContent = msg;
  }

  // validações básicas
  if (!account || !riskPct || !entry || !atr || !multStop) {
    setStatus('Preencha capital, risco, preço de entrada, ATR e multiplicadores para calcular.');
    return;
  }

  // distância do stop e do alvo em dólares por share
  const stopDist = atr * multStop;
  const takeDist = atr * multTake;

  // base de capital para limitar o tamanho (EM USO se tiver, senão conta × alavancagem, senão só conta)
  let baseCapital = 0;
  if (tradeCap > 0) {
    baseCapital = tradeCap;
  } else if (account > 0 && lev > 0) {
    baseCapital = account * lev;
  } else {
    baseCapital = account;
  }

  // risco máximo em dinheiro (por trade) baseado % da conta real
  const maxRiskMoney = account * (riskPct / 100);

  // tamanho de posição pelo risco e pelo capital
  const sharesByRisk    = maxRiskMoney / stopDist;
  const sharesByCapital = baseCapital && entry ? baseCapital / entry : sharesByRisk;
  let shares = Math.floor(Math.min(sharesByRisk, sharesByCapital));

  if (!Number.isFinite(shares) || shares <= 0) {
    setStatus('Verifique os valores: o risco em dólares precisa ser maior que a distância do stop.');
    return;
  }

  // preços de stop e take
  const stopPrice = side === 'short'
    ? entry + stopDist
    : entry - stopDist;

  const takePrice = side === 'short'
    ? entry - takeDist
    : entry + takeDist;

  // risco real com a quantidade ajustada
  const realRiskMoney = shares * stopDist;
  const realRiskPct   = account ? (realRiskMoney / account) * 100 : 0;

  // ==== atualiza os textos do card ====
  if (sbEls.outStopDistance)
    sbEls.outStopDistance.textContent = `Distância do STOP: ${stopDist.toFixed(2)} USD`;

  if (sbEls.outStopPrice)
    sbEls.outStopPrice.textContent = `Stop Loss sugerido: ${stopPrice.toFixed(2)}`;

  if (sbEls.outTakePrice)
    sbEls.outTakePrice.textContent = `Take Profit sugerido: ${takePrice.toFixed(2)}`;

  if (sbEls.outPositionSize)
    sbEls.outPositionSize.textContent = `Qtd sugerida: ${shares.toFixed(0)}`;

  if (sbEls.outRiskDollar)
    sbEls.outRiskDollar.textContent = `Risco aprox.: $ ${realRiskMoney.toFixed(2)}`;

    if (sbEls.outRiskPercent)
    sbEls.outRiskPercent.textContent =
      `Risco % trade / conta: ${realRiskPct.toFixed(2)}%`;

  setStatus(
    `Ok: ${shares.toFixed(0)} shares, risco ≈ ${realRiskPct.toFixed(2)}% (${realRiskMoney.toFixed(2)} USD).`
  );

  // NOVO · Termômetro offline do gerenciador de risco
  const sbMeterFill  = document.getElementById('sb-meter-fill');
  const sbMeterLabel = document.getElementById('sb-meter-label');
  if (sbMeterFill && sbMeterLabel) {
    // ratio = quanto do risco planejado você está usando
    const ratio = riskPct > 0 ? realRiskPct / riskPct : 0; // 1 = exatamente o risco que você planejou
    let score   = ratio * 100;                             // transforma em "porcentagem de uso"
    score       = Math.max(0, Math.min(130, score));       // trava para não explodir
    const width = Math.max(8, Math.min(100, score));       // largura da barra

    sbMeterFill.style.width = width.toFixed(0) + '%';

    sbMeterFill.classList.remove('safe', 'warn', 'danger');
    if (ratio <= 0.6) {
      sbMeterFill.classList.add('safe');    // bem conservador
    } else if (ratio <= 1.0) {
      sbMeterFill.classList.add('warn');    // perto do limite planejado
    } else {
      sbMeterFill.classList.add('danger');  // acima do risco planejado
    }

    sbMeterLabel.textContent =
      (currentLang === 'en'
        ? `Risk usage ${realRiskPct.toFixed(2)}% (plan ${riskPct.toFixed(2)}%)`
        : `Uso de risco ${realRiskPct.toFixed(2)}% (alvo ${riskPct.toFixed(2)}%)`);
  }

  // Alimenta o bloco de baixo (Aaron Pine) com a distância do stop em USD/share
  if (els.sizingStopInput) {
    els.sizingStopInput.value = stopDist.toFixed(2);
    if (typeof updateSizingPhrase === 'function') {
      updateSizingPhrase();
    }
  }
}
   
// conecta o botão "Recalcular Sizing" ao cálculo local
if (sbEls.calcBtn) {
  sbEls.calcBtn.addEventListener('click', function (ev) {
    ev.preventDefault();
    recalcSizingBrainLocal();
  });
}


// liga o toggle dos botões PT / EN
const langToggleEl = document.getElementById('lang-toggle');
if (langToggleEl) {
  langToggleEl.addEventListener('click', (ev) => {
    const btn = ev.target.closest('.lang-btn');
    if (!btn) return;

    const lang = btn.getAttribute('data-lang');
    if (!lang) return;

    langToggleEl.querySelectorAll('.lang-btn').forEach((b) =>
      b.classList.remove('active')
    );
    btn.classList.add('active');

    applyLang(lang);
  });
}

// idioma inicial (puxa do localStorage via currentLang)
applyLang(currentLang);


// garante que roda depois que o DOM existe
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initAaron9);
} else {
  initAaron9();
}

   // ================== GARIMPO DE HOJE - DADOS EXEMPLO ==================
let lastGarimpoToday = null;

function updateGarimpoTodayCard(data) {
  lastGarimpoToday = data || null;

  const tickerEl = document.getElementById('garimpo-ticker');
  const profileEl = document.getElementById('garimpo-profile');
  const gapEl = document.getElementById('garimpo-gap');
  const pmEl = document.getElementById('garimpo-premarket');
  const atrEl = document.getElementById('garimpo-atr');
  const confEl = document.getElementById('garimpo-confidence');

  if (!tickerEl) return;

  const d = data || {};
  const lang = (window.currentLang === 'en' ? 'en' : 'pt');

  const profile =
    (d.profile && typeof d.profile === 'object')
      ? (d.profile[lang] || d.profile.pt || '—')
      : (d.profile || '—');

  tickerEl.textContent = d.ticker || '—';
  if (profileEl) profileEl.textContent = profile;
  if (gapEl) gapEl.textContent = d.gapPct || '—';
  if (pmEl) pmEl.textContent = d.preMarketRatio || '—';
  if (atrEl) atrEl.textContent = d.atrPct || '—';
  if (confEl) confEl.textContent = d.confidence || '—';
}

// chamada inicial (vazio até chegar JSON do n8n)
updateGarimpoTodayCard(null);


// ================== GARIMPO DE HOJE - TEXTOS PT/EN =================
if (typeof I18N !== 'undefined' && I18N.pt && I18N.en) {
  Object.assign(I18N.pt, {
    garimpo_badge: 'Garimpo de Hoje',
    garimpo_best_label: 'Melhor ativo para hoje',
    garimpo_comment:
      'Hoje este é o ativo com melhor combinação de fluxo, liquidez e volatilidade para o seu perfil.',
    garimpo_metric_gap: 'Gap',
    garimpo_metric_premarket: 'Pré-market vs média',
    garimpo_metric_atr: 'ATR% (volatilidade)',
    garimpo_metric_confidence: 'Confiança do cérebro',
    garimpo_btn_full: 'Ver página do garimpo',
  });

  Object.assign(I18N.en, {
    garimpo_badge: "Today's Mining Pick",
    garimpo_best_label: 'Best stock to trade today',
    garimpo_comment:
      "Today this is the asset with the best combination of flow, liquidity and volatility for your profile.",
    garimpo_metric_gap: 'Gap',
    garimpo_metric_premarket: 'Pre-market vs avg.',
    garimpo_metric_atr: 'ATR% (volatility)',
    garimpo_metric_confidence: "Brain's confidence",
    garimpo_btn_full: 'Open full mining page',
  });
}

    function openGarimpoPage() {
  // Se o arquivo da página com os 4 quadros se chamar garimpo.html
  window.location.href = 'garimpo.html';
}


// ================== FIM GARIMPO DE HOJE ==================
</script>
<script>
/* ===================== MATCHER PICKER (AUTO PILOT LOOK) ===================== */
(function matcherPicker_addOnly(){
  if (window.__AARON_MATCHER_PICKER_INSTALLED__) return;
  window.__AARON_MATCHER_PICKER_INSTALLED__ = true;

  const DEFAULT_SYMBOLS = ['NVDA','TSLA','AMD','AAPL','MSFT','AMZN','META','GOOGL','NFLX','SPY','QQQ','IWM','PLTR'];

  const SYMBOLS =
    (Array.isArray(window.AARON_SYMBOLS) && window.AARON_SYMBOLS.length)
      ? window.AARON_SYMBOLS
      : DEFAULT_SYMBOLS;

  function injectStyles(){
    const id = "aaron-matcher-picker-style";
    if (document.getElementById(id)) return;

    const style = document.createElement("style");
    style.id = id;
    style.textContent = `
      /* ====== MATCHER com o mesmo “DNA” do AUTOPILOT v2 ====== */
      #matcher-picker.autopilot-v2{
        padding: 14px;
        border: 1px solid rgba(148,163,184,0.18);
        background:
          radial-gradient(1200px 500px at 20% 0%, rgba(56,189,248,0.10), transparent 60%),
          radial-gradient(900px 420px at 85% 10%, rgba(34,197,94,0.08), transparent 55%),
          rgba(2,6,23,0.35);
      }

      #matcher-picker .ap2-top{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-bottom:10px;
      }

      #matcher-picker .ap2-sub{
        margin-top:2px;
        font-size:0.78rem;
        opacity:0.75;
      }

      #matcher-picker .ap2-controls{
        display:flex;
        align-items:center;
        gap:10px;
      }

      #matcher-picker .ap2-sizing{
        margin: 10px 0 12px 0;
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(148,163,184,0.16);
        background: rgba(0,0,0,0.18);
        box-shadow: inset 0 0 0 1px rgba(2,6,23,0.15);
      }

      #matcher-picker .ap2-input-row{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      @media (max-width: 520px){
        #matcher-picker .ap2-input-row{ grid-template-columns: 1fr; }
      }

      #matcher-picker .ap2-field{
        display:flex;
        flex-direction: column;
        gap: 6px;
      }

      #matcher-picker .ap2-label{
        font-size: 0.72rem;
        opacity: .78;
        letter-spacing: .08em;
        text-transform: uppercase;
      }

      #matcher-picker .ap2-input{
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148,163,184,0.20);
        background: rgba(2,6,23,0.35);
        color: rgba(226,232,240,0.96);
        outline: none;
      }

      #matcher-picker .ap2-input:focus{
        border-color: rgba(34,211,238,0.45);
        box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
      }

      /* select com cara “premium” (seta discreta) */
      #matcher-picker select.ap2-input{
        appearance:none;
        padding-right: 34px;
        background-image:
          linear-gradient(45deg, transparent 50%, rgba(148,163,184,0.85) 50%),
          linear-gradient(135deg, rgba(148,163,184,0.85) 50%, transparent 50%);
        background-position:
          calc(100% - 16px) 50%,
          calc(100% - 11px) 50%;
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }

      /* evita cortar o popup */
#matcher-picker.autopilot-v2{ overflow: visible; }

/* força dark widgets quando possível */
#matcher-picker{ color-scheme: dark; }

/* esconde o select nativo */
#matcher-picker .ap2-field{ position:relative; }
#matcher-picker .mp-native-select{
  position:absolute;
  width:1px; height:1px;
  opacity:0;
  pointer-events:none;
}

/* dropdown custom (lista bonita) */
#matcher-picker .ap2-select{ position:relative; }
#matcher-picker .ap2-select-btn{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  cursor:pointer;
}
#matcher-picker #mp-symbol-text{
  font-weight: 900;
  letter-spacing: .04em;
}

/* caret */
#matcher-picker .ap2-caret{
  width: 9px; height: 9px;
  transform: rotate(45deg);
  border-right: 2px solid rgba(148,163,184,0.85);
  border-bottom: 2px solid rgba(148,163,184,0.85);
  opacity: .9;
  margin-right: 2px;
}
#matcher-picker .ap2-select.open .ap2-caret{
  transform: rotate(-135deg);
}

/* popup */
#matcher-picker .ap2-pop{
  position:absolute;
  left:0; right:0;
  top: calc(100% + 8px);
  z-index: 99999;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.22);
  background: rgba(2,6,23,0.92);
  backdrop-filter: blur(10px);
  box-shadow:
    0 18px 50px rgba(0,0,0,0.55),
    inset 0 0 0 1px rgba(56,189,248,0.10);
  display:none;
}
#matcher-picker .ap2-select.open .ap2-pop{ display:block; }

#matcher-picker .ap2-select-search{
  width:100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148,163,184,0.20);
  background: rgba(15,23,42,0.55);
  color: rgba(226,232,240,0.96);
  outline:none;
}
#matcher-picker .ap2-select-search:focus{
  border-color: rgba(34,211,238,0.45);
  box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
}

#matcher-picker .ap2-list{
  margin-top: 8px;
  max-height: 260px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap: 6px;
  padding-right: 4px;
}

#matcher-picker .ap2-opt{
  width:100%;
  text-align:left;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148,163,184,0.10);
  background: rgba(15,23,42,0.22);
  color: rgba(226,232,240,0.95);
  cursor:pointer;
  font-weight: 800;
  letter-spacing: .06em;
  transition: transform .08s ease, background .12s ease, border-color .12s ease;
}
#matcher-picker .ap2-opt:hover{
  background: rgba(56,189,248,0.12);
  border-color: rgba(56,189,248,0.26);
}
#matcher-picker .ap2-opt:active{ transform: translateY(1px); }

#matcher-picker .ap2-opt.active{
  background: rgba(34,197,94,0.12);
  border-color: rgba(34,197,94,0.32);
}

/* scrollbar (chrome) */
#matcher-picker .ap2-list::-webkit-scrollbar{ width: 10px; }
#matcher-picker .ap2-list::-webkit-scrollbar-thumb{
  background: rgba(148,163,184,0.22);
  border-radius: 999px;
}


      #matcher-picker .mp-hint{
        margin-top:10px;
        font-size: 11px;
        opacity: .85;
        color: rgba(148,163,184,0.90);
      }

      #matcher-picker .ap2-bottom{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
      }

      /* ap-btn existe global, mas o “premium” do autopilot é ID-scoped.
         Então replicamos o ajuste aqui também: */
      #matcher-picker .ap-btn{
        border-radius: 14px;
        padding: 9px 12px;
        letter-spacing: .6px;
        background: rgba(15,23,42,0.25);
        border-color: rgba(148,163,184,0.28);
      }

      #matcher-picker .ap-btn:active{
        transform: translateY(1px);
      }

      /* alinha o “Preço” como no print */
      #matcher-picker #mp-price{
        text-align:right;
        font-weight:900;
      }
    `;
    document.head.appendChild(style);
  }

  function buildBlock(){
    const row = document.createElement("div");
    row.id = "matcher-picker-row";

    row.innerHTML = `
      <section id="matcher-picker" class="decision-card autopilot-v2" aria-label="Matcher Symbol Picker">
        <div class="ap2-top">
          <div>
            <div class="decision-title">MATCHER • SYMBOL</div>
            <div class="ap2-sub">Escolha 1 ativo para enviar ao workflow X</div>
          </div>

          <div class="ap2-controls">
            <div class="badge-outline" title="Somente seleção (não altera o painel)">
              <span class="dot"></span>
              <span>Selector</span>
            </div>
          </div>
        </div>

        <div class="ap2-sizing">
          <div class="ap2-input-row">
            <div class="ap2-field">
  <label class="ap2-label" for="mp-symbol-btn">Ativo</label>

  <!-- select real (mantém compatibilidade), mas invisível -->
  <select id="mp-symbol" class="ap2-input mp-native-select" aria-hidden="true" tabindex="-1"></select>

  <!-- dropdown bonito -->
  <div class="ap2-select" id="mp-symbol-dd">
    <button id="mp-symbol-btn"
            class="ap2-input ap2-select-btn"
            type="button"
            aria-haspopup="listbox"
            aria-expanded="false">
      <span id="mp-symbol-text">—</span>
      <span class="ap2-caret" aria-hidden="true"></span>
    </button>

    <div id="mp-symbol-pop" class="ap2-pop" role="listbox" aria-label="Ativos">
      <input id="mp-symbol-search"
             class="ap2-select-search"
             type="text"
             placeholder="Buscar..."
             autocomplete="off" />
      <div class="ap2-list" id="mp-symbol-list"></div>
    </div>
  </div>
</div>


            <div class="ap2-field">
              <label class="ap2-label" for="mp-price">Preço</label>
              <input id="mp-price" class="ap2-input" type="text" value="—" readonly />
            </div>
          </div>

          <div class="mp-hint">Evento: <code>aaron:symbolSelected</code></div>
        </div>

        <div class="ap2-bottom">
          <button class="ap-btn" id="mp-copy" type="button">Copiar símbolo</button>
        </div>
      </section>
    `;
    return row;
  }

  function getQuote(symbol){
    const q = (window.AARON_QUOTES && window.AARON_QUOTES[symbol]) ? window.AARON_QUOTES[symbol] : null;
    if (q && typeof q.price === "number") return q.price;

    const p = window.__AARON_LAST_PANEL_JSON__;
    if (p){
      const pSym = (p.symbol || p.ticker || (p.trade && p.trade.symbol) || (p.execution && p.execution.symbol));
      const pPrice = p.price ?? p.last_price ?? (p.trade && (p.trade.price || p.trade.last_price));
      if (pSym && String(pSym).toUpperCase().includes(symbol) && typeof pPrice === "number") return pPrice;
    }
    return null;
  }

  function refreshPrice(priceEl, symbol){
    const v = getQuote(symbol);
    priceEl.value = (typeof v === "number") ? v.toFixed(2) : "—";
  }

  function emit(symbol, priceEl){
    localStorage.setItem("aaron_selected_symbol", symbol);
    window.AARON_SELECTED_SYMBOL = symbol;

    window.dispatchEvent(new CustomEvent("aaron:symbolSelected", { detail: { symbol } }));
    refreshPrice(priceEl, symbol);
  }

  function install(){
    injectStyles();
    if (document.getElementById("matcher-picker-row")) return;

    const row = buildBlock();

    // âncora: COLUNA DIREITA, antes do primeiro card (Resumo institucional)
    const cols = document.querySelectorAll("main.layout > section.column");
    const rightCol = (cols && cols.length >= 2) ? cols[1] : null;
    if (!rightCol) return;

    const firstCard = rightCol.querySelector(".card, .decision-card") || rightCol.firstElementChild;
    if (firstCard) firstCard.insertAdjacentElement("beforebegin", row);
    else rightCol.appendChild(row);

    const sel = row.querySelector("#mp-symbol");
    const priceEl = row.querySelector("#mp-price");
    const copyBtn = row.querySelector("#mp-copy");

    SYMBOLS.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sel.appendChild(opt);
    });

    const saved = localStorage.getItem("aaron_selected_symbol");
    if (saved && SYMBOLS.includes(saved)) sel.value = saved;

    sel.addEventListener("change", () => emit(sel.value, priceEl));

    // ===== dropdown bonito (espelha o <select>) =====
const dd = row.querySelector("#mp-symbol-dd");
const btn = row.querySelector("#mp-symbol-btn");
const txt = row.querySelector("#mp-symbol-text");
const search = row.querySelector("#mp-symbol-search");
const list = row.querySelector("#mp-symbol-list");

function closeDD(){
  dd.classList.remove("open");
  btn.setAttribute("aria-expanded", "false");
}

function openDD(){
  dd.classList.add("open");
  btn.setAttribute("aria-expanded", "true");
  search.value = "";
  renderOptions("");
  setTimeout(() => search.focus(), 0);
}

function renderOptions(filter){
  const f = String(filter || "").trim().toUpperCase();
  list.innerHTML = "";
  SYMBOLS
    .filter(s => !f || s.includes(f))
    .forEach(s => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "ap2-opt" + (s === sel.value ? " active" : "");
      b.setAttribute("role", "option");
      b.setAttribute("aria-selected", s === sel.value ? "true" : "false");
      b.textContent = s;
      b.addEventListener("click", () => {
        sel.value = s;           // espelha no select real
        txt.textContent = s;     // atualiza UI
        emit(s, priceEl);        // mantém teu comportamento
        closeDD();
      });
      list.appendChild(b);
    });
}

btn.addEventListener("click", () => {
  dd.classList.contains("open") ? closeDD() : openDD();
});

btn.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " " || e.key === "ArrowDown") {
    e.preventDefault();
    openDD();
  }
  if (e.key === "Escape") {
    e.preventDefault();
    closeDD();
  }
});

search.addEventListener("input", () => renderOptions(search.value));
search.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    e.preventDefault();
    closeDD();
    btn.focus();
  }
});

// fecha clicando fora
document.addEventListener("pointerdown", (e) => {
  if (!dd.contains(e.target)) closeDD();
}, { capture: true });

// inicializa texto + lista
txt.textContent = sel.value || "—";
renderOptions("");
// ===== /dropdown bonito =====


    copyBtn.addEventListener("click", () => {
      const symbol = sel.value;
      navigator.clipboard?.writeText(symbol).then(() => {
        copyBtn.textContent = "Copiado ✓";
        setTimeout(() => copyBtn.textContent = "Copiar símbolo", 900);
      }).catch(() => {
        const ta = document.createElement("textarea");
        ta.value = symbol;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      });
    });

    emit(sel.value, priceEl);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", install);
  } else {
    install();
  }
})();
</script>



</body>
</html>