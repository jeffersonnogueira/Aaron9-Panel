<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>AARON 9 ‚Äì Painel Institucional em Tempo Real </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --card: #020617;
      --card-border: #1f2937;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.12);
      --danger: #f97373;
      --success: #4ade80;
      --text-soft: #9ca3af;
      --text-main: #e5e7eb;
      --error: #f97373;
    }

    * {
      box-sizing: border-box;
    }

   body {
  margin: 0;
  padding: 0;
  background: #020617;
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  overflow-x: hidden;
}


/* wrapper principal da p√°gina */
.app-shell {
  min-height: 100vh;
  display: flex;
  justify-content: flex-start;  /* fica encostado √† esquerda */
}

.app-inner {
  width: 100%;
  max-width: 100%;              /* tira o limite de 1680px */
  margin: 16px 24px 32px 24px;  /* margens finas s√≥ pra n√£o colar na borda */
}


 .page{
  min-height: 100vh;
  width: 100%;
  max-width: none;            /* remove o limite (some o vazio lateral) */
  margin: 0;                  /* para de centralizar com ‚Äúauto‚Äù */
  padding: 16px 24px 32px 24px; /* mant√©m respiro nas bordas */
  display: flex;
  flex-direction: column;
  gap: 10px;
}




    /* TOPO / HEADER */

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(34, 211, 238, 0.12), transparent 55%);
      border: 1px solid rgba(31, 41, 55, 0.95);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.85);
      position: relative;
      overflow: hidden;
    }

    .top-bar::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0 0, rgba(34, 211, 238, 0.3), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(59, 130, 246, 0.25), transparent 60%);
      opacity: 0.75;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .top-left,
    .top-right {
      position: relative;
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 14px;
      align-items: center;
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--text-soft);
    }

    .brand-title span {
      color: var(--accent);
    }

        /* === The Six Seats ‚Äì logo no topo === */
    .brand-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .brand-logo-img {
      height: 34px;        /* aumenta/diminui o tamanho aqui */
      width: auto;
      filter: drop-shadow(0 0 12px rgba(248, 250, 252, 0.85));
    }

    .brand-logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
    }

    .brand-logo-main {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .brand-logo-sub {
      font-size: 9px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--text-soft);
    }


    .status-dot-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(248, 113, 113, 0.12);
      border: 1px solid rgba(248, 113, 113, 0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #fecaca;
    }

    .status-dot-live::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97373;
      box-shadow: 0 0 14px rgba(239, 68, 68, 0.9);
    }

    .pill-small {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .pill-small strong {
      color: var(--text-main);
      font-weight: 500;
      margin-left: 3px;
    }
/* === TIMEFRAME PICKER (AARON10) === */
.tf-picker{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:2px 6px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.35);
  background: rgba(2, 6, 23, 0.6);
}

.tf-btn{
  appearance:none;
  border:0;
  cursor:pointer;
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  letter-spacing:0.12em;
  text-transform:uppercase;
  color: var(--text-soft);
  background: transparent;
  transition: transform .12s ease, background .12s ease, color .12s ease, box-shadow .12s ease;
}

.tf-btn:hover{
  transform: translateY(-1px);
  background: rgba(148,163,184,0.12);
  color: var(--text-main);
}

.tf-btn.active{
  background: rgba(34,211,238,0.22);
  border:1px solid rgba(34,211,238,0.55);
  color:#e0f2fe;
  box-shadow: 0 0 0 1px rgba(34,211,238,0.15), 0 10px 24px rgba(34,211,238,0.12);
}

    .pill-state {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.8);
      background: rgba(8, 47, 73, 0.85);
      color: #e0f2fe;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-state::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22d3ee;
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.9);
    }

    .pill-soft {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.85);
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .pill-soft strong {
      color: var(--text-main);
      font-weight: 500;
      margin-left: 4px;
    }

    .pill-soft-accent {
      border-color: rgba(34, 211, 238, 0.85);
      color: #e0f2fe;
    }

    .btn-refresh {
      position: relative;
      z-index: 1;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.7);
      background: radial-gradient(circle at top, rgba(34, 211, 238, 0.2), rgba(15, 23, 42, 0.9));
      color: #e0f2fe;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      cursor: pointer;
    }

    .btn-refresh::before {
      content: "‚ü≥";
      font-size: 12px;
    }

    .btn-refresh[disabled] {
      opacity: 0.5;
      cursor: default;
    }
        .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      margin-right: 6px;
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 999px;
      cursor: pointer;
    }

    .lang-btn.active {
      background: rgba(34, 211, 238, 0.16);
      color: #e0f2fe;
    }


    /* BANNER ERRO */

    .error-banner {
      display: none;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(248, 113, 113, 0.8);
      background: rgba(127, 29, 29, 0.3);
      color: #fecaca;
      font-size: 12px;
    }

    .error-banner strong {
      color: #fee2e2;
    }

    /* LAYOUT PRINCIPAL */

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 12px;
      align-items: flex-start;
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      position: relative;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(3, 7, 18, 0.98));
      border: 1px solid rgba(30, 64, 175, 0.9);
      box-shadow:
        0 18px 42px rgba(15, 23, 42, 0.95),
        0 0 28px rgba(15, 23, 42, 0.9);
      padding: 12px 14px;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(34, 211, 238, 0.12), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card-header {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge-outline {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      gap: 6px;
    }

    .badge-outline.green {
      border-color: rgba(74, 222, 128, 0.8);
      color: #bbf7d0;
    }

    .badge-outline.red {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    .badge-outline span.dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: currentColor;
      box-shadow: 0 0 10px currentColor;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 10px;
    }

    .panel-section {
      position: relative;
      z-index: 1;
      padding: 10px 10px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(30, 64, 175, 0.8);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      margin-bottom: 8px;
    }

    .panel-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .panel-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }
/* ====== AARON CHART + STUDIES (ALPACA) ====== */
.aaron-studies{
  margin-top: 8px;
  padding: 8px;
  border-radius: 12px;
  border: 1px solid rgba(148, 163, 184, 0.18);
  background: rgba(2, 6, 23, 0.55);
}

.aaron-studies-title{
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: var(--text-soft);
  margin-bottom: 8px;
}

.aaron-studies-pills{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.pill-toggle{
  display: inline-flex;
  align-items: center;
  cursor: pointer;
  user-select: none;
}

.pill-toggle input{
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.pill-toggle span{
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.75);
  color: var(--text-soft);
  font-size: 11px;
  letter-spacing: 0.06em;
  transition: transform .08s ease, background .15s ease, border-color .15s ease, color .15s ease;
}

.pill-toggle span:hover{
  transform: translateY(-1px);
  border-color: rgba(34, 211, 238, 0.55);
  color: var(--text-main);
}

.pill-toggle input:checked + span{
  border-color: rgba(34, 211, 238, 0.85);
  background: rgba(34, 211, 238, 0.12);
  color: #e0f2fe;
  box-shadow: 0 0 18px rgba(34, 211, 238, 0.22);
}

/* shell do chart */
.aaron10-chart-shell{
  position: relative;
  margin-top: 10px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(15, 23, 42, 0.9);
  min-height: 420px;
  background: #020617;
}

.aaron10-chart{
  width: 100%;
  height: 430px;
}

.aaron10-chart-overlay{
  position: absolute;
  top: 10px;
  right: 10px;
  pointer-events: none;
  opacity: 0.95;
}

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      color: var(--text-main);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .pill-green {
      border-color: rgba(74, 222, 128, 0.8);
      color: var(--success);
    }

    .pill-red {
      border-color: rgba(248, 113, 113, 0.8);
      color: var(--danger);
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      margin-bottom: 2px;
    }

    /* === DIRE√á√ÉO COM FLECHA === */
    .direction-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .arrow-badge {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px rgba(34, 211, 238, 0.7);
      font-size: 24px;
      font-weight: 700;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .arrow-badge.arrow-up {
      border-color: rgba(74, 222, 128, 0.9);
      box-shadow: 0 0 22px rgba(74, 222, 128, 0.8);
      color: #4ade80;
    }

    .arrow-badge.arrow-down {
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 0 22px rgba(248, 113, 113, 0.85);
      color: #f97373;
    }

    .direction-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    .direction-text strong {
      font-size: 13px;
    }

    .text-soft {
      color: var(--text-soft);
    }
    /* ====== AARON 9 ‚Äì COLUNA DIREITA (DECISION PANEL) ====== */

.decision-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.decision-card {
  background: var(--card, #020617);
  border-radius: 18px;
  border: 1px solid var(--card-border, #1f2937);
  padding: 16px 18px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.75);
}

/* t√≠tulos e textos pequenos */
.decision-title {
  font-size: 0.75rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-soft, #9ca3af);
  margin-bottom: 8px;
}

.decision-label-strong {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-main, #e5e7eb);
}

/* radar de dire√ß√£o */
.radar-header {
  display: flex;
  align-items: center;
  gap: 12px;
}

.radar-circle {
  width: 54px;
  height: 54px;
  border-radius: 999px;
  border: 2px solid #f97373;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
}

.radar-circle.buy {
  border-color: var(--accent, #22d3ee);
}

.radar-percent {
  font-size: 0.9rem;
  color: var(--text-soft, #9ca3af);
}

/* barrinhas horizontal (a favor x contra, etc.) */
.decision-bar {
  position: relative;
  width: 100%;
  height: 6px;
  border-radius: 999px;
  background: rgba(148, 163, 184, 0.18);
  overflow: hidden;
}

.decision-bar-fill {
  position: absolute;
  inset: 0;
  width: 70%; /* ser√° ajustado depois com JS ou no backend */
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
}

.decision-bar-fill-danger {
  position: absolute;
  inset: 0;
  width: 30%;
  border-radius: inherit;
  background: linear-gradient(90deg, #f97373, #facc15);
}

/* pill do estado (NO TRADE / GO FULL etc.) */
.decision-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.16em;
  text-transform: uppercase;
}

.decision-pill.go-full {
  background: rgba(248, 113, 113, 0.16);
  color: #fecaca;
}

.decision-pill.scalp {
  background: rgba(56, 189, 248, 0.16);
  color: #bae6fd;
}

.decision-pill.wait {
  background: rgba(234, 179, 8, 0.16);
  color: #facc15;
}

.decision-pill.no-trade {
  background: rgba(148, 163, 184, 0.16);
  color: #cbd5f5;
}

/* checklist de padr√µes */
.checklist-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.check-pill {
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 0.8rem;
  border: 1px solid rgba(148, 163, 184, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.check-pill.on {
  border-color: rgba(45, 212, 191, 0.9);
  background: rgba(34, 197, 94, 0.12);
  color: #bbf7d0;
}

/* pattern radar + pullback */
.pattern-layout {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
  gap: 12px;
}

.pattern-box {
  border-radius: 14px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  padding: 8px 10px;
  font-size: 0.78rem;
}

.pattern-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.pullback-highlight {
  font-size: 0.78rem;
  margin-top: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(34, 197, 94, 0.08);
  border: 1px solid rgba(34, 197, 94, 0.4);
}

/* responsivo: em telas estreitas essa coluna vira full-width */
@media (max-width: 1024px) {
  .decision-column {
    margin-top: 16px;
  }
}
/* ====== HERO STATUS (MODO CEGO) ====== */

.status-hero {
  background: radial-gradient(circle at top left, rgba(34,197,94,0.18), rgba(15,23,42,1));
  border-radius: 20px;
  border: 1px solid rgba(34,197,94,0.7);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
}

.status-hero-label {
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(148,163,184,0.9);
}

/* ===== AUTOPILOT (simulador) ===== */
.trade-autopilot { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.ap-switch { position:relative; width:42px; height:22px; display:inline-block; }
.ap-switch input { opacity:0; width:0; height:0; }
.ap-slider {
  position:absolute; cursor:pointer; inset:0;
  background: rgba(148,163,184,0.25);
  border:1px solid rgba(148,163,184,0.35);
  transition:.2s; border-radius:999px;
}
.ap-slider:before {
  content:""; position:absolute; height:16px; width:16px; left:3px; top:2px;
  background: rgba(226,232,240,0.9);
  transition:.2s; border-radius:999px;
}
.ap-switch input:checked + .ap-slider {
  background: rgba(34,197,94,0.25);
  border-color: rgba(34,197,94,0.45);
}
.ap-switch input:checked + .ap-slider:before { transform: translateX(19px); }

.ap-btn {
  border:1px solid rgba(148,163,184,0.25);
  background: rgba(15,23,42,0.35);
  color:#e2e8f0; font-weight:800; letter-spacing:.4px;
  padding:7px 10px; border-radius:12px; cursor:pointer;
}
.ap-btn:hover { filter:brightness(1.08); }

.ap-meta { opacity:.85; font-size:0.86rem; }

#ap-state { padding:4px 10px; border-radius:999px; font-weight:800; }
#ap-state.ap-on { border-color: rgba(34,197,94,0.55); }
#ap-state.ap-off { border-color: rgba(148,163,184,0.35); opacity:.8; }
#ap-state.ap-buy { border-color: rgba(56,189,248,0.55); }
#ap-state.ap-sell { border-color: rgba(248,113,113,0.55); }

/* ===== AUTOPILOT UI v2 (premium) ===== */
#autopilot-panel.autopilot-v2{
  padding: 14px;
  border: 1px solid rgba(148,163,184,0.18);
  background:
    radial-gradient(1200px 500px at 20% 0%, rgba(56,189,248,0.10), transparent 60%),
    radial-gradient(900px 420px at 85% 10%, rgba(34,197,94,0.08), transparent 55%),
    rgba(2,6,23,0.35);
}

#autopilot-panel .ap2-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}

#autopilot-panel .ap2-sub{
  margin-top:2px;
  font-size:0.78rem;
  opacity:0.75;
}

#autopilot-panel .ap2-controls{
  display:flex;
  align-items:center;
  gap:10px;
}

#autopilot-panel .ap2-bottom{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

#autopilot-panel .ap-btn{
  min-width: 98px;
  border-radius: 14px;
  padding: 9px 12px;
  letter-spacing: .6px;
}

#autopilot-panel .ap-btn:active{
  transform: translateY(1px);
}

#autopilot-panel .ap2-ico{
  display:inline-block;
  margin-right:7px;
  opacity:.85;
  font-weight:900;
}

#autopilot-panel #ap-meta{
  margin-left:auto;
  padding-left:10px;
  opacity:0.85;
  font-size:0.86rem;
}

/* Deixa o estado mais "badge premium" */
#autopilot-panel #ap-state{
  padding: 6px 12px;
  border-radius: 999px;
  font-weight: 900;
  letter-spacing: .6px;
}

/* ===== AUTOPILOT 2.0 (cores fortes + sizing) ===== */
#autopilot-panel .ap-btn.ap-buy{
  background: linear-gradient(135deg, rgba(34,197,94,0.22), rgba(34,197,94,0.08));
  border-color: rgba(34,197,94,0.55);
  color: rgba(236,253,245,0.98);
}
#autopilot-panel .ap-btn.ap-sell{
  background: linear-gradient(135deg, rgba(248,113,113,0.22), rgba(248,113,113,0.08));
  border-color: rgba(248,113,113,0.62);
  color: rgba(255,241,242,0.98);
}
#autopilot-panel .ap-btn.ap-close{
  background: rgba(15,23,42,0.25);
  border-color: rgba(148,163,184,0.28);
}
#autopilot-panel .ap-btn:disabled{
  opacity: .45;
  cursor: not-allowed;
}

#autopilot-panel .ap2-sizing{
  margin: 10px 0 12px 0;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid rgba(148,163,184,0.16);
  background: rgba(0,0,0,0.18);
  box-shadow: inset 0 0 0 1px rgba(2,6,23,0.15);
}

#autopilot-panel .ap2-price-row{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

#autopilot-panel .ap2-quote{
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.18);
  background: rgba(2,6,23,0.28);
}

#autopilot-panel .ap2-quote-sell{
  border-color: rgba(248,113,113,0.30);
}
#autopilot-panel .ap2-quote-buy{
  border-color: rgba(34,197,94,0.30);
}

#autopilot-panel .ap2-quote-label{
  font-size: 0.72rem;
  opacity: .78;
  letter-spacing: .08em;
  text-transform: uppercase;
}

#autopilot-panel .ap2-quote-price{
  margin-top: 2px;
  font-size: 1.05rem;
  font-weight: 900;
}

#autopilot-panel .ap2-quote-mid{
  padding: 0 4px;
  text-align:center;
  opacity: .82;
}
#autopilot-panel .ap2-quote-mid-label{
  font-size: 0.70rem;
  letter-spacing: .08em;
  text-transform: uppercase;
}
#autopilot-panel .ap2-quote-mid-price{
  margin-top: 2px;
  font-weight: 800;
}

#autopilot-panel .ap2-input-row{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
@media (max-width: 520px){
  #autopilot-panel .ap2-input-row{ grid-template-columns: 1fr; }
  #autopilot-panel .ap2-price-row{ grid-template-columns: 1fr; }
  #autopilot-panel .ap2-quote-mid{ display:none; }
}

#autopilot-panel .ap2-field{
  display:flex;
  flex-direction: column;
  gap: 6px;
}

#autopilot-panel .ap2-label{
  font-size: 0.72rem;
  opacity: .78;
  letter-spacing: .08em;
  text-transform: uppercase;
}

#autopilot-panel .ap2-input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148,163,184,0.20);
  background: rgba(2,6,23,0.35);
  color: rgba(226,232,240,0.96);
  outline: none;
}
#autopilot-panel .ap2-input:focus{
  border-color: rgba(34,211,238,0.45);
  box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
}


.status-hero-main {
  font-size: 1.35rem;
  font-weight: 500; /* <-- aqui para de deixar tudo bold */
  color: #e5e7eb;
}

/* mant√©m os labels (strong) com destaque */
.status-hero-main strong {
  font-weight: 800;
}

/* Coment√°rio do AARON formatado em linhas */
.comment-lines {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 6px;
}

.comment-line {
  font-weight: 500;
  line-height: 1.35;
  font-size: 0.92rem;
}

.comment-line strong {
  font-weight: 800;
}


.status-hero-sub {
  font-size: 0.8rem;
  color: var(--text-soft, #9ca3af);
}

/* bolha da direita (GO FULL / WAIT etc.) */
.status-hero-badge {
  min-width: 88px;
  text-align: center;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.18em;
  text-transform: uppercase;
}

/* cores por estado */
.status-buy {
  background: radial-gradient(circle at top left, rgba(34,197,94,0.22), #020617);
  border-color: rgba(34,197,94,0.8);
}

.status-sell {
  background: radial-gradient(circle at top left, rgba(248,113,113,0.22), #020617);
  border-color: rgba(248,113,113,0.9);
}

.status-wait {
  background: radial-gradient(circle at top left, rgba(234,179,8,0.22), #020617);
  border-color: rgba(234,179,8,0.9);
}

.status-no-trade {
  background: radial-gradient(circle at top left, rgba(148,163,184,0.22), #020617);
  border-color: rgba(148,163,184,0.9);
}

/* cores da badge */
.status-hero-badge.buy { background: rgba(34,197,94,0.18); color:#bbf7d0; }
.status-hero-badge.sell { background: rgba(248,113,113,0.18); color:#fecaca; }
.status-hero-badge.wait { background: rgba(234,179,8,0.18); color:#facc15; }
.status-hero-badge.no-trade { background: rgba(148,163,184,0.18); color:#e5e7eb; }

/* piscando leve para EXECUTAR AGORA */
.blink-hero {
  animation: heroPulse 1.4s ease-in-out infinite;
}

@keyframes heroPulse {
  0%   { transform: scale(1); box-shadow: 0 0 0 0 rgba(248,113,113,0.7); }
  50%  { transform: scale(1.01); box-shadow: 0 0 0 12px rgba(248,113,113,0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(248,113,113,0); }
}

/* ====== PATTERN DRAWINGS (PADR√ÉO DO DIA / MOMENTO) ====== */

.pattern-canvas {
  background: rgba(15,23,42,0.9);
  border-radius: 10px;
  padding: 4px 6px;
  margin-bottom: 6px;
  border: 1px solid rgba(148,163,184,0.35);
}

.pattern-svg {
  width: 100%;
  height: 34px;
}

.prob-phrase {
  font-size: 0.76rem;
  margin-top: 4px;
  color: var(--text-soft, #9ca3af);
}

.prob-phrase.favor {
  color: #bbf7d0;
}

.prob-phrase.contra {
  color: #fecaca;
}
    /* ====== ESTRUTURA RECENTE ‚Äî HH / HL / LH / LL ====== */

.structure-wrapper {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.structure-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.structure-chip {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.55);
  background: rgba(15, 23, 42, 0.95);
  font-size: 0.78rem;
}

.structure-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: var(--text-soft);
}

.structure-status {
  font-weight: 500;
  color: var(--text-main);
}

.structure-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: #4b5563;
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 1);
  margin-left: 6px;
}

.structure-dot.on {
  background: #fb7185;
  box-shadow: 0 0 10px rgba(248, 113, 113, 0.85);
}

/* ZigZag / Market Structure */

.structure-zigzag-title {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.structure-zigzag-box {
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.96);
  padding: 4px 6px;
}

.structure-zigzag-svg {
  width: 100%;
  height: 40px;
}

/* ====== GERENCIADOR DE RISCO ¬∑ ATR ====== */

.risk-card {
  background: var(--card);
  border-radius: 18px;
  border: 1px solid var(--card-border);
  padding: 14px 16px;
  margin-bottom: 14px;
  box-shadow: 0 18px 40px rgba(15,23,42,0.7);
}

.risk-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.risk-title {
  font-size: 0.9rem;
  font-weight: 600;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-soft);
}

.risk-subtitle {
  font-size: 0.75rem;
  color: var(--text-soft);
}

.risk-toggle {
  border-radius: 999px;
  padding: 4px 12px;
  border: 1px solid var(--accent);
  background: transparent;
  color: var(--accent);
  font-size: 0.75rem;
  cursor: pointer;
}

.risk-toggle:hover {
  background: var(--accent-soft);
}

.risk-body {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 12px;
}

.risk-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.risk-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-soft);
}

.risk-group input,
.risk-group select {
  background: #020617;
  border-radius: 10px;
  border: 1px solid #1f2937;
  padding: 6px 8px;
  font-size: 0.78rem;
  color: var(--text-main);
}

.risk-group input:focus,
.risk-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(34,211,238,0.35);
}

.risk-actions {
  grid-column: 1 / -1;
  display: flex;
  justify-content: flex-start;
  margin-top: 4px;
}

.risk-actions button {
  border-radius: 999px;
  padding: 6px 16px;
  border: none;
  background: var(--accent);
  color: #020617;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
}

.risk-results {
  grid-column: 1 / -1;
  margin-top: 8px;
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 12px;
}

.risk-result-label {
  font-size: 0.72rem;
  color: var(--text-soft);
}

.risk-result-value {
  font-size: 0.9rem;
  font-weight: 600;
}

.risk-result-value.small {
  font-size: 0.78rem;
  opacity: 0.8;
}
    /* ====== TOGGLE DE IDIOMA PT / EN ====== */
    .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.45);
      margin-right: 12px;
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .lang-btn.active {
      background: rgba(34, 211, 238, 0.18);
      color: var(--accent);
    }
    /* ====== PULLBACK BRAIN ‚Äì UX AVAN√áADO ====== */

.pullback-header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 6px;
}

.pullback-status-block {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.pullback-status-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
}

.pullback-status-main {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-main);
}

.pullback-meta-block {
  text-align: right;
  font-size: 0.76rem;
  color: var(--text-soft);
}

.pullback-tag-row {
  display: flex;
  gap: 6px;
  margin-top: 4px;
  justify-content: flex-end;
}

.pullback-tag {
  border-radius: 999px;
  padding: 3px 8px;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  border: 1px solid rgba(148,163,184,0.5);
  background: rgba(15,23,42,0.9);
  white-space: nowrap;
}

.pullback-tag.side-buy {
  border-color: rgba(34,197,94,0.9);
  color: #bbf7d0;
}

.pullback-tag.side-sell {
  border-color: rgba(248,113,113,0.9);
  color: #fecaca;
}

.pullback-tag.side-neutral {
  border-color: rgba(148,163,184,0.8);
  color: #e5e7eb;
}

.pullback-tag.stage {
  border-color: rgba(56,189,248,0.9);
  color: #bae6fd;
}

/* term√¥metro horizontal */

.pullback-meter {
  margin-top: 8px;
  margin-bottom: 8px;
}

.pullback-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.pullback-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.pullback-meter-fill {
  position: absolute;
  inset: 0;
  width: 40%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

.pullback-meter-fill.neutral {
  background: linear-gradient(90deg, #eab308, #f97316);
}

.pullback-meter-fill.danger {
  background: linear-gradient(90deg, #f97373, #fb7185);
}

/* j√° existia, mas este bloco usa muito: */
.pullback-highlight {
  font-size: 0.78rem;
  margin-top: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(34, 197, 94, 0.08);
  border: 1px solid rgba(34, 197, 94, 0.4);
}

    /* === SIZING BRAIN ‚Äì GERENCIADOR DE RISCO (OFFLINE) ‚Äì EXTRA UI === */

/* Stop e Take bem destacados */
#sb-stop-price {
  color: var(--danger);
  font-weight: 600;
  font-size: 0.95rem;
}

#sb-take-price {
  color: var(--success);
  font-weight: 600;
  font-size: 0.95rem;
}

/* Term√¥metro offline */
.sb-meter {
  margin-top: 10px;
}

.sb-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.sb-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.sb-meter-fill {
  position: absolute;
  inset: 0;
  width: 0%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

/* varia√ß√µes de cor conforme o risco usado */
.sb-meter-fill.safe {
  background: linear-gradient(90deg, #22c55e, #22d3ee);
}

.sb-meter-fill.warn {
  background: linear-gradient(90deg, #facc15, #fb923c);
}

.sb-meter-fill.danger {
  background: linear-gradient(90deg, #f97373, #fb7185);
}

    /* ====== SIZING BRAIN ‚Äì GEST√ÉO DE CAPITAL DO DIA ====== */

.sizing-header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 6px;
}

.sizing-main-numbers {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.sizing-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
}

.sizing-target-value {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--accent);
}

.sizing-secondary-numbers {
  font-size: 0.76rem;
  color: var(--text-soft);
  text-align: right;
}

.sizing-tag-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
  margin-bottom: 6px;
}

.sizing-tag {
  border-radius: 999px;
  padding: 3px 9px;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  border: 1px solid rgba(148,163,184,0.6);
  background: rgba(15,23,42,0.9);
  white-space: nowrap;
}

.sizing-tag.profile-conservative {
  border-color: rgba(56,189,248,0.9);
  color: #bae6fd;
}

.sizing-tag.profile-normal {
  border-color: rgba(34,197,94,0.9);
  color: #bbf7d0;
}

.sizing-tag.profile-aggressive {
  border-color: rgba(234,179,8,0.9);
  color: #fef9c3;
}

.sizing-tag.style-daytrade {
  border-color: rgba(94,234,212,0.9);
  color: #a5f3fc;
}

.sizing-tag.style-swing {
  border-color: rgba(129,140,248,0.9);
  color: #e0e7ff;
}

.sizing-tag.style-momentum {
  border-color: rgba(251,146,60,0.9);
  color: #fed7aa;
}

.sizing-tag.style-noedge {
  border-color: rgba(148,163,184,0.9);
  color: #e5e7eb;
}

.sizing-meter {
  margin-top: 4px;
  margin-bottom: 6px;
}

.sizing-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.sizing-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.sizing-meter-fill {
  position: absolute;
  inset: 0;
  width: 40%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

.sizing-comment {
  margin-top: 4px;
  font-size: 0.78rem;
  color: var(--text-main);
  background: rgba(15,23,42,0.85);
  border-radius: 10px;
  padding: 6px 8px;
  border: 1px dashed rgba(148,163,184,0.6);
}

    /* --- SIZING BRAIN ¬∑ inputs de capital/risco/stop + frases --- */

.sizing-inputs {
  margin-top: 6px;
  margin-bottom: 6px;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
}

.sizing-input {
  display: flex;
  flex-direction: column;
  gap: 3px;
  font-size: 0.75rem;
}

.sizing-input label {
  color: var(--text-soft);
  text-transform: none;
  letter-spacing: 0.02em;
}

.sizing-input input {
  border-radius: 999px;
  border: 1px solid rgba(31,41,55,0.9);
  background: #020617;
  padding: 5px 10px;
  font-size: 0.8rem;
  color: var(--text-main);
}

.sizing-input input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

.sizing-phrase {
  margin-top: 2px;
  margin-bottom: 6px;
  font-size: 0.8rem;
  line-height: 1.35;
}

.sizing-phrase-main {
  color: var(--text-main);
}

.sizing-phrase-detail {
  color: var(--text-soft);
  margin-top: 2px;
}

/* responsivo */
@media (max-width: 900px) {
  .sizing-inputs {
    grid-template-columns: 1fr;
  }
}

/* === SIZING BRAIN ‚Äì GERENCIADOR DE RISCO === */
.sizing-brain-card {
  border: 1px solid var(--card-border);
  border-radius: 16px;
  padding: 16px 20px;
  background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.4));
  box-shadow: 0 0 40px rgba(15, 23, 42, 0.8);
}

.sizing-brain-card .card-header h2 {
  margin: 0;
  font-size: 1.1rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.sizing-brain-card .card-subtitle {
  margin: 4px 0 0;
  font-size: 0.75rem;
  color: var(--text-soft);
}

.sb-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px 16px;
  margin-top: 12px;
}

.sb-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sb-field label {
  font-size: 0.8rem;
  color: var(--text-soft);
}

.sb-field input {
  background: #020617;
  border-radius: 10px;
  border: 1px solid var(--card-border);
  padding: 6px 8px;
  color: var(--text-main);
  font-size: 0.9rem;
}

.sb-field input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.3);
}

.sb-hint {
  font-size: 0.7rem;
  color: var(--text-soft);
}

.sb-divider {
  margin: 14px 0;
  border: none;
  border-top: 1px dashed rgba(148, 163, 184, 0.4);
}

.sb-side-toggle {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.8rem;
}

.sb-side-toggle label {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.sb-side-toggle input[type="radio"] {
  accent-color: var(--accent);
}

.sb-results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-top: 8px;
}

.sb-result-block h3 {
  margin: 0 0 6px;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-soft);
}

.sb-result-main {
  font-size: 1rem;
  font-weight: 600;
  margin: 2px 0;
}

.sb-result-sub {
  font-size: 0.8rem;
  margin: 2px 0;
  color: var(--text-soft);
}

.sb-actions {
  margin-top: 14px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.primary-btn {
  border-radius: 999px;
  padding: 6px 14px;
  border: 1px solid var(--accent);
  background: radial-gradient(circle at top, var(--accent-soft), transparent);
  color: var(--accent);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
}

.primary-btn:hover {
  filter: brightness(1.1);
}

.sb-status {
  font-size: 0.75rem;
  color: var(--text-soft);
}

/* ================== GARIMPO DE HOJE ================== */
.garimpo-banner {
  width: 100%;
  /* menos espa√ßo em cima e embaixo, encaixa melhor entre o header e o painel */
  margin: 8px auto 12px auto;
  display: flex;
  justify-content: center;
}

.garimpo-container {
  width: 100%;
  max-width: 100%;         /* agora acompanha a largura inteira da .page */
  padding: 14px 24px;      /* um pouco mais de ‚Äúrespiro‚Äù nas laterais */
  border-radius: 18px;
  background: radial-gradient(circle at top left, rgba(80, 220, 255, 0.25), transparent 55%),
              linear-gradient(135deg, rgba(7, 16, 40, 0.95), rgba(10, 26, 70, 0.98));
  border: 1px solid rgba(120, 220, 255, 0.35);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  display: flex;
  flex-direction: column;
  gap: 10px;
}


.garimpo-badge {
  display: inline-flex;
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background: rgba(9, 189, 140, 0.18);
  color: #5df2c8;
  border: 1px solid rgba(93, 242, 200, 0.5);
}

.garimpo-main {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.garimpo-header-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

    .garimpo-header-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
}

/* Bot√£o "Ver p√°gina do garimpo" no painel principal */
.garimpo-link-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 14px;
  border-radius: 999px;
  border: 1px solid rgba(120, 200, 255, 0.5);
  background: rgba(3, 10, 25, 0.85);
  color: #e5f2ff;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  text-decoration: none;
  cursor: pointer;
  transition:
    background 0.18s ease,
    transform 0.18s ease,
    box-shadow 0.18s ease,
    color 0.18s ease;
}

.garimpo-link-btn:hover {
  background: linear-gradient(135deg, #04d9ff, #22ff88);
  color: #02101f;
  box-shadow: 0 0 12px rgba(34, 211, 238, 0.6);
  transform: translateY(-1px);
}


    .garimpo-right-block {
  display: flex;
  align-items: center;
  gap: 10px;       /* espa√ßo entre o bot√£o e o chip de confian√ßa */
}


.garimpo-title-block {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.garimpo-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #a5b4fc;
}

.garimpo-ticker-line {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.garimpo-ticker {
  font-size: 26px;
  font-weight: 700;
  color: #e5e7ff;
}

.garimpo-profile-tag {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 4px 9px;
  border-radius: 999px;
  background: rgba(59, 130, 246, 0.15);
  color: #bfdbfe;
  border: 1px solid rgba(129, 199, 255, 0.5);
}

.garimpo-confidence-chip {
  display: inline-flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 3px;
  padding: 6px 10px;
  border-radius: 12px;
  background: rgba(15, 118, 110, 0.24);
  border: 1px solid rgba(45, 212, 191, 0.6);
}

.garimpo-confidence-chip .chip-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #a7f3d0;
}

.garimpo-confidence-chip .chip-value {
  font-size: 16px;
  font-weight: 700;
  color: #ecfeff;
}

.garimpo-metrics-row {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  margin-top: 4px;
}

.garimpo-metric {
  min-width: 120px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.garimpo-metric .metric-label {
  font-size: 11px;
  color: #9ca3af;
}

.garimpo-metric .metric-value {
  font-size: 14px;
  font-weight: 600;
  color: #e5e7eb;
}

.garimpo-comment {
  margin-top: 4px;
  font-size: 12px;
  color: #d1d5db;
  max-width: 800px;
}

/* Responsivo */
@media (max-width: 768px) {
  .garimpo-container {
    padding: 12px 12px;
  }
  .garimpo-ticker {
    font-size: 22px;
  }

  .garimpo-right-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Bot√£o para abrir a p√°gina completa do garimpo */
.garimpo-page-btn {
  border-radius: 999px;
  padding: 6px 14px;
  border: 1px solid rgba(120, 220, 255, 0.6);
  background: radial-gradient(circle at top, rgba(56, 189, 248, 0.35), transparent);
  color: #e0f2fe;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  cursor: pointer;
  white-space: nowrap;
  transition:
    background 0.2s ease,
    transform 0.15s ease,
    box-shadow 0.15s ease;
}

.garimpo-page-btn:hover {
  background: radial-gradient(circle at top, rgba(56, 189, 248, 0.55), transparent);
  box-shadow: 0 0 18px rgba(56, 189, 248, 0.6);
  transform: translateY(-1px);
}

.garimpo-page-btn:active {
  transform: translateY(0);
  box-shadow: none;
}

  
}
/* ================== FIM GARIMPO DE HOJE ================== */
/* ================== PREMONI√á√ÉO (Breakout Window Card) ================== */
.premonition-banner{
  margin: 14px 0 12px;
}

.premonition-container{
  background:
    radial-gradient(1200px 320px at 20% 10%, rgba(0,180,255,.16), rgba(0,0,0,0) 55%),
    linear-gradient(180deg, rgba(10,14,22,.65), rgba(10,14,22,.35));
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 18px;
  padding: 14px 16px;
  position: relative;
  overflow: hidden;
}

.premonition-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom: 10px;
}

.premonition-title{
  font-size: 13px;
  font-weight: 900;
  letter-spacing: .18em;
  opacity:.92;
}

.premonition-sub{
  font-size: 12px;
  opacity:.70;
  margin-top: 2px;
}

.premonition-badge{
  font-size: 10px;
  letter-spacing: .14em;
  text-transform: uppercase;
  opacity:.9;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  white-space: nowrap;
}

/* ‚úÖ RR: overrides locais (ANTES estava #rr-panel, mas o id real √© rr-section) */
#rr-section .premonition-container{
  overflow: visible; /* evita ‚Äúcorte‚Äù quando texto quebra linha */
}

#rr-section .premonition-badge{
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  line-height: 1.15;
}

#rr-section .premonition-value{
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* ‚úÖ RR: readout completo (lista estilo sua 2¬™ imagem) */
#rr-section .rr-readout{
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,.08);
  display: flex;
  flex-direction: column;
  gap: 6px;
}

#rr-section .rr-line{
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 12px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 12px;
}

#rr-section .rr-key{
  color: rgba(255,255,255,.65);
  text-transform: uppercase;
  letter-spacing: .08em;
  flex: 0 0 auto;
}

#rr-section .rr-val{
  color: rgba(255,255,255,.92);
  text-align: right;
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  flex: 1 1 auto;
}

#rr-section .rr-action{
  font-weight: 800;
}



.premonition-grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 14px;
  align-items: stretch;
}

@media (max-width: 980px){
  .premonition-grid{ grid-template-columns: 1fr; }
}

.premonition-chart{
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  background: rgba(0,0,0,.22);
  position: relative;
  overflow: hidden;
  padding: 10px;
}

.premonition-canvas{
  width: 100%;
  height: 240px;
  display:block;
}

.premonition-kpi{
  margin-top: 10px;
  display:flex;
  align-items: baseline;
  gap: 10px;
  flex-wrap: wrap;
}
/* RR: N√ÉO cortar conte√∫do */
#rr-container{ overflow: visible !important; }

/* RR: readout estilo ‚Äúbloco‚Äù (igual sua 2¬™ imagem) */
#rr-section .rr-readout{
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(0,0,0,0.28);
  color: rgba(255,255,255,0.92);
  display: block !important;
  overflow: visible;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12px;
  line-height: 1.35;
  letter-spacing: 0.02em;
}

#rr-section .rr-line{
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  justify-content: center;
  margin-top: 6px;
}
#rr-section .rr-line:first-child{ margin-top: 0; }

#rr-section .rr-k{
  opacity: 0.75;
  font-size: 10px;
  letter-spacing: 0.16em;
  text-transform: uppercase;
}
#rr-section .rr-v{
  font-weight: 800;
  opacity: 0.95;
}
#rr-section .rr-pipe{
  opacity: 0.35;
  font-weight: 700;
  margin: 0 2px;
}

/* üî• RR: hierarquia + highlight amarelo (√°reas circuladas) */
#rr-section .premonition-title{
  color: rgba(255, 208, 64, 0.95);
  font-size: 14px;
  font-weight: 950;
}

#rr-section .premonition-sub{
  color: rgba(255, 208, 64, 0.65);
}

/* layout Respiro/Revers√£o (lado a lado) */
#rr-section .rr-grid{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
  align-items: start;
}
@media (max-width: 720px){
  #rr-section .rr-grid{ grid-template-columns: 1fr; }
}

#rr-section .rr-label{
  color: rgba(255, 208, 64, 0.70);
  text-transform: uppercase;
  letter-spacing: 0.14em;
  font-size: 11px;
  margin-bottom: 4px;
}

#rr-section .rr-value{
  color: rgba(255, 208, 64, 0.95);
  font-size: 18px;
  font-weight: 950;
  line-height: 1.1;
}

#rr-section .rr-sub{
  color: rgba(255, 208, 64, 0.70);
  font-size: 12px;
  margin-top: 4px;
}

#rr-section .rr-badge{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255, 208, 64, 0.20);
  background: rgba(255, 208, 64, 0.08);
  color: rgba(255, 208, 64, 0.95);
  font-weight: 900;
  letter-spacing: 0.10em;
  text-transform: uppercase;
}

/* barra do meio (readout) mais forte */
#rr-section .rr-readout{
  border-color: rgba(255, 208, 64, 0.16);
  background: rgba(0,0,0,0.32);
}

#rr-section .rr-line{
  font-size: 13px;
  gap: 10px;
}

#rr-section .rr-k{
  color: rgba(255, 208, 64, 0.72);
  opacity: 1;
  font-size: 11px;
}

#rr-section .rr-v{
  color: rgba(255, 255, 255, 0.92);
  font-size: 13px;
  font-weight: 900;
}

#rr-section #rr-acao{
  color: rgba(255, 208, 64, 0.95);
}

#rr-section .rr-pipe{
  color: rgba(255, 208, 64, 0.40);
  opacity: 1;
}


.premonition-kpi .kpi-label{
  opacity:.7;
  font-size: 12px;
}

.premonition-kpi .kpi-time{
  font-size: 34px;
  font-weight: 950;
  letter-spacing: .02em;
  color: #ffcc66;
}

.premonition-kpi .kpi-ampm{
  font-size: 12px;
  opacity:.85;
  margin-left: -6px;
}

.premonition-kpi .kpi-prob{
  font-size: 26px;
  font-weight: 950;
  color: #ffcc66;
}

.premonition-panel{
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  background: rgba(0,0,0,.18);
  padding: 12px 12px;
}

.premonition-panel .row{
  padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,.06);
}

.premonition-panel .row:last-child{
  border-bottom: none;
}

.premonition-panel .label{
  font-size: 10px;
  letter-spacing: .14em;
  text-transform: uppercase;
  opacity: .75;
  margin-bottom: 6px;
}

.premonition-panel .value{
  font-size: 13px;
  line-height: 1.35;
}

.premonition-panel .muted{
  opacity: .70;
}

/* ====== PREMONI√á√ÉO (Mockup upgrade) ====== */

/* deixa o KPI antigo embaixo do chart discreto (ou esconda se quiser) */
.premonition-kpi { opacity: .18; transform: scale(.95); }
@media (max-width: 980px){
  .premonition-kpi { opacity: .10; }
}

/* FIX: Premoni√ß√£o vis√≠vel (KPI estava quase invis√≠vel) */
.premonition-banner .premonition-kpi{
  opacity: .78 !important;
  transform: scale(1) !important;
}

.premonition-banner .premonition-kpi{
  background: rgba(0,0,0,.28);
  border: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(6px);
}

.premonition-banner .premonition-kpi .kpi-label{ opacity: .85; }
.premonition-banner .premonition-kpi .kpi-time,
.premonition-banner .premonition-kpi .kpi-prob{ opacity: 1; font-weight: 700; }


/* KPI grande no painel direito */
.prem-kpi-right{
  padding: 10px 10px 14px;
  margin-bottom: 10px;
  border-bottom: 1px solid rgba(255,255,255,.08);
}

.prem-kpi-right-title{
  font-size: 14px;
  font-weight: 850;
  opacity: .85;
  margin-bottom: 10px;
}

.prem-kpi-right-main{
  display:flex;
  align-items: baseline;
  gap: 12px;
  flex-wrap: wrap;
}

.prem-kpi-right-time{
  font-size: 44px;
  font-weight: 950;
  letter-spacing: .02em;
  color: rgba(255,255,255,.95);
  text-shadow: 0 10px 30px rgba(0,0,0,.55);
}

.prem-kpi-right-ampm{
  font-size: 14px;
  font-weight: 800;
  opacity: .85;
  margin-left: -8px;
}

.prem-kpi-right-prob{
  font-size: 36px;
  font-weight: 950;
  color: #ffcc66;
  text-shadow: 0 10px 30px rgba(0,0,0,.55);
}

.prem-kpi-right-sub{
  margin-top: 10px;
  font-size: 16px;
  opacity: .75;
}
/* PREMONI√á√ÉO: readout (REGIME/REVERS√ÉO/CONSOLIDA√á√ÉO/...) com hierarquia visual */
.prem-kpi-right #prem-readout{
  margin: 10px 0 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.prem-kpi-right #prem-readout .rr-row{
  display:flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 14px;
}

.prem-kpi-right #prem-readout .rr-k{
  font-size: 14px;
  font-weight: 950;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: #ffcc66;
  opacity: 1;
  white-space: nowrap;
}


.prem-kpi-right #prem-readout .rr-v{
  font-size: 16px;
  font-weight: 850;
  opacity: .95;
  text-align: right;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.prem-kpi-right #prem-readout .rr-row.rr-primary .rr-k,
.prem-kpi-right #prem-readout .rr-row.rr-primary .rr-v{
  color: #ffcc66;
  font-weight: 950;
}

.prem-kpi-right #prem-readout .rr-v.rr-strong{
  font-size: 18px;
}

/* deixa o painel direito mais ‚ÄúTV-like‚Äù */
.premonition-panel .label{
  font-size: 10px;
  letter-spacing: .18em;
  opacity: .62;
}

.premonition-panel .value{
  font-size: 14px;
}

.premonition-panel .value b,
.premonition-panel .value strong{
  color:#ffcc66;
}

/* ====== FIM upgrade ====== */

/* ================== FIM PREMONI√á√ÉO ================== */

/* ====== PATTERN REFERENCE (ABAIXO DO SIZING BRAIN) ====== */
.ref-card { margin-top: 14px; }

.ref-details { margin-top: 8px; }

.ref-summary {
  list-style: none;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(56, 189, 248, 0.28);
  background: rgba(10, 18, 35, 0.55);
  cursor: pointer;
  user-select: none;
}

.ref-summary::-webkit-details-marker { display: none; }

.ref-summary-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.ref-summary-title {
  font-weight: 700;
  letter-spacing: 0.2px;
}

.ref-summary-mini {
  font-size: 12px;
  opacity: 0.75;
}

.ref-summary-right {
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.22);
  background: rgba(2, 6, 23, 0.35);
  opacity: 0.9;
}

.ref-details[open] .ref-summary-right { content: "Fechar"; }

.ref-body { padding-top: 12px; }

.ref-grid {
  display: grid;
  grid-template-columns: 1.25fr 1fr;
  gap: 12px;
}

@media (max-width: 980px) {
  .ref-grid { grid-template-columns: 1fr; }
}

.ref-img-wrap {
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(148, 163, 184, 0.18);
  background: rgba(2, 6, 23, 0.55);
}

.ref-img-wrap img {
  width: 100%;
  height: auto;
  display: block;
}

.ref-text {
  border-radius: 16px;
  border: 1px solid rgba(148, 163, 184, 0.14);
  background: rgba(2, 6, 23, 0.35);
  padding: 12px;
}

.ref-line { margin-bottom: 10px; }

.ref-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(56, 189, 248, 0.25);
  text-decoration: none;
}
/* ====== /PATTERN REFERENCE ====== */
/* =========================
   TRADE CARD ‚Ä¢ RESPONDER OUTPUT (panel/ui/digest)
   ========================= */
.resp-snap{
  margin-top: 10px;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid rgba(80,120,200,.35);
  background: rgba(15,20,40,.55);
  box-shadow: 0 10px 28px rgba(0,0,0,.28);
}

.resp-snap-title{
  font-size: 11px;
  letter-spacing: .22em;
  opacity: .8;
  margin-bottom: 8px;
}

/* KPI row */
.resp-kpis{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid rgba(120,170,255,.18);
  background: rgba(10,14,28,.55);
  margin-bottom: 10px;
}

.resp-kpi{
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(120,170,255,.12);
  background: rgba(8,10,22,.55);
}

.resp-kpi-label{
  font-size: 10px;
  letter-spacing: .16em;
  text-transform: uppercase;
  opacity: .75;
  margin-bottom: 4px;
}

.resp-kpi-value{
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .02em;
}

/* 3 col output */
.resp-snap-grid{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.resp-snap-col{
  border-radius: 12px;
  border: 1px solid rgba(120,170,255,.12);
  background: rgba(8,10,22,.45);
  overflow: hidden;
}

.resp-snap-head{
  padding: 8px 10px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  background: rgba(255,255,255,.03);
  border-bottom: 1px solid rgba(120,170,255,.12);
}

/* === OVERRIDE: UI + DIGEST sem rolagem (cresce a altura do card) === */
#resp-snap-ui,
#resp-snap-digest{
  max-height: none;
  overflow: visible;
}

.resp-snap-row{
  display: grid;
  grid-template-columns: 1fr 1.25fr;
  gap: 10px;
  padding: 6px 8px; /* <-- antes era 6px 0 (sem espa√ßo nas laterais) */
  border-bottom: 1px dashed rgba(255,255,255,.07);
}

.resp-snap-row:last-child{ border-bottom: none; }

.resp-snap-key{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  line-height: 1.35; /* <-- respiro entre linhas */
  opacity: .85;
}

.resp-snap-val{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  line-height: 1.35; /* <-- respiro entre linhas */
  text-align: right;
  opacity: .95;
  word-break: break-word;
}

.resp-snap-null{ opacity: .55; font-style: italic; }

.resp-snap-strong .resp-snap-key{ opacity: 1; font-weight: 800; }
.resp-snap-strong .resp-snap-val{ opacity: 1; font-weight: 700; }

.resp-bool{
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  font-size: 11px;
}
.resp-bool-true{ background: rgba(60,190,120,.16); }
.resp-bool-false{ background: rgba(220,80,90,.14); }

/* flash quando muda */
.resp-snap-flash{
  animation: respSnapFlash .55s ease-out;
}
@keyframes respSnapFlash{
  from { background: rgba(80,160,255,.18); }
  to   { background: transparent; }
}

@media (max-width: 980px){
  .resp-kpis{ grid-template-columns: repeat(2,1fr); }
  .resp-snap-grid{ grid-template-columns: 1fr; }
  .resp-snap-row{ grid-template-columns: 1fr; }
  .resp-snap-val{ text-align: left; }
}



  </style>
</head>

<body>
    <div class="page">
    <!-- ====== TOPO ====== -->
    <header class="top-bar">
      <div class="top-left">

        <!-- Logo The Six Seats Investments -->
        <div class="brand-logo">
          <img
            src="six-seats-logo.png"
            alt="The Six Seats Investments"
            class="brand-logo-img"
          />
          <div class="brand-logo-text">
            <div class="brand-logo-main">THE SIX SEATS</div>
            <div class="brand-logo-sub">INVESTMENTS</div>
          </div>
        </div>

        <!-- T√≠tulo do painel AARON 9 -->
        <div class="brand-title">
          <span>AARON 9</span>&nbsp;INSTITUTIONAL PANEL
        </div>


    <div class="status-dot-live" data-i18n="top.live_feed">
      LIVE FEED
    </div>

    <div class="pill-small">
      <span data-i18n="top.symbol">S√≠mbolo</span>
      <strong id="symbol-label">‚Äî</strong>
    </div>

    <div class="pill-small">
      <span data-i18n="top.timeframe">Timeframe</span>
      <strong id="timeframe-label">‚Äî</strong>
    </div>
<div class="tf-picker" id="tf-picker" title="Timeframe">
  <button class="tf-btn" type="button" data-tf="1m">1m</button>
  <button class="tf-btn" type="button" data-tf="5m">5m</button>
  <button class="tf-btn" type="button" data-tf="15m">15m</button>
  <button class="tf-btn" type="button" data-tf="1h">1h</button>
  <button class="tf-btn" type="button" data-tf="4h">4h</button>
  <button class="tf-btn" type="button" data-tf="1d">1D</button>
</div>

    <div class="pill-small">
      <span data-i18n="top.session">Sess√£o</span>
      <strong id="session-label">‚Äî</strong>
    </div>
  </div>

  <div class="top-right">
    <!-- TOGGLE PT / EN -->
    <div id="lang-toggle" class="lang-toggle">
      <button type="button" class="lang-btn active" data-lang="pt">PT</button>
      <button type="button" class="lang-btn" data-lang="en">EN</button>
    </div>

    <div class="pill-state" id="state-pill">
      AGUARDANDO
    </div>

    <div class="pill-soft">
      <span data-i18n="top.last_update">√öltima atualiza√ß√£o:</span>
      <strong id="last-update-label">‚Äî</strong>
    </div>

    <button class="btn-refresh" id="btn-refresh" data-i18n="top.refresh">
      ATUALIZAR
    </button>
  </div>
</header>

    <!-- ================== GARIMPO DE HOJE / BEST STOCK TO TRADE ================== -->
<section id="garimpo-today" class="garimpo-banner">
  <div class="garimpo-container">
    <div class="garimpo-badge" data-i18n="garimpo_badge">
      Garimpo de Hoje
    </div>

        <div class="garimpo-main">
      <div class="garimpo-header-row">
        <div class="garimpo-title-block">
          <span class="garimpo-label" data-i18n="garimpo_best_label">
            Melhor ativo para hoje
          </span>
          <div class="garimpo-ticker-line">
            <span id="garimpo-ticker" class="garimpo-ticker">NVDA</span>
            <span id="garimpo-profile" class="garimpo-profile-tag">
              Day Trade Momentum
            </span>
          </div>
        </div>

        <div class="garimpo-header-right">
          <!-- BOT√ÉO PARA IR AO GARIMPO -->
          <a
            href="garimpo.html"
            class="garimpo-link-btn"
            data-i18n="garimpo_view_page"
          >
            Ver p√°gina do garimpo
          </a>

          <!-- CHIP DE CONFIAN√áA DO C√âREBRO -->
          <div class="garimpo-confidence-chip">
            <span class="chip-label" data-i18n="garimpo_metric_confidence">
              Confian√ßa do c√©rebro
            </span>
            <span id="garimpo-confidence" class="chip-value">91%</span>
          </div>
        </div>
      </div>




      <div class="garimpo-metrics-row">
        <div class="garimpo-metric">
          <div class="metric-label" data-i18n="garimpo_metric_gap">Gap</div>
          <div id="garimpo-gap" class="metric-value">+2.3%</div>
        </div>
        <div class="garimpo-metric">
          <div class="metric-label" data-i18n="garimpo_metric_premarket">
            Pr√©-market vs m√©dia
          </div>
          <div id="garimpo-premarket" class="metric-value">1.8√ó</div>
        </div>
        <div class="garimpo-metric">
          <div class="metric-label" data-i18n="garimpo_metric_atr">
            ATR% (volatilidade)
          </div>
          <div id="garimpo-atr" class="metric-value">2.1%</div>
        </div>
      </div>

      <p class="garimpo-comment" data-i18n="garimpo_comment">
        Hoje este √© o ativo com melhor combina√ß√£o de fluxo, liquidez e
        volatilidade para o seu perfil.
      </p>
    </div>
  </div>
</section>
<!-- ================== FIM GARIMPO DE HOJE ================== -->
<section id="premonition-section" class="premonition-banner">
  <div class="premonition-container">
    <div class="premonition-head">
      <div>
        <div class="premonition-title" id="prem-title">PREMONI√á√ÉO</div>
        <div class="premonition-sub" id="prem-sub">Breakout Window (heur√≠stico)</div>
      </div>
      <div class="premonition-badge" id="prem-badge">‚Äî</div>
    </div>

    <div class="premonition-grid">
      <div class="premonition-chart">
        <canvas id="prem-canvas" class="premonition-canvas" width="900" height="260"></canvas>

        <div class="premonition-kpi">
          <span class="kpi-label" id="prem-kpi-label">Prob. romper ‚Äî</span>
          <span class="kpi-time" id="prem-kpi-time">‚Äî</span>
          <span class="kpi-ampm" id="prem-kpi-ampm"></span>
          <span class="kpi-prob" id="prem-kpi-prob">‚Äî</span>
        </div>
      </div>

      <div class="premonition-panel">
        <!-- KPI grande (estilo mockup) -->
<div class="prem-kpi-right">
  <div class="prem-kpi-right-title" id="prem-right-title">Prob.</div>
        <div class="rr-readout" id="prem-readout">
      <div class="rr-row"><div class="rr-k">REGIME</div><div class="rr-v" id="prem-regime">‚Äî</div></div>
      <div class="rr-row rr-primary"><div class="rr-k">REVERS√ÉO</div><div class="rr-v" id="prem-reversao-full">‚Äî</div></div>
      <div class="rr-row"><div class="rr-k">CONSOLIDA√á√ÉO</div><div class="rr-v" id="prem-consolidacao">‚Äî</div></div>
      <div class="rr-row rr-primary"><div class="rr-k">CONTINUA√á√ÉO</div><div class="rr-v" id="prem-continuacao">‚Äî</div></div>
      <div class="rr-row rr-primary"><div class="rr-k">A√á√ÉO</div><div class="rr-v rr-strong" id="prem-acao-full">‚Äî</div></div>
    </div>



  <div class="prem-kpi-right-main">
    <span class="prem-kpi-right-time" id="prem-right-time">--:--</span>
    <span class="prem-kpi-right-ampm" id="prem-right-ampm"></span>
    <span class="prem-kpi-right-prob" id="prem-right-prob">--%</span>
  </div>

  <div class="prem-kpi-right-sub" id="prem-right-eta">‚Äî</div>
</div>

        <div class="row">
          <div class="label">Janela estimada</div>
          <div class="value" id="prem-window">‚Äî</div>
        </div>

        <div class="row">
          <div class="label">Tempo t√≠pico</div>
          <div class="value" id="prem-median">‚Äî</div>
        </div>

        <div class="row">
          <div class="label">Se n√£o romper...</div>
          <div class="value muted" id="prem-miss">‚Äî</div>
        </div>

        <div class="row">
          <div class="label">Premoni√ß√£o Macro</div>
          <div class="value" id="prem-macro">‚Äî</div>
        </div>

        <div class="row">
          <div class="label">Premoni√ß√£o Micro</div>
          <div class="value" id="prem-micro">‚Äî</div>
        </div>

        <div class="row">
          <div class="label">Base</div>
          <div class="value muted" id="prem-base">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</section>

  <!-- ================== RESPIRO & REVERS√ÉO (abaixo da Premoni√ß√£o) ================== -->
<section class="premonition-banner" id="rr-section">
  <div class="premonition-container" id="rr-container">
    <div class="premonition-head">
      <div class="premonition-title">RESPIRO &amp; REVERS√ÉO</div>
      <div class="premonition-sub">Leitura de microestrutura (respiro ‚Üí revers√£o)</div>
    </div>

    <div class="rr-grid">
      <div class="rr-left">
        <div class="rr-label">Respiro</div>
        <div class="rr-value" id="rr-respiro">‚Äî</div>
      </div>

      <div class="rr-right">
        <div class="rr-label">Revers√£o</div>
        <div class="rr-value" id="rr-reversao">‚Äî</div>
        <div class="rr-sub" id="rr-reversao-sub">‚Äî</div>
      </div>
    </div>

    <div class="rr-badge" id="rr-badge">A√á√ÉO: ‚Äî</div>

    <div class="rr-readout" id="rr-readout">
      <div class="rr-line">
        <span class="rr-k">REGIME:</span> <span class="rr-v" id="rr-regime">‚Äî</span>
        <span class="rr-pipe">|</span>
        <span class="rr-k">REVERS√ÉO:</span> <span class="rr-v" id="rr-reversao-full">‚Äî</span>
        <span class="rr-pipe">|</span>
        <span class="rr-k">RESPIRO:</span> <span class="rr-v" id="rr-respiro-full">‚Äî</span>
      </div>

      <div class="rr-line">
        <span class="rr-k">CONSOLIDA√á√ÉO:</span> <span class="rr-v" id="rr-consolidacao">‚Äî</span>
        <span class="rr-pipe">|</span>
        <span class="rr-k">CONTINUA√á√ÉO:</span> <span class="rr-v" id="rr-continuacao">‚Äî</span>
        <span class="rr-pipe">|</span>
        <span class="rr-k">A√á√ÉO:</span> <span class="rr-v" id="rr-acao">‚Äî</span>
      </div>
    </div>
  </div>
</section>

<!-- ================== FIM RESPIRO & REVERS√ÉO ================== -->



    <div id="error-banner" class="error-banner">
      <strong>Erro ao carregar painel.</strong> Verifique o n8n / webhook e tente novamente.
    </div>

    <!-- ====== LAYOUT PRINCIPAL ====== -->
    <main class="layout">
      <!-- ====== COLUNA ESQUERDA: TV + PADR√ïES ====== -->
      <section class="column">
           <!-- ====== GERENCIADOR DE RISCO ¬∑ ATR ====== -->
<section class="risk-card" id="atr-risk-panel">
  <div class="risk-header">
    <div>
      <div class="risk-title" data-i18n="risk.title">
        Gerenciador de risco ¬∑ ATR
      </div>
      <div class="risk-subtitle" data-i18n="risk.subtitle">
        Ajuste os par√¢metros do ATR e calcule risco / reward da opera√ß√£o.
      </div>
    </div>

    <button
      type="button"
      class="risk-toggle"
      id="atr-risk-toggle"
      data-i18n="risk.toggle_open"
    >
      Abrir
    </button>
  </div>



  <div class="risk-body" id="atr-risk-body" style="display:none;">
    <div class="risk-group">
      <div class="risk-label">Length</div>
      <input id="atr-length-input" type="number" value="14" min="1" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Smoothing</div>
      <select id="atr-smoothing-input">
        <option value="RMA" selected>RMA</option>
        <option value="SMA">SMA</option>
        <option value="EMA">EMA</option>
        <option value="WMA">WMA</option>
      </select>
    </div>

    <div class="risk-group">
      <div class="risk-label">Multiplier</div>
      <input id="atr-multiplier-input" type="number" step="0.1" value="2.3" />
    </div>

    <div class="risk-group">
      <div class="risk-label">ATR atual</div>
      <input id="atr-value-input" type="number" step="0.01" placeholder="ex: 1.25" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Capital da posi√ß√£o ($)</div>
      <input id="atr-capital-input" type="number" step="100" placeholder="ex: 100000" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Pre√ßo de entrada</div>
      <input id="atr-entry-input" type="number" step="0.01" placeholder="ex: 177" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Risco por trade (%)</div>
      <input id="atr-riskpct-input" type="number" step="0.1" value="1" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Lado</div>
      <select id="atr-side-input">
        <option value="buy">Compra</option>
        <option value="sell">Venda</option>
      </select>
    </div>

    <div class="risk-actions">
      <button id="atr-calc-btn" type="button">Calcular risco</button>
    </div>

    <div class="risk-results">
      <div>
        <div class="risk-result-label">Dist√¢ncia do stop (ATR √ó mult)</div>
        <div class="risk-result-value" id="atr-stop-distance">‚Äî</div>
      </div>
      <div>
        <div class="risk-result-label">Qtd. sugerida de a√ß√µes</div>
        <div class="risk-result-value" id="atr-shares">‚Äî</div>
      </div>
      <div>
        <div class="risk-result-label">Risco aproximado</div>
        <div class="risk-result-value" id="atr-risk-money">‚Äî</div>
      </div>
      <div>
        <div class="risk-result-label">Alvo 2R ¬∑ 3R (aprox.)</div>
        <div class="risk-result-value" id="atr-reward-2r">‚Äî</div>
        <div class="risk-result-value small" id="atr-reward-3r">‚Äî</div>
      </div>
    </div>
  </div>
</section>

      <!-- SIZING BRAIN ‚Äì GERENCIADOR DE RISCO -->


      
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="card.tv_title">Painel de Pre√ßo em Tempo Real</div>
<div class="card-subtitle" data-i18n="card.tv_sub">Alpaca PRO + Estrutura do Dia</div>


            </div>
            <div class="badge-outline green">
              <span class="dot"></span>
              Fluxo
              <span id="flow-label">Neutro</span>
            </div>
          </div>

         




          <!-- AARON CHART (ALPACA) -->
<div class="panel-section">
  <div class="panel-section-header">
    <div class="panel-section-title">Gr√°fico em Tempo Real</div>
    <div class="pill-soft pill-soft-accent">Fonte: Alpaca PRO</div>
  </div>

  <!-- AARON Studies (m√≥dulos) -->
  <div class="aaron-studies">
    <div class="aaron-studies-title">AARON Studies</div>

    <div class="aaron-studies-pills">
      <label class="pill-toggle">
        <input id="st-session-hl" type="checkbox" checked />
        <span>Session H/L</span>
      </label>

      <label class="pill-toggle">
        <input id="st-prevday" type="checkbox" checked />
        <span>Prev Day</span>
      </label>

      <label class="pill-toggle">
        <input id="st-orb" type="checkbox" />
        <span>ORB 5m</span>
      </label>

      <label class="pill-toggle">
        <input id="st-vwap" type="checkbox" checked />
        <span>VWAP</span>
      </label>

      <label class="pill-toggle">
        <input id="st-ema21" type="checkbox" checked />
        <span>EMA 21</span>
      </label>
    </div>
  </div>

  <div class="aaron10-chart-shell">
    <div id="aaron10-chart" class="aaron10-chart"></div>

    <!-- overlay discreto (meta do chart) -->
    <div class="aaron10-chart-overlay">
      <div class="pill-small" id="chart-meta">‚Äî</div>
    </div>
  </div>
</div>

        </div>
                  <div class="resp-snap" id="resp-snap">
  <div class="resp-snap-title">RESPONDER OUTPUT</div>

  <div class="resp-kpis">
    <div class="resp-kpi">
      <div class="resp-kpi-label">PATTERN</div>
      <div class="resp-kpi-value" id="resp-kpi-pattern">‚Äî</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">CONFIDENCE</div>
      <div class="resp-kpi-value" id="resp-kpi-confidence">‚Äî</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">BIAS</div>
      <div class="resp-kpi-value" id="resp-kpi-bias">‚Äî</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">DIRECTION</div>
      <div class="resp-kpi-value" id="resp-kpi-direction">‚Äî</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">SR (L‚ÄîH)</div>
      <div class="resp-kpi-value" id="resp-kpi-sr">‚Äî</div>
    </div>
    <div class="resp-kpi">
      <div class="resp-kpi-label">BARS</div>
      <div class="resp-kpi-value" id="resp-kpi-bars">‚Äî</div>
    </div>
  </div>

  <div class="resp-snap-grid">
    <div class="resp-snap-col">
      <div class="resp-snap-head">panel</div>
      <div class="resp-snap-body" id="resp-snap-panel">‚Äî</div>
    </div>

    <div class="resp-snap-col">
      <div class="resp-snap-head">ui</div>
      <div class="resp-snap-body" id="resp-snap-ui">‚Äî</div>
    </div>

    <div class="resp-snap-col">
      <div class="resp-snap-head">digest</div>
      <div class="resp-snap-body" id="resp-snap-digest">‚Äî</div>
    </div>
  </div>
</div>

                  <!-- ===== NOVO: Estrutura recente + Market Structure ===== -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Estrutura recente</div>
            </div>

            <div class="structure-wrapper">
              <!-- Chips HH / HL / LH / LL -->
              <div class="structure-grid">
                <div class="structure-chip" id="structure-hh">
                  <span class="structure-label">HH</span>
                  <span>
                    <span class="structure-status" id="structure-hh-status">off</span>
                    <span class="structure-dot" id="structure-hh-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-hl">
                  <span class="structure-label">HL</span>
                  <span>
                    <span class="structure-status" id="structure-hl-status">off</span>
                    <span class="structure-dot" id="structure-hl-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-lh">
                  <span class="structure-label">LH</span>
                  <span>
                    <span class="structure-status" id="structure-lh-status">ativo</span>
                    <span class="structure-dot on" id="structure-lh-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-ll">
                  <span class="structure-label">LL</span>
                  <span>
                    <span class="structure-status" id="structure-ll-status">ativo</span>
                    <span class="structure-dot on" id="structure-ll-dot"></span>
                  </span>
                </div>
              </div>

              <!-- ZigZag / Market Structure -->
              <div class="structure-zigzag">
                <div class="structure-zigzag-title">
                  Market structure ¬∑ √∫ltimos candles
                </div>
                <div class="structure-zigzag-box">
                  <svg
                    id="structure-zigzag-svg"
                    class="structure-zigzag-svg"
                    viewBox="0 0 100 40"
                    preserveAspectRatio="none"
                  >
                    <polyline
                      id="structure-zigzag-poly"
                      points="0,30 15,12 30,26 45,10 60,24 75,8 90,22 100,14"
                      fill="none"
                      stroke="rgba(248,113,113,0.9)"
                      stroke-width="2.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </div>
            </div>
          </div>
          <!-- ===== /Estrutura recente ===== -->


       <!-- ===== SIZING BRAIN ‚Äì ABAIXO DO TRADEVIEW ===== -->

<!-- ===== SIZING BRAIN ‚Äì GERENCIADOR + CAPITAL DO DIA (ABAIXO DO TRADEVIEW) ===== -->
<section class="card sizing-brain-card" id="sizing-brain-card">
  <div class="card-header">
    <h2>Sizing Brain ‚Äì Gerenciador de Risco & Gest√£o de capital do dia</h2>
    <p class="card-subtitle">
      ATR ‚Ä¢ Capital em uso ‚Ä¢ Stop ‚Ä¢ Take Profit ‚Ä¢ Qtd sugerida ¬∑ Gest√£o de capital do dia
    </p>
  </div>

  <div class="card-body">
    <!-- BLOCO 1 ¬∑ GERENCIADOR DE RISCO (MESMO DE CIMA) -->
    <div class="sb-grid">
      <div class="sb-field">
        <label for="sb-account-balance">Capital real da conta (USD)</label>
        <input id="sb-account-balance" type="number" step="0.01" value="25000" />
      </div>

      <div class="sb-field">
        <label for="sb-leverage">Alavancagem (buying power x)</label>
        <input id="sb-leverage" type="number" step="0.1" value="4" />
        <small id="sb-buying-power-info" class="sb-hint">Buying power ‚âà $100.000</small>
      </div>

      <div class="sb-field">
        <label for="sb-trade-capital">Capital em uso neste trade (USD)</label>
        <input id="sb-trade-capital" type="number" step="0.01" value="50000" />
        <small class="sb-hint">Pode ser menor que o buying power se quiser ser conservador.</small>
      </div>

      <div class="sb-field">
        <label for="sb-risk-percent">Risco m√°x. por trade (% da conta)</label>
        <input id="sb-risk-percent" type="number" step="0.1" value="1" />
        <small class="sb-hint">Ex: 1% em uma conta de 25k = $250 de risco.</small>
      </div>
    </div>

    <hr class="sb-divider" />

    <div class="sb-grid">
      <div class="sb-field">
        <label for="sb-entry-price">Pre√ßo de entrada</label>
        <input id="sb-entry-price" type="number" step="0.01" value="100" />
      </div>

      <div class="sb-field">
        <label for="sb-atr-value">ATR atual ($)</label>
        <input id="sb-atr-value" type="number" step="0.01" value="1.2" />
      </div>

      <div class="sb-field">
        <label for="sb-atr-mult-stop">Multiplicador ATR STOP</label>
        <input id="sb-atr-mult-stop" type="number" step="0.1" value="1.5" />
        <small class="sb-hint">Stop em ATR (ex: 1.5x ATR).</small>
      </div>

      <div class="sb-field">
        <label for="sb-atr-mult-take">Multiplicador ATR TAKE</label>
        <input id="sb-atr-mult-take" type="number" step="0.1" value="3" />
        <small class="sb-hint">Take profit em ATR (ex: 3x ATR).</small>
      </div>

      <div class="sb-field">
        <label>Dire√ß√£o</label>
        <div class="sb-side-toggle">
          <label>
            <input type="radio" name="sb-side" value="long" checked />
            <span>Compra / CALL</span>
          </label>
          <label>
            <input type="radio" name="sb-side" value="short" />
            <span>Venda / PUT</span>
          </label>
        </div>
      </div>
    </div>

    <hr class="sb-divider" />

    <div class="sb-results-grid">
  <div class="sb-result-block">
    <h3>Stop &amp; Alvo (ATR)</h3>
    <p id="sb-stop-distance" class="sb-result-main">Dist√¢ncia do STOP: ‚Äì</p>
    <p id="sb-stop-price" class="sb-result-sub">Stop Loss sugerido: ‚Äì</p>
    <p id="sb-take-price" class="sb-result-sub">Take Profit sugerido: ‚Äì</p>
  </div>

  <div class="sb-result-block">
    <h3>Qtd &amp; Risco</h3>
    <p id="sb-position-size" class="sb-result-main">Qtd sugerida: ‚Äì</p>
    <p id="sb-risk-dollar" class="sb-result-sub">Risco aprox.: ‚Äì</p>
    <p id="sb-risk-percent" class="sb-result-sub">Risco % trade / conta: ‚Äì</p>
  </div>
</div>

<!-- NOVO ¬∑ TERM√îMETRO DO GERENCIADOR DE RISCO (OFFLINE) -->
<div class="sb-meter">
  <div class="sb-meter-label">
    <span>Conservador</span>
    <span id="sb-meter-label">Uso de risco 0%</span>
    <span>Agressivo</span>
  </div>
  <div class="sb-meter-bar">
    <div id="sb-meter-fill" class="sb-meter-fill safe"></div>
  </div>
</div>

<div class="sb-actions">
  <button id="sb-calcular" class="primary-btn">Recalcular Sizing</button>
  <span id="sb-status" class="sb-status">
    Ajuste os valores e clique em ‚ÄúRecalcular Sizing‚Äù.
  </span>
</div>


    <!-- DIVISOR ENTRE GERENCIADOR E CAPITAL DO DIA -->
    <hr class="sb-divider" />

    <!-- BLOCO 2 ¬∑ GEST√ÉO DE CAPITAL DO DIA (O MESMO QUE FICAVA ABAIXO DO TRADEVIEW) -->

    <div class="decision-title" data-i18n="sizing.title">
      Sizing Brain ¬∑ Gest√£o de capital do dia
    </div>

    <!-- HEADER: n√∫meros principais -->
    <div class="sizing-header-row">
      <div class="sizing-main-numbers">
        <div class="sizing-label">
          <span data-i18n="sizing.target_label">Alvo razo√°vel hoje</span>
        </div>
        <div class="sizing-target-value" id="sizing-target">
          0.8‚Äì1.4%
        </div>
      </div>

      <div class="sizing-secondary-numbers">
        <div>
          <span data-i18n="sizing.max_dd">M√°x. perda</span>:
          <strong id="sizing-max-dd">0.8%</strong>
        </div>
        <div>
          <span data-i18n="sizing.risk_trade">Risco / trade</span>:
          <strong id="sizing-risk-trade">0.25%</strong>
        </div>
        <div>
          <span data-i18n="sizing.trades">Trades A+</span>:
          <strong id="sizing-trades-count">3</strong>
        </div>
      </div>
    </div>

    <!-- TAGS: perfil + estilo -->
    <div class="sizing-tag-row">
      <span id="sizing-profile-tag" class="sizing-tag profile-normal">
        Normal
      </span>
      <span id="sizing-style-tag" class="sizing-tag style-daytrade">
        Day trade tendencial
      </span>
    </div>

    <!-- TERM√îMETRO -->
    <div class="sizing-meter">
      <div class="sizing-meter-label">
        <span data-i18n="sizing.conservative">Conservador</span>
        <span id="sizing-meter-label">Uso de risco 40%</span>
        <span data-i18n="sizing.aggressive">Agressivo</span>
      </div>
      <div class="sizing-meter-bar">
        <div
          id="sizing-meter-fill"
          class="sizing-meter-fill"
          style="width:40%;"
        ></div>
      </div>
    </div>

    <!-- Inputs tipo Aaron Pine -->
    <div class="sizing-inputs">
      <div class="sizing-input">
        <label for="sizing-account-real-input">
          Capital REAL da conta (USD)
        </label>
        <input
          id="sizing-account-real-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 10000"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-use-input">
          Capital EM USO neste trade (USD)
        </label>
        <input
          id="sizing-use-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 10000"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-leverage-input">
          Alavancagem (√ó)
        </label>
        <input
          id="sizing-leverage-input"
          type="number"
          inputmode="decimal"
          step="0.1"
          placeholder="ex: 4"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-risk-input">
          Risco por trade (%)
        </label>
        <input
          id="sizing-risk-input"
          type="number"
          inputmode="decimal"
          step="0.1"
          placeholder="ex: 0.5"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-stop-input">
          Dist√¢ncia do stop (USD por share)
        </label>
        <input
          id="sizing-stop-input"
          type="number"
          inputmode="decimal"
          step="0.01"
          placeholder="ex: 1.20"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-fixedqty-input">
          Qtd fixa (a√ß√µes) ‚Äì opcional
        </label>
        <input
          id="sizing-fixedqty-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 100"
        />
      </div>
    </div>

    <!-- Frases + coment√°rio -->
    <div class="sizing-phrase">
      <div id="sizing-phrase-main" class="sizing-phrase-main">
        Digite Capital REAL, EM USO, risco % e stop para ver o tamanho sugerido
        da posi√ß√£o.
      </div>
      <div id="sizing-phrase-detail" class="sizing-phrase-detail"></div>
    </div>

    <div class="sizing-comment" id="sizing-comment">
      Hoje o fluxo permite buscar algo em torno de 0.8‚Äì1.2% se voc√™ focar em 2‚Äì3
      trades A+. Acima disso j√° entra zona de gan√¢ncia; abaixo disso ainda √© um
      dia ok se voc√™ seguiu o plano.
    </div>
  </div>
</section>

<!-- ====== ABA DE REFER√äNCIA (ABAIXO DO SIZING BRAIN) ====== -->
<section class="card ref-card" id="pattern-reference-card">
  <div class="card-header">
    <div>
      <div class="card-title">Refer√™ncia de Padr√£o</div>
      <div class="card-subtitle">Abra para ver a imagem que o THE EYE est√° usando.</div>
    </div>
    <span class="pill neutral">REF</span>
  </div>

  <details class="ref-details" id="refDetails">
    <summary class="ref-summary">
      <span class="ref-summary-left">
        <span class="ref-summary-title" id="refSummaryTitle">Abrir refer√™ncia</span>
        <span class="ref-summary-mini" id="refPatternMini">‚Äî</span>
      </span>
      <span class="ref-summary-right" id="refSummaryRight">Abrir</span>
    </summary>

    <div class="ref-body">
      <div class="ref-grid">
        <div class="ref-img-wrap">
          <img
            id="refPatternImg"
            src="assets/patterns/F%20(1).jpg"
            alt="Refer√™ncia do padr√£o"
            loading="lazy"
          />
        </div>

        <div class="ref-text">
          <div class="ref-line">
            <span class="muted">Padr√£o:</span>
            <strong id="refPatternLabel">‚Äî</strong>
          </div>

          <div class="ref-line">
            <span class="muted">Setup:</span>
            <span id="refPatternSetup">‚Äî</span>
          </div>

          <div class="ref-line">
            <span class="muted">Notas:</span>
            <span id="refPatternNotes">‚Äî</span>
          </div>

          <a
            id="refPatternLink"
            class="ref-link"
            href="assets/patterns/F%20(1).jpg"
            target="_blank"
            rel="noopener"
          >
            Ver imagem em tamanho real
          </a>
        </div>
      </div>
    </div>
  </details>
</section>
<!-- ====== /ABA DE REFER√äNCIA ====== -->





      </section>

      <!-- ====== COLUNA DIREITA: RESUMO + RISCO ====== -->
      <section class="column">
        <div class="card">
  <div class="card-header">
    <div>
      <div class="card-title" data-i18n="summary.title">Resumo institucional</div>
      <div class="card-subtitle" data-i18n="summary.subtitle">Leitura consolidada do AARON 9</div>
    </div>
    <div class="badge-outline">
      <span class="dot"></span>
      <span data-i18n="summary.risk_mgmt">Gest√£o de risco</span>
    </div>
  </div>

<!-- ====== AARON 9 ‚Äì COLUNA DIREITA (DECISION PANEL) ====== -->
<div class="decision-column">

    <!-- AUTO PILOT (fora do Citadel, dentro do Resumo Institucional) -->
<section class="decision-card autopilot-v2" id="autopilot-panel">
  <div class="ap2-top">
    <div>
      <div class="decision-title">AUTO PILOT</div>
      <div class="ap2-sub">Execu√ß√£o r√°pida (simulador)</div>
    </div>

    <div class="ap2-controls">
      <span id="ap-state" class="badge-outline ap-off">OFF</span>

      <label class="ap-switch ap2-switch" title="Liga/desliga o Autopilot (simulador)">
        <input type="checkbox" id="ap-toggle" />
        <span class="ap-slider"></span>
      </label>
    </div>
  </div>

  <!-- ====== MODO 2.0: capital -> units (shares) ====== -->
  <div class="ap2-sizing">
    <div class="ap2-price-row">
      <div class="ap2-quote ap2-quote-sell">
        <div class="ap2-quote-label">Sell</div>
        <div id="ap-price-sell" class="ap2-quote-price">‚Äî</div>
      </div>

      <div class="ap2-quote-mid">
        <div class="ap2-quote-mid-label">Price</div>
        <div id="ap-price-mid" class="ap2-quote-mid-price">‚Äî</div>
      </div>

      <div class="ap2-quote ap2-quote-buy">
        <div class="ap2-quote-label">Buy</div>
        <div id="ap-price-buy" class="ap2-quote-price">‚Äî</div>
      </div>
    </div>

    <div class="ap2-input-row">
      <div class="ap2-field">
        <label class="ap2-label">Units (shares)</label>
        <input id="ap-units" class="ap2-input" type="text" value="‚Äî" readonly />
      </div>

      <div class="ap2-field">
        <label class="ap2-label">Capital USD</label>
        <input id="ap-capital" class="ap2-input" type="number" step="100" value="25000" />
      </div>
    </div>
  </div>

  <div class="ap2-bottom">
    <button id="ap-buy" class="ap-btn ap-buy"><span class="ap2-ico">‚ñ≤</span>BUY</button>
    <button id="ap-sell" class="ap-btn ap-sell"><span class="ap2-ico">‚ñº</span>SELL</button>
    <button id="ap-close" class="ap-btn ap-close"><span class="ap2-ico">‚úï</span>CLOSE</button>

    <span id="ap-meta" class="ap-meta">‚Äî</span>
  </div>
</section>




  <!-- CART√ÉO CITADEL ¬∑ CART√ÉO DE TRADE ATUAL -->
  <section id="trade-card" class="status-hero status-sell blink-hero">
    <div>
      <!-- T√çTULO -->
      <div class="status-hero-label" data-i18n="trade_card.title">
        AARON ‚Äì Cart√£o de Trade Atual
      </div>

      <!-- BLOCO PRINCIPAL DO CART√ÉO -->
      <div class="status-hero-main">
        <div class="trade-line">
          <strong data-i18n="trade_card.status_label">Status:</strong>
          <span id="trade-status-text">‚úÖ Setup v√°lido | ‚ùå Sem trade</span>
        </div>

<div class="trade-line">
  <strong>Pulse:</strong>
  <span id="pulseLine">‚Äî</span>
</div>


        <div class="trade-line" id="trade-stats-top-line" style="display:none;">
  <strong data-i18n="trade_card.stats_label">Estat√≠stica:</strong>
  <span id="trade-stats-top">‚Äî</span>
</div>




        <!-- NOVO: Estat√≠stica (7y) no topo -->
      
        <div class="trade-line">
          <strong data-i18n="trade_card.asset_label">Ativo:</strong>
          <span id="trade-symbol">NVDA</span>
          <span class="trade-sep">|</span>
          <strong data-i18n="trade_card.timeframe_label">Timeframe:</strong>
          <span id="trade-timeframe">1m</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.stats_label">Estat√≠stica:</strong>
          <span id="trade-stats">‚Äî</span>
        </div>


        <div class="trade-line">
          <strong data-i18n="trade_card.mode_label">Modo:</strong>
          <span id="trade-mode">Revers√£o em Resist√™ncia</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.against_label">Contra:</strong>
          <span id="trade-against">57% (base 7 anos)</span>
        </div>

        <hr class="trade-divider" />

        <div class="trade-line">
          <strong data-i18n="trade_card.dir_label">Dire√ß√£o sugerida:</strong>
          <span id="trade-direction">VENDA</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.entry_label">Entrada:</strong>
          <span id="trade-entry">492.80 ‚Äì 493.10</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.stop_label">Stop:</strong>
          <span id="trade-stop">494.20</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.tp_label">TP1:</strong>
          <span id="trade-tp1">490.00</span>
          <span class="trade-sep">|</span>
          <strong>TP2:</strong>
          <span id="trade-tp2">487.50</span>
        </div>

        <hr class="trade-divider" />

        <div class="trade-line">
          <strong data-i18n="trade_card.size_label">Tamanho:</strong>
          <span id="trade-size">227 shares</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.risk_label">Risco:</strong>
          <span id="trade-risk">US$ 250 (1% do risk budget)</span>
        </div>

        <div class="trade-line">
          <strong data-i18n="trade_card.thermo_label">Term√¥metro:</strong>
          <span id="trade-thermo">Agressivo moderado</span>
        </div>

        <hr class="trade-divider" />

        <div class="trade-line trade-comment">
          <strong data-i18n="trade_card.comment_label">Coment√°rio do AARON:</strong>
          <span id="trade-comment">
            ‚ÄúRevers√£o estatisticamente forte ap√≥s falso rompimento.
            Se executar, n√£o mova stop contra a posi√ß√£o.‚Äù
          </span>
        </div>
               


      </div>
    </div>

    <!-- BADGE LATERAL IGUAL AO COMPRA EM CONTINUA√á√ÉO -->
    <div id="trade-badge" class="status-hero-badge sell">
      GO FULL
    </div>
  </section>



  <!-- RESUMO INSTITUCIONAL / VEREDITO -->
<section class="right-col">

  <div class="decision-card hero-mode-card" id="hero-block">
    <div class="decision-row">
      <div>
        <div class="decision-title">RESUMO INSTITUCIONAL</div>
        <button class="decision-pill go-full" id="hero-mode-pill">GO FULL</button>
      </div>
      <div class="decision-verdict" id="hero-side-label">‚Äî</div>
    </div>

    <div class="decision-text" id="hero-summary-text">
      Carregando leitura institucional do mercado...
    </div>

    <div class="decision-title" style="margin-bottom:2px;">A favor</div>
    <div class="decision-subtitle" id="hero-favor-label">A favor: ‚Äî%</div>
    <div class="decision-bar">
      <div class="decision-bar-fill" id="hero-favor-bar" style="width:0%"></div>
    </div>
    <div class="prob-phrase" id="hero-favor-phrase">‚Äî</div>

    <div style="height:10px"></div>

    <div class="decision-title" style="margin-bottom:2px;">Contra</div>
    <div class="decision-subtitle" id="hero-contra-label">Contra: ‚Äî%</div>
    <div class="decision-bar">
      <div class="decision-bar-fill-danger" id="hero-contra-bar" style="width:0%"></div>
    </div>
    <div class="prob-phrase prob-phrase-danger" id="hero-contra-phrase">‚Äî</div>

    <div class="decision-grid3">
      <div>
        <div class="decision-mini-title">RISCO</div>
        <div class="decision-mini-text" id="hero-mini-risk">‚Äî</div>
      </div>
      <div>
        <div class="decision-mini-title">CONTEXTO</div>
        <div class="decision-mini-text" id="hero-mini-context">‚Äî</div>
      </div>
      <div>
        <div class="decision-mini-title">EXECU√á√ÉO</div>
        <div class="decision-mini-text" id="hero-mini-execution">‚Äî</div>
      </div>
    </div>
  </div>

</section>

    <!-- PULLBACK BRAIN ¬∑ C√âREBRO ESPECIAL DE PULLBACK -->
  <section class="decision-card" id="pullback-brain-card">
    <div class="decision-title" data-i18n="pullback.title">
      Pullback Brain ¬∑ Zona de respiro
    </div>

    <!-- HEADER: status + tags -->
    <div class="pullback-header-row">
      <div class="pullback-status-block">
        <div class="pullback-status-label">Status</div>
        <div id="pullback-status" class="pullback-status-main">
          Aguardando pullback...
        </div>
      </div>

      <div class="pullback-meta-block">
        <div>
          <span data-i18n="pullback.depth">Profundidade</span>:
          <strong id="pullback-depth">‚Äî</strong>
        </div>
        <div>
          <span data-i18n="pullback.quality">Qualidade</span>:
          <strong id="pullback-quality">‚Äî</strong>
        </div>

        <div class="pullback-tag-row">
          <span id="pullback-side-tag" class="pullback-tag side-neutral">
            NEUTRO
          </span>
          <span id="pullback-stage-tag" class="pullback-tag stage">
            Aguardando
          </span>
        </div>
      </div>
    </div>

    <!-- TERM√îMETRO / CONFIAN√áA DO PULLBACK -->
    <div class="pullback-meter">
      <div class="pullback-meter-label">
        <span>Somente respiro</span>
        <span id="pullback-meter-label">Confian√ßa 40%</span>
        <span>Revers√£o forte</span>
      </div>
      <div class="pullback-meter-bar">
        <div
          id="pullback-meter-fill"
          class="pullback-meter-fill neutral"
          style="width:40%;"
        ></div>
      </div>
    </div>

    <!-- TEXTO "HUMANO" DO C√âREBRO DE PULLBACK -->
    <div class="pullback-highlight" id="pullback-highlight-box">
      <div id="pullback-headline" style="font-weight:600; margin-bottom:4px;">
        Pullback ainda saud√°vel dentro da tend√™ncia.
      </div>
      <div id="pullback-text" style="font-size:0.8rem;">
        Ainda n√£o h√° um pullback claro.  
        O mercado ainda n√£o ofereceu um pullback limpo na dire√ß√£o principal.
        Deixe o pre√ßo respirar e espere estrutura.
      </div>
    </div>
  </section>

   


  <!-- CHECKLIST DE PADR√ïES -->
  <section class="decision-card">
    <div class="decision-title">Checklist de padr√µes</div>
    <div class="checklist-grid">
      <div class="check-pill on">Rompimento</div>
      <div class="check-pill">Continua√ß√£o</div>
      <div class="check-pill">Revers√£o (ausente)</div>
      <div class="check-pill on">Diverg√™ncia</div>
      <div class="check-pill">Exaust√£o</div>
      <div class="check-pill">Volume normal</div>
    </div>
  </section>

  <!-- PATTERN RADAR + CHECK PULLBACK -->
  <section class="decision-card">
  <div class="decision-title">Pattern radar ¬∑ estrutura</div>

  <div class="pattern-layout" style="margin-top:6px;">

    <!-- PADR√ÉO DO DIA -->
    <div class="pattern-box">
      <div class="decision-title" style="margin-bottom:4px;">Padr√£o do dia</div>

      <div class="pattern-canvas">
        <!-- Desenho simb√≥lico do padr√£o do dia (ex.: canal de baixa) -->
        <svg class="pattern-svg" viewBox="0 0 100 36">
          <polyline
            points="0,10 20,16 40,20 60,24 80,28 100,32"
            fill="none"
            stroke="rgba(248,113,113,0.9)"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

           <div id="pattern-day-label" class="pattern-name">Canal de baixa moderada</div>
      <div id="pattern-day-detail">
        Pre√ßo respeitando topos e fundos descendentes durante o dia. Favorece opera√ß√µes a favor da tend√™ncia de baixa.
      </div>


    <!-- PADR√ÉO DO MOMENTO (√∫ltimos 50 candles) -->
    <div class="pattern-box">
      <div class="decision-title" style="margin-bottom:4px;">Padr√£o do momento ¬∑ √∫ltimos 50 candles</div>

      <div class="pattern-canvas">
        <!-- Desenho simb√≥lico do padr√£o do momento (ex.: range / zigue-zague) -->
        <svg class="pattern-svg" viewBox="0 0 100 36">
          <polyline
            points="0,26 15,10 30,24 45,12 60,22 75,8 90,20 100,14"
            fill="none"
            stroke="rgba(56,189,248,0.9)"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

           <div id="pattern-now-label" class="pattern-name">Range / consolida√ß√£o ativa</div>
      <div id="pattern-now-detail">
        Mercado alternando entre suporte e resist√™ncia nos √∫ltimos candles. Melhor aguardar rompimento ou pullback bem claro.
      </div>

    </div>

  </div>


    <!-- Check de pullback / respiro -->
    <div class="pullback-highlight">
      <div style="font-weight:600; margin-bottom:4px;">Check de pullback</div>
      <div style="font-size:0.78rem;">
        ATR do candle atual: <strong>0.85</strong> ¬∑ Profundidade: <strong>0.96 ATR</strong><br />
        Tend√™ncia: <strong>Baixa forte</strong> ¬∑ Estrutura: <strong>LH</strong><br />
        Pullback dentro da faixa ideal. Continua√ß√£o prov√°vel se o contexto se mantiver.
      </div>
    </div>
  </section>

</div>

          <!-- Coment√°rio principal -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Coment√°rio do Painel</div>
            </div>
            <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
              <div id="summary-text" style="font-size: 12px; line-height: 1.5; color: var(--text-main);">
                Aguardando primeiro alerta do TradingView para montar o painel...
              </div>
            </div>
          </div>

          <!-- Risco + Contexto -->
          <div class="grid-2">
            <div class="panel-section">
              <div class="panel-section-header">
                <div class="panel-section-title">Risco</div>
              </div>
              <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                <div class="pill" id="risk-pill">Neutro</div>
                <div id="risk-text" style="font-size: 12px; color: var(--text-soft);">
                  ‚Äî
                </div>
              </div>
            </div>

            <div class="panel-section">
              <div class="panel-section-header">
                <div class="panel-section-title">Contexto</div>
              </div>
              <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                <div id="context-text" style="font-size: 12px; color: var(--text-soft);">
                  ‚Äî
                </div>
              </div>
            </div>
          </div>

          <!-- Execu√ß√£o -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Execu√ß√£o</div>
            </div>
            <div id="execution-text" style="font-size: 12px; color: var(--text-soft);">
              ‚Äî
            </div>
          </div>
        </div>
      </section>
    </main>
      </div> <!-- /.page -->
    </div>   <!-- /.app-inner -->
  </div>     <!-- /.app-shell -->

  <script>
// ======= CONFIG PAINEL (JSON) =======
const PANEL_URL = 'https://jjjnogueira.app.n8n.cloud/webhook/aaron10_panel_json';
const REFRESH_MS = 60000; // 1 minuto

// ======= AARON10 (FASE 1) ‚Äî Dropdown -> n8n WEBHOOK (symbol) =======
// COLE ESTE BLOCO LOGO ABAIXO DO: const REFRESH_MS = 60000;

// OP√á√ÉO 2 (direto)
const MATCHER_WEBHOOK_URL_PROD = "https://jjjnogueira.app.n8n.cloud/webhook/aaron10_matcher_request";
const MATCHER_WEBHOOK_URL_TEST = "https://jjjnogueira.app.n8n.cloud/webhook-test/aaron10_matcher_request";
const MATCHER_WEBHOOK_URL = MATCHER_WEBHOOK_URL_PROD; // default
// (pra testar no editor do n8n, use webhook-test):
// const MATCHER_WEBHOOK_URL = "https://jjjnogueira.app.n8n.cloud/webhook-test/aaron10_matcher_request"; 
// Exemplo (prod): https://SEU_WORKSPACE.app.n8n.cloud/webhook/aaron10_matcher_request
// (n√£o use a test url depois de publicar; use a url de produ√ß√£o)


// ======= AARON10 LIVE CANDLES (Alpaca PRO ‚Üí Cloud Run ‚Üí UI) =======
const A10_USE_LIVE_CANDLES = true;

// Cloud Run (SEU servi√ßo atual)
const A10_LIVE_WS_URL_PROD = "wss://aaron10-panel-api-888402066046.us-central1.run.app/ws";

// (opcional) preview/local (se quiser depois trocar pra ws://localhost:8080/ws)
const A10_LIVE_WS_URL_TEST = "wss://aaron10-panel-api-888402066046.us-central1.run.app/ws";

// auto-select: local (file://, localhost, 127.0.0.1) -> TEST, sen√£o -> PROD
const __A10_IS_LOCAL =
  (location.protocol === "file:" ||
   location.hostname === "" ||
   location.hostname === "localhost" ||
   location.hostname === "127.0.0.1");

const A10_LIVE_WS_URL = __A10_IS_LOCAL ? A10_LIVE_WS_URL_TEST : A10_LIVE_WS_URL_PROD;

let a10LiveWanted = { symbol: null, timeframe: null };

// timers/estado (pra n√£o dar ReferenceError)
let a10LiveWS = null;
let a10LiveReconnectTimer = null;
let a10LiveHeartbeatTimer = null;
let a10LastMsgAt = 0;
window.a10LastMsgAt = 0;
// backoff de reconex√£o (evita spam/429 no Cloud Run)
const A10_LIVE_RETRY_MIN_MS = 5000;   // 5s
const A10_LIVE_RETRY_MAX_MS = 60000;  // 60s
let a10LiveRetryMs = A10_LIVE_RETRY_MIN_MS;


function a10LiveSetStatus(text){
  const msg = text || "‚Äî";

  // 1) label do topo (Sess√£o)
  const el = document.getElementById("session-label");
  if (el) el.textContent = msg;

  // 2) Mostra tamb√©m no ‚ÄúLIVE FEED‚Äù
  const liveEl = document.querySelector(".status-dot-live");
  if (liveEl) liveEl.textContent = msg;

  window.__A10_LIVE_STATUS__ = msg;
}

function a10LiveClose(){
  try { if (a10LiveWS) a10LiveWS.close(); } catch(e){}
  a10LiveWS = null;

  // (1B) zera tamb√©m no window pra console refletir na hora
  window.a10LiveWS = null;

  window.a10LastMsgAt = 0;

  if (a10LiveReconnectTimer) clearTimeout(a10LiveReconnectTimer);
  a10LiveReconnectTimer = null;

  if (a10LiveHeartbeatTimer) clearInterval(a10LiveHeartbeatTimer);
  a10LiveHeartbeatTimer = null;

  window.__A10_LIVE_FALLBACK_TRIED__ = false;
}



function a10LiveSubscribe(symbol, timeframe){
  const sym = String(symbol || "").trim().toUpperCase();
  const tfRaw = String(timeframe || "1m").trim();

  if (!sym) return;
  if (!a10LiveWS || a10LiveWS.readyState !== 1) return;

  // normaliza timeframe ‚Äúdesejado‚Äù (UI)
  const desiredTf =
    (/^\d+m(in)?$/i.test(tfRaw) || /^\d+m$/i.test(tfRaw)) ? tfRaw.replace(/in$/i, '') :
    (/^\d+min$/i.test(tfRaw)) ? tfRaw :
    tfRaw;

  // üî• IMPORTANTE:
  // A maioria dos relays/streams s√≥ entrega BAR em 1m (ou trades).
  // Ent√£o a gente SEMPRE pede 1m no wire e agrega localmente pro timeframe desejado.
  const wireTf = "1m";

  // payload compat√≠vel (type + action) pra n√£o depender do nome do campo no server
  const payload = {
    type: "subscribe",
    action: "subscribe",
    symbol: sym,
    timeframe: wireTf,           // ‚úÖ sempre 1m
    target_timeframe: desiredTf  // (debug) timeframe real da UI
  };

  // debug global
  window.__A10_LIVE_LAST_SUB__ = payload;

  try { a10LiveWS.send(JSON.stringify(payload)); } catch(e){}

  a10LiveSetStatus(`LIVE: subscribed ${sym} ${desiredTf} (wire ${wireTf})`);
}


function a10LiveHandleMessage(payloadOrEvent) {
  // aceita tanto o Event do WS quanto o "data" puro (string/obj)
  const data = (payloadOrEvent && typeof payloadOrEvent === "object" && "data" in payloadOrEvent)
    ? payloadOrEvent.data
    : payloadOrEvent;

  if (!data) return;

  // debug raw
  window.__A10_LIVE_LAST_RAW__ = data;

  // garante chart
  a10InitChart();

  // parse
  let obj = data;
  if (typeof data === "string") {
    try { obj = JSON.parse(data); } catch (e) {}
  }
    // Se o relay mandar status (ex.: "ALPACA: disconnected"), mostra e tenta resetar
  if (obj && typeof obj === "object" && String(obj.type || "").toLowerCase() === "status" && obj.status) {
    window.__A10_LIVE_LAST_OBJ__ = obj;

    const s = String(obj.status);
    a10LiveSetStatus(s);

    // Se o bridge Alpaca caiu mas o WS UI ainda est√° aberto, for√ßa reset (throttle 5s)
    if (/alpaca/i.test(s) && /disconnected|down|error/i.test(s)) {
      const now = Date.now();
      if (!window.__A10_RELAY_RESET_AT__ || (now - window.__A10_RELAY_RESET_AT__) > 5000) {
        window.__A10_RELAY_RESET_AT__ = now;
        try { a10LiveClose(); } catch(e) {}
        const w = a10LiveWanted || {};
        if (w.symbol) setTimeout(() => a10LiveConnect(w.symbol, w.timeframe), 250);
      }
    }
    return;
  }


  const wanted = a10LiveWanted || {};
  const symWanted = String(wanted.symbol || "").trim().toUpperCase();
  const tfWanted = String(wanted.timeframe || "1m").trim();

  function tfToSec(tf){
    const s = String(tf || "1m").trim().toLowerCase();
    if (/^\d+m$/.test(s)) return Math.max(1, parseInt(s, 10)) * 60;
    if (/^\d+h$/.test(s)) return Math.max(1, parseInt(s, 10)) * 3600;
    if (s === "1d" || s === "d") return 86400;
    return 60;
  }

  const bucketSec = tfToSec(tfWanted);

  function normOHLC(x){
    if (!x || typeof x !== "object") return null;

    const tSec = a10UnixSec(x?.t ?? x?.time ?? x?.timestamp ?? x?.datetime);
    const o = Number(x?.o ?? x?.open);
    const h = Number(x?.h ?? x?.high);
    const l = Number(x?.l ?? x?.low);
    const c = Number(x?.c ?? x?.close);
    const v = Number(x?.v ?? x?.volume ?? 0);

    if (!tSec) return null;
    if (!Number.isFinite(o) || !Number.isFinite(h) || !Number.isFinite(l) || !Number.isFinite(c)) return null;

    return { tSec, open:o, high:h, low:l, close:c, volume: Number.isFinite(v) ? v : 0 };
  }

  function normTrade(x){
    if (!x || typeof x !== "object") return null;

    const tSec = a10UnixSec(x?.t ?? x?.time ?? x?.timestamp ?? x?.datetime);
    const p = Number(x?.p ?? x?.price);
    const s = Number(x?.s ?? x?.size ?? x?.q ?? x?.qty ?? x?.volume ?? 0);

    if (!tSec) return null;
    if (!Number.isFinite(p)) return null;

    return { tSec, open:p, high:p, low:p, close:p, volume: Number.isFinite(s) ? s : 0 };
  }

  function buildAggBar(norm){
    if (!norm) return null;

    const bucketTime = Math.floor(norm.tSec / bucketSec) * bucketSec;

    // usa o candle que j√° est√° na tela como ‚Äúestado‚Äù (open fixa, high/low expandem)
    const hasBase = Array.isArray(a10ChartCandles) && a10ChartCandles.length > 0;
    const last = hasBase ? a10ChartCandles[a10ChartCandles.length - 1] : null;

    let o, h, l, c, v;

    if (last && last.time === bucketTime) {
      o = last.open;
      h = Math.max(last.high, norm.high);
      l = Math.min(last.low,  norm.low);
      c = norm.close;
      v = (Number(last.volume) || 0) + (Number(norm.volume) || 0);
    } else if (last && bucketTime > last.time) {
      o = norm.open;
      h = norm.high;
      l = norm.low;
      c = norm.close;
      v = Number(norm.volume) || 0;
    } else if (!last) {
      o = norm.open;
      h = norm.high;
      l = norm.low;
      c = norm.close;
      v = Number(norm.volume) || 0;
    } else {
      // out-of-order/antigo: manda o ‚Äúnorm‚Äù bucketizado mesmo
      o = norm.open;
      h = norm.high;
      l = norm.low;
      c = norm.close;
      v = Number(norm.volume) || 0;
    }

    return { t: bucketTime, o, h, l, c, v };
  }

      function pushAggBar(bar){
    if (!bar) return;

    window.__A10_LIVE_HAS_BARS__ = true;
    window.__A10_LIVE_LAST_BAR_AT__ = Date.now(); // ‚úÖ s√≥ quando chega BAR/TRADE
    window.__A10_LIVE_LAST_BAR_T__  = bar.t;

    a10UpdateChartFromPayload({
      bars: [bar],
      symbol: symWanted,
      timeframe: tfWanted,
      __live: true
    });
  }



    function handleOne(msg) {
    if (!msg) return;

    // lista
    if (Array.isArray(msg)) { msg.forEach(handleOne); return; }

    // envelope com bar / bars / candles / data
    if (msg && typeof msg === "object") {
      if (msg.bar && typeof msg.bar === "object") { handleOne(msg.bar); return; }

      // ‚úÖ PATCH: suporta { type:"candle_update", candle:{...} }
      if (msg.candle && typeof msg.candle === "object") { handleOne(msg.candle); return; }

      if (Array.isArray(msg.bars) || Array.isArray(msg.candles)) { handleOne(msg.bars || msg.candles); return; }
      if (msg.data) { handleOne(msg.data); return; }
    }


    // 1) BAR OHLC
    const ohlc = normOHLC(msg);
    if (ohlc) {
      window.__A10_LIVE_LAST_45__ = ohlc;
      const bar = buildAggBar(ohlc);
      pushAggBar(bar);
      return;
    }

    // 2) TRADE tick (p/t)
    const tr = normTrade(msg);
    if (tr) {
      window.__A10_LIVE_LAST_45__ = tr;
      const bar = buildAggBar(tr);
      pushAggBar(bar);
      return;
    }

    // fallback debug
    window.__A10_LIVE_LAST_OBJ__ = msg;
  }

  handleOne(obj);
}



function a10LiveConnect(symbol, timeframe) {
  if (!A10_USE_LIVE_CANDLES) return;

  // guarda o "desejado" (pra reconectar certo)
  a10LiveWanted = { symbol, timeframe };
    window.__A10_LIVE_HAS_BARS__ = false;
  window.__A10_LIVE_LAST_BAR_AT__ = 0;
  window.__A10_LIVE_LAST_BAR_T__ = 0;
  window.__A10_LIVE_LAST_45__ = null;


  // fecha WS anterior (se existir)
  try { a10LiveClose(); } catch (e) {}

  // garante /ws
  const base = String(A10_LIVE_WS_URL || "").trim();
  const url = base.endsWith("/ws") ? base : (base.replace(/\/+$/, "") + "/ws");

  a10LiveSetStatus("ALPACA: CONNECTING");

  try {
    const ws = new WebSocket(url);
a10LiveWS = ws;
window.a10LiveWS = ws; // (1B) aparece no console


    ws.addEventListener("open", () => {
  if (ws !== a10LiveWS) return; // ignora socket velho
  a10LastMsgAt = Date.now();
  window.a10LastMsgAt = a10LastMsgAt; // debug no console
  a10LiveRetryMs = A10_LIVE_RETRY_MIN_MS; // resetou porque conectou

  a10LiveSetStatus("ALPACA: CONNECTED");

  // heartbeat (UI): N√ÉO envia ping pro relay
  // (se o relay repassar pro WS da Alpaca, isso pode derrubar a Alpaca)
        // heartbeat (UI): N√ÉO envia ping pro relay
      if (a10LiveHeartbeatTimer) clearInterval(a10LiveHeartbeatTimer);
      a10LiveHeartbeatTimer = setInterval(() => {
        window.__A10_UI_HEARTBEAT__ = Date.now();
      }, 15000);

  // subscribe assim que conectar
  a10LiveSubscribe(symbol, timeframe);
});


    // ‚úÖ CR√çTICO: passar o Event (o handler aceita Event ou data)
ws.addEventListener("message", (ev) => {
  if (ws !== a10LiveWS) return;
  a10LastMsgAt = Date.now();
  window.a10LastMsgAt = a10LastMsgAt; // debug no console
  a10LiveHandleMessage(ev);
});



    ws.addEventListener("close", (e) => {
  if (ws !== a10LiveWS) return; // close de socket velho: ignora

  const code = (e && typeof e.code === "number") ? e.code : 0;
  const waitMs = Math.max(A10_LIVE_RETRY_MIN_MS, a10LiveRetryMs || A10_LIVE_RETRY_MIN_MS);

  a10LiveSetStatus(`ALPACA: DISCONNECTED (${code || "close"}) ‚Äî retry em ${Math.round(waitMs/1000)}s`);

  if (a10LiveHeartbeatTimer) clearInterval(a10LiveHeartbeatTimer);
  a10LiveHeartbeatTimer = null;

  if (a10LiveReconnectTimer) clearTimeout(a10LiveReconnectTimer);

  // aumenta backoff (cap)
  a10LiveRetryMs = Math.min(A10_LIVE_RETRY_MAX_MS, Math.round(waitMs * 1.8));

  a10LiveReconnectTimer = setTimeout(() => {
    const w = a10LiveWanted || {};
    if (w.symbol) a10LiveConnect(w.symbol, w.timeframe);
  }, waitMs);
});


    ws.addEventListener("error", () => {
  if (ws !== a10LiveWS) return;
  a10LiveSetStatus("ALPACA: WS ERROR");
  try { ws.close(); } catch(e) {}
});

  } catch (err) {
    console.error(err);
    a10LiveSetStatus("ALPACA: CONNECT FAIL");
  }
}







// ======= AARON10 (FASE 2) ‚Äî Timeframe picker (UI) + query param =======
const AARON_TF_KEY = "aaron_selected_timeframe";


function getSelectedTimeframe(){
  const tf = (window.AARON_SELECTED_TIMEFRAME || localStorage.getItem(AARON_TF_KEY) || "1m").toString().trim();
  return tf || "1m";
}

function setSelectedTimeframe(tf, opts = {}){
  const { dispatch = true } = opts;
  tf = String(tf || "").trim();
  if (!tf) return;

  window.AARON_SELECTED_TIMEFRAME = tf;
  try { localStorage.setItem(AARON_TF_KEY, tf); } catch(e){}

  // UI active state
  const picker = document.getElementById("tf-picker");
  if (picker) {
    picker.querySelectorAll(".tf-btn").forEach(btn => {
      const isOn = String(btn.dataset.tf || "") === tf;
      btn.classList.toggle("active", isOn);
    });
  }

  // labels
  const tfLabel = document.getElementById("timeframe-label");
  if (tfLabel) tfLabel.textContent = tf.toUpperCase();

  const tradeTf = document.getElementById("trade-timeframe");
  if (tradeTf) tradeTf.textContent = tf.toUpperCase();

  if (dispatch) {
    window.dispatchEvent(new CustomEvent("aaron:timeframeSelected", { detail: { timeframe: tf } }));
  }
}

function installTimeframePicker(){
  const picker = document.getElementById("tf-picker");
  if (!picker) return;

  if (picker.__installed) return;
  picker.__installed = true;

  picker.addEventListener("click", (e) => {
    const btn = e.target.closest(".tf-btn");
    if (!btn) return;
    const tf = String(btn.dataset.tf || "").trim();
    if (!tf) return;
    setSelectedTimeframe(tf, { dispatch: true });
  });

  // init from storage
  const initTf = getSelectedTimeframe();
  setSelectedTimeframe(initTf, { dispatch: false });
}

// instala agora (script est√° no fim do body)
installTimeframePicker();

window.addEventListener("aaron:timeframeSelected", () => {
  const symbol =
    window.AARON_SELECTED_SYMBOL ||
    localStorage.getItem("aaron_selected_symbol") ||
    "NVDA";

  const tf =
    (typeof getSelectedTimeframe === "function")
      ? getSelectedTimeframe()
      : (localStorage.getItem("aaron_selected_timeframe") || "1m");

  // ‚úÖ re-assina live candles no novo TF
  if (typeof a10LiveConnect === "function") a10LiveConnect(symbol, tf);

  requestMatcher(symbol);
  loadPanel(true);
});


// chama o n8n e atualiza o painel com o retorno
// ==========================
// TRADE CARD ‚Ä¢ RESPONDER OUTPUT renderer
// ==========================
// chama o n8n e atualiza o painel com o retorno
// ==========================
// RESPONDER OUTPUT helpers
// ==========================
function setRespSnapMessage(msg){
  const html = `<div class="resp-snap-null">${String(msg || "‚Äî")}</div>`;
  ["resp-snap-panel","resp-snap-ui","resp-snap-digest"].forEach((id)=>{
    const el = document.getElementById(id);
    if (el) el.innerHTML = html;
  });
  // KPIs (se existirem)
  ["resp-kpi-pattern","resp-kpi-conf","resp-kpi-bias","resp-kpi-dir","resp-kpi-sr","resp-kpi-bars","resp-kpi-price"]
    .forEach((id)=>{
      const el = document.getElementById(id);
      if (el) el.textContent = "‚Äî";
    });
}

// ==========================
// TRADE CARD ‚Ä¢ RESPONDER OUTPUT renderer
// ==========================
function renderTradeResponderOutput(data){
  data = Array.isArray(data) ? (data[0] ?? {}) : (data ?? {});
  const elPanel  = document.getElementById("resp-snap-panel");
  const elUI     = document.getElementById("resp-snap-ui");
  const elDigest = document.getElementById("resp-snap-digest");
  if (!elPanel || !elUI || !elDigest) return;

  const panel  = data?.panel  || {};
  const ui     = data?.ui     || {};
  const digest = data?.digest || {};

  // ====== KPI row (WOW "na cara") ======
  const sf = digest?.shape_focus || {};
  const sr = digest?.sr_proxy || {};

  const setK = (id, v) => {
    const el = document.getElementById(id);
    if (!el) return;
    const out = (v === undefined || v === null || v === "") ? "‚Äî" : String(v);
    el.textContent = out;
  };

  setK("resp-kpi-pattern", sf.label || ui.structure_line || "‚Äî");
  setK("resp-kpi-conf", ui.confidence_label || (sf.confidence_pct != null ? `${sf.confidence_pct}%` : "‚Äî"));
  setK("resp-kpi-bias", sf.bias || "‚Äî");
  setK("resp-kpi-dir",  sf.direction || sr.direction || "‚Äî");
  setK("resp-kpi-sr",   (sr.recent_low != null || sr.recent_high != null) ? `${sr.recent_low ?? "‚Äî"} ‚Äî ${sr.recent_high ?? "‚Äî"}` : "‚Äî");
  setK("resp-kpi-bars", digest.intraday_bars ?? "‚Äî");
  setK("resp-kpi-price", (panel.price_now ?? ui.price_now ?? digest.price_now) ?? "‚Äî");

  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");

  const fmt = (v) => {
    if (v === null || v === undefined) return { html:`<span class="resp-snap-null">null</span>`, plain:"null" };
    if (typeof v === "boolean") {
      return {
        html: `<span class="resp-bool ${v ? "resp-bool-true" : "resp-bool-false"}">${v}</span>`,
        plain: String(v)
      };
    }
    if (Array.isArray(v)) {
      const p = v.map(x => (x === null || x === undefined) ? "null" : String(x));
      const plain = p.join(", ");
      return { html: esc(plain), plain };
    }
    if (typeof v === "object") {
      const plain = JSON.stringify(v);
      return { html: `<span class="resp-snap-null">${esc(plain)}</span>`, plain };
    }
    const plain = String(v);
    return { html: esc(plain), plain };
  };

  const flatten = (obj, prefix = "", out = [], depth = 0) => {
    if (!obj || typeof obj !== "object") return out;
    for (const [k,v] of Object.entries(obj)){
      const key = prefix ? `${prefix}.${k}` : k;
      const isObj = v && typeof v === "object" && !Array.isArray(v);
      if (isObj && depth < 2) flatten(v, key, out, depth+1);
      else out.push([key, v]);
    }
    return out;
  };

  // prioridades p/ ficar "na cara" primeiro
  const P_PANEL  = ["symbol","timeframe","session","flow_label","status.label","updated_at","price_now","last_price","reference_price"];
  const P_UI     = ["confidence_pct","confidence_label","headline","structure_line","tactical_line","market_structure_line","pullback_line","detector_key","price_now"];
  const P_DIGEST = [
    "shape_focus.pattern_id","shape_focus.label","shape_focus.name_pt","shape_focus.family_en",
    "shape_focus.bias","shape_focus.direction","shape_focus.confidence_pct",
    "sr_proxy.recent_high","sr_proxy.recent_low","intraday_bars","features_true","price_now"
  ];

  const renderCol = (title, obj, priorities, el) => {
    const rows = flatten(obj);

    // mapa p/ ordenar prioridades
    const idx = new Map();
    priorities.forEach((k,i)=> idx.set(k, i));

    rows.sort((a,b)=>{
      const ak = a[0], bk = b[0];
      const ai = idx.has(ak) ? idx.get(ak) : 9999;
      const bi = idx.has(bk) ? idx.get(bk) : 9999;
      if (ai !== bi) return ai - bi;
      return ak.localeCompare(bk);
    });

    const prev = window.__RESP_SNAP_PREV__ || {};
    const next = {};

    let html = "";
    for (const [k,v] of rows){
      const { html:vh, plain:vp } = fmt(v);
      const keyFull = `${title}.${k}`;
      const was = prev[keyFull];
      const changed = (was !== undefined && was !== vp);
      next[keyFull] = vp;

      const strong = idx.has(k) ? "resp-snap-strong" : "";
      const flash  = changed ? "resp-snap-flash" : "";

      html += `
        <div class="resp-snap-row ${strong} ${flash}">
          <div class="resp-snap-key">${esc(k)}</div>
          <div class="resp-snap-val">${vh}</div>
        </div>
      `;
    }

    window.__RESP_SNAP_PREV__ = { ...prev, ...next };
    el.innerHTML = html || "‚Äî";
  };

  renderCol("panel",  panel,  P_PANEL,  elPanel);
  renderCol("ui",     ui,     P_UI,     elUI);
  renderCol("digest", digest, P_DIGEST, elDigest);
}

function escapeHtml(v){
  const s = (v===null || v===undefined) ? "" : String(v);
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function safe(v, fallback="‚Äî"){
  return (v===null || v===undefined || v==="") ? fallback : String(v);
}
function mapDir(dir){
  const d = String(dir||"").toLowerCase();
  if (d==="up" || d==="bull" || d==="long") return "COMPRA";
  if (d==="down" || d==="bear" || d==="short") return "VENDA";
  if (!d) return "‚Äî";
  return d.toUpperCase();
}

// <<< isso cria um ‚Äúresumo‚Äù DENTRO do trade card (sem aquele grid de cards)
function ensureRespInlineSlot(){
  const anchor = document.getElementById("resp-snap-msg") || document.getElementById("resp-out-panel");
  if (!anchor || !anchor.parentElement) return null;

  let box = document.getElementById("resp-inline");
  if (box) return box;

  box = document.createElement("div");
  box.id = "resp-inline";
  box.style.margin = "10px 0 6px 0";
  box.style.padding = "10px 12px";
  box.style.border = "1px solid rgba(255,255,255,.08)";
  box.style.borderRadius = "12px";
  box.style.background = "rgba(10,14,22,.35)";

  anchor.parentElement.insertBefore(box, anchor);
  return box;
}

function renderResponderInline(data){
  const box = ensureRespInlineSlot();
  if (!box) return;

  const ui = data?.ui || {};
  const digest = data?.digest || {};
  const sf = digest?.shape_focus || {};
  const sr = digest?.sr_proxy || {};

  const conf = safe(ui.confidence_label || (sf.confidence_pct!=null ? `${sf.confidence_pct}%` : ""), "‚Äî");

  box.innerHTML = `
    <div style="font-weight:700; letter-spacing:.14em; font-size:10px; opacity:.85; margin-bottom:6px;">
      RESPONDER
    </div>
    <div style="font-size:12px; line-height:1.35;">
      <div><span style="opacity:.7;">Pattern:</span> ${escapeHtml(safe(ui.headline || sf.label))}</div>
      <div><span style="opacity:.7;">Bias:</span> ${escapeHtml(safe(sf.bias))} ¬∑ <span style="opacity:.7;">Dir:</span> ${escapeHtml(mapDir(sf.direction))} ¬∑ <span style="opacity:.7;">Conf:</span> ${escapeHtml(conf)}</div>
      <div><span style="opacity:.7;">Estrutura:</span> ${escapeHtml(safe(ui.market_structure_line))}</div>
      <div><span style="opacity:.7;">Pullback:</span> ${escapeHtml(safe(ui.pullback_line))}</div>
      <div><span style="opacity:.7;">SR:</span> H ${escapeHtml(safe(sr.recent_high))} ¬∑ L ${escapeHtml(safe(sr.recent_low))} ¬∑ <span style="opacity:.7;">Bars:</span> ${escapeHtml(safe(digest.intraday_bars || ""))}</div>
    </div>
  `;
}
function updatePremonitionPanel(payload){
  try{
    const panel  = payload?.panel  || payload || {};
    const ui     = payload?.ui     || {};
    const digest = payload?.digest || {};

    const lang = (typeof currentLang !== "undefined" && currentLang === "en") ? "en" : "pt";

    const pickFirst = (...vals) => {
      for (const v of vals){
        if (v === null || v === undefined) continue;
        const s = String(v).trim();
        if (s) return v;
      }
      return null;
    };
const fmtMT = (d) => {
  try {
    return d.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
      hour12: true,
      timeZone: 'America/Denver'
    });
  } catch (_) {
    return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  }
};

const extractPct = (txt) => {
  const m = String(txt || "").match(/(\d{1,3})\s*%/);
  if (!m) return null;
  const n = Number(m[1]);
  return (Number.isFinite(n) && n >= 0 && n <= 100) ? n : null;
};

    const splitTimeLabel = (label) => {
      const s = String(label || "").trim();
      // aceita "11:56 AM" ou "11:56"
      const m = s.match(/^(\d{1,2}:\d{2})\s*(AM|PM)?$/i);
      if (!m) return { hhmm: s || "‚Äî", ampm: "" };
      return { hhmm: m[1], ampm: (m[2] || "").toUpperCase() };
    };

    const extractMinutes = (txt) => {
      const s = String(txt || "");
      const m = s.match(/~\s*(\d+(?:\.\d+)?)\s*(min|mins|minutes|minutos)/i);
      if (!m) return null;
      const n = Number(m[1]);
      return isFinite(n) ? n : null;
    };

    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = (v === null || v === undefined || v === "") ? "‚Äî" : String(v);
    };

    // pega macro/micro (PT/EN)
    const macro = pickFirst(
      (lang === "en") ? ui.premonicao_macro_en : ui.premonicao_macro_pt,
      (lang === "en") ? panel.premonicao_macro_en : panel.premonicao_macro_pt,
      (lang === "en") ? digest.premonicao_macro_en : digest.premonicao_macro_pt,
      ui.premonicao_macro_pt, panel.premonicao_macro_pt, digest.premonicao_macro_pt,
      ui.premonicao_macro_en, panel.premonicao_macro_en, digest.premonicao_macro_en
    );

    const micro = pickFirst(
      (lang === "en") ? ui.premonicao_micro_en : ui.premonicao_micro_pt,
      (lang === "en") ? panel.premonicao_micro_en : panel.premonicao_micro_pt,
      (lang === "en") ? digest.premonicao_micro_en : digest.premonicao_micro_pt,
      ui.premonicao_micro_pt, panel.premonicao_micro_pt, digest.premonicao_micro_pt,
      ui.premonicao_micro_en, panel.premonicao_micro_en, digest.premonicao_micro_en
    );

        let macroTxt = macro;
    let microTxt = micro;

    // breakout window card (estruturado)
        let bw = pickFirst(ui.breakout_window_card, panel.breakout_window_card, digest.breakout_window_card);

            // ‚úÖ DEMO quando n√£o houver dados (sistema OFF / vazio)
    const A10_PREM_DEMO_WHEN_EMPTY = true;

    if (A10_PREM_DEMO_WHEN_EMPTY) {
      const hasBW = bw && (
        bw.prob_until_end_pct != null ||
        bw.window_end_label ||
        bw.trigger_price != null
      );

      if (!hasBW) {
        const now = new Date();

        const fmtMT = (d) => {
          try {
            return d.toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true,
              timeZone: 'America/Denver'
            });
          } catch (_) {
            return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          }
        };

        const end   = new Date(now.getTime() + 2 * 60 * 1000);
        const start = new Date(now.getTime() - 26 * 60 * 1000);

        bw = {
          dir: "DOWN",
          prob_until_end_pct: 81,
          window_start_label: fmtMT(start),
          window_end_label: fmtMT(end),
          median_minutes: 2,
          miss_line: "Se tentar cair perto das 12:00: Prob. cai para 47%",
          n_total: 444,
          confidence: "LOW confidence",
          source: "DEMO",
          score: 0.88,
          trigger_price: 100 // depois o canvas ajusta para o pre√ßo atual se precisar
        };

        if (!macroTxt) macroTxt = "PREMONI√á√ÉO MACRO (DEMO): tend√™ncia de baixa ‚Äî ETA ~17 min.";
        if (!microTxt) microTxt = "PREMONI√á√ÉO MICRO (DEMO): queda r√°pida ‚Äî ETA ~2 min.";
      }
    }

// ETA (min) ‚Äî precisa existir ANTES do painel direito usar
let etaMin = extractMinutes(microTxt);   // MICRO primeiro
if (etaMin == null && bw?.median_minutes != null && isFinite(Number(bw.median_minutes))) {
  etaMin = Number(bw.median_minutes);   // fallback
}
if (etaMin == null) etaMin = extractMinutes(macroTxt); // √∫ltimo fallback (se quiser)


    const dir = String(bw?.dir || "").toUpperCase();
    const verbPT = (dir === "DOWN") ? "cair" : (dir === "UP") ? "subir" : "romper";
    const verbEN = (dir === "DOWN") ? "drop" : (dir === "UP") ? "rise" : "break";

    const microPct = extractPct(microTxt);
const prob = (microPct != null)
  ? `${microPct}%`
  : (bw?.prob_until_end_pct != null ? `${bw.prob_until_end_pct}%` : "‚Äî");

// **HOR√ÅRIO DO KPI = AGORA + ETA DO MICRO**
const tLab = (etaMin != null)
  ? fmtMT(new Date(Date.now() + Number(etaMin) * 60 * 1000))
  : "‚Äî";

const t = splitTimeLabel(tLab);


    setText("prem-kpi-label", (lang === "en") ? `Prob. ${verbEN} by` : `Prob. ${verbPT} at√©`);
    setText("prem-kpi-time", t.hhmm || "‚Äî");
    setText("prem-kpi-ampm", t.ampm || "");
    setText("prem-kpi-prob", prob);

    // espelha KPI grande no painel direito (mockup)
    setText("prem-right-title", (lang === "en") ? `Prob. ${verbEN} by` : `Prob. ${verbPT} at√©`);
    setText("prem-right-time", t.hhmm || "‚Äî");
    setText("prem-right-ampm", t.ampm || "");
    setText("prem-right-prob", prob);
    setText("prem-right-eta", (etaMin != null) ? ((lang==="en") ? `In ~${Math.round(etaMin)} min` : `Em ~${Math.round(etaMin)} min`) : "‚Äî");


    const wLine = (bw?.window_start_label || bw?.window_end_label)
      ? `${bw.window_start_label || "‚Äî"} ‚Äì ${bw.window_end_label || "‚Äî"} (MT)`
      : "‚Äî";
    setText("prem-window", wLine);

    const mLine = (bw?.median_minutes != null && isFinite(Number(bw.median_minutes)))
      ? `${Math.round(Number(bw.median_minutes))} min (mediana)`
      : "‚Äî";
    setText("prem-median", mLine);

    setText("prem-miss", bw?.miss_line || "‚Äî");
        setText("prem-macro", macroTxt || "‚Äî");
    setText("prem-micro", microTxt || "‚Äî");

    const score = (payload?.digest?.shape_focus?.score ?? bw?.score);
    const nTxt = (bw?.n_total != null) ? `N=${bw.n_total}` : "N=‚Äî";
    const scTxt = (score != null && isFinite(Number(score))) ? ` (Score ${Number(score).toFixed(2)})` : "";
    const confTxt = bw?.confidence ? ` ¬∑ ${bw.confidence}` : "";
    setText("prem-base", `${nTxt} casos similares${scTxt}${confTxt}`);

    const badge = bw?.source ? `${bw.source} ¬∑ ${dir || "‚Äî"}` : (dir || "‚Äî");
    setText("prem-badge", badge);

    // --------- MINI CHART (candles) + cruz X/Y ----------
    const canvas = document.getElementById("prem-canvas");
    if (canvas){
      const parent = canvas.parentElement;
      const cssW = parent ? Math.max(320, parent.clientWidth - 20) : 720;
      // deixa o quadro maior (e evita ficar esmagado)
      const cssH = 380;              // <-- aumenta aqui
// opcional: se quiser limite
// const cssH = Math.max(300, Math.min(520, 380));


      const dpr = window.devicePixelRatio || 1;
      canvas.style.width = "100%";
      canvas.style.height = cssH + "px";
      canvas.width  = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);

            const W = cssW, H = cssH;

            // FIX: d√° contraste no canvas (antes estava transparente e ‚Äúsumia‚Äù no fundo)
ctx.clearRect(0, 0, W, H);
ctx.fillStyle = "rgba(0,0,0,0.55)";
ctx.fillRect(0, 0, W, H);


      // ===== TradingView-style bottom time axis + forecast candles (cir√∫rgico) =====
      const pad = 12;
      const axisH = 28;            // espa√ßo reservado para hor√°rios
      const plotH = H - axisH;     // √°rea do gr√°fico
      const tz = "America/Denver"; // MT

      const msOf = (v) => {
        if (v == null) return NaN;
        if (v instanceof Date) return v.getTime();
        if (typeof v === "number") {
          if (!isFinite(v)) return NaN;
          return (v > 1e12) ? v : (v > 1e9) ? v * 1000 : v;
        }
        const s = String(v).trim();
        if (!s) return NaN;
        const n = Number(s);
        if (isFinite(n)) return (n > 1e12) ? n : (n > 1e9) ? n * 1000 : n;
        const d = new Date(s);
        const ms = d.getTime();
        return isFinite(ms) ? ms : NaN;
      };

      const fmtTimeMT = (ms) => {
        try {
          return new Intl.DateTimeFormat("en-US", {
            timeZone: tz,
            hour: "numeric",
            minute: "2-digit"
          }).format(new Date(ms));
        } catch (e) {
          const d = new Date(ms);
          let hh = d.getHours();
          const mm = String(d.getMinutes()).padStart(2, "0");
          const ampm = (hh >= 12) ? "PM" : "AM";
          hh = hh % 12; if (hh === 0) hh = 12;
          return `${hh}:${mm} ${ampm}`;
        }
      };

      const roundRectPath = (x, y, w, h, r) => {
        const rr = Math.min(r, w / 2, h / 2);
        ctx.beginPath();
        ctx.moveTo(x + rr, y);
        ctx.arcTo(x + w, y, x + w, y + h, rr);
        ctx.arcTo(x + w, y + h, x, y + h, rr);
        ctx.arcTo(x, y + h, x, y, rr);
        ctx.arcTo(x, y, x + w, y, rr);
        ctx.closePath();
      };

      // pega candles LIVE do seu chart (se existir)
      const src = (Array.isArray(window.a10ChartCandles) && window.a10ChartCandles.length)
        ? window.a10ChartCandles
        : [];

      const N = 60;
      let candles = src.slice(-N).map(c => ({
        open:  Number(c.open ?? c.o),
        high:  Number(c.high ?? c.h),
        low:   Number(c.low  ?? c.l),
        close: Number(c.close ?? c.c),
        t:     msOf(c.t ?? c.time ?? c.timestamp ?? c.ts ?? c.datetime ?? c.date)
      })).filter(c => [c.open, c.high, c.low, c.close].every(x => isFinite(x)));

      // fallback (se ainda n√£o tiver candles)
      if (!candles.length) {
        let px = 100;
        const now = Date.now();
        candles = Array.from({ length: N }, (_, i) => {
          const o = px;
          const d = (Math.random() - 0.5) * 1.2;
          const c = o + d;
          const h = Math.max(o, c) + Math.random() * 0.6;
          const l = Math.min(o, c) - Math.random() * 0.6;
          px = c;
          return { open: o, high: h, low: l, close: c, t: now - (N - 1 - i) * 60000 };
        });
      }

      // garante timestamps (se vier sem tempo)
      if (!isFinite(candles[0]?.t)) {
        const now = Date.now();
        for (let i = 0; i < candles.length; i++) {
          candles[i].t = now - (candles.length - 1 - i) * 60000;
        }
      }

      // infer bar size (ms) via mediana dos deltas
      const inferBarMs = () => {
        const ts = candles.map(c => c.t).filter(x => isFinite(x));
        if (ts.length < 6) return 60000;
        const diffs = [];
        for (let i = ts.length - 1; i > 0 && diffs.length < 12; i--) {
          const d = ts[i] - ts[i - 1];
          if (d > 0 && d < 60 * 60 * 1000) diffs.push(d);
        }
        if (!diffs.length) return 60000;
        diffs.sort((a, b) => a - b);
        return diffs[Math.floor(diffs.length / 2)] || 60000;
      };
      const barMs = inferBarMs();

      const targetPrice = (bw?.trigger_price != null && isFinite(Number(bw.trigger_price)))
        ? Number(bw.trigger_price)
        : null;

      // reaproveita o etaMin calculado acima (n√£o redeclara)
etaMin = (bw?.median_minutes != null && isFinite(Number(bw.median_minutes)))
  ? Number(bw.median_minutes)
  : etaMin;

if (etaMin == null) etaMin = extractMinutes(microTxt) ?? extractMinutes(macroTxt) ?? 0;


      const lows = candles.map(c => c.low);
      const highs = candles.map(c => c.high);
      let yMin = Math.min(...lows);
      let yMax = Math.max(...highs);
      if (targetPrice != null) {
        yMin = Math.min(yMin, targetPrice);
        yMax = Math.max(yMax, targetPrice);
      }
      const span = (yMax - yMin) || 1;
      yMin -= span * 0.08;
      yMax += span * 0.08;

      const yMap = (p) => pad + (yMax - p) * (plotH - pad * 2) / (yMax - yMin);

      // grid leve (s√≥ na √°rea do gr√°fico)
ctx.strokeStyle = "rgba(255,255,255,.06)";
ctx.lineWidth = 1;
for (let i = 1; i <= 4; i++) {
  const y = pad + (plotH - pad * 2) * (i / 5);
  ctx.beginPath();
  ctx.moveTo(pad, y);
  ctx.lineTo(W - pad, y);
  ctx.stroke();
}


      const futureSlots = Math.max(10, Math.round(Number(etaMin) || 0) + 6);
      const stepX = (W - pad * 2) / ((candles.length - 1) + futureSlots);
      const bodyW = Math.max(3, Math.min(10, stepX * 0.65));

      const lastMs = isFinite(candles[candles.length - 1]?.t) ? candles[candles.length - 1].t : Date.now();

      // faixa azul suave (janela futura) at√© o ETA
      let xT = null;
      const idxEta = (candles.length - 1) + Math.max(0, Number(etaMin) || 0);
      xT = Math.min(W, pad + stepX * idxEta);
      const xNow = pad + stepX * (candles.length - 1);
      if (xT > xNow) {
        ctx.fillStyle = "rgba(120,170,255,.08)";
        ctx.fillRect(xNow, 0, xT - xNow, plotH);
      }

      // candles reais
      for (let i = 0; i < candles.length; i++) {
        const c = candles[i];
        const x = pad + stepX * i;

        const yO = yMap(c.open);
        const yC = yMap(c.close);
        const yH = yMap(c.high);
        const yL = yMap(c.low);

        const up = c.close >= c.open;
        const col = up ? "rgba(70,220,160,.95)" : "rgba(255,100,90,.95)";

        // wick
        ctx.strokeStyle = col;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x, yH);
        ctx.lineTo(x, yL);
        ctx.stroke();

        // body
        ctx.fillStyle = col;
        const top = Math.min(yO, yC);
        const h = Math.max(1, Math.abs(yC - yO));
        ctx.fillRect(x - bodyW / 2, top, bodyW, h);
      }

      // ===== candles previs√£o (azuis) ‚Äî 1 a 3 candles no futuro =====
      const canForecast = (targetPrice != null) && isFinite(Number(etaMin)) && (Number(etaMin) > 0) && (Number(etaMin) <= 6);
      if (canForecast) {
        const nF = Math.min(3, Math.max(1, Math.round(Number(etaMin) / 2))); // 2‚Üí1, 4‚Üí2, 6‚Üí3
        const lastClose = candles[candles.length - 1].close;
        let prevClose = lastClose;

        for (let k = 1; k <= nF; k++) {
          const off = Math.max(1, Math.round((k * Number(etaMin)) / nF)); // √∫ltimo cai em etaMin
          const frac = k / nF;
          const close = lastClose + (targetPrice - lastClose) * frac;
          const open = prevClose;

          const wig = Math.max(span * 0.005, Math.abs(close - open) * 0.35);
          const high = Math.max(open, close) + wig;
          const low = Math.min(open, close) - wig;

          const x = pad + stepX * ((candles.length - 1) + off);
          const yO = yMap(open);
          const yC = yMap(close);
          const yH = yMap(high);
          const yL = yMap(low);

          const col = "rgba(120,170,255,.95)";

          ctx.strokeStyle = col;
          ctx.lineWidth = 1;
          ctx.beginPath(); ctx.moveTo(x, yH); ctx.lineTo(x, yL); ctx.stroke();

          ctx.fillStyle = col;
          const top = Math.min(yO, yC);
          const h = Math.max(1, Math.abs(yC - yO));
          ctx.fillRect(x - bodyW / 2, top, bodyW, h);

          prevClose = close;
        }
      }

      // ‚úÖ Premoni√ß√£o: BOOT DEMO (quando sistema OFF / ningu√©m chama updatePremonitionPanel)
// Cole ESTE BLOCO logo ap√≥s o "}" de updatePremonitionPanel (linha 5111),
// e ANTES de: let __AARON_MATCHER_REQ_ID = 0; (linha 5113)
(function(){
  if (window.__A10_PREM_BOOT_DEMO__) return;
  window.__A10_PREM_BOOT_DEMO__ = true;

  const boot = () => {
    try {
      const canvas = document.getElementById("prem-canvas");
      if (!canvas) return;

      // se j√° chegou dado real do matcher, n√£o sobrescreve
      const last = window.__AARON_MATCHER_LAST__;
      const hasReal =
        !!last && (
          (last.panel && Object.keys(last.panel).length) ||
          (last.ui && Object.keys(last.ui).length) ||
          (last.digest && Object.keys(last.digest).length)
        );

      if (!hasReal && typeof updatePremonitionPanel === "function") {
        updatePremonitionPanel(null); // cai no seu DEMO/fallback
      }
    } catch (e) {}
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => setTimeout(boot, 250));
  } else {
    setTimeout(boot, 250);
  }

  // tenta de novo depois (caso o canvas ainda n√£o exista no primeiro tick)
  setTimeout(boot, 2000);
})();


      // cruz (X/Y) em amarelo
      if (targetPrice != null) {
        const yT = yMap(targetPrice);

        // linha Y (pre√ßo)
        ctx.strokeStyle = "rgba(255,204,102,.95)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(pad, yT);
        ctx.lineTo(W - pad, yT);
        ctx.stroke();


        // linha X (tempo/ETA)
        ctx.beginPath();
        ctx.moveTo(xT, pad);
        ctx.lineTo(xT, plotH - pad);
        ctx.stroke();


        // ponto
        ctx.fillStyle = "rgba(255,204,102,.95)";
        ctx.beginPath();
        ctx.arc(xT, yT, 5, 0, Math.PI * 2);
        ctx.fill();
      }

      // ===== eixo de hor√°rio embaixo (TradingView-ish) =====
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(0, plotH + 0.5); ctx.lineTo(W, plotH + 0.5); ctx.stroke();

      const startMs = isFinite(candles[0]?.t) ? candles[0].t : (lastMs - (candles.length - 1) * barMs);
      const endMs = lastMs + futureSlots * barMs;
      const interval = 15 * 60 * 1000;

      ctx.font = "11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.textAlign = "center";
      ctx.textBaseline = "alphabetic";

      let tick = Math.ceil(startMs / interval) * interval;
      const yLbl = H - 8;

      while (tick <= endMs) {
        const barsFromStart = (tick - startMs) / barMs;
        const x = pad + stepX * barsFromStart;
        if (x >= 0 && x <= W) {
          ctx.fillText(fmtTimeMT(tick), x, yLbl);
        }
        tick += interval;
      }

      // ‚Äúp√≠lula‚Äù do hor√°rio do ETA (ex: 11:56 AM MT)
      if (targetPrice != null && isFinite(xT)) {
        const pillMs = lastMs + Math.max(0, Number(etaMin) || 0) * barMs;
        const pillBase =
          (t && t.hhmm && t.hhmm !== "‚Äî")
            ? `${t.hhmm}${t.ampm ? ` ${t.ampm}` : ""}`
            : fmtTimeMT(pillMs);

        const pillText = `${pillBase} MT`;

        ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const tw = ctx.measureText(pillText).width;

        const pxPad = 10;
        const ph = 20;
        const pw = tw + pxPad * 2;

        let px = xT - pw / 2;
        px = Math.max(10, Math.min(W - pw - 10, px));

        const py = plotH + 6;

        // fundo
        ctx.fillStyle = "rgba(0,0,0,.55)";
        roundRectPath(px, py, pw, ph, 10);
        ctx.fill();

        // borda
        ctx.strokeStyle = "rgba(255,255,255,.14)";
        ctx.lineWidth = 1;
        roundRectPath(px, py, pw, ph, 10);
        ctx.stroke();

        // texto
        ctx.fillStyle = "rgba(255,255,255,.85)";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(pillText, px + pw / 2, py + ph / 2);
      }

    }
  }catch(e){
    // n√£o quebra o painel por causa disso
  }
}
function updateRespiroReversaoPanel(payload){
  try{
    const lang = (typeof currentLang !== "undefined" && currentLang === "en") ? "en" : "pt";

    const panel  = payload?.panel || payload || {};
    const ui     = payload?.ui || panel?.ui || {};
    const digest = payload?.digest || panel?.digest || {};

    const pb = panel.pullback_brain || panel.pullbackBrain || panel.pullback || {};
    const rev = payload?.reversal_classifier || payload?.reversalClassifier || payload?.reversal ||
                panel?.reversal_classifier || panel?.reversalClassifier || panel?.reversal || {};

    // Fonte #1 (linha √∫nica com REGIME/RESPIRO/REVERSAO/...)
    const summary =
      ui.top_summary_pt_inline ||
      ui.top_summary_pt ||
      ui.top_summary_en ||
      ui.top_summary ||
      digest.top_summary_pt_inline ||
      digest.top_summary_pt ||
      digest.top_summary_en ||
      digest.top_summary ||
      panel.top_summary_pt_inline ||
      panel.top_summary_pt ||
      panel.top_summary_en ||
      panel.top_summary ||
      "";

    // Fonte #2 (linhas antigas)
    const line = String(
      ui.pullback_line || ui.market_structure_line || ui.tactical_line ||
      panel.pullback_line || panel.market_structure_line || panel.tactical_line ||
      ""
    );

    const src = String((summary || line || "")).trim();

    const grab = (re) => {
      if (!src) return null;
      const m = src.match(re);
      return m ? String(m[1]).trim() : null;
    };

    // Pega tudo do topo (quando existir)
    let acao = grab(/A[√áC]AO\s*:\s*([^|]+)/i);
    let respiro = grab(/RESPIR[O0]\s*:\s*([^|]+)/i);
    let reversao = grab(/REVERS(?:A|√É)O\s*:\s*([^|]+)/i);
    let regime = grab(/REGIME\s*:\s*([^|]+)/i);
    let consolidacao = grab(/(?:CONSOLIDA(?:C|√á)(?:A|√É)O|RANGE)\s*:\s*([^|]+)/i);
    let continuacao = grab(/CONTINUAC(?:A|√É)O\s*:\s*([^|]+)/i);

    // Normaliza (se algu√©m mandar "A√á√ÉO: VENDER" dentro do valor)
    if (acao) acao = String(acao).replace(/^A[√áC]AO\s*:\s*/i, "").trim();

    const stage =
      (lang === "en")
        ? (pb.stage_title_en || pb.stage_title || pb.state_title_en || pb.status_en || pb.state_title || pb.status)
        : (pb.stage_title_pt || pb.stage_title || pb.state_title_pt || pb.status_pt || pb.state_title || pb.status);

    // Fallbacks
    if (!regime) regime = pb.regime || pb.mode || pb.context || stage || "‚Äî";
    if (!respiro) respiro = pb.respiro || stage || "‚Äî";

    const revTxt =
      (lang === "en")
        ? (rev.verdict_en || rev.summary_en || rev.verdict || "")
        : (rev.verdict_pt || rev.summary_pt || rev.verdict || "");

    if (!reversao) reversao = revTxt || "‚Äî";

    // subtexto (ex: "Sem setup de breakout")
    let reversaoSub = rev.sub || rev.note || pb.breakout_note || pb.note || "";
    if (!reversaoSub) reversaoSub = (revTxt && reversao !== revTxt) ? String(revTxt).trim() : "";
    if (!reversaoSub) reversaoSub = "‚Äî";

    if (!consolidacao) consolidacao = pb.consolidacao || pb.range || "‚Äî";
    if (!continuacao) continuacao = pb.continuacao || "‚Äî";
    if (!acao) acao = pb.acao || pb.action || ui.acao || ui.action || digest.acao || digest.action || "‚Äî";

    // vers√µes ‚Äúfull‚Äù
    const verdictPt = rev?.verdict_pt || rev?.verdictPt;
    let reversaoFull = reversao;
    if (verdictPt && !String(reversaoFull).toLowerCase().includes(String(verdictPt).toLowerCase())){
      reversaoFull = (reversaoFull === "‚Äî") ? String(verdictPt) : `${reversaoFull} ‚Ä¢ ${verdictPt}`;
    }
    const respiroFull = respiro;

    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = (v === null || v === undefined || v === "") ? "‚Äî" : String(v);
    };

    // topo (grande)
    setText("rr-respiro", respiro);
    setText("rr-reversao", reversao);
    setText("rr-reversao-sub", reversaoSub);

    // badge
    setText("rr-badge", `A√á√ÉO: ${acao || "‚Äî"}`);

    // readout completo (igual sua 2¬™ imagem)
    setText("rr-regime", regime);
    setText("rr-reversao-full", reversaoFull);
    setText("rr-respiro-full", respiroFull);
    setText("rr-consolidacao", consolidacao);
    setText("rr-continuacao", continuacao);
    setText("rr-acao", acao);
    // ===== espelho no bloco de PREMONI√á√ÉO (SEM RESPIRO) =====
    setText("prem-regime", regime);
    setText("prem-reversao-full", reversaoFull);
    setText("prem-consolidacao", consolidacao);
    setText("prem-continuacao", continuacao);
    setText("prem-acao-full", acao);

    const pro = document.getElementById("prem-readout");
    if (pro) pro.style.display = "block";

    const ro = document.getElementById("rr-readout");
    if (ro) ro.style.display = "block";
  }catch(e){
    // n√£o quebra o painel por causa disso
  }
}


let __AARON_MATCHER_REQ_ID = 0;

function applyResponderIntoTradeCard(data){
  data = Array.isArray(data) ? (data[0] ?? {}) : (data ?? {});
  const panel  = data?.panel  || {};
  const ui     = data?.ui     || {};
  const digest = data?.digest || {};
  const sf = digest?.shape_focus || {};
  const sr = digest?.sr_proxy || {};

  const set = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    const v = (val === null || val === undefined || val === "") ? "‚Äî" : String(val);
    el.textContent = v;
  };

  const fmt2 = (n) => (typeof n === "number" && isFinite(n)) ? n.toFixed(2) : (n ?? "‚Äî");

  // Estat√≠stica ‚Äúna cara‚Äù
  const stats = ui.headline || ui.structure_line || sf.label || "‚Äî";
  set("trade-stats", stats);
  set("trade-stats-top", stats);

  // Dire√ß√£o (s√≥ pra exibir o output do responder)
  const dirRaw = String(sf.direction || "").toLowerCase();
  const dirPT  = (dirRaw === "up") ? "COMPRA" : (dirRaw === "down") ? "VENDA" : "NEUTRO";
  set("trade-direction", dirPT);

  // Modo / contexto (pra aparecer dentro do Trade Card)
  const mode = ui.pullback_line || ui.market_structure_line || ui.tactical_line || "‚Äî";
  set("trade-mode", mode);

  // Contra (resumo do digest)
  const against = [
    sf.family_en || sf.family || "",
    sf.bias ? `bias:${sf.bias}` : "",
    (Array.isArray(digest.features_true) && digest.features_true.length)
      ? `feat:${digest.features_true.join(", ")}`
      : ""
  ].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî";
  set("trade-against", against);

  // Entrada: usa o range SR proxy (se existir)
  if (sr.recent_low != null || sr.recent_high != null) {
    set("trade-entry", `${fmt2(sr.recent_low)} ‚Äì ${fmt2(sr.recent_high)}`);
  }

  // Coment√°rio do AARON (mostra as linhas do ui)
  const comment = [
    ui.structure_line ? `Estrutura: ${ui.structure_line}` : "",
    ui.tactical_line ? `T√°tico: ${ui.tactical_line}` : "",
    ui.market_structure_line ? `MS: ${ui.market_structure_line}` : "",
    ui.pullback_line ? `Pullback: ${ui.pullback_line}` : "",
  ].filter(Boolean).join(" | ");

  if (comment) set("trade-comment", comment);
}

async function requestMatcher(symbol) {
  symbol = String(symbol || "").trim().toUpperCase();
  if (!symbol) return;

  const tf =
    (typeof getSelectedTimeframe === "function")
      ? getSelectedTimeframe()
      : (localStorage.getItem("aaron_selected_timeframe") || "1m");

    // ‚úÖ LIVE candles (Cloud Run WS): N√ÉO reconecta aqui (evita "WS closed before established")
  // Quem abre a conex√£o √© o handler do dropdown/timeframe; aqui s√≥ re-assina se j√° estiver conectado
  if (typeof a10LiveSubscribe === "function") a10LiveSubscribe(symbol, tf);

  const reqId = ++__AARON_MATCHER_REQ_ID;

  const ctxEl = document.getElementById("context-text");
  const exeEl = document.getElementById("execution-text");
  if (ctxEl) ctxEl.textContent = `Carregando matcher para ${symbol} (${tf})...`;
  if (exeEl) exeEl.textContent = "‚Äî";
  if (typeof setRespSnapMessage === "function") setRespSnapMessage(`Carregando ${symbol} (${tf})...`);

  async function fetchOne(baseUrl){
    const url = `${baseUrl}?symbol=${encodeURIComponent(symbol)}&timeframe=${encodeURIComponent(tf)}&_=${Date.now()}`;
    const res = await fetch(url, { method: "GET", cache: "no-store" }); // ‚úÖ GET
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status}${t ? ` ‚Ä¢ ${t.slice(0,160)}` : ""}`);
    }
    return await res.json();
  }

  let raw = null;

    try {
    raw = await fetchOne(MATCHER_WEBHOOK_URL);
  } catch (errProd) {

    // ‚úÖ S√≥ tenta webhook-test quando estiver rodando LOCAL (localhost/127.0.0.1)
    if (__A10_IS_LOCAL) {
      try {
        raw = await fetchOne(MATCHER_WEBHOOK_URL_TEST);
      } catch (errTest) {
        if (reqId !== __AARON_MATCHER_REQ_ID) return;
        const msg = `Matcher fetch falhou: ${errTest?.message || errTest || "Failed to fetch"}`;
        if (ctxEl) ctxEl.textContent = msg;
        if (exeEl) exeEl.textContent = "‚Äî";
        if (typeof setRespSnapMessage === "function") setRespSnapMessage(msg);
        return;
      }
    } else {
      // ‚úÖ Em produ√ß√£o: N√ÉO tenta webhook-test (ele sempre quebra)
      if (reqId !== __AARON_MATCHER_REQ_ID) return;
      const msg = `Matcher (PROD) falhou: ${errProd?.message || errProd || "Failed to fetch"}`;
      if (ctxEl) ctxEl.textContent = msg;
      if (exeEl) exeEl.textContent = "‚Äî";
      if (typeof setRespSnapMessage === "function") setRespSnapMessage(msg);
      return;
    }
  }


  if (reqId !== __AARON_MATCHER_REQ_ID) return;

  const data = Array.isArray(raw) ? (raw[0] ?? {}) : (raw ?? {});
  window.__AARON_MATCHER_LAST__ = data; // debug

  // ‚úÖ bloco ‚ÄúRESPONDER OUTPUT‚Äù
  if (typeof renderTradeResponderOutput === "function") {
    renderTradeResponderOutput(data);
  }
if (typeof updatePremonitionPanel === "function") {
  updatePremonitionPanel(data);
}
if (typeof updateRespiroReversaoPanel === "function") {
  updateRespiroReversaoPanel(data);
}

  // ‚úÖ injeta dentro do Trade Card
  applyResponderIntoTradeCard(data);

  if (ctxEl) ctxEl.textContent = `Matcher OK: ${symbol} (${tf})`;
  if (exeEl) exeEl.textContent = data?.panel?.updated_at || "‚Äî";
  if (typeof setRespSnapMessage === "function") setRespSnapMessage("");
}









// ‚úÖ Isso aqui √© a ‚Äúconversa‚Äù: o seu dropdown j√° dispara esse evento.
// Quando trocar o ativo, ele chama o n8n automaticamente.
window.addEventListener("aaron:symbolSelected", (ev) => {
  const symbol = String(ev?.detail?.symbol || '').toUpperCase().trim();
  if (!symbol) return;

  // 0) AutoPilot amarrado ao s√≠mbolo atual (evita ‚Äúvazar‚Äù trade entre ativos)
  if (typeof apOnSymbolChange === 'function') apOnSymbolChange(symbol);

  // 1) chama o matcher
  requestMatcher(symbol);

  // 2) atualiza o painel JSON imediatamente
  loadPanel(true);

  // 3) (opcional) Live Candles via Cloud Run (N√ÉO muda nada enquanto A10_USE_LIVE_CANDLES=false)
  if (typeof a10LiveConnect === "function") {
    const tf = (typeof getSelectedTimeframe === "function")
      ? getSelectedTimeframe()
      : (window.AARON_SELECTED_TIMEFRAME || "1m");
    a10LiveConnect(symbol, tf);
  }
});




// ‚úÖ Ao abrir a p√°gina, dispara 1x com o √∫ltimo s√≠mbolo salvo (pra j√° mostrar algo)
setTimeout(() => {
  const symbol =
    window.AARON_SELECTED_SYMBOL ||
    localStorage.getItem("aaron_selected_symbol") ||
    "NVDA";

  // garante timeframe aplicado antes do primeiro load
  if (typeof setSelectedTimeframe === "function") {
    setSelectedTimeframe(getSelectedTimeframe(), { dispatch: false });
  }

  window.dispatchEvent(new CustomEvent("aaron:symbolSelected", { detail: { symbol } }));
}, 200);



// ======= LANG GLOBAL (precisa vir ANTES do AutoPilot / loadPanel) =======
var currentLang = (function(){
  try { return localStorage.getItem('AARON_LANG') || 'pt'; } catch(e) { return 'pt'; }
})();
window.currentLang = currentLang;


const els = {
  errorBanner: document.getElementById('error-banner'),
  btnRefresh: document.getElementById('btn-refresh'),
  state: document.getElementById('state-pill'),
  symbol: document.getElementById('symbol-label'),
  timeframe: document.getElementById('timeframe-label'),
  pulseLine: document.getElementById('pulseLine'),
    // AUTOPILOT
  apToggle: document.getElementById('ap-toggle'),
  apState: document.getElementById('ap-state'),
  apBuy: document.getElementById('ap-buy'),
  apSell: document.getElementById('ap-sell'),
  apClose: document.getElementById('ap-close'),
  apMeta: document.getElementById('ap-meta'),
    // AUTOPILOT 2.0 (sizing / quotes)
  apCapital: document.getElementById('ap-capital'),
  apUnits: document.getElementById('ap-units'),
  apPriceSell: document.getElementById('ap-price-sell'),
  apPriceMid: document.getElementById('ap-price-mid'),
  apPriceBuy: document.getElementById('ap-price-buy'),


  session: document.getElementById('session-label'),
  lastUpdate: document.getElementById('last-update-label'),
  flow: document.getElementById('flow-label'),
  trendDayPill: document.getElementById('trend-day-pill'),
  trendNowPill: document.getElementById('trend-now-pill'),
  dirDayArrow: document.getElementById('direction-day-arrow'),
  dirNowArrow: document.getElementById('direction-now-arrow'),
  patternDayLabel: document.getElementById('pattern-day-label'),
  patternDayDetail: document.getElementById('pattern-day-detail'),
  patternNowLabel: document.getElementById('pattern-now-label'),
  patternNowDetail: document.getElementById('pattern-now-detail'),
  summary: document.getElementById('summary-text'),
  riskPill: document.getElementById('risk-pill'),
  riskText: document.getElementById('risk-text'),
  contextText: document.getElementById('context-text'),
  executionText: document.getElementById('execution-text'),
  directionDayText: document.getElementById('direction-day-text'),
  directionNowText: document.getElementById('direction-now-text'),

    // Pattern Reference (ABA)
  refDetails: document.getElementById('refDetails'),
  refSummaryTitle: document.getElementById('refSummaryTitle'),
  refSummaryRight: document.getElementById('refSummaryRight'),
  refPatternMini: document.getElementById('refPatternMini'),
  refPatternImg: document.getElementById('refPatternImg'),
  refPatternLabel: document.getElementById('refPatternLabel'),
  refPatternSetup: document.getElementById('refPatternSetup'),
  refPatternNotes: document.getElementById('refPatternNotes'),
  refPatternLink: document.getElementById('refPatternLink'),


  // HERO / MODO CEGO
  heroBlock: document.getElementById('hero-block'),
  heroMain: document.getElementById('hero-main'),
  heroSub: document.getElementById('hero-sub'),
  heroBadge: document.getElementById('hero-badge'),
  heroModePill: document.getElementById('hero-mode-pill'),
  heroSideLabel: document.getElementById('hero-side-label'),
  heroSummary: document.getElementById('hero-summary-text'),
  heroFavorLabel: document.getElementById('hero-favor-label'),
  heroFavorBar: document.getElementById('hero-favor-bar'),
  heroFavorPhrase: document.getElementById('hero-favor-phrase'),

  heroContraLabel: document.getElementById('hero-contra-label'),
  heroContraBar: document.getElementById('hero-contra-bar'),
  heroContraPhrase: document.getElementById('hero-contra-phrase'),

  heroMiniRisk: document.getElementById('hero-mini-risk'),
  heroMiniContext: document.getElementById('hero-mini-context'),
  heroMiniExecution: document.getElementById('hero-mini-execution'),

    // RESUMO INSTITUCIONAL (barras)
  heroFavorLabel: document.getElementById('hero-favor-label'),
  heroFavorBar: document.getElementById('hero-favor-bar'),
  heroFavorPhrase: document.getElementById('hero-favor-phrase'),

  heroContraLabel: document.getElementById('hero-contra-label'),
  heroContraBar: document.getElementById('hero-contra-bar'),
  heroContraPhrase: document.getElementById('hero-contra-phrase'),

  heroMiniRisk: document.getElementById('hero-mini-risk'),
  heroMiniContext: document.getElementById('hero-mini-context'),
  heroMiniExecution: document.getElementById('hero-mini-execution'),


    // --- Cart√£o de Trade (Citadel) ---
  tradeCard: document.getElementById('trade-card'),
  tradeStatusText: document.getElementById('trade-status-text'),
  // NOVO (topo)
  tradeStatsTopLine: document.getElementById('trade-stats-top-line'),
  tradeStatsTop: document.getElementById('trade-stats-top'),
  tradeStatsTopLine: document.getElementById('trade-stats-top-line'),
  tradeStatsTop: document.getElementById('trade-stats-top'),
  tradeStats: document.getElementById('trade-stats'),
  tradeSymbol: document.getElementById('trade-symbol'),
  tradeTimeframe: document.getElementById('trade-timeframe'),
  tradeMode: document.getElementById('trade-mode'),
  tradeAgainst: document.getElementById('trade-against'),
  tradeDirection: document.getElementById('trade-direction'),
  tradeEntry: document.getElementById('trade-entry'),
  tradeStop: document.getElementById('trade-stop'),
  tradeTP1: document.getElementById('trade-tp1'),
  tradeTP2: document.getElementById('trade-tp2'),
  tradeSize: document.getElementById('trade-size'),
  tradeRisk: document.getElementById('trade-risk'),
  tradeThermo: document.getElementById('trade-thermo'),
  tradeComment: document.getElementById('trade-comment'),
  tradeBadge: document.getElementById('trade-badge'),


  // Estrutura recente (HH / HL / LH / LL)
  structureHHStatus: document.getElementById('structure-hh-status'),
  structureHLStatus: document.getElementById('structure-hl-status'),
  structureLHStatus: document.getElementById('structure-lh-status'),
  structureLLStatus: document.getElementById('structure-ll-status'),
  structureHHDot: document.getElementById('structure-hh-dot'),
  structureHLDot: document.getElementById('structure-hl-dot'),
  structureLHDot: document.getElementById('structure-lh-dot'),
  structureLLDot: document.getElementById('structure-ll-dot'),

  // Pullback Brain
  pullbackStatus: document.getElementById('pullback-status'),
  pullbackDepth: document.getElementById('pullback-depth'),
  pullbackQuality: document.getElementById('pullback-quality'),
  pullbackHeadline: document.getElementById('pullback-headline'),
  pullbackText: document.getElementById('pullback-text'),
  pullbackHighlightBox: document.getElementById('pullback-highlight-box'),
  pullbackSideTag: document.getElementById('pullback-side-tag'),
  pullbackStageTag: document.getElementById('pullback-stage-tag'),
  pullbackMeterFill: document.getElementById('pullback-meter-fill'),
  pullbackMeterLabel: document.getElementById('pullback-meter-label'),

       // Sizing Brain
  sizingTarget: document.getElementById('sizing-target'),
  sizingMaxDD: document.getElementById('sizing-max-dd'),
  sizingRiskTrade: document.getElementById('sizing-risk-trade'),
  sizingTradesCount: document.getElementById('sizing-trades-count'),
  sizingProfileTag: document.getElementById('sizing-profile-tag'),
  sizingStyleTag: document.getElementById('sizing-style-tag'),
  sizingMeterFill: document.getElementById('sizing-meter-fill'),
  sizingMeterLabel: document.getElementById('sizing-meter-label'),
  sizingComment: document.getElementById('sizing-comment'),

  // Sizing Brain ‚Äì inputs e frases (l√≥gica tipo Aaron Pine)
  sizingAccountRealInput: document.getElementById('sizing-account-real-input'),
  sizingUseInput: document.getElementById('sizing-use-input'),
  sizingLeverageInput: document.getElementById('sizing-leverage-input'),
  sizingRiskInput: document.getElementById('sizing-risk-input'),
  sizingStopInput: document.getElementById('sizing-stop-input'),
  sizingFixedQtyInput: document.getElementById('sizing-fixedqty-input'),
  sizingPhraseMain: document.getElementById('sizing-phrase-main'),
  sizingPhraseDetail: document.getElementById('sizing-phrase-detail'),

};

// ===============================
// AUTOPILOT v1 (simula√ß√£o local)
// ===============================
const AP_KEY = 'AARON_AUTOPILOT_V1';
let lastTradeCard = null;

function apLoad() {
  try {
    const raw = localStorage.getItem(AP_KEY);
    const obj = raw ? JSON.parse(raw) : null;

    const capital =
      (typeof obj?.capital === 'number' && isFinite(obj.capital)) ? obj.capital : 25000;

    const base = {
      enabled: !!obj?.enabled,
      active:  !!obj?.active,
      side:    (obj?.side === 'buy' || obj?.side === 'sell') ? obj.side : null,
      entry:   (obj?.entry != null && isFinite(Number(obj.entry))) ? Number(obj.entry) : null,
      startedAt: (obj?.startedAt != null && isFinite(Number(obj.startedAt))) ? Number(obj.startedAt) : null,

      // 2.0
      capital,
      units: (obj?.units != null && isFinite(Number(obj.units))) ? Number(obj.units) : null,
      priceNow: (obj?.priceNow != null && isFinite(Number(obj.priceNow))) ? Number(obj.priceNow) : null,

      // ===== CONTRATO (state + snapshot + regra de conflito) =====
      state: (typeof obj?.state === 'string') ? obj.state : null, // FLAT | LONG_ACTIVE | SHORT_ACTIVE | EXIT_PENDING
      snapshot: (obj?.snapshot && typeof obj.snapshot === 'object') ? obj.snapshot : null,
      marketNow: (obj?.marketNow === 'buy' || obj?.marketNow === 'sell' || obj?.marketNow === 'wait')
        ? obj.marketNow
        : 'wait',
      exitPending: !!obj?.exitPending,
      current_price: (obj?.current_price != null && isFinite(Number(obj.current_price))) ? Number(obj.current_price) : null,
      pnl: (obj?.pnl != null && isFinite(Number(obj.pnl))) ? Number(obj.pnl) : null,
      rMultiple: (obj?.rMultiple != null && isFinite(Number(obj.rMultiple))) ? Number(obj.rMultiple) : null,
      lastUpdate: (obj?.lastUpdate != null && isFinite(Number(obj.lastUpdate))) ? Number(obj.lastUpdate) : null,
    };

    // Normaliza state legado
    const valid = ['FLAT', 'LONG_ACTIVE', 'SHORT_ACTIVE', 'EXIT_PENDING'];
    if (!valid.includes(base.state)) {
      if (base.active && base.side === 'buy') base.state = 'LONG_ACTIVE';
      else if (base.active && base.side === 'sell') base.state = 'SHORT_ACTIVE';
      else base.state = 'FLAT';
    }

    // Se state diz que tem posi√ß√£o, mas falta snapshot, cria snapshot m√≠nimo
    if (base.state !== 'FLAT' && !base.snapshot) {
      const posSide = (base.state === 'SHORT_ACTIVE') ? 'short' : 'long';
      base.snapshot = {
        opened_at_timestamp: base.startedAt ?? null,
        side: posSide,
        entry_price: base.entry,
        stop: null,
        tp1: null,
        tp2: null,
        capital: base.capital,
        units: base.units,
      };
    }

    // Se FLAT, limpa
    if (base.state === 'FLAT') {
      base.active = false;
      base.side = null;
      base.entry = null;
      base.startedAt = null;
      base.snapshot = null;
      base.exitPending = false;
    } else {
      base.active = true;
      base.side = (base.snapshot?.side === 'short') ? 'sell' : 'buy';

      if (base.entry == null && base.snapshot?.entry_price != null) {
        const e = Number(base.snapshot.entry_price);
        if (isFinite(e)) base.entry = e;
      }
      if (base.units == null && base.snapshot?.units != null) {
        const u = Number(base.snapshot.units);
        if (isFinite(u)) base.units = u;
      }
    }

    return base;
  } catch (e) {
    return {
      enabled: false, active: false, side: null, entry: null, startedAt: null,
      capital: 25000, units: null, priceNow: null,
      state: 'FLAT', snapshot: null, marketNow: 'wait', exitPending: false,
      current_price: null, pnl: null, rMultiple: null, lastUpdate: null,
    };
  }
}



function apSave(state) {
  localStorage.setItem(AP_KEY, JSON.stringify(state));
}
let autopilot = apLoad();
let apMarketPrice = null;

function apExtractPriceFromPayload(payload){
  if (!payload) return null;

  const panel  = payload.panel  || payload || {};
  const ui     = payload.ui     || {};
  const digest = payload.digest || {};
  const raw    = payload.raw || payload.raw_eye || payload.data || {};

  const candidates = [
    // painel
    panel.price_now, panel.last_price, panel.price, panel.current_price,
    // ui
    ui.price, ui.last_price, ui.current_price,
    // raw/candle (quando existir)
    raw?.candle?.close, raw?.candle?.c, raw?.last?.close,
    // digest (se voc√™ decidir mandar pre√ßo pra c√° no futuro)
    digest.price, digest.last_price
  ];

  for (const c of candidates){
    const n = apParseNumber(c);
    if (typeof n === "number") return n;
  }
  return null;
}

function apUpdateMarketPriceFromPayload(payload){
  const px = apExtractPriceFromPayload(payload);

  if (typeof px === "number") {
    apMarketPrice = px;
    autopilot.priceNow = px;
    autopilot.current_price = px;
  } else {
    apMarketPrice = null;
    autopilot.priceNow = null;
    autopilot.current_price = null;
  }

  apRenderSizing();
}


function apOnSymbolChange(symbol){
  try {
    symbol = String(symbol || '').toUpperCase().trim();
    if (!symbol) return;

    // corta ‚Äúpre√ßo velho‚Äù do ativo anterior
    apMarketPrice = null;

    // remove panel antigo do contexto (pra UI n√£o mostrar s√≠mbolo velho)
    if (window.apCtx) window.apCtx.panel = null;

    // carrega estado atual
    autopilot = apLoad();

    // ‚úÖ fallback de s√≠mbolo (porque snapshot.symbol pode vir vazio)
    const prevSymRaw =
      (autopilot?.snapshot?.symbol) ??
      (autopilot?.lastSymbol) ??
      (localStorage.getItem("aaron_selected_symbol")) ??
      null;

    const prevSym = prevSymRaw ? String(prevSymRaw).toUpperCase().trim() : null;

    const inTrade = !!autopilot?.snapshot && autopilot?.state && autopilot.state !== 'FLAT';

    // ‚úÖ se mudou s√≠mbolo, zera pre√ßo cacheado pra n√£o ‚Äúvazar‚Äù
    if (prevSym && prevSym !== symbol) {
      autopilot.priceNow = null;
      autopilot.current_price = null;
    }

    // ‚úÖ se estiver em trade e mudar s√≠mbolo, reseta contrato
    if (inTrade && prevSym && prevSym !== symbol) {
      autopilot.enabled = false;
      autopilot.active = false;
      autopilot.side = null;
      autopilot.entry = null;
      autopilot.startedAt = null;

      autopilot.state = 'FLAT';
      autopilot.snapshot = null;
      autopilot.exitPending = false;

      autopilot.marketNow = 'wait';
      autopilot.priceNow = null;
      autopilot.current_price = null;
      autopilot.pnl = null;
      autopilot.rMultiple = null;
      autopilot.lastUpdate = null;

      apSave(autopilot);
      if (els?.apToggle) els.apToggle.checked = false;
    }

    // ‚úÖ sempre salva qual √© o s√≠mbolo ‚Äúatual‚Äù pro pr√≥ximo ciclo (fallback)
    autopilot.lastSymbol = symbol;
    apSave(autopilot);

    // atualiza UI imediatamente (mesmo antes do loadPanel terminar)
    if (typeof apSyncUI === 'function') apSyncUI();
  } catch (e) {
    console.error('[AARON][AP] apOnSymbolChange error', e);
  }
}


// ======================== AUTOPILOT CONTRACT ENGINE (state + snapshot + conflict) ========================
const AP_STATES = {
  FLAT: 'FLAT',
  LONG_ACTIVE: 'LONG_ACTIVE',
  SHORT_ACTIVE: 'SHORT_ACTIVE',
  EXIT_PENDING: 'EXIT_PENDING',
};

window.apCtx = window.apCtx || {
  panel: null,
  executionPlan: '',
  riskLevel: '',
  finalSummary: '',
  marketNow: 'wait',
};
const apCtx = window.apCtx;


function apToNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function apFmtPx(v){
  const n = apToNum(v);
  if(n == null) return '‚Äî';
  return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
}

function apFmtMoney(v){
  const n = apToNum(v);
  if(n == null) return '‚Äî';
  const sign = n >= 0 ? '+' : '-';
  const abs = Math.abs(n);
  return `${sign}$${abs.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
}

function apParseMarketNow(executionPlan){
  const s = String(executionPlan || '').toLowerCase();

  // WAIT primeiro (se aparecer explicitamente)
  if (/\bwait\b/.test(s) || /aguarde|espera|no trade|stand by/.test(s)) return 'wait';

  // GO FULL BUY / GO FULL SELL
  if (/go\s*full.*buy|full.*buy/.test(s)) return 'buy';
  if (/go\s*full.*sell|full.*sell/.test(s)) return 'sell';

  // BUY / SELL
  const hasBuy  = /\bbuy\b|compra|\blong\b/.test(s);
  const hasSell = /\bsell\b|venda|\bshort\b/.test(s);

  if (hasBuy && !hasSell) return 'buy';
  if (hasSell && !hasBuy) return 'sell';

  // amb√≠guo => WAIT (mais seguro)
  return 'wait';
}

function apConsensusScores(panel){
  const c = panel?.ai_consensus || panel?.consensus || panel?.consenso || {};
  const buy  = apToNum(c.buy ?? c.buy_pct ?? c.long ?? c.up ?? c.bull) ?? 0;
  const sell = apToNum(c.sell ?? c.sell_pct ?? c.short ?? c.down ?? c.bear) ?? 0;
  return { buy, sell };
}

function apConsensusDominant(scores, side){
  const buy = scores.buy ?? 0;
  const sell = scores.sell ?? 0;

  // ‚Äúdominante‚Äù = diferen√ßa clara OU >60/40
  if(side === 'sell'){
    return (sell - buy) >= 15 || (sell >= 60 && buy <= 40) || (buy > 0 && (sell / buy) >= 1.25);
  }
  if(side === 'buy'){
    return (buy - sell) >= 15 || (buy >= 60 && sell <= 40) || (sell > 0 && (buy / sell) >= 1.25);
  }
  return false;
}

function apStructureConfirm(panel){
  return !!(
    panel?.estrutura_mercado?.confirma ??
    panel?.market_structure?.confirma ??
    panel?.structure_confirm ??
    false
  );
}

function apDidHitStop(px, snap){
  const p = apToNum(px);
  const stop = apToNum(snap?.stop);
  if(p == null || stop == null) return false;

  if(snap?.side === 'long') return p <= stop;
  if(snap?.side === 'short') return p >= stop;
  return false;
}

function apIsStrongContra(panel, marketNow, snap, px){
  if(!snap) return false;

  // ‚Äúcontra‚Äù s√≥ importa quando MarketNow aponta pro lado oposto do trade
  if(snap.side === 'long' && marketNow !== 'sell') return false;
  if(snap.side === 'short' && marketNow !== 'buy') return false;

  const hitStop = apDidHitStop(px, snap);
  const structure = apStructureConfirm(panel);
  const scores = apConsensusScores(panel);
  const dom = (snap.side === 'long')
    ? apConsensusDominant(scores, 'sell')
    : apConsensusDominant(scores, 'buy');

  return !!(hitStop || structure || dom);
}

function apBuildSnapshot(side){
  const panel = apCtx.panel;

  // tenta pegar stop/tps do √∫ltimo tradeCard (se existir)
  const tc = (typeof lastTradeCard !== 'undefined') ? lastTradeCard : null;

  const entry = apPickEntryFromUI() ?? apGetMarketPrice();

  return {
    opened_at_timestamp: Date.now(),
    side: (side === 'buy') ? 'long' : 'short',
    entry_price: apToNum(entry),

    stop: apToNum(tc?.stop),
    tp1: apToNum(tc?.tp1),
    tp2: apToNum(tc?.tp2),

    // extras (se tiver)
    symbol: panel?.symbol ?? panel?.ticker ?? null,
    timeframe: panel?.timeframe ?? null,
    pattern_id: panel?.pattern_id ?? panel?.pattern ?? null,
    setup_id: panel?.setup_id ?? panel?.setup ?? null,
  };
}

function apUpdatePnLAndR(autopilotObj, px){
  const snap = autopilotObj.snapshot;
  if(!snap) return;

  const entry = apToNum(snap.entry_price);
  const p = apToNum(px);
  if(entry == null || p == null) return;

  autopilotObj.current_price = p;

  // PnL (simples): usa units se existir; se n√£o, PnL em ‚Äúpor unidade‚Äù
  const units = apToNum(autopilotObj.units) ?? apToNum(snap.size);
  const delta = (snap.side === 'long') ? (p - entry) : (entry - p);
  autopilotObj.pnl = (units != null && units > 0) ? (delta * units) : delta;

  // R multiple: precisa de stop
  const stop = apToNum(snap.stop);
  if(stop == null) { autopilotObj.rMultiple = null; return; }

  const risk = (snap.side === 'long') ? (entry - stop) : (stop - entry);
  if(!Number.isFinite(risk) || risk <= 0) { autopilotObj.rMultiple = null; return; }

  autopilotObj.rMultiple = delta / risk;
}

function apOnPanelUpdate(panel, meta){
  autopilot = apLoad();

  apCtx.panel = panel ?? null;
  apCtx.executionPlan = meta?.executionPlan ?? '';
  apCtx.riskLevel = meta?.riskLevel ?? '';
  apCtx.finalSummary = meta?.finalSummary ?? '';

  const marketNow = apParseMarketNow(apCtx.executionPlan);
  apCtx.marketNow = marketNow;

  autopilot.marketNow = marketNow;

  const px = apGetMarketPrice();
  if(px != null) apUpdatePnLAndR(autopilot, px);

  // regra de conflito ‚Üí EXIT_PENDING (e relaxa se parar de ser forte)
  if(autopilot.state !== AP_STATES.FLAT && autopilot.snapshot){
    const strongContra = apIsStrongContra(panel, marketNow, autopilot.snapshot, autopilot.current_price ?? px);

    if(strongContra){
      autopilot.state = AP_STATES.EXIT_PENDING;
      autopilot.exitPending = true;
    }else{
      autopilot.state = (autopilot.snapshot.side === 'short') ? AP_STATES.SHORT_ACTIVE : AP_STATES.LONG_ACTIVE;
      autopilot.exitPending = false;
    }
  }

  autopilot.lastUpdate = Date.now();
  apSave(autopilot);

  if(typeof apSyncUI === 'function') apSyncUI();
}


function apMoneyEN(n){
  return (typeof n === 'number' && isFinite(n))
    ? '$' + n.toLocaleString('en-US', { maximumFractionDigits: 0 })
    : '‚Äî';
}
function apMoneyPT(n){
  return (typeof n === 'number' && isFinite(n))
    ? 'US$ ' + n.toLocaleString('pt-BR', { maximumFractionDigits: 0 })
    : '‚Äî';
}

function apGetMarketPrice(){
  if (typeof apMarketPrice === 'number' && isFinite(apMarketPrice) && apMarketPrice > 0) return apMarketPrice;
  if (typeof autopilot.priceNow === 'number' && isFinite(autopilot.priceNow) && autopilot.priceNow > 0) return autopilot.priceNow;

  const entry = apPickEntryFromUI();
  if (typeof entry === 'number' && isFinite(entry) && entry > 0) return entry;

  return null;
}

function apComputeUnits(capital, price){
  const cap = Number(capital);
  const p = Number(price);
  if (!isFinite(cap) || cap <= 0 || !isFinite(p) || p <= 0) return null;
  return Math.floor(cap / p);
}

function apRenderSizing(){
  // mant√©m state sempre ‚Äú2.0-ready‚Äù
  // N√ÉO re-hidratar aqui (apLoad), sen√£o apActivate() perde enabled/active/side rec√©m-setados
  if (!autopilot) autopilot = apLoad();

  // capital vem do input (se existir)
  if (els.apCapital) {
    const cap = Number(String(els.apCapital.value || '').replace(',', '.'));
    if (isFinite(cap) && cap > 0) autopilot.capital = cap;
  }

  const price = apGetMarketPrice();
  autopilot.priceNow = (price != null) ? Number(price) : autopilot.priceNow;

  const inPos = (autopilot.state && autopilot.state !== AP_STATES.FLAT && autopilot.snapshot);
const frozenUnits = inPos ? (apToNum(autopilot.snapshot?.units ?? autopilot.snapshot?.size)) : null;

const units = (frozenUnits != null)
  ? frozenUnits
  : apComputeUnits(autopilot.capital, price);

autopilot.units = units;


  if (els.apUnits) {
    els.apUnits.value = (units != null) ? units.toLocaleString('en-US') : '‚Äî';
  }

  const px = (price != null) ? Number(price) : null;
  if (els.apPriceSell) els.apPriceSell.textContent = (px != null) ? px.toFixed(2) : '‚Äî';
  if (els.apPriceBuy)  els.apPriceBuy.textContent  = (px != null) ? px.toFixed(2) : '‚Äî';
  if (els.apPriceMid)  els.apPriceMid.textContent  = (px != null) ? px.toFixed(2) : '‚Äî';

  apSave(autopilot);
}



function apSideLabel(side, lang) {
  if (lang === 'en') return side === 'buy' ? 'BUY' : 'SELL';
  return side === 'buy' ? 'COMPRA' : 'VENDA';
}
function apPickEntryFromUI() {
  const txt = (els.tradeEntry?.textContent || '').replace(',', '.');
  const m = txt.match(/(\d+(\.\d+)?)/);
  return m ? Number(m[1]) : null;
}
function apSyncUI() {
  if (!els.apToggle || !els.apState || !els.apMeta) return;

  autopilot = apLoad();

  const selSym = (localStorage.getItem('aaron_selected_symbol') || '').trim().toUpperCase() || '‚Äî';
  const panelSym = apCtx?.panel?.symbol || apCtx?.panel?.ticker;
  const sym = String(autopilot?.snapshot?.symbol || panelSym || selSym || '‚Äî').toUpperCase();
  const tf = String(autopilot?.snapshot?.timeframe || apCtx?.panel?.timeframe || '‚Äî');
  const symTf = `${sym} | ${tf}`;


  els.apToggle.checked = !!autopilot.enabled;

  // garante que o 2.0 (capital/units) est√° sempre renderizado
  if (els.apCapital) els.apCapital.value = String(autopilot.capital ?? 25000);
  apRenderSizing();

  // contrato (state/marketNow) com fallback seguro
  const st = (typeof autopilot.state === 'string')
    ? autopilot.state
    : (autopilot.active ? (autopilot.side === 'sell' ? 'SHORT_ACTIVE' : 'LONG_ACTIVE') : 'FLAT');

  const mn = (autopilot.marketNow === 'buy' || autopilot.marketNow === 'sell' || autopilot.marketNow === 'wait')
    ? autopilot.marketNow
    : 'wait';

  const mnTxt = String(mn).toUpperCase();

  els.apState.classList.remove('ap-on', 'ap-off', 'ap-buy', 'ap-sell');

  if (!autopilot.enabled) {
    els.apState.classList.add('ap-off');
    els.apState.textContent = 'OFF';
    els.apMeta.textContent = `${symTf} ‚Ä¢ ${st} ‚Ä¢ MN ${mnTxt}`;
    return;
  }

  els.apState.classList.add('ap-on');

  // Se est√° em posi√ß√£o
  if (autopilot.active && (autopilot.side === 'buy' || autopilot.side === 'sell')) {
    els.apState.classList.add(autopilot.side === 'buy' ? 'ap-buy' : 'ap-sell');

    // Se contrato mandou EXIT_PENDING, mostra EXIT no label
    const isExit = (st === 'EXIT_PENDING') || !!autopilot.exitPending;
    els.apState.textContent = isExit ? 'EXIT' : (autopilot.side === 'buy' ? 'BUY' : 'SELL');

    const entry = (autopilot.entry != null && isFinite(autopilot.entry)) ? Number(autopilot.entry).toFixed(2) : '‚Äî';
    const started = autopilot.startedAt
      ? new Date(autopilot.startedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : '‚Äî';

    const capTxt = (currentLang === 'en') ? apMoneyEN(autopilot.capital) : apMoneyPT(autopilot.capital);
    const unitsTxt = (autopilot.units != null) ? `${autopilot.units.toLocaleString('en-US')} sh` : '‚Äî';

    // P/L e R (se existirem)
    const pnl = (autopilot.pnl != null && isFinite(autopilot.pnl)) ? Number(autopilot.pnl) : null;
    const r = (autopilot.rMultiple != null && isFinite(autopilot.rMultiple)) ? Number(autopilot.rMultiple) : null;

    const pnlTxt = (pnl == null) ? '' : ` ‚Ä¢ P/L ${(pnl >= 0 ? '+' : '')}${pnl.toFixed(2)}`;
    const rTxt = (r == null) ? '' : ` ‚Ä¢ R ${r.toFixed(2)}`;

    els.apMeta.textContent =
      `${symTf} ‚Ä¢ @ ${entry} ‚Ä¢ ${started} ‚Ä¢ ${capTxt} ‚Ä¢ ${unitsTxt} ‚Ä¢ ${st} ‚Ä¢ MN ${mnTxt}${pnlTxt}${rTxt}`;
    return;
  }

  // ON mas sem posi√ß√£o
  els.apState.textContent = 'ON';
  els.apMeta.textContent = `${symTf} ‚Ä¢ armado (sem posi√ß√£o) ‚Ä¢ ${st} ‚Ä¢ MN ${mnTxt}`;
}


function apActivate(side) {
  autopilot = apLoad(); // re-hidrata

  autopilot.enabled = true;
  autopilot.active = true;
  autopilot.side = side;

  const entry = apPickEntryFromUI() ?? apGetMarketPrice();
  autopilot.entry = (entry != null && isFinite(entry)) ? Number(entry) : autopilot.entry;

  // atualiza sizing 2.0 quando entra em posi√ß√£o
  apRenderSizing();
  autopilot.startedAt = Date.now();

  // ===== CONTRATO (Snapshot congelado) =====
  const panel = (typeof apCtx !== 'undefined' && apCtx && apCtx.panel) ? apCtx.panel : null;

  // 1) Base snapshot (j√° traz symbol/timeframe/pattern_id/setup_id)
  const snap = apBuildSnapshot(side);

  // 2) Congelar size/units no momento da entrada
  const unitsAtEntry = apComputeUnits(autopilot.capital, snap.entry_price);
  autopilot.units = unitsAtEntry;

  snap.size = unitsAtEntry;
  snap.size_text = (unitsAtEntry != null) ? unitsAtEntry.toLocaleString('en-US') : null;

  // 3) Congelar capital/units tamb√©m (ajuda em reload e PnL)
  snap.capital = autopilot.capital;
  snap.units = unitsAtEntry;

  // 4) Contexto congelado (safe)
  const scores = apConsensusScores(panel);
  snap.contexto = {
    tendencia: panel?.status_geral?.tendencia ?? null,
    estrutura_confirma: panel?.estrutura_mercado?.confirma ?? null,
    ai_consensus: (scores.sell > scores.buy) ? 'sell' : (scores.buy > scores.sell) ? 'buy' : 'neutral',
    pullback_ativo: panel?.pullback_brain?.pullback_ativo ?? null,
    regime: panel?.regime ?? panel?.tags ?? null,
  };

  autopilot.snapshot = snap;

  // estado
  autopilot.state = (side === 'sell') ? AP_STATES.SHORT_ACTIVE : AP_STATES.LONG_ACTIVE;
  autopilot.exitPending = false;

  apSave(autopilot);
  apSyncUI();

  // for√ßa re-render do painel no estado "travado"
  if (typeof loadPanel === 'function') loadPanel(false);
}

function apClose() {
  autopilot = apLoad();

  // ‚úÖ contrato: Close = apaga snapshot + OFF + FLAT (reset total)
  autopilot.enabled = false;
  autopilot.active = false;
  autopilot.side = null;
  autopilot.entry = null;
  autopilot.startedAt = null;

  autopilot.state = AP_STATES.FLAT;
  autopilot.snapshot = null;
  autopilot.exitPending = false;

  autopilot.marketNow = 'wait';
  autopilot.current_price = null;
  autopilot.pnl = null;
  autopilot.rMultiple = null;
  autopilot.lastUpdate = null;

  apSave(autopilot);

  if (els?.apToggle) els.apToggle.checked = false;
  if (typeof apSyncUI === 'function') apSyncUI();
  if (typeof loadPanel === 'function') loadPanel(false);
}




   // ====== SIZING BRAIN ‚Äì CAMPOS DO CARD COMPLETO ======
const sbEls = {
  card: document.getElementById('sizing-brain-card'),
  accountBalance: document.getElementById('sb-account-balance'),
  leverage: document.getElementById('sb-leverage'),
  tradeCapital: document.getElementById('sb-trade-capital'),
  riskPercentInput: document.querySelector('input#sb-risk-percent'),
  entryPrice: document.getElementById('sb-entry-price'),
  atrValue: document.getElementById('sb-atr-value'),
  atrMultStop: document.getElementById('sb-atr-mult-stop'),
  atrMultTake: document.getElementById('sb-atr-mult-take'),
  sideRadios: document.querySelectorAll('input[name="sb-side"]'),

  outStopDistance: document.getElementById('sb-stop-distance'),
  outStopPrice: document.getElementById('sb-stop-price'),
  outTakePrice: document.getElementById('sb-take-price'),
  outPositionSize: document.getElementById('sb-position-size'),
  outRiskDollar: document.getElementById('sb-risk-dollar'),
  outRiskPercent: document.querySelector('p#sb-risk-percent'),

  calcBtn: document.getElementById('sb-calcular'),
  status: document.getElementById('sb-status'),
};

    // ====== SIZING BRAIN OFFLINE ‚Äì C√ÅLCULO COMPLETO ======
function sbNum(el) {
  if (!el) return 0;
  const raw = (el.value || '').toString().replace(',', '.');
  const n = Number(raw);
  return Number.isFinite(n) ? n : 0;
}

function recalcSizingBrainOffline() {
  if (!sbEls.accountBalance) return;

  const account    = sbNum(sbEls.accountBalance);   // capital real da conta
  const leverage   = sbNum(sbEls.leverage);         // alavancagem (x)
  const tradeInput = sbNum(sbEls.tradeCapital);     // capital em uso neste trade
  const riskPct    = sbNum(sbEls.riskPercentInput); // risco % por trade (da conta)
  const entry      = sbNum(sbEls.entryPrice);       // pre√ßo de entrada
  const atr        = sbNum(sbEls.atrValue);         // ATR $
  const multStop   = sbNum(sbEls.atrMultStop);      // mult stop
  const multTake   = sbNum(sbEls.atrMultTake);      // mult take

  const sideRadio  = Array.from(sbEls.sideRadios || []).find(r => r.checked);
  const side       = sideRadio ? sideRadio.value : 'long';

  const statusEl   = sbEls.status;

  // valida√ß√µes b√°sicas
  if (!account || !entry || !atr || !multStop || !riskPct) {
    if (statusEl) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en')
          ? 'Fill account, risk %, entry price and ATR to calculate.'
          : 'Preencha conta, risco %, pre√ßo de entrada e ATR para calcular.';
    }
    return;
  }

  // buying power = conta * alavancagem
  const lev = leverage > 0 ? leverage : 1;
  const buyingPower = account * lev;

  // capital em uso: se n√£o preencher, usamos o buying power
  let tradeCapital = tradeInput > 0 ? tradeInput : buyingPower;
  if (tradeCapital > buyingPower) tradeCapital = buyingPower;

  const stopDist = atr * multStop; // dist√¢ncia do stop em d√≥lar
  if (!stopDist) {
    if (statusEl) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en')
          ? 'Stop distance (ATR √ó mult) is zero. Check ATR and multiplier.'
          : 'Dist√¢ncia do stop (ATR √ó mult) est√° zero. Confira ATR e multiplicador.';
    }
    return;
  }

  // risco m√°ximo permitido pela regra (risco % da conta)
  const riskAllowedDollar = account * (riskPct / 100);

  // limite por capital e por risco
  const maxSharesByCapital = tradeCapital / entry;
  const maxSharesByRisk    = riskAllowedDollar / stopDist;
  let shares               = Math.floor(Math.max(0, Math.min(maxSharesByCapital, maxSharesByRisk)));

  if (!Number.isFinite(shares) || shares <= 0) {
    shares = 0;
  }

  const riskUsedDollar       = shares * stopDist;
  const riskUsedPctAccount   = account > 0 ? (riskUsedDollar / account) * 100 : 0;

  // pre√ßos de stop e alvo
  let stopPrice, takePrice;
  if (side === 'short') {
    stopPrice = entry + stopDist;
    takePrice = entry - (atr * multTake);
  } else {
    stopPrice = entry - stopDist;
    takePrice = entry + (atr * multTake);
  }

  // ====== escreve nos campos ======
  if (sbEls.outStopDistance) {
    sbEls.outStopDistance.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Stop distance: '
        : 'Dist√¢ncia do STOP: ') +
      stopDist.toFixed(2) +
      ' USD';
  }

  if (sbEls.outStopPrice) {
    sbEls.outStopPrice.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Suggested Stop Loss: '
        : 'Stop Loss sugerido: ') +
      '$ ' +
      stopPrice.toFixed(2);
  }

  if (sbEls.outTakePrice) {
    sbEls.outTakePrice.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Suggested Take Profit: '
        : 'Take Profit sugerido: ') +
      '$ ' +
      takePrice.toFixed(2);
  }

  if (sbEls.outPositionSize) {
    sbEls.outPositionSize.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Suggested size: '
        : 'Qtd sugerida: ') +
      (shares > 0 ? shares + ' shares' : '‚Äî');
  }

  if (sbEls.outRiskDollar) {
    sbEls.outRiskDollar.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Approx. risk: '
        : 'Risco aprox.: ') +
      '$ ' +
      riskUsedDollar.toFixed(2);
  }

  if (sbEls.outRiskPercent) {
    sbEls.outRiskPercent.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Risk % trade / account: '
        : 'Risco % trade / conta: ') +
      riskUsedPctAccount.toFixed(2) +
      '%';
  }

  // ====== term√¥metro do Sizing Brain offline ======
  const meterFill  = document.getElementById('sb-meter-fill');
  const meterLabel = document.getElementById('sb-meter-label');

  if (meterFill && meterLabel) {
    // uso de risco = quanto do risco permitido (riskAllowedDollar) voc√™ est√° usando
    let usage = riskAllowedDollar > 0
      ? (riskUsedDollar / riskAllowedDollar) * 100
      : 0;

    // clamp
    usage = Math.max(0, Math.min(usage, 150));
    const width = Math.max(0, Math.min(usage, 100));

    meterFill.style.width = width.toFixed(0) + '%';
    meterFill.classList.remove('safe', 'warn', 'danger');

    let modeClass = 'safe';
    if (usage <= 60) {
      modeClass = 'safe';
    } else if (usage <= 100) {
      modeClass = 'warn';
    } else {
      modeClass = 'danger';
    }
    meterFill.classList.add(modeClass);

    meterLabel.textContent =
      (typeof currentLang !== 'undefined' && currentLang === 'en'
        ? 'Risk usage '
        : 'Uso de risco ') +
      usage.toFixed(0) +
      '%';
  }

  // ====== status em texto ======
  if (statusEl) {
    if (!shares) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en'
          ? 'Position too small or zero. Check risk %, ATR and stop distance.'
          : 'Posi√ß√£o muito pequena ou zero. Confira risco %, ATR e dist√¢ncia do stop.');
    } else if (usage > 100) {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en'
          ? 'You are using more than 100% of the risk you defined. Consider reducing size or widening the base capital.'
          : 'Voc√™ est√° usando mais de 100% do risco que definiu. Considere reduzir o tamanho ou ajustar o capital base.');
    } else {
      statusEl.textContent =
        (typeof currentLang !== 'undefined' && currentLang === 'en'
          ? 'Sizing calculated. Size stays within your defined risk. Execute only if setup is A+.'
          : 'Sizing calculado. Tamanho dentro do risco que voc√™ definiu. Execute apenas se o setup for A+.');
    }
  }
}

// liga o bot√£o "Recalcular Sizing"
if (sbEls.calcBtn) {
  sbEls.calcBtn.addEventListener('click', function (e) {
    e.preventDefault();
    recalcSizingBrainOffline();
  });
}


// dados atuais do "c√©rebro de pullback" para re-renderizar quando trocar PT/EN
let lastPullbackBrain = null;
let lastSizingBrain = null;


// ====== GERENCIADOR DE RISCO ¬∑ ATR (FRONTEND) ======
const atrEls = {
  panel: document.getElementById('atr-risk-panel'),
  toggleBtn: document.getElementById('atr-risk-toggle'),
  body: document.getElementById('atr-risk-body'),
  length: document.getElementById('atr-length-input'),
  smoothing: document.getElementById('atr-smoothing-input'),
  mult: document.getElementById('atr-multiplier-input'),
  atrValue: document.getElementById('atr-value-input'),
  capital: document.getElementById('atr-capital-input'),
  entry: document.getElementById('atr-entry-input'),
  riskPercent: document.getElementById('atr-riskpct-input'),
  side: document.getElementById('atr-side-input'),
  outDistance: document.getElementById('atr-stop-distance'),
  outShares: document.getElementById('atr-shares'),
  outRisk: document.getElementById('atr-risk-money'),
  outReward2R: document.getElementById('atr-reward-2r'),
  outReward3R: document.getElementById('atr-reward-3r'),
  calcBtn: document.getElementById('atr-calc-btn'),
};

// abre / fecha o card
if (atrEls.toggleBtn && atrEls.body) {
  atrEls.toggleBtn.addEventListener('click', () => {
    const hidden =
      atrEls.body.style.display === 'none' || atrEls.body.style.display === '';
    atrEls.body.style.display = hidden ? 'grid' : 'none';
    atrEls.toggleBtn.textContent = hidden ? 'Fechar' : 'Abrir';
  });
}

// c√°lculo do risco baseado no ATR digitado
function updateAtrRisk() {
  if (!atrEls.atrValue || !atrEls.capital || !atrEls.entry) return;

  const atr = parseFloat(atrEls.atrValue.value || '0');
  const mult = parseFloat(atrEls.mult.value || '1');
  const capital = parseFloat(atrEls.capital.value || '0');
  const entry = parseFloat(atrEls.entry.value || '0');
  const riskPct = parseFloat(atrEls.riskPercent.value || '1');

  if (!atr || !capital || !entry) return;

  const stopDist = atr * mult;
  const riskPerShare = stopDist;

  const sharesByCapital = capital / entry;
  const sharesByRisk = (capital * (riskPct / 100)) / riskPerShare;
  const shares = Math.min(sharesByCapital, sharesByRisk);

  const riskMoney = shares * riskPerShare;
  const reward2R = riskMoney * 2;
  const reward3R = riskMoney * 3;

  if (atrEls.outDistance) atrEls.outDistance.textContent = stopDist.toFixed(2);
  if (atrEls.outShares) atrEls.outShares.textContent = shares.toFixed(0);
  if (atrEls.outRisk) atrEls.outRisk.textContent = '$ ' + riskMoney.toFixed(2);
  if (atrEls.outReward2R)
    atrEls.outReward2R.textContent = '$ ' + reward2R.toFixed(2);
  if (atrEls.outReward3R)
    atrEls.outReward3R.textContent = '$ ' + reward3R.toFixed(2);
}

if (atrEls.calcBtn) {
  atrEls.calcBtn.addEventListener('click', (e) => {
    e.preventDefault();
    updateAtrRisk();
  });
}

// Preenche ATR + pre√ßo de entrada a partir do JSON (panel + raw)
function prefillAtrFromPanel(panel, raw) {
  if (!panel || !atrEls) return;

  const atrBlock = panel.atr || panel.atr_info;
  const indicators = raw && raw.indicators ? raw.indicators : {};

  // ATR
  if (atrBlock && atrBlock.value != null && atrEls.atrValue) {
    atrEls.atrValue.value = Number(atrBlock.value).toFixed(2);
  } else if (typeof indicators.atr === 'number' && atrEls.atrValue) {
    atrEls.atrValue.value = indicators.atr.toFixed(2);
  }

  if (atrBlock && atrBlock.length != null && atrEls.length) {
    atrEls.length.value = atrBlock.length;
  }
  if (atrBlock && atrBlock.smoothing && atrEls.smoothing) {
    atrEls.smoothing.value = atrBlock.smoothing;
  }
  if (atrBlock && atrBlock.multiplier != null && atrEls.mult) {
    atrEls.mult.value = atrBlock.multiplier;
  }

  // PRE√áO DE ENTRADA
  let entry =
    panel.entry_price ||
    panel.reference_price ||
    panel.price_now ||
    panel.last_price ||
    (raw && raw.candle && raw.candle.close);

  if (entry != null && atrEls.entry) {
    atrEls.entry.value = Number(entry).toFixed(2);
  }
}

function safeText(el, value, fallback = '‚Äî') {
  if (!el) return;
  el.textContent =
    value === undefined || value === null || value === ''
      ? fallback
      : String(value);
}

function escapeHTML(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

// Puxa "Estat√≠stica: ...." de dentro do coment√°rio (PT/EN) e remove do coment√°rio
function splitStatsFromComment(raw) {
  const out = { stats: '', comment: '' };
  if (raw === undefined || raw === null) return out;

  let s = String(raw);

  // remove aspas bonitas do come√ßo/fim se vierem
  s = s.replace(/^[‚Äú"]+/, '').replace(/[‚Äù"]+$/, '');

  // pega a LINHA INTEIRA: "üìä Estat√≠stica (7y): ...." (PT/EN) sem remover do coment√°rio
  const rx =
    /(?:^|\n)\s*(?:üìä\s*)?(?:estat[i√≠]stica(?:\s*\([^)]*\))?|statistics(?:\s*\([^)]*\))?|stats(?:\s*\([^)]*\))?)\s*:\s*.+?(?=\n|$)/i;

  const m = s.match(rx);
  if (m) out.stats = m[0].trim();

  out.comment = s.trim(); // mant√©m intacto
  return out;
}


function formatCommentToHTML(raw) {
  if (raw === undefined || raw === null) return '<div class="comment-lines"><div class="comment-line">‚Äî</div></div>';

  let s = String(raw).trim();
  s = s.replace(/^[‚Äú"]+/, '').replace(/[‚Äù"]+$/, '');

  // quebra por linhas / bullets
  let lines = s
    .split(/\r?\n|‚Ä¢|\u2022/g)
    .map(x => x.trim())
    .filter(Boolean);

  // se veio tudo numa frase gigante, quebra por senten√ßas
  if (lines.length <= 1 && s.length > 90) {
    lines = s
      .split(/(?<=[.!?])\s+/g)
      .map(x => x.trim())
      .filter(Boolean);
  }

  const html = lines.map(line => {
    const idx = line.indexOf(':');
    // Se parecer "T√≠tulo: texto", deixa o t√≠tulo em bold
    if (idx > 0 && idx <= 28) {
      const key = line.slice(0, idx + 1);
      const val = line.slice(idx + 1).trim();
      return `<div class="comment-line"><strong>${escapeHTML(key)}</strong> ${escapeHTML(val)}</div>`;
    }
    return `<div class="comment-line">${escapeHTML(line)}</div>`;
  }).join('');

  return `<div class="comment-lines">${html || '<div class="comment-line">‚Äî</div>'}</div>`;
}

function setFormattedComment(el, raw) {
  if (!el) return;
  el.innerHTML = formatCommentToHTML(raw);
}


function setArrow(el, dir) {
  if (!el) return;
  el.classList.remove('arrow-up', 'arrow-down');
  let symbol = '‚Üï';
  if (dir === 'up' || dir === 'UP' || dir === 'alta' || dir === 'ALTA') {
    el.classList.add('arrow-up');
    symbol = '‚Üë';
  } else if (dir === 'down' || dir === 'DOWN' || dir === 'baixa' || dir === 'BAIXA') {
    el.classList.add('arrow-down');
    symbol = '‚Üì';
  }
  el.textContent = symbol;
}

function setPillTrend(el, dir, label) {
  if (!el) return;
  el.classList.remove('pill-green', 'pill-red');
  let txt = label || 'Neutro';

  if (!dir) {
    el.textContent = txt;
    return;
  }

  const d = String(dir).toLowerCase();

  if (d.includes('alta') || d === 'up') {
    el.classList.add('pill-green');
    if (!label) txt = 'Fluxo de alta';
  } else if (d.includes('baixa') || d === 'down') {
    el.classList.add('pill-red');
    if (!label) txt = 'Fluxo de baixa';
  }

  el.textContent = txt;
}

function setRiskPill(level) {
  if (!els.riskPill) return;
  const el = els.riskPill;
  el.classList.remove('pill-green', 'pill-red');
  let txt = 'Neutro';

  if (!level) {
    el.textContent = txt;
    return;
  }

  const l = String(level).toLowerCase();

  if (l.includes('alto') || l.includes('high')) {
    el.classList.add('pill-red');
    txt = 'Risco Alto';
  } else if (l.includes('baixo') || l.includes('low')) {
    el.classList.add('pill-green');
    txt = 'Risco Baixo';
  } else {
    txt = level;
  }

  el.textContent = txt;
}

// === ATUALIZAR CART√ÉO DE TRADE (CITADEL) ===
function updateTradeCard(trade) {
  // se o HTML ainda n√£o carregou, sai
  if (!els.tradeStatusText) return;

  const t = trade || {};
    lastTradeCard = t;

  const lang = currentLang === 'en' ? 'en' : 'pt';

  // helpers para pegar PT/EN
  const pick = (obj, baseKey) => {
    if (!obj) return null;
    if (lang === 'en') return obj[baseKey + '_en'] || obj[baseKey];
    return obj[baseKey + '_pt'] || obj[baseKey];
  };

  // ===== texto de status (linha de cima) =====
  const statusText =
    pick(t, 'status_text') ||
    pick(t, 'status') ||
    (lang === 'en'
      ? '‚úÖ Valid setup | ‚ùå No trade'
      : '‚úÖ Setup v√°lido | ‚ùå Sem trade');

  els.tradeStatusText.textContent = statusText;

  // ===== campos ‚Äúneutros‚Äù (sem idioma) =====
  safeText(els.tradeSymbol,    t.symbol   || t.ticker || '‚Äî');
  safeText(els.tradeTimeframe, t.timeframe || t.tf    || '‚Äî');
  safeText(els.tradeEntry,     t.entry_text || t.entry_range || t.entry || '‚Äî');
  safeText(els.tradeStop,      t.stop      != null ? t.stop      : '‚Äî');
  safeText(els.tradeTP1,       t.tp1       != null ? t.tp1       : '‚Äî');
  safeText(els.tradeTP2,       t.tp2       != null ? t.tp2       : '‚Äî');
  safeText(els.tradeSize,      t.size_text || t.size || '‚Äî');
  safeText(els.tradeRisk,      t.risk_text || t.risk || '‚Äî');
  safeText(els.pulseLine, pick(t, 'pulse_line') || '‚Äî');


  // ===== textos com PT/EN =====
  const modeText =
    pick(t, 'mode') ||
    (lang === 'en' ? 'Reversal at resistance' : 'Revers√£o em Resist√™ncia');

  const againstText =
    pick(t, 'against') ||
    (t.against_text || t.against_pct) ||
    (lang === 'en' ? '‚Äî' : '‚Äî');

  const directionText =
    pick(t, 'direction') ||
    (lang === 'en' ? 'SELL' : 'VENDA');

  const thermoText =
    pick(t, 'thermo') ||
    pick(t, 'thermometer') ||
    (lang === 'en' ? 'Moderately aggressive' : 'Agressivo moderado');

  const commentText =
    pick(t, 'comment') ||
    (lang === 'en'
      ? 'Statistically strong reversal after false breakout. If you execute, do not move the stop against the position.'
      : 'Revers√£o estatisticamente forte ap√≥s falso rompimento. Se executar, n√£o mova o stop contra a posi√ß√£o.');

  safeText(els.tradeMode,    modeText);
  safeText(els.tradeAgainst, againstText);
  safeText(els.tradeDirection, directionText);
    // ===== AUTOPILOT override (trava o card no estado da posi√ß√£o) =====
  autopilot = apLoad();
  apSyncUI();

  if (autopilot.enabled && autopilot.active && (autopilot.side === 'buy' || autopilot.side === 'sell')) {
    const sideLabel = apSideLabel(autopilot.side, lang);
    const entry = autopilot.entry != null ? autopilot.entry.toFixed(2) : '‚Äî';

    // status no topo
    els.tradeStatusText.textContent = (lang === 'en')
      ? `üß† AUTOPILOT ON | Simulating position: ${sideLabel} @ ${entry}`
      : `üß† AUTOPILOT ON | Simulando posi√ß√£o: ${sideLabel} @ ${entry}`;

    // for√ßa dire√ß√£o do card
    safeText(els.tradeDirection, sideLabel);

        // 2.0: empurra capital/units pro Cart√£o Citadel
    const px = apGetMarketPrice() ?? autopilot.entry;
    const units = apComputeUnits(autopilot.capital, px);

    if (els.tradeSize) {
      if (lang === 'en') {
        const capTxt = apMoneyEN(autopilot.capital);
        const uTxt = (units != null) ? `${units.toLocaleString('en-US')} shares` : '‚Äî';
        els.tradeSize.textContent = `${capTxt} ¬∑ ${uTxt}`;
      } else {
        const capTxt = apMoneyPT(autopilot.capital);
        const uTxt = (units != null) ? `${units.toLocaleString('pt-BR')} a√ß√µes` : '‚Äî';
        els.tradeSize.textContent = `${capTxt} ¬∑ ${uTxt}`;
      }
    }


    // troca ‚Äúskin‚Äù buy/sell do card
    if (els.tradeCard) {
      els.tradeCard.classList.remove('status-buy','status-sell','status-neutral');
      els.tradeCard.classList.add(autopilot.side === 'buy' ? 'status-buy' : 'status-sell');
    }

    // badge vira ‚ÄúHOLD / EM POSI√á√ÉO‚Äù
    if (els.tradeBadge) {
      els.tradeBadge.classList.remove('buy','sell');
      els.tradeBadge.classList.add(autopilot.side === 'buy' ? 'buy' : 'sell');
      els.tradeBadge.textContent = (lang === 'en') ? 'IN POSITION' : 'EM POSI√á√ÉO';
    }
  }

  safeText(els.tradeThermo, thermoText);

// --- estat√≠stica: pega do JSON (normal) ---
const parsed = splitStatsFromComment(commentText);

// Estat√≠stica ‚Äúnormal‚Äù do campo do cart√£o (n√£o usa a linha do coment√°rio)
const setupStatsText =
  pick(t, 'stats_text') ||
  pick(t, 'statistics_text') ||
  pick(t, 'stats') ||
  pick(t, 'statistics') ||
  '‚Äî';

safeText(els.tradeStats, setupStatsText, '‚Äî');

// NOVO: Estat√≠stica (7y) no topo ‚Äî vem do coment√°rio (ou cai pro JSON)
const topStatsText = parsed.stats || setupStatsText || '‚Äî';

if (els.tradeStatsTop) safeText(els.tradeStatsTop, topStatsText, '‚Äî');

if (els.tradeStatsTopLine) {
  const s = (topStatsText || '').trim();
  const hasStats = s && s !== '‚Äî' && s !== '-';
  els.tradeStatsTopLine.style.display = hasStats ? '' : 'none';

  // garante "Com estat√≠stica" no Status quando existir
  if (hasStats && els.tradeStatusText) {
    const token = (lang === 'en') ? 'With stats' : 'Com estat√≠stica';
    const cur = els.tradeStatusText.textContent || '';
    if (!cur.toLowerCase().includes(token.toLowerCase())) {
      els.tradeStatusText.textContent = `${cur} | ${token}`;
    }
  }
}

// Coment√°rio: N√ÉO remove nada
setFormattedComment(els.tradeComment, parsed.comment || commentText);



  // ===== visual do cart√£o (cor / badge) =====
  const card  = els.tradeCard;
  const badge = els.tradeBadge;

  if (card) {
    card.classList.remove('status-buy', 'status-sell', 'status-wait', 'status-no-trade');

    const side = (t.side || t.direction || '').toString().toLowerCase();
    const state = (t.state || t.trade_state || '').toString().toLowerCase();

    let modeClass = 'status-wait';

    if (state.includes('no') || state.includes('sem')) {
      modeClass = 'status-no-trade';
    } else if (side.includes('buy') || side.includes('compra')) {
      modeClass = 'status-buy';
    } else if (side.includes('sell') || side.includes('venda')) {
      modeClass = 'status-sell';
    }

    card.classList.add(modeClass);
  }

  if (badge) {
    const rawBadge = (t.badge || t.mode_badge || '').toString().toLowerCase();

    let text;
    if (rawBadge.includes('wait') || rawBadge.includes('aguardar')) {
      text = 'WAIT';
    } else if (rawBadge.includes('no')) {
      text = 'NO TRADE';
    } else if (rawBadge) {
      text = rawBadge.toUpperCase();
    } else {
      text = 'GO FULL';
    }

    badge.textContent = text;
  }
}


function applyHeroDecision(executionPlan, riskLevel, finalSummary) {
  const lang = (typeof currentLang !== 'undefined' ? currentLang : 'pt');

  // ‚úÖ Suporta IDs antigos (camelCase) e os da sua UI nova (kebab-case)
  const heroModePill =
    document.getElementById('heroModePill') ||
    document.getElementById('hero-mode-pill');

  const heroMain =
    document.getElementById('heroMain') ||
    document.getElementById('hero-main') ||
    null;

  const heroSummary =
    document.getElementById('heroSummary') ||
    document.getElementById('hero-summary-text') ||
    null;

  const heroSideLabel =
    document.getElementById('heroSideLabel') ||
    document.getElementById('hero-side-label') ||
    null;

  const heroSecondary =
    document.getElementById('heroSecondary') ||
    document.getElementById('hero-mini-context') ||
    null;

  const heroBadge =
    document.getElementById('status-hero-badge') ||
    document.querySelector('.status-hero-badge') ||
    null;

  // ‚úÖ Se a UI n√£o tiver esses elementos, simplesmente n√£o faz nada (NUNCA quebra o painel)
  if (!heroModePill && !heroSummary && !heroSideLabel && !heroBadge && !heroMain && !heroSecondary) {
    return;
  }

  // --- Market Now / dire√ß√£o (com fallback seguro)
  const marketNow =
    (apCtx && apCtx.panel && (apCtx.panel.market_now || apCtx.panel.marketNow)) ||
    autopilot.marketNow ||
    null;

  const mn =
    (marketNow === 'buy' || marketNow === 'BUY') ? 'buy' :
    (marketNow === 'sell' || marketNow === 'SELL') ? 'sell' :
    'wait';

  const mnText = (mn === 'buy') ? 'BUY' : (mn === 'sell') ? 'SELL' : 'WAIT';

  // Texto principal/summary
  const summaryText = String(finalSummary || executionPlan || '‚Äî');

  // Side label (PT/EN)
  const sideLabel =
    (mn === 'buy') ? (lang === 'en' ? 'BUY' : 'COMPRA') :
    (mn === 'sell') ? (lang === 'en' ? 'SELL' : 'VENDA') :
    'WAIT';

  // ‚úÖ Aplica sem quebrar (tudo com guard)
  if (heroSummary) heroSummary.textContent = summaryText;
  if (heroSideLabel) heroSideLabel.textContent = sideLabel;

  if (heroModePill) {
    heroModePill.textContent = mnText;
    // classes esperadas no seu CSS atual
    heroModePill.classList.remove('go-full', 'wait', 'buy', 'sell');
    if (mn === 'wait') heroModePill.classList.add('wait');
    else heroModePill.classList.add('go-full');
  }

  if (heroBadge) {
    // se for wait -> badge WAIT, sen√£o GO FULL (como seu layout)
    heroBadge.textContent = (mn === 'wait') ? 'WAIT' : 'GO FULL';
  }

  // Se existir ‚Äúmain/secondary‚Äù no layout antigo, preenche tamb√©m
  if (heroMain) heroMain.textContent = mnText;
  if (heroSecondary) heroSecondary.textContent = summaryText;
}



  

function applyInstitutionalDecision(panel, executionPlan, riskLevel) {
  // se o HTML n√£o existe (ou n√£o √© essa p√°gina), sai
  if (!els.heroFavorBar || !els.heroContraBar) return;

  const baseText = executionPlan || '‚Äî';
  const t = (baseText || '').toLowerCase();

  let mode = 'wait';
  if (t.includes('compra') || t.includes('buy')) mode = 'buy';
  else if (t.includes('venda') || t.includes('sell')) mode = 'sell';

  // pega consensus real do JSON
  const c =
    (panel && (panel.ai_consensus || panel.consensus || panel.aiConsensus)) || {};

  const normPct = (v) => {
  if (v === null || v === undefined) return NaN;

  if (typeof v === 'string') {
    v = v.replace('%', '').trim().replace(',', '.');
  }

  const n = parseFloat(v);
  if (!Number.isFinite(n)) return NaN;

  // aceita 0‚Äì1 OU 0‚Äì100
  if (n >= 0 && n <= 1) return n * 100;
  return n;
};


  const buyRaw = c.buy ?? c.BUY ?? c.long ?? c.LONG ?? c.compra ?? c.call ?? c.bull ?? c.bullish ?? c.up;
const sellRaw = c.sell ?? c.SELL ?? c.short ?? c.SHORT ?? c.venda ?? c.put ?? c.bear ?? c.bearish ?? c.down;
const neuRaw  = c.neutral ?? c.NEUTRAL ?? c.flat ?? c.wait ?? c.hold ?? c.aguardar ?? c.sideways ?? c.range;

let buy = normPct(buyRaw);
let sell = normPct(sellRaw);
let neu = normPct(neuRaw);


  buy = Number.isFinite(buy) ? buy : 0;
  sell = Number.isFinite(sell) ? sell : 0;
  neu = Number.isFinite(neu) ? neu : 0;

    // transforma 3-way em 2 barras (buy vs sell) de forma ‚Äúinstitucional‚Äù
  const dirTotal = buy + sell;
  const total = buy + sell + neu;

  let favorPct = 0;
  let contraPct = 0;

  if (dirTotal > 0) {
    const favorRaw =
      mode === 'sell' ? sell :
      mode === 'buy'  ? buy  :
      Math.max(buy, sell); // wait -> mostra o lado mais forte (entre buy/sell)

    favorPct = Math.round((favorRaw / dirTotal) * 100);
    favorPct = Math.max(0, Math.min(100, favorPct));
    contraPct = 100 - favorPct;

  } else if (total > 0) {
    // ‚úÖ Se n√£o h√° BUY/SELL (s√≥ NEUTRAL), n√£o existe ‚Äúvantagem‚Äù direcional
    // ent√£o mostramos equil√≠brio (50/50) em vez de 100%
    favorPct = 50;
    contraPct = 50;
  }

  // labels + barras
  if (els.heroFavorLabel) els.heroFavorLabel.textContent = `A favor: ${favorPct}%`;
  if (els.heroContraLabel) els.heroContraLabel.textContent = `Contra: ${contraPct}%`;

  // ‚úÖ SAFE: nunca deixa isso quebrar o resto do painel (e o TradingView)
  if (els.heroFavorBar) els.heroFavorBar.style.width = `${favorPct}%`;
  if (els.heroContraBar) els.heroContraBar.style.width = `${contraPct}%`;


  // frases (realistas, mas derivadas de dado real)
  const favorPhrase =
    favorPct >= 70
      ? 'Continua√ß√£o muito prov√°vel. Fluxo bem alinhado com a dire√ß√£o atual. Operar a favor √© mais seguro que contra.'
      : favorPct >= 55
        ? 'Leve vantagem a favor. Fluxo parcialmente alinhado; reduza tamanho e exija confirma√ß√£o.'
        : 'Sem vantagem clara. A favor e contra est√£o equilibrados; prefira esperar ou operar menor.';

  const contraPhrase =
    contraPct >= 35
      ? 'Probabilidade moderada de rea√ß√£o contra ainda existe; evite alavancagem exagerada e respeite o stop.'
      : 'Contra-movimento menos prov√°vel, mas sempre poss√≠vel; disciplina de stop obrigat√≥ria.';

  if (els.heroFavorPhrase) els.heroFavorPhrase.textContent = favorPhrase;
  if (els.heroContraPhrase) els.heroContraPhrase.textContent = contraPhrase;

  // minis (RISCO / CONTEXTO / EXECU√á√ÉO)
  if (els.heroMiniRisk) els.heroMiniRisk.textContent = riskLevel || '‚Äî';

  const ctx =
    panel?.context_tag ||
    panel?.context_short ||
    panel?.trade_window ||
    panel?.session_window ||
    panel?.session ||
    panel?.window ||
    panel?.time_window ||
    panel?.trade_style ||
    panel?.style_today ||
    panel?.style_label_pt ||
    panel?.style_label_en ||
    '‚Äî';

  if (els.heroMiniContext) els.heroMiniContext.textContent = ctx;
  if (els.heroMiniExecution) els.heroMiniExecution.textContent = baseText;
}


// Atualiza os chips HH/HL/LH/LL a partir do JSON
function updateStructureUI(struct) {
  const map = [
    { key: 'hh', status: els.structureHHStatus, dot: els.structureHHDot },
    { key: 'hl', status: els.structureHLStatus, dot: els.structureHLDot },
    { key: 'lh', status: els.structureLHStatus, dot: els.structureLHDot },
    { key: 'll', status: els.structureLLStatus, dot: els.structureLLDot },
  ];

  map.forEach(({ key, status, dot }) => {
    if (!status || !dot) return;

    let rawVal =
      struct &&
      (struct[key] ??
        struct[key.toUpperCase()] ??
        struct['recent_' + key] ??
        struct['last_' + key]);

    let label = 'off';
    let active = false;

    if (typeof rawVal === 'string') {
      const v = rawVal.toLowerCase();
      if (
        v.includes('ativo') ||
        v.includes('on') ||
        v.includes('true') ||
        v.includes('active')
      ) {
        active = true;
      }
      if (v) label = rawVal;
    } else if (typeof rawVal === 'boolean') {
      active = rawVal;
      label = rawVal ? 'ativo' : 'off';
    }

    status.textContent = label;
    if (active) dot.classList.add('on');
    else dot.classList.remove('on');
  });
}

// Atualiza o desenho do ZigZag, se o JSON mandar pontos
function updateStructureZigzag(panel) {
  const poly = document.getElementById('structure-zigzag-poly');
  if (!poly || !panel) return;

  const pts =
    panel.structure_points ||
    panel.zigzag_points ||
    panel.market_structure_points;

  if (!Array.isArray(pts) || pts.length === 0) return;

  const n = pts.length;
  const step = n > 1 ? 100 / (n - 1) : 100;

  const svgPoints = pts.map((v, i) => {
    const yNorm = Math.max(0, Math.min(1, Number(v))); // 0‚Äì1
    const x = (step * i).toFixed(2);
    const y = (30 - yNorm * 20).toFixed(2); // faixa 10‚Äì30 no SVG
    return `${x},${y}`;
  });

  poly.setAttribute('points', svgPoints.join(' '));
}

// ====== PULLBACK BRAIN ‚Äì FUN√á√ÉO GLOBAL ======
function updatePullbackBrain(data) {
  lastPullbackBrain = data || null;

  if (!els.pullbackStatus) return;

  // helpers para classe do term√¥metro
  function setMeter(score, tone) {
    const fill = els.pullbackMeterFill;
    const label = els.pullbackMeterLabel;
    if (!fill || !label) return;

    let v = score;

if (typeof v === 'string') {
  v = v.replace('%', '').trim().replace(',', '.');
}
v = parseFloat(v);

if (!Number.isFinite(v)) v = 40; // fallback (s√≥ quando n√£o vem dado)
v = Math.max(0, Math.min(100, v));


    fill.style.width = v.toFixed(0) + '%';

    fill.classList.remove('neutral', 'danger');
    if (tone === 'red' || tone === 'danger') {
      fill.classList.add('danger');
    } else if (tone === 'yellow' || tone === 'neutral') {
      fill.classList.add('neutral');
    }

    label.textContent =
      (currentLang === 'en' ? 'Confidence ' : 'Confian√ßa ') +
      v.toFixed(0) +
      '%';
  }

  function setSideTag(side) {
    const tag = els.pullbackSideTag;
    if (!tag) return;

    const s = (side || '').toString().toLowerCase();
    tag.classList.remove('side-buy', 'side-sell', 'side-neutral');

    if (s === 'buy' || s === 'compra') {
      tag.classList.add('side-buy');
      tag.textContent = currentLang === 'en' ? 'BUY PULLBACK' : 'COMPRA';
    } else if (s === 'sell' || s === 'venda') {
      tag.classList.add('side-sell');
      tag.textContent = currentLang === 'en' ? 'SELL PULLBACK' : 'VENDA';
    } else {
      tag.classList.add('side-neutral');
      tag.textContent = currentLang === 'en' ? 'NEUTRAL' : 'NEUTRO';
    }
  }

  function setStageTag(stageTitle) {
    const tag = els.pullbackStageTag;
    if (!tag) return;

    const txt =
      stageTitle ||
      (currentLang === 'en' ? 'Waiting' : 'Aguardando');
    tag.textContent = txt;
  }

  // ===== CASO SEM DADOS (estado neutro) =====
  if (!data || Object.keys(data).length === 0) {
    els.pullbackStatus.textContent =
      currentLang === 'en' ? 'Waiting for pullback...' : 'Aguardando pullback...';

    if (els.pullbackDepth) els.pullbackDepth.textContent = '‚Äî';
    if (els.pullbackQuality) els.pullbackQuality.textContent = '‚Äî';

    if (els.pullbackHeadline) {
      els.pullbackHeadline.textContent =
        currentLang === 'en'
          ? 'No clear pullback yet.'
          : 'Ainda n√£o h√° um pullback claro.';
    }

    if (els.pullbackText) {
      els.pullbackText.textContent =
        currentLang === 'en'
          ? 'The market has not offered a clean pullback in the main direction yet. Let price breathe and wait for structure.'
          : 'O mercado ainda n√£o ofereceu um pullback limpo na dire√ß√£o principal. Deixe o pre√ßo respirar e espere estrutura.';
    }

    if (els.pullbackHighlightBox) {
      els.pullbackHighlightBox.style.background = 'rgba(15,23,42,0.7)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(148,163,184,0.4)';
    }

    setSideTag(null);
    setStageTag(null);
    setMeter(40, 'neutral');
    return;
  }

  // ===== campos num√©ricos / status =====
  const depthAtr = data.depth_atr ?? data.atr_depth ?? null;
  const quality = data.quality ?? data.grade ?? null;
  const tone = (data.tone || '').toLowerCase();
  const side = data.side || data.direction || null;
  const score = data.score ?? data.confidence ?? 40;

  // t√≠tulo principal (usa state_title_pt/en se tiver)
  const statusTitle =
    (currentLang === 'en'
      ? (data.state_title_en || data.status_en || data.state_title || data.status)
      : (data.state_title_pt || data.status_pt || data.state_title || data.status)) ||
    (currentLang === 'en'
      ? 'Pullback detected'
      : 'Pullback detectado');

  els.pullbackStatus.textContent = statusTitle;

  if (els.pullbackDepth) {
    els.pullbackDepth.textContent =
      depthAtr != null ? depthAtr.toFixed(2) + ' ATR' : '‚Äî';
  }

  if (els.pullbackQuality) {
    els.pullbackQuality.textContent = quality || '‚Äî';
  }

  setSideTag(side);

  // est√°gio (1..7 ‚Äì aquelas frases que fizemos: tend√™ncia, pullback fraco, revers√£o, etc.)
  const stageTitle =
    (currentLang === 'en'
      ? (data.stage_title_en || data.stage_title)
      : (data.stage_title_pt || data.stage_title)) || null;
  setStageTag(stageTitle);

  // ===== textos em PT / EN vindos do backend =====
  const headline =
    (currentLang === 'en'
      ? (data.headline_en || data.headline)
      : (data.headline_pt || data.headline)) ||
    (currentLang === 'en'
      ? 'Healthy pullback inside the main trend.'
      : 'Pullback saud√°vel dentro da tend√™ncia principal.');

  const body =
    (currentLang === 'en'
      ? (data.text_en || data.text)
      : (data.text_pt || data.text)) ||
    (currentLang === 'en'
      ? 'AARON 9 sees this pullback as aligned with the main direction. Focus on trades with the trend and avoid fighting the move.'
      : 'O AARON 9 v√™ este pullback como alinhado com a dire√ß√£o principal. Foque em opera√ß√µes a favor e evite brigar com o movimento.');

  if (els.pullbackHeadline) els.pullbackHeadline.textContent = headline;
  if (els.pullbackText) els.pullbackText.textContent = body;

  // ===== cor do bloco (verde / amarelo / vermelho) =====
  if (els.pullbackHighlightBox) {
    if (tone === 'red' || tone === 'danger') {
      els.pullbackHighlightBox.style.background = 'rgba(248,113,113,0.06)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(248,113,113,0.6)';
    } else if (tone === 'yellow' || tone === 'neutral') {
      els.pullbackHighlightBox.style.background = 'rgba(234,179,8,0.06)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(234,179,8,0.6)';
    } else {
      // default = saud√°vel / ok
      els.pullbackHighlightBox.style.background = 'rgba(34,197,94,0.08)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(34,197,94,0.4)';
    }
  }

  // term√¥metro de confian√ßa / ‚Äúrisco de revers√£o‚Äù
  setMeter(score, tone);
}

  


// ====== SIZING BRAIN ‚Äì frases baseadas em Capital EM USO + Alavancagem ======
function updateSizingPhrase() {
  const accEl = els.sizingAccountRealInput;
  const useEl = els.sizingUseInput;
  const levEl = els.sizingLeverageInput;
  const riskEl = els.sizingRiskInput;
  const stopEl = els.sizingStopInput;
  const fixedEl = els.sizingFixedQtyInput;
  const mainEl = els.sizingPhraseMain;
  const detailEl = els.sizingPhraseDetail;

  if (!accEl || !useEl || !levEl || !riskEl || !stopEl || !mainEl || !detailEl) {
    return;
  }

  function numFromInput(el) {
    if (!el) return 0;
    const raw = (el.value || '').toString().replace(',', '.');
    const n = Number(raw);
    return Number.isFinite(n) ? n : 0;
  }

  const capitalReal = numFromInput(accEl);
  const capitalUso  = numFromInput(useEl);
  const leverage    = numFromInput(levEl);
  const riskPct     = numFromInput(riskEl);
  const stopUsd     = numFromInput(stopEl);
  const fixedQty    = Math.floor(numFromInput(fixedEl));

  // === L√ìGICA TIPO AARON PINE ===
  // 1) Se Capital EM USO > 0 ‚Üí base = EM USO
  // 2) Sen√£o, se Capital REAL > 0 e alavancagem > 0 ‚Üí base = REAL √ó alavancagem
  // 3) Sen√£o, se Capital REAL > 0 ‚Üí base = REAL
  let baseCapital = 0;

  if (capitalUso > 0) {
    baseCapital = capitalUso;
  } else if (capitalReal > 0 && leverage > 0) {
    baseCapital = capitalReal * leverage;
  } else if (capitalReal > 0) {
    baseCapital = capitalReal;
  }

  const baseMsg =
    currentLang === 'en'
      ? 'Type account capital, capital in use, risk % and stop distance to see the suggested position size.'
      : 'Digite capital real, capital em uso, risco % e stop para ver o tamanho sugerido da posi√ß√£o.';

  if (!baseCapital || !riskPct || !stopUsd) {
    mainEl.textContent = baseMsg;
    detailEl.textContent = '';
    return;
  }

  const riskMoney  = baseCapital * (riskPct / 100);
  const sharesRisk = Math.floor(riskMoney / stopUsd);

  if (!Number.isFinite(sharesRisk) || sharesRisk <= 0) {
    mainEl.textContent =
      currentLang === 'en'
        ? 'Check the values. The risk in dollars must be greater than the stop distance.'
        : 'Verifique os valores. O risco em d√≥lares precisa ser maior que a dist√¢ncia do stop.';
    detailEl.textContent = '';
    return;
  }

  function fmtUSD(v) {
    return v.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    });
  }

  // Mensagem principal
  if (currentLang === 'en') {
    mainEl.textContent =
      'Base capital: ' +
      fmtUSD(baseCapital) +
      '. With ' +
      riskPct.toFixed(2) +
      '% risk per trade, max risk is about ' +
      fmtUSD(riskMoney) +
      ' per trade.';
  } else {
    mainEl.textContent =
      'Base de c√°lculo: ' +
      fmtUSD(baseCapital) +
      '. Com risco de ' +
      riskPct.toFixed(2) +
      '% por trade, o risco m√°ximo por trade √© de aproximadamente ' +
      fmtUSD(riskMoney) +
      '.';
  }

  // Detalhe ‚Äì compara√ß√£o com Qtd fixa (se existir)
  if (fixedQty > 0) {
    const aboveSafe = fixedQty > sharesRisk;

    if (currentLang === 'en') {
      detailEl.textContent =
        'With a stop at ' +
        stopUsd.toFixed(2) +
        ' USD per share, the risk-based safe size is around ' +
        sharesRisk +
        ' shares. Your fixed size is ' +
        fixedQty +
        ' shares, which is ' +
        (aboveSafe ? 'ABOVE' : 'within') +
        ' the safe size.';
    } else {
      detailEl.textContent =
        'Com o stop a ' +
        stopUsd.toFixed(2) +
        ' USD por share, o tamanho seguro pelo risco fica em torno de ' +
        sharesRisk +
        ' shares. Sua quantidade fixa √© ' +
        fixedQty +
        ' shares, o que est√° ' +
        (aboveSafe ? 'ACIMA' : 'dentro') +
        ' do tamanho considerado seguro.';
    }
  } else {
    if (currentLang === 'en') {
      detailEl.textContent =
        'With a stop at ' +
        stopUsd.toFixed(2) +
        ' USD per share, the suggested position size is around ' +
        sharesRisk +
        ' shares. You can round down if you want to be more conservative.';
    } else {
      detailEl.textContent =
        'Com o stop a ' +
        stopUsd.toFixed(2) +
        ' USD por share, o tamanho de posi√ß√£o sugerido √© de cerca de ' +
        sharesRisk +
        ' shares. Voc√™ pode arredondar para baixo se quiser ser mais conservador.';
    }
  }
}

// Eventos para recalcular quando digitar
['input', 'change'].forEach(function (evt) {
  if (els.sizingAccountRealInput)
    els.sizingAccountRealInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingUseInput)
    els.sizingUseInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingLeverageInput)
    els.sizingLeverageInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingRiskInput)
    els.sizingRiskInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingStopInput)
    els.sizingStopInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingFixedQtyInput)
    els.sizingFixedQtyInput.addEventListener(evt, updateSizingPhrase);
});


// ====== SIZING BRAIN ‚Äì FUN√á√ÉO GLOBAL ======
function updateSizingBrain(data) {
  lastSizingBrain = data || null;

  if (!els.sizingTarget) return;

  function fmtPct(v) {
  if (v === null || v === undefined) return null;
  if (typeof v === 'string') v = v.replace('%', '').trim().replace(',', '.');

  const n = parseFloat(v);
  if (!Number.isFinite(n)) return null;
  return n.toFixed(1) + '%';
}


  // sempre que chegar dado novo (ou trocar idioma), recalcula frase
  updateSizingPhrase();

  function setProfileTag(profile) {
    const tag = els.sizingProfileTag;
    if (!tag) return;

    const p = (profile || '').toString().toLowerCase();
    tag.classList.remove(
      'profile-conservative',
      'profile-normal',
      'profile-aggressive'
    );

    if (p.includes('conserv')) {
      tag.classList.add('profile-conservative');
      tag.textContent =
        currentLang === 'en' ? 'Conservative' : 'Conservador';
    } else if (p.includes('agress') || p.includes('aggress')) {
      tag.classList.add('profile-aggressive');
      tag.textContent =
        currentLang === 'en' ? 'Aggressive' : 'Agressivo';
    } else {
      tag.classList.add('profile-normal');
      tag.textContent =
        currentLang === 'en' ? 'Normal' : 'Normal';
    }
  }

  function setStyleTag(style, labelPt, labelEn) {
    const tag = els.sizingStyleTag;
    if (!tag) return;

    const s = (style || '').toString().toLowerCase();
    tag.classList.remove(
      'style-daytrade',
      'style-swing',
      'style-momentum',
      'style-noedge'
    );

    let txt =
      currentLang === 'en'
        ? (labelEn || '')
        : (labelPt || '');

    if (!txt) {
      if (s.includes('day')) {
        txt =
          currentLang === 'en'
            ? 'Trend day trade'
            : 'Day trade tendencial';
      } else if (s.includes('swing')) {
        txt =
          currentLang === 'en'
            ? 'Swing trade'
            : 'Swing trade';
      } else if (s.includes('momentum') || s.includes('scalp')) {
        txt =
          currentLang === 'en'
            ? 'Momentum / scalp'
            : 'Momentum / scalp';
      } else {
        txt =
          currentLang === 'en'
            ? 'No clear edge'
            : 'Sem edge claro';
      }
    }

    if (s.includes('day')) {
      tag.classList.add('style-daytrade');
    } else if (s.includes('swing')) {
      tag.classList.add('style-swing');
    } else if (s.includes('momentum') || s.includes('scalp')) {
      tag.classList.add('style-momentum');
    } else {
      tag.classList.add('style-noedge');
    }

    tag.textContent = txt;
  }

  function setMeter(score) {
    const fill = els.sizingMeterFill;
    const label = els.sizingMeterLabel;
    if (!fill || !label) return;

    let v = score;
if (typeof v === 'string') v = v.replace('%', '').trim().replace(',', '.');
v = parseFloat(v);
if (!Number.isFinite(v)) v = 40;


    fill.style.width = v.toFixed(0) + '%';
    label.textContent =
      (currentLang === 'en' ? 'Risk usage ' : 'Uso de risco ') +
      v.toFixed(0) +
      '%';
  }

  // ===== estado neutro (sem dados do backend) =====
  if (!data || Object.keys(data).length === 0) {
    if (els.sizingTarget) els.sizingTarget.textContent = '0.8‚Äì1.2%';
    if (els.sizingMaxDD) els.sizingMaxDD.textContent = '0.8%';
    if (els.sizingRiskTrade) els.sizingRiskTrade.textContent = '0.25%';
    if (els.sizingTradesCount) els.sizingTradesCount.textContent = '3';

    setProfileTag('normal');
    setStyleTag('day_trade', null, null);
    setMeter(40);

    if (els.sizingComment) {
      els.sizingComment.textContent =
        currentLang === 'en'
          ? 'Today you can think in terms of a realistic 0.8‚Äì1.2% if you focus on 2‚Äì3 A+ trades and respect your max daily loss.'
          : 'Hoje voc√™ pode pensar em algo em torno de 0.8‚Äì1.2% se focar em 2‚Äì3 trades A+ e respeitar sua perda m√°xima do dia.';
    }

    return;
  }

  // ===== com dados do backend (sizing_brain) =====
  const profile      = data.profile;
  const style        = data.style_today;
  const styleLabelPt = data.style_label_pt;
  const styleLabelEn = data.style_label_en;

  const tMin    = data.target_min_pct   ?? data.recommended_target_min_pct;
  const tMax    = data.target_max_pct   ?? data.recommended_target_max_pct;
  const tSingle = data.target_pct       ?? data.recommended_target_pct;

  const maxDD        = data.max_dd_pct         ?? data.recommended_max_dd_pct;
  const riskPerTrade = data.risk_per_trade_pct ?? data.recommended_risk_per_trade_pct;
  const tradesCount  = data.trades_count       ?? data.recommended_trades_count;
  const score        = data.score              ?? data.risk_usage_score ?? 40;

  // alvo
  let targetText = '';
  const tMinFmt    = fmtPct(tMin);
  const tMaxFmt    = fmtPct(tMax);
  const tSingleFmt = fmtPct(tSingle);

  if (tMinFmt && tMaxFmt) targetText = `${tMinFmt}‚Äì${tMaxFmt}`;
  else if (tSingleFmt)    targetText = tSingleFmt;

  if (!targetText) {
    targetText = currentLang === 'en' ? 'Auto' : 'Autom√°tico';
  }

  if (els.sizingTarget) els.sizingTarget.textContent = targetText;
  if (els.sizingMaxDD && fmtPct(maxDD)) {
    els.sizingMaxDD.textContent = fmtPct(maxDD);
  }
  if (els.sizingRiskTrade && fmtPct(riskPerTrade)) {
    els.sizingRiskTrade.textContent = fmtPct(riskPerTrade);
  }
  if (els.sizingTradesCount && tradesCount != null) {
    els.sizingTradesCount.textContent = String(tradesCount);
  }

  setProfileTag(profile);
  setStyleTag(style, styleLabelPt, styleLabelEn);
  setMeter(score);

  const comment =
    currentLang === 'en'
      ? (data.comment_en || data.comment || '')
      : (data.comment_pt || data.comment || '');

  if (els.sizingComment) {
    if (comment) {
      els.sizingComment.textContent = comment;
    } else {
      els.sizingComment.textContent =
        currentLang === 'en'
          ? 'Sizing Brain suggests focusing on A+ setups only, with a realistic target for the day and a strict daily loss limit.'
          : 'O Sizing Brain sugere focar apenas em setups A+, com alvo realista para o dia e limite de perda di√°ria bem definido.';
    }
  }
}

function uniq(list) {
  return Array.from(new Set(list.filter(Boolean)));
}

function buildPatternFileCandidates(file) {
  const f = String(file || '').trim();
  if (!f) return [];

  const cand = [f];

  const hasExt = /\.[a-z0-9]{2,5}$/i.test(f);
  if (!hasExt) {
    // tenta extens√µes comuns
    cand.push(`${f}.jpg`, `${f}.png`, `${f}.jpeg`, `${f}.webp`);
  } else {
    // se veio jpg, tenta png equivalente (e vice-versa)
    if (f.toLowerCase().endsWith('.jpg')) cand.push(f.replace(/\.jpg$/i, '.png'));
    if (f.toLowerCase().endsWith('.png')) cand.push(f.replace(/\.png$/i, '.jpg'));

    // casos ‚ÄúF(1).jpg‚Äù vs ‚ÄúF (1).jpg‚Äù
    if (/^F\(\d+\)\./i.test(f)) cand.push(f.replace(/^F\(/i, 'F ('));
    if (/^F \(\d+\)\./i.test(f)) cand.push(f.replace(/^F \(/i, 'F('));

    // Tentativas gen√©ricas: com e sem espa√ßo antes do "("
    if (f.includes('(')) cand.push(f.replace('(', ' ('));
    if (f.includes(' (')) cand.push(f.replace(' (', '('));
  }

  return uniq(cand);
}


function setRefImageWithFallback(file) {
  if (!els.refPatternImg) return;

  const candidates = buildPatternFileCandidates(file);
  if (!candidates.length) return;

  let idx = 0;

  const tryLoad = () => {
    const base = encodeURI(`assets/patterns/${candidates[idx]}`);
    const bust = `${base}${base.includes('?') ? '&' : '?'}t=${Date.now()}`;

    els.refPatternImg.src = bust;
    if (els.refPatternLink) els.refPatternLink.href = base;
  };

  els.refPatternImg.onerror = () => {
    idx += 1;
    if (idx < candidates.length) tryLoad();
  };

  tryLoad();
}


function updatePatternReference(panel, patterns) {
  if (!els.refPatternImg || !els.refPatternLabel) return;

  const trade = panel.trade_card || panel.tradeCard || {};
  const ref = panel.pattern_reference || panel.pattern_ref || {};
  const day = (patterns && patterns.day) ? patterns.day : {};

  const pid = trade.pattern_id || ref.id || '';

  const namePt = ref.name_pt || ref.name || (pid ? `Padr√£o ${pid}` : '') || panel.pattern_day || day.name || '‚Äî';
  const nameEn = ref.name_en || ref.name || (pid ? `Pattern ${pid}` : '') || panel.pattern_day || day.name || '‚Äî';

  const setupPt = ref.setup_pt || ref.setup || day.desc || '‚Äî';
  const setupEn = ref.setup_en || ref.setup || day.desc || '‚Äî';

  const notesPt = ref.notes_pt || ref.notes || '‚Äî';
  const notesEn = ref.notes_en || ref.notes || '‚Äî';

  // imagem: prioriza o que veio do n8n; sen√£o monta pelo pattern_id
  let img =
    ref.image_url ||
    ref.image ||
    ref.img ||
    ref.file ||
    ref.filename ||
    panel.pattern_image ||
    panel.pattern_img ||
    trade.pattern_image ||
    (pid ? pid : '') ||
    '';

  if (!img) img = 'F(1).jpg';

  // textos
  if (els.refPatternLabel) els.refPatternLabel.textContent = (currentLang === 'en') ? nameEn : namePt;
  if (els.refPatternSetup) els.refPatternSetup.textContent = (currentLang === 'en') ? setupEn : setupPt;
  if (els.refPatternNotes) els.refPatternNotes.textContent = (currentLang === 'en') ? notesEn : notesPt;
  if (els.refPatternMini) els.refPatternMini.textContent = (currentLang === 'en') ? nameEn : namePt;

  const isUrl = /^https?:\/\//i.test(img);

  if (isUrl) {
    const finalSrc = `${img}${img.includes('?') ? '&' : '?'}t=${Date.now()}`;
    els.refPatternImg.src = finalSrc;
    if (els.refPatternLink) els.refPatternLink.href = img;
  } else {
    setRefImageWithFallback(img);
  }

  // Abrir/Fechar
  if (els.refDetails && els.refSummaryRight) {
    els.refSummaryRight.textContent = els.refDetails.open
      ? (currentLang === 'en' ? 'Close' : 'Fechar')
      : (currentLang === 'en' ? 'Open' : 'Abrir');
  }
}

// ===============================
// ADAPTER: panel_json -> trade card model (Citadel)
// (n√£o mexe no dropdown, n√£o mexe no autopilot)
// ===============================
function adaptPanelToTradeCard(panel, raw, fallbackSymbol){
  if (!panel || typeof panel !== "object") return null;

  const statusGeral = panel.status_geral || {};
  const ai = panel.ai_advisor || panel.aiAdvisor || {};
  const meta = panel.meta || {};

  const sym = String(panel.symbol || raw?.symbol || fallbackSymbol || "").toUpperCase().trim() || "‚Äî";
  const tf  = String(panel.timeframe || raw?.timeframe || panel.timeframe_label || "").trim() || "‚Äî";

  const parseBoolish = (v) => {
    if (typeof v === "boolean") return v;
    if (typeof v === "number") return v > 0;
    const s = String(v ?? "").trim().toLowerCase();
    if (!s) return false;
    if (/(false|n√£o|nao|no|0)/.test(s)) return false;
    if (/(true|sim|yes|1|v√°lido|valido|valid)/.test(s)) return true;
    return false;
  };

  const setupOk = parseBoolish(statusGeral.setup_valido ?? statusGeral.setupValido ?? statusGeral.setup);

  const actionRaw = String(ai.acao_recomendada || ai.action || ai.recommendation || "").toLowerCase();
  const dirInfo =
    (actionRaw.includes("buy") || actionRaw.includes("compra")) ? { pt:"COMPRA", en:"BUY",  cls:"status-buy",  side:"buy" } :
    (actionRaw.includes("sell")|| actionRaw.includes("venda"))  ? { pt:"VENDA",  en:"SELL", cls:"status-sell", side:"sell"} :
    (actionRaw.includes("close")|| actionRaw.includes("fechar"))? { pt:"FECHAR", en:"CLOSE",cls:"status-wait", side:"close"} :
    (actionRaw.includes("wait")|| actionRaw.includes("aguard")) ? { pt:"AGUARDAR",en:"WAIT", cls:"status-wait", side:"wait"} :
                                                                 { pt:"NEUTRO", en:"NEUTRAL",cls:"status-wait", side:"neutral" };

  const updatedAt =
    panel.updated_at || panel.updated || meta.panel_ts || meta.timestamp || panel.timestamp || raw?.time || "‚Äî";
  const session = panel.session || raw?.session || "‚Äî";
  const flow =
    panel.flow_label || panel.flow || statusGeral.tendencia || "‚Äî";

  const status_text_pt = setupOk ? `‚úÖ Setup v√°lido | ${dirInfo.pt}` : `‚è≥ Aguardando | ${dirInfo.pt}`;
  const status_text_en = setupOk ? `‚úÖ Valid setup | ${dirInfo.en}` : `‚è≥ Waiting | ${dirInfo.en}`;

  const pulse_line_pt = `${session} ‚Ä¢ ${flow} ‚Ä¢ atualizado: ${updatedAt}`;
  const pulse_line_en = `${session} ‚Ä¢ ${flow} ‚Ä¢ updated: ${updatedAt}`;

  const mode_pt =
    String(ai.modo_pt || ai.modo || ai.motivo || "").trim() || (setupOk ? "Setup identificado" : "Aguardando confirma√ß√£o");
  const mode_en =
    String(ai.modo_en || ai.mode || ai.motivo_en || ai.motivo || "").trim() || (setupOk ? "Setup identified" : "Waiting confirmation");

  const entry_text = ai.gatilho_entrada || ai.entry || ai.entrada || "‚Äî";

  const firstNum = (x) => {
    if (x == null) return null;
    if (typeof x === "number" && isFinite(x)) return x;
    const m = String(x).match(/-?\d+(?:\.\d+)?/);
    return m ? Number(m[0]) : null;
  };

  const stopRaw = (ai.stop_loss_plano ?? ai.stop_loss ?? ai.stop);
  const stopNum = firstNum(stopRaw);
  const stop = (stopNum != null) ? stopNum.toFixed(2) : (stopRaw || "‚Äî");

  const tpPlan = (ai.take_profit_plano ?? ai.take_profit ?? ai.tp);
  let tp1 = "‚Äî", tp2 = "‚Äî";
  if (tpPlan != null) {
    const s = String(tpPlan);
    const m1 = s.match(/TP1\s*[:=]?\s*(-?\d+(?:\.\d+)?)/i);
    const m2 = s.match(/TP2\s*[:=]?\s*(-?\d+(?:\.\d+)?)/i);
    if (m1) tp1 = Number(m1[1]).toFixed(2);
    if (m2) tp2 = Number(m2[1]).toFixed(2);

    if (!m1 && !m2) {
      const nums = s.match(/-?\d+(?:\.\d+)?/g);
      if (nums && nums.length) tp1 = Number(nums[0]).toFixed(2);
      if (nums && nums.length > 1) tp2 = Number(nums[1]).toFixed(2);
      if (!nums || !nums.length) tp1 = s; // mant√©m texto se n√£o tiver n√∫mero
    }
  }

  const size_text = ai.size_text || "‚Äî";
  const risk_text = ai.risk_text || "‚Äî";

  const comment_pt = [
    ai.motivo ? `Motivo: ${ai.motivo}` : null,
    ai.gatilho_entrada ? `Entrada: ${ai.gatilho_entrada}` : null,
    ai.stop_loss_plano ? `Stop: ${ai.stop_loss_plano}` : null,
    ai.take_profit_plano ? `TP: ${ai.take_profit_plano}` : null,
    ai.manejo_posicao ? `Manejo: ${ai.manejo_posicao}` : null,
  ].filter(Boolean).join("\n") || "‚Äî";

  const comment_en = [
    ai.motivo_en ? `Reason: ${ai.motivo_en}` : (ai.motivo ? `Reason: ${ai.motivo}` : null),
    ai.gatilho_entrada_en ? `Entry: ${ai.gatilho_entrada_en}` : (ai.gatilho_entrada ? `Entry: ${ai.gatilho_entrada}` : null),
    ai.stop_loss_plano_en ? `Stop: ${ai.stop_loss_plano_en}` : (ai.stop_loss_plano ? `Stop: ${ai.stop_loss_plano}` : null),
    ai.take_profit_plano_en ? `TP: ${ai.take_profit_plano_en}` : (ai.take_profit_plano ? `TP: ${ai.take_profit_plano}` : null),
    ai.manejo_posicao_en ? `Management: ${ai.manejo_posicao_en}` : (ai.manejo_posicao ? `Management: ${ai.manejo_posicao}` : null),
  ].filter(Boolean).join("\n") || "‚Äî";

  return {
    symbol: sym,
    timeframe: tf,

    status_text_pt,
    status_text_en,

    pulse_line_pt,
    pulse_line_en,

    mode_pt,
    mode_en,

    against_pt: "‚Äî",
    against_en: "‚Äî",

    direction_pt: dirInfo.pt,
    direction_en: dirInfo.en,

    // garante cor do card
    side: dirInfo.side,
    direction: dirInfo.side,

    entry_text,
    stop,
    tp1,
    tp2,

    size_text,
    risk_text,

    thermo_pt: setupOk ? "Agressivo moderado" : "Neutro",
    thermo_en: setupOk ? "Moderately aggressive" : "Neutral",

    comment_pt,
    comment_en,

    badge: setupOk ? "WAIT" : "NO TRADE",
    status_class: dirInfo.cls,
    trade_state: String(ai.trade_state || "").toUpperCase() || undefined,
  };
}


// ====== LOAD PANEL (agora usando data.panel + data.raw) ======
async function loadPanel(showSpinner) {
  if (!PANEL_URL) return;
  try {
    if (els.errorBanner) els.errorBanner.style.display = 'none';
    if (els.btnRefresh && showSpinner) els.btnRefresh.disabled = true;

        const sym = (localStorage.getItem('aaron_selected_symbol') || '').trim() || 'NVDA';
    const tf  = (typeof getSelectedTimeframe === "function") ? getSelectedTimeframe() : "1m";
    const url = `${PANEL_URL}${PANEL_URL.includes('?') ? '&' : '?'}symbol=${encodeURIComponent(sym)}&timeframe=${encodeURIComponent(tf)}&t=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });


    if (!res.ok) throw new Error('HTTP ' + res.status);

const data = await res.json();

// n8n pode devolver: {panel, raw, ui, digest}  OU  [ { json: {...} } ]  OU  [ {...} ]
const root = Array.isArray(data) ? (data[0] || {}) : (data || {});
const payload =
  (root && typeof root === 'object' && root.json && typeof root.json === 'object')
    ? root.json
    : root;

// salva debug
window.__AARON_LAST_PAYLOAD__ = payload;

// ‚úÖ 1) Preenche o bloco ‚ÄúRESPONDER OUTPUT‚Äù (KPI + colunas panel/ui/digest)
if (typeof renderTradeResponderOutput === "function") {
  renderTradeResponderOutput(payload);
}

// ‚úÖ 2) Injeta dentro do Trade Card (campos ‚Äúna sua cara‚Äù)
if (typeof applyResponderIntoTradeCard === "function") {
  applyResponderIntoTradeCard(payload);
}
if (typeof updatePremonitionPanel === "function") {
  updatePremonitionPanel(payload);
}
if (typeof updateRespiroReversaoPanel === "function") {
  updateRespiroReversaoPanel(payload);
}

// ‚úÖ 3) Mini-resumo dentro do Trade Card (se o anchor existir)
if (typeof renderResponderInline === "function") {
  renderResponderInline(payload);
}

window.dispatchEvent(new Event("aaron:panelUpdated"));

// segue o fluxo normal do seu loadPanel

const panel = payload.panel || payload;
const raw = payload.raw || payload.raw_eye || {};

// alimenta Autopilot 2.0 com o pre√ßo atual (sem inventar)
const pxNow =
  panel.price_now ||
  panel.last_price ||
  panel.reference_price ||
  (raw && raw.candle && raw.candle.close);

if (pxNow != null && isFinite(Number(pxNow))) {
  apMarketPrice = Number(pxNow);
}
apRenderSizing();

// ‚úÖ SYNC do dropdown PRE√áO (Matcher Picker) + fonte de quote
try {
  const pxNum = (pxNow != null && isFinite(Number(pxNow))) ? Number(pxNow) : null;

  // alimenta o getQuote() do dropdown
  window.__AARON_LAST_PANEL_JSON__ = {
    symbol: panel?.symbol || raw?.symbol || sym,
    price: pxNum,
    last_price: pxNum,
  };

  // atualiza o campo "PRE√áO" do dropdown
  const mpEl = document.getElementById("mp-price");
  if (mpEl) mpEl.value = (pxNum != null) ? pxNum.toFixed(2) : "‚Äî";
} catch (e) {}



    updateGarimpoTodayCard(panel?.garimpo_today || null);


    // Preenche ATR + pre√ßo de entrada
    prefillAtrFromPanel(panel, raw);

    const statusGeral = panel.status_geral || {};
    const aiAdvisor = panel.ai_advisor || {};
    const patterns = panel.patterns || {};
    const patternDay = patterns.day || {};
    const patternShort = patterns.short || {};
    const meta = panel.meta || {};

    // "c√©rebro" de pullback vindo do n8n
    const pullbackBrain =
      panel.pullback_brain ||
      panel.pullbackBrain ||
      panel.pullback ||
      {};
    updatePullbackBrain(pullbackBrain);

        const sizingBrain =
      panel.sizing_brain ||
      panel.sizingBrain ||
      panel.capital_brain ||
      {};
    updateSizingBrain(sizingBrain);

            // Cart√£o de trade (Citadel / cart√£o atual)
const tradeCard =
  panel.trade_card ||
  panel.current_trade ||
  panel.citadel_card ||
  panel.trade ||
  null;

// 1) Se o backend j√° trouxe um cart√£o pronto, usa ele
if (tradeCard && typeof tradeCard === "object" && Object.keys(tradeCard).length) {
  updateTradeCard(tradeCard);
} else {
  // 2) Sen√£o, ADAPTA do panel.ai_advisor + panel.status_geral (sem inventar)
  const adapted = adaptPanelToTradeCard(panel, raw, sym);
  if (adapted) {
    window.__AARON_TRADE_FROM_PANEL__ = adapted; // debug (opcional)
    updateTradeCard(adapted);
  }
}

// ‚úÖ GARANTIA: depois que o loadPanel atualizar o cart√£o, re-aplica o output do RESPONDER
try {
  if (typeof applyResponderIntoTradeCard === "function") {
    applyResponderIntoTradeCard(payload);
  }
  if (typeof renderResponderInline === "function") {
    renderResponderInline(payload);
  }
} catch (e) {}



    // Cabe√ßalho
    safeText(els.symbol, panel.symbol || raw.symbol || '‚Äî');
    safeText(
      els.timeframe,
      panel.timeframe ||
        raw.timeframe ||
        panel.timeframe_label ||
        '‚Äî'
    );
    safeText(
      els.session,
      panel.session || raw.session || panel.session_label || '‚Äî'
    );

    const micro = panel.microcontexto || {};
    const flowLabel = panel.flow_label || panel.flow || micro.direcao;
    safeText(els.flow, flowLabel || 'Neutro');

    const stateText =
      (panel.status && (panel.status.label || panel.status.state)) ||
      statusGeral.tendencia ||
      'ONLINE';
    safeText(els.state, stateText);

    const ts =
  meta.panel_ts ||
  meta.timestamp ||
  panel.timestamp ||
  panel.updated_at || panel.updatedAt || panel.updated_at_ms ||
  raw.time;

    if (els.lastUpdate) {
      if (!ts) {
        els.lastUpdate.textContent = 'sem timestamp';
      } else {
        try {
          const d =
            typeof ts === 'number'
              ? new Date(ts)
              : new Date(String(ts));
          els.lastUpdate.textContent = d.toLocaleString('pt-BR', {
            timeZone: 'America/Denver',
          });
        } catch (e) {
          els.lastUpdate.textContent = String(ts);
        }
      }
    }

    // Padr√µes / Dire√ß√µes
    const patternDayName =
      panel.pattern_day ||
      panel.pattern_of_day ||
      patternDay.name;
    const patternDayDesc =
      panel.pattern_day_detail ||
      panel.pattern_of_day_detail ||
      patternDay.desc;

    const patternNowName =
      panel.pattern_now ||
      panel.pattern_of_moment ||
      patternShort.name;
    const patternNowDesc =
      panel.pattern_now_detail ||
      panel.pattern_of_moment_detail ||
      patternShort.desc;

    safeText(els.patternDayLabel, patternDayName || '-');
    safeText(els.patternDayDetail, patternDayDesc || '‚Äî');
    safeText(els.patternNowLabel, patternNowName || '-');
    safeText(els.patternNowDetail, patternNowDesc || '‚Äî');

    setArrow(
      els.dirDayArrow,
      panel.direction_day ||
        panel.direction_of_day ||
        micro.direcao
    );
    setArrow(
      els.dirNowArrow,
      panel.direction_now ||
        panel.direction_of_moment ||
        micro.direcao
    );

    setPillTrend(
      els.trendDayPill,
      panel.direction_day || panel.direction_of_day || micro.direcao,
      panel.trend_day_label
    );
    setPillTrend(
      els.trendNowPill,
      panel.direction_now ||
        panel.direction_of_moment ||
        micro.direcao,
      panel.trend_now_label
    );

        // Atualiza aba de refer√™ncia (imagem + textos)
    updatePatternReference(panel, patterns);

    // Listener do abre/fecha (pra atualizar o texto "Abrir/Fechar")
    if (els.refDetails && !els.refDetails.__bound) {
      els.refDetails.__bound = true;
      els.refDetails.addEventListener('toggle', () => {
        if (els.refSummaryRight) {
          els.refSummaryRight.textContent = els.refDetails.open
            ? (currentLang === 'en' ? 'Close' : 'Fechar')
            : (currentLang === 'en' ? 'Open' : 'Abrir');
        }
      });
    }


    // =======================================================
    // TEXTO DIN√ÇMICO: DIRE√á√ÉO DO DIA / 1‚Äì3 CANDLES
    // =======================================================

    let dayProb   = panel.direction_day_prob;
    let dayDetail = panel.direction_day_detail;
    let nowProb   = panel.direction_now_prob;
    let nowDetail = panel.direction_now_detail;

    // fallback usando prob_favor / prob_contra
    if ((!dayProb && !dayDetail) || (!nowProb && !nowDetail)) {
      const forecast = panel.ai_forecast || {};
      const probFavor  = Number(panel.prob_favor  ?? forecast.prob_continuacao ?? NaN);
      const probContra = Number(panel.prob_contra ?? forecast.prob_contra      ?? NaN);

      if (!Number.isNaN(probFavor) && !Number.isNaN(probContra)) {
        // --- DIA ---
        if (!dayProb && !dayDetail) {
          if (probFavor >= probContra) {
            dayProb = probFavor;
            dayDetail =
              `Continua√ß√£o a favor: ${probFavor}% ¬∑ Contra: ${probContra}%.`;
          } else {
            dayProb = probContra;
            dayDetail =
              `Maior chance de contra-movimento: ${probContra}% ¬∑ Continua√ß√£o: ${probFavor}%.`;
          }
        }

        // --- MOMENTO (1‚Äì3 candles) ---
        if (!nowProb && !nowDetail) {
          if (probFavor >= probContra) {
            nowProb = probFavor;
            nowDetail =
              `Curto prazo favorece continua√ß√£o (${probFavor}% vs ${probContra}% de contra).`;
          } else {
            nowProb = probContra;
            nowDetail =
              `Curto prazo favorece contra-movimento (${probContra}% vs ${probFavor}% de continua√ß√£o).`;
          }
        }
      }
    }

    if (els.directionDayText && (dayProb || dayDetail)) {
      els.directionDayText.textContent =
        (dayProb ? dayProb + '% ¬∑ ' : '') + (dayDetail || '');
    }

    if (els.directionNowText && (nowProb || nowDetail)) {
      els.directionNowText.textContent =
        (nowProb ? nowProb + '% ¬∑ ' : '') + (nowDetail || '');
    }

    // Estrutura recente: HH / HL / LH / LL
    const structureRecent =
      panel.structure_recent ||
      panel.recent_structure ||
      panel.market_structure ||
      (panel.structure && panel.structure.recent) ||
      null;

    updateStructureUI(structureRecent);
    updateStructureZigzag(panel);

    // Textos principais
    const finalSummary =
      panel.summary ||
      panel.painel_terminal ||
      '‚Äî';

    const riskLevel =
  panel.risk_level ||
  aiAdvisor.risk_text ||
  aiAdvisor.risco ||
  panel.trade_card?.risk_text ||
  '‚Äî';

const riskComment =
  panel.risk_comment ||
  aiAdvisor.motivo ||
  aiAdvisor.motivo_pt ||
  panel.trade_card?.comment_pt ||
  panel.painel_terminal ||
  '‚Äî';


    const contextComment =
      panel.context_comment ||
      panel.painel_terminal ||
      '‚Äî';

    const executionPlan =
  panel.execution_plan ||
  aiAdvisor.acao_recomendada ||
  panel.trade_card?.direction_pt ||
  panel.trade_card?.direction_en ||
  '‚Äî';


    safeText(els.summary, finalSummary);
    setRiskPill(riskLevel);
    safeText(els.riskText, riskComment);
    safeText(els.contextText, contextComment);
    safeText(els.executionText, executionPlan);

    // AUTOPILOT CONTRACT: PANEL_UPDATE (MarketNow + P/L + R + EXIT_PENDING)
if (typeof apOnPanelUpdate === 'function') {
  apOnPanelUpdate(panel, { executionPlan, riskLevel, finalSummary });
}


    // MODO CEGO usa os mesmos textos (NUNCA pode quebrar o loadPanel)
try {
  applyHeroDecision(executionPlan, riskLevel, finalSummary);
} catch (e) {
  console.warn('[HERO] applyHeroDecision falhou, mas o painel continua:', e);
}

applyInstitutionalDecision(panel, executionPlan, riskLevel);



  } catch (err) {
    console.error('Erro ao carregar painel', err);
    if (els.errorBanner) {
      els.errorBanner.style.display = 'block';
      els.errorBanner.innerHTML =
        '<strong>Erro ao carregar painel.</strong> Verifique o webhook "aaron10_panel_json" no n8n e tente novamente.';
    }
  } finally {
    if (els.btnRefresh) els.btnRefresh.disabled = false;
  }
}

// ====== INICIALIZA√á√ÉO ======
// ========= AARON 10 ‚Äì ALPACA CHART + STUDIES =========
let a10Chart = null;
let a10CandleSeries = null;
let a10Ema21Series = null;
let a10VwapSeries = null;
let a10PriceLines = {};

// üî• fonte da verdade do gr√°fico (para live incremental)
let a10ChartCandles = [];              // candles que est√£o na tela
let a10LastPayloadKey = '';
let a10LastStudyUpdateAt = 0;
const A10_STUDY_THROTTLE_MS = 1500;

function a10ResetLiveChart(reason = '') {
  try {
    // zera base local
    a10ChartCandles = [];

    // limpa s√©ries (se j√° existirem)
    if (a10CandleSeries) a10CandleSeries.setData([]);
    if (a10Ema21Series) a10Ema21Series.setData([]);
    if (a10VwapSeries)  a10VwapSeries.setData([]);

    // remove price lines antigas (prev day / session hi/lo / orb etc)
    if (a10CandleSeries && Array.isArray(a10PriceLines) && a10PriceLines.length) {
      for (const pl of a10PriceLines) {
        try { a10CandleSeries.removePriceLine(pl); } catch (_) {}
      }
    }
    a10PriceLines = [];

    // debug globals (opcional, mas ajuda MUITO)
    window.__A10_LIVE_HAS_BARS__ = false;
    window.__A10_LIVE_LAST_45__ = null;
    window.__A10_LIVE_LAST_RAW__ = null;

    console.log('[A10] reset live chart', reason);
  } catch (e) {
    console.warn('[A10] reset live chart failed', e);
  }
}

function a10UnixSec(t) {
  if (typeof t === 'number') {
    if (t > 1e12) return Math.floor(t / 1000); // ms
    if (t > 1e10) return Math.floor(t / 1000); // ms (s√≥ garantia)
    return Math.floor(t); // sec
  }
  if (typeof t === 'string') {
    const ms = Date.parse(t);
    if (!Number.isNaN(ms)) return Math.floor(ms / 1000);
  }
  return null;
}

function a10ExtractCandles(payload) {
  const raw = payload?.raw || payload?.data || payload || {};
  const panel = payload?.panel || raw?.panel || raw || {};
  const symbol = String(panel.symbol || panel.ticker || payload.symbol || '')
    .toUpperCase()
    .trim();

  const candidates = [
    raw?.intraday?.candles,
    raw?.intraday?.bars,
    raw?.candles,
    raw?.bars,

    // alguns fluxos devolvem objeto por s√≠mbolo
    raw?.intraday?.bars_by_symbol,
    raw?.bars_by_symbol,

    panel?.intraday?.candles,
    panel?.intraday?.bars,
    panel?.candles,
    panel?.bars,
    panel?.recent_candles,

    payload?.candles,
    payload?.bars,
  ];

  function pickArray(x) {
    if (!x) return null;

    // j√° √© array
    if (Array.isArray(x)) return x;

    // Alpaca multi-symbol: { bars: { "NVDA":[...] } }
    if (typeof x === 'object') {
      if (x.bars && typeof x.bars === 'object') {
        if (symbol && Array.isArray(x.bars[symbol])) return x.bars[symbol];
      }

      // objeto direto: { "NVDA":[...] }
      if (symbol && Array.isArray(x[symbol])) return x[symbol];

      // fallback: se existir s√≥ 1 array dentro do objeto, usa ele
      for (const k of Object.keys(x)) {
        if (Array.isArray(x[k])) return x[k];
      }
    }

    return null;
  }

  const arr = candidates.map(pickArray).find((a) => Array.isArray(a)) || [];

  // ‚úÖ dedupe por time: se vier repetido, o ‚Äú√∫ltimo ganha‚Äù
  const map = new Map();

  for (const c of arr) {
    const time = a10UnixSec(c?.t ?? c?.time ?? c?.timestamp ?? c?.datetime);
    const open = Number(c?.o ?? c?.open);
    const high = Number(c?.h ?? c?.high);
    const low  = Number(c?.l ?? c?.low);
    const close= Number(c?.c ?? c?.close);
    const volume = Number(c?.v ?? c?.volume ?? 0);

    if (!time) continue;
    if (!Number.isFinite(open) || !Number.isFinite(high) || !Number.isFinite(low) || !Number.isFinite(close)) continue;

    // sanidade: garante high/low consistentes mesmo se vierem estranhos
    const hi = Math.max(high, open, close, low);
    const lo = Math.min(low, open, close, high);

    map.set(time, {
      time,
      open,
      high: hi,
      low: lo,
      close,
      volume: Number.isFinite(volume) ? volume : 0
    });
  }

  return Array.from(map.values()).sort((a, b) => a.time - b.time);
}


function a10ComputeEMA(candles, period) {
  const alpha = 2 / (period + 1);
  let ema = null;
  const out = [];
  for (const c of candles) {
    ema = (ema == null) ? c.close : (c.close - ema) * alpha + ema;
    out.push({ time: c.time, value: ema });
  }
  return out;
}

function a10ComputeVWAP(candles) {
  let cumPV = 0;
  let cumV = 0;
  const out = [];

  for (const c of candles) {
    const v = c.volume || 0;
    if (!v) continue;

    const tp = (c.high + c.low + c.close) / 3;
    cumPV += tp * v;
    cumV += v;

    if (cumV > 0) out.push({ time: c.time, value: cumPV / cumV });
  }

  return out;
}

function a10IsETAfterOpen(unixSec) {
  // 09:30 ET (aprox via Intl)
  const d = new Date(unixSec * 1000);
  const parts = new Intl.DateTimeFormat('en-US', {
    timeZone: 'America/New_York',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).formatToParts(d);

  const hh = Number(parts.find(p => p.type === 'hour')?.value || 0);
  const mm = Number(parts.find(p => p.type === 'minute')?.value || 0);
  return (hh > 9) || (hh === 9 && mm >= 30);
}

function a10ComputeSessionHL(candles) {
  const sessionCandles = candles.filter(c => a10IsETAfterOpen(c.time));
  if (!sessionCandles.length) return null;

  let hi = -Infinity, lo = Infinity;
  for (const c of sessionCandles) {
    if (c.high > hi) hi = c.high;
    if (c.low  < lo) lo = c.low;
  }
  if (!Number.isFinite(hi) || !Number.isFinite(lo)) return null;
  return { hi, lo };
}

function a10ComputeORB(candles, minutes = 5) {
  // ORB: primeiros X minutos ap√≥s 09:30 ET (assumindo 1m candles)
  const afterOpen = candles.filter(c => a10IsETAfterOpen(c.time));
  if (afterOpen.length < minutes) return null;

  const slice = afterOpen.slice(0, minutes);
  let hi = -Infinity, lo = Infinity;
  for (const c of slice) {
    if (c.high > hi) hi = c.high;
    if (c.low  < lo) lo = c.low;
  }
  if (!Number.isFinite(hi) || !Number.isFinite(lo)) return null;
  return { hi, lo };
}

function a10ToggleState() {
  return {
    sessionHL: !!document.getElementById('st-session-hl')?.checked,
    prevDay:   !!document.getElementById('st-prevday')?.checked,
    orb:       !!document.getElementById('st-orb')?.checked,
    vwap:      !!document.getElementById('st-vwap')?.checked,
    ema21:     !!document.getElementById('st-ema21')?.checked,
  };
}

function a10ClearPriceLine(key) {
  try {
    if (a10PriceLines[key] && a10CandleSeries) {
      a10CandleSeries.removePriceLine(a10PriceLines[key]);
    }
  } catch (e) {}
  a10PriceLines[key] = null;
}

function a10SetPriceLine(key, price, title, color, style) {
  a10ClearPriceLine(key);
  if (!a10CandleSeries || !Number.isFinite(price)) return;

  a10PriceLines[key] = a10CandleSeries.createPriceLine({
    price,
    title,
    color,
    lineWidth: 1,
    lineStyle: style, // 0 solid | 1 dotted | 2 dashed | 3 large dashed
    axisLabelVisible: true,
  });
}

function a10InitChart() {
  const el = document.getElementById('aaron10-chart');
  if (!el) return;
  if (a10Chart) return;
  if (!window.LightweightCharts) {
    console.warn('[A10] LightweightCharts n√£o carregou.');
    return;
  }

  // Utah (Mountain Time) - labels do eixo X + crosshair
  const A10_TZ = 'America/Denver';

  const fmtTime = new Intl.DateTimeFormat('en-US', {
    timeZone: A10_TZ,
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  });

  const fmtDate = new Intl.DateTimeFormat('en-US', {
    timeZone: A10_TZ,
    month: '2-digit',
    day: '2-digit',
  });

  function a10FmtUtah(time, wantDate) {
    // suporte caso venha BusinessDay (por seguran√ßa)
    if (time && typeof time === 'object' && 'year' in time) {
      const d = new Date(Date.UTC(time.year, (time.month || 1) - 1, time.day || 1));
      return fmtDate.format(d);
    }
    const sec = Number(time);
    if (!Number.isFinite(sec)) return '';
    const d = new Date(sec * 1000);
    return wantDate ? fmtDate.format(d) : fmtTime.format(d);
  }

  a10Chart = LightweightCharts.createChart(el, {
    layout: {
      attributionLogo: false, // <<< REMOVE o "TV" do canto
      background: { type: 'solid', color: '#020617' },
      textColor: '#e5e7eb',
    },
    grid: {
      vertLines: { color: 'rgba(148,163,184,0.08)' },
      horzLines: { color: 'rgba(148,163,184,0.08)' },
    },
    rightPriceScale: { borderColor: 'rgba(148,163,184,0.22)' },

    localization: {
      // label de tempo do crosshair (tooltip)
      timeFormatter: (time) => a10FmtUtah(time, false),
    },

    timeScale: {
      timeVisible: true,
      secondsVisible: false,
      // labels do eixo X
      tickMarkFormatter: (time, tickMarkType) => {
        const tmt = LightweightCharts.TickMarkType || {};
        const isDate =
          tickMarkType === tmt.DayOfMonth ||
          tickMarkType === tmt.Month ||
          tickMarkType === tmt.Year;
        return a10FmtUtah(time, isDate);
      },
    },

    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });

  a10CandleSeries = a10Chart.addCandlestickSeries({
    upColor: '#4ade80',
    downColor: '#f97373',
    borderUpColor: '#4ade80',
    borderDownColor: '#f97373',
    wickUpColor: '#4ade80',
    wickDownColor: '#f97373',
    wickDownColor: '#f97373',
  });

  a10Ema21Series = a10Chart.addLineSeries({ lineWidth: 2 });
  a10VwapSeries  = a10Chart.addLineSeries({ lineWidth: 2 });

  // Resize autom√°tico
  const ro = new ResizeObserver(() => {
    try {
      a10Chart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
    } catch (e) {}
  });
  ro.observe(el);
}


function a10UpdateChartFromPayload(payload) {
  try {
    if (!payload) return;
    a10InitChart();
    if (!a10Chart || !a10CandleSeries) return;

    const panel = payload.panel || payload.raw?.panel || {};
    const symbol =
      panel.symbol ||
      panel.ticker ||
      payload.symbol ||
      (a10LiveWanted && a10LiveWanted.symbol) ||
      '‚Äî';

    const tf =
      panel.timeframe ||
      panel.tf ||
      panel.interval ||
      payload.timeframe ||
      payload.tf ||
      (a10LiveWanted && a10LiveWanted.timeframe) ||
      '1m';

    const metaEl = document.getElementById('chart-meta');
    if (metaEl) metaEl.textContent = `${symbol} ¬∑ ${tf} ¬∑ Alpaca`;

    const incoming = a10ExtractCandles(payload);
    if (!incoming.length) return;

    const hasBase = Array.isArray(a10ChartCandles) && a10ChartCandles.length > 0;
    const isIncremental = hasBase && incoming.length <= 3;

    function mergeOne(c){
      if (!c || !c.time) return false;

      if (!Array.isArray(a10ChartCandles) || a10ChartCandles.length === 0) {
        a10ChartCandles = [c];
        a10CandleSeries.setData(a10ChartCandles);
        return true;
      }

      const last = a10ChartCandles[a10ChartCandles.length - 1];

      if (c.time === last.time) {
        a10ChartCandles[a10ChartCandles.length - 1] = c;
        a10CandleSeries.update(c);
        return true;
      }

      if (c.time > last.time) {
        a10ChartCandles.push(c);
        a10CandleSeries.update(c);
        return true;
      }

      // raro: out-of-order ‚Äî tenta achar e substitui; depois setData pra garantir
      for (let i = a10ChartCandles.length - 1; i >= 0; i--) {
        if (a10ChartCandles[i].time === c.time) {
          a10ChartCandles[i] = c;
          a10CandleSeries.setData(a10ChartCandles);
          return true;
        }
        if (a10ChartCandles[i].time < c.time) break;
      }

      return false;
    }

    if (!isIncremental) {
      // FULL SNAPSHOT
      const last = incoming[incoming.length - 1];
      const payloadKey = `${symbol}|${tf}|len:${incoming.length}|t:${last.time}|h:${last.high}|l:${last.low}|c:${last.close}|v:${last.volume}`;
      if (payloadKey === a10LastPayloadKey) return;
      a10LastPayloadKey = payloadKey;

      a10ChartCandles = incoming;
      a10CandleSeries.setData(a10ChartCandles);
    } else {
      // LIVE INCREMENTAL
      let changed = false;
      for (const c of incoming) changed = mergeOne(c) || changed;
      if (!changed) return;

      // throttle estudos (candles continuam live mesmo se pular aqui)
      const now = Date.now();
      if (now - a10LastStudyUpdateAt < A10_STUDY_THROTTLE_MS) return;
      a10LastStudyUpdateAt = now;
    }


    window.a10ChartCandles = a10ChartCandles;
    const candles = a10ChartCandles;
    if (!candles || !candles.length) return;

    const t = a10ToggleState();

    // EMA 21
    if (a10Ema21Series) {
      a10Ema21Series.applyOptions({ visible: t.ema21 });
      if (t.ema21) a10Ema21Series.setData(a10ComputeEMA(candles, 21));
    }

    // VWAP
    if (a10VwapSeries) {
      a10VwapSeries.applyOptions({ visible: t.vwap });
      if (t.vwap) a10VwapSeries.setData(a10ComputeVWAP(candles));
    }

    // Session High / Low
    if (t.sessionHL) {
      const hl = a10ComputeSessionHL(candles);
      if (hl) {
        a10SetPriceLine('sessionHi', hl.hi, 'Session High', 'rgba(74,222,128,0.85)', 2);
        a10SetPriceLine('sessionLo', hl.lo, 'Session Low',  'rgba(248,113,113,0.85)', 2);
      }
    } else {
      a10ClearPriceLine('sessionHi');
      a10ClearPriceLine('sessionLo');
    }

    // ORB 5m
    if (t.orb) {
      const orb = a10ComputeORB(candles, 5);
      if (orb) {
        a10SetPriceLine('orbHi', orb.hi, 'ORB High', 'rgba(34,211,238,0.85)', 1);
        a10SetPriceLine('orbLo', orb.lo, 'ORB Low',  'rgba(34,211,238,0.85)', 1);
      }
    } else {
      a10ClearPriceLine('orbHi');
      a10ClearPriceLine('orbLo');
    }

    // Prev Day levels (se vier no payload; se n√£o vier, s√≥ ignora)
    if (t.prevDay) {
      const pd = panel.prev_day || panel.prevDay || payload.prev_day || payload.prevDay || null;
      const pdHigh = Number(pd?.high ?? pd?.h ?? panel.prev_day_high ?? panel.pd_high);
      const pdLow  = Number(pd?.low  ?? pd?.l ?? panel.prev_day_low  ?? panel.pd_low);
      if (Number.isFinite(pdHigh)) a10SetPriceLine('pdHigh', pdHigh, 'PD High', 'rgba(59,130,246,0.85)', 3);
      if (Number.isFinite(pdLow))  a10SetPriceLine('pdLow',  pdLow,  'PD Low',  'rgba(59,130,246,0.85)', 3);
    } else {
      a10ClearPriceLine('pdHigh');
      a10ClearPriceLine('pdLow');
    }
  } catch (e) {
    console.warn('[A10] updateChart falhou (mas o painel continua):', e);
  }
}


function a10BindStudiesUI() {
  document.querySelectorAll('.pill-toggle input').forEach((el) => {
    el.addEventListener('change', () => {
      a10LastPayloadKey = ''; // for√ßa redraw
      a10UpdateChartFromPayload(window.__AARON_LAST_PAYLOAD__);
    });
  });
}

// ====== INICIALIZA√á√ÉO ======
function initAaron9() {
  // liga chart + estudos
  a10InitChart();
  a10BindStudiesUI();
// Premoni√ß√£o: se o painel estiver OFF (sem URL), ainda mostra o DEMO
if (!PANEL_URL) {
  try { updatePremonitionPanel(null); } catch (e) {}
  try { updateRespiroReversaoPanel(null); } catch (e) {}

}

  // sempre que o painel atualizar, atualiza o chart
      window.addEventListener('aaron:panelUpdated', () => {
    // S√≥ ‚Äúprotege‚Äù o chart contra snapshot do polling se estiver chegando BAR de verdade
    const lastBarAt = window.__A10_LIVE_LAST_BAR_AT__ || 0;
    const liveBarFresh = A10_USE_LIVE_CANDLES && lastBarAt && (Date.now() - lastBarAt) < 90000; // 90s


    if (liveBarFresh) return; // live de verdade -> n√£o sobrescreve com polling

    a10UpdateChartFromPayload(window.__AARON_LAST_PAYLOAD__); // sem BAR -> deixa polling atualizar
  });




    // bot√£o ATUALIZAR
  if (els.btnRefresh) {
    els.btnRefresh.addEventListener('click', function () {
      loadPanel(true);
    });
  }

  // evita leak de conex√µes WS ao fechar/recarregar a aba
  window.addEventListener('beforeunload', () => {
    try { a10LiveClose(); } catch(e) {}
  });

  loadPanel(false);
  setInterval(() => loadPanel(false), REFRESH_MS);
}





// AUTOPILOT init
autopilot = apLoad();
apSyncUI();

function apArmFromButton(side) {
  // for√ßa o toggle visual ficar ON tamb√©m
  if (els.apToggle && !els.apToggle.checked) {
    els.apToggle.checked = true;
  }

  apActivate(side); // seta enabled=true, salva e sincroniza UI

  // garante que o resto do painel atualiza imediatamente
  if (typeof loadPanel === 'function') loadPanel(false);
}


if (els.apToggle) {
  els.apToggle.addEventListener('change', () => {
    const turningOn = !!els.apToggle.checked;

    if (!turningOn) {
      apClose();          // ‚úÖ contrato: OFF = reset total
      return;
    }

    // ON (armado, sem posi√ß√£o)
    autopilot = apLoad();
    autopilot.enabled = true;
    autopilot.active = false;
    autopilot.side = null;
    autopilot.entry = null;
    autopilot.startedAt = null;

    // ‚úÖ garante ‚Äúsem resqu√≠cios‚Äù
    autopilot.state = AP_STATES.FLAT;
    autopilot.snapshot = null;
    autopilot.exitPending = false;
    autopilot.marketNow = autopilot.marketNow ?? 'wait';

    apSave(autopilot);
    apSyncUI();
    if (typeof loadPanel === 'function') loadPanel(false);
  });
}


// ===== AUTOPILOT: handlers robustos (BUY/SELL armam o toggle e ativam) =====
const arm = (side) => {
  try {
    // liga o toggle (se existir)
    if (els.apToggle && !els.apToggle.checked) els.apToggle.checked = true;

    // ativa o autopilot no lado escolhido
    if (typeof apActivate === 'function') apActivate(side);

    // se voc√™ usa a fun√ß√£o do contrato, pode chamar tamb√©m:
    if (typeof apArmFromButton === 'function') apArmFromButton(side);

    // reflete na UI
    if (typeof apSyncUI === 'function') apSyncUI();

    // atualiza painel (se existir)
    if (typeof loadPanel === 'function') loadPanel(false);
  } catch (e) {
    console.error('[AP] erro ao armar:', e);
  }
};

if (els.apBuy) {
  els.apBuy.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    arm('buy');
  });
}

if (els.apSell) {
  els.apSell.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    arm('sell');
  });
}

if (els.apClose) {
  els.apClose.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    try {
      if (typeof apClose === 'function') apClose();
      if (els.apToggle) els.apToggle.checked = false;
      if (typeof apSyncUI === 'function') apSyncUI();
      if (typeof loadPanel === 'function') loadPanel(false);
    } catch (err) {
      console.error('[AP] erro no close:', err);
    }
  });
}


// AUTOPILOT 2.0: quando muda capital, recalcula units e reflete no Citadel
if (els.apCapital) {
  els.apCapital.addEventListener('input', () => {
    apRenderSizing();
    apSyncUI();
    if (typeof loadPanel === 'function') loadPanel(false);
  });
 }

// ================ TOGGLE DE IDIOMA PT / EN ==================

const I18N = {
  pt: {
    // TOPO
    'top.live_feed': 'FEED AO VIVO',
    'top.symbol': 'S√≠mbolo',
    'top.timeframe': 'Timeframe',
    'top.session': 'Sess√£o',
    'top.last_update': '√öltima atualiza√ß√£o:',
    'top.refresh': 'ATUALIZAR',

        // GARIMPO DE HOJE
    'garimpo_badge': 'Garimpo de Hoje',
    'garimpo_best_label': 'Melhor ativo para hoje',
    'garimpo_metric_confidence': 'Confian√ßa do c√©rebro',
    'garimpo_metric_gap': 'Gap',
    'garimpo_metric_premarket': 'Pr√©-market vs m√©dia',
    'garimpo_metric_atr': 'ATR% (volatilidade)',
    'garimpo_comment':
      'Hoje este √© o ativo com melhor combina√ß√£o de fluxo, liquidez e volatilidade para o seu perfil.',
    'garimpo_view_page': 'Ver p√°gina do garimpo',


    // RISCO ¬∑ ATR
    'risk.title': 'Gerenciador de risco ¬∑ ATR',
    'risk.subtitle': 'Ajuste os par√¢metros do ATR e calcule risco / reward da opera√ß√£o.',
    'risk.toggle_open': 'Abrir',
    'risk.toggle_close': 'Fechar',

    // CARD TRADINGVIEW
    'card.tv_title': 'Painel de Pre√ßo em Tempo Real',
    'card.tv_sub': 'Alpaca PRO + Estrutura do Dia',


    // RESUMO INSTITUCIONAL
    'summary.title': 'Resumo institucional',
    'summary.subtitle': 'Leitura consolidada do AARON 9',
    'summary.risk_mgmt': 'Gest√£o de risco',

    // RADAR
    'radar.day_title': 'Dire√ß√£o geral do dia',
    'radar.now_title': 'Dire√ß√£o prevista ¬∑ 1‚Äì3 candles',

    // OUTROS
    'comment.title': 'Coment√°rio do Painel',
    'panel.risk_title': 'Risco',
    'panel.context_title': 'Contexto',
    'panel.execution_title': 'Execu√ß√£o',

    // PULLBACK
    'pullback.title': 'Pullback Brain ¬∑ Zona de respiro',
    'pullback.depth': 'Profundidade',
    'pullback.quality': 'Qualidade',

        // SIZING BRAIN
    'sizing.title': 'Sizing Brain ¬∑ Gest√£o de capital do dia',
    'sizing.target_label': 'Alvo razo√°vel hoje',
    'sizing.max_dd': 'M√°x. perda',
    'sizing.risk_trade': 'Risco / trade',
    'sizing.trades': 'Trades A+',
    'sizing.conservative': 'Conservador',
    'sizing.aggressive': 'Agressivo',

        // CART√ÉO DE TRADE CITADEL
    'trade_card.title': 'AARON ‚Äì Cart√£o de Trade Atual',
    'trade_card.status_label': 'Status:',
    'trade_card.stats_label': 'Estat√≠stica:',
    'trade_card.asset_label': 'Ativo:',
    'trade_card.timeframe_label': 'Timeframe:',
    'trade_card.mode_label': 'Modo:',
    'trade_card.against_label': 'Contra:',
    'trade_card.dir_label': 'Dire√ß√£o sugerida:',
    'trade_card.entry_label': 'Entrada:',
    'trade_card.stop_label': 'Stop:',
    'trade_card.tp_label': 'TP1:',
    'trade_card.size_label': 'Tamanho:',
    'trade_card.risk_label': 'Risco:',
    'trade_card.thermo_label': 'Term√¥metro:',
    'trade_card.comment_label': 'Coment√°rio do AARON:',


  },

  en: {
    // TOP
    'top.live_feed': 'LIVE FEED',
    'top.symbol': 'Symbol',
    'top.timeframe': 'Timeframe',
    'top.session': 'Session',
    'top.last_update': 'Last update:',
    'top.refresh': 'REFRESH',

        // GARIMPO TODAY
    'garimpo_badge': 'Garimpo Today',
    'garimpo_best_label': 'Best asset for today',
    'garimpo_metric_confidence': 'Brain confidence',
    'garimpo_metric_gap': 'Gap',
    'garimpo_metric_premarket': 'Pre-market vs average',
    'garimpo_metric_atr': 'ATR% (volatility)',
    'garimpo_comment':
      'Today this is the asset with the best combination of flow, liquidity and volatility for your profile.',
    'garimpo_view_page': 'View Garimpo page',


    // RISK ¬∑ ATR
    'risk.title': 'Risk manager ¬∑ ATR',
    'risk.subtitle': 'Adjust ATR parameters and calculate trade risk / reward.',
    'risk.toggle_open': 'Open',
    'risk.toggle_close': 'Close',

    // TRADINGVIEW CARD
    'card.tv_title': 'Real-Time Price Panel',
    'card.tv_sub': 'Alpaca PRO + Daily Structure',

    // SUMMARY
    'summary.title': 'Institutional summary',
    'summary.subtitle': 'Consolidated reading from AARON 9',
    'summary.risk_mgmt': 'Risk management',

    // RADAR
    'radar.day_title': 'Overall direction of the day',
    'radar.now_title': 'Expected direction ¬∑ 1‚Äì3 candles',

    // OTHERS
    'comment.title': 'Panel commentary',
    'panel.risk_title': 'Risk',
    'panel.context_title': 'Context',
    'panel.execution_title': 'Execution',

    // PULLBACK
    'pullback.title': 'Pullback Brain ¬∑ Pullback zone',
    'pullback.depth': 'Depth',
    'pullback.quality': 'Quality',

        // SIZING BRAIN
    'sizing.title': 'Sizing Brain ¬∑ Daily capital plan',
    'sizing.target_label': 'Reasonable target today',
    'sizing.max_dd': 'Max loss',
    'sizing.risk_trade': 'Risk / trade',
    'sizing.trades': 'A+ trades',
    'sizing.conservative': 'Conservative',
    'sizing.aggressive': 'Aggressive',

        // CITADEL TRADE CARD
    'trade_card.title': 'AARON ‚Äì Current Trade Card',
    'trade_card.status_label': 'Status:',
    'trade_card.stats_label': 'Statistics:',
    'trade_card.asset_label': 'Asset:',
    'trade_card.timeframe_label': 'Timeframe:',
    'trade_card.mode_label': 'Mode:',
    'trade_card.against_label': 'Against:',
    'trade_card.dir_label': 'Suggested direction:',
    'trade_card.entry_label': 'Entry:',
    'trade_card.stop_label': 'Stop:',
    'trade_card.tp_label': 'TP1:',
    'trade_card.size_label': 'Size:',
    'trade_card.risk_label': 'Risk:',
    'trade_card.thermo_label': 'Thermometer:',
    'trade_card.comment_label': 'AARON\'s comment:',


  },
};

// currentLang j√° foi definido no topo do <script> (ANTES de qualquer apSyncUI/loadPanel)
currentLang = window.currentLang || currentLang || 'pt';


function applyLang(lang) {
  const dict = I18N[lang] || I18N.pt;
  currentLang = lang;
  window.currentLang = currentLang;
  try { localStorage.setItem('AARON_LANG', currentLang); } catch(e) {}


  // troca TODO elemento com data-i18n
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    const txt = dict[key];
    if (txt) el.textContent = txt;
  });

  // pill de estado (AGUARDANDO / WAITING)
  const statePill = document.getElementById('state-pill');
  if (statePill) {
    statePill.textContent = lang === 'en' ? 'WAITING' : 'AGUARDANDO';
  }

  // bot√£o refresh
  const btnRefresh = document.getElementById('btn-refresh');
  if (btnRefresh) {
    btnRefresh.textContent =
      dict['top.refresh'] || (lang === 'en' ? 'REFRESH' : 'ATUALIZAR');
  }

  // texto de "Abrir / Fechar" do card ATR, se j√° estiver aberto
  const atrToggle = document.getElementById('atr-risk-toggle');
  const atrBody = document.getElementById('atr-risk-body');
  if (atrToggle && atrBody) {
    const isOpen = atrBody.style.display && atrBody.style.display !== 'none';
    if (isOpen) {
      atrToggle.textContent =
        dict['risk.toggle_close'] || (lang === 'en' ? 'Close' : 'Fechar');
    } else {
      atrToggle.textContent =
        dict['risk.toggle_open'] || (lang === 'en' ? 'Open' : 'Abrir');
    }
  }

  // re-renderiza o Pullback Brain no idioma atual
  if (typeof updatePullbackBrain === 'function') {
    updatePullbackBrain(lastPullbackBrain);
  }
  if (typeof updateSizingBrain === 'function') {
    updateSizingBrain(lastSizingBrain);
  }
  if (typeof updateSizingPhrase === 'function') {
    updateSizingPhrase();
  }

  // re-renderiza o Garimpo de Hoje no idioma atual (PT / EN)
  if (typeof updateGarimpoTodayCard === 'function' &&
      typeof garimpoTodayData !== 'undefined') {
    updateGarimpoTodayCard(garimpoTodayData);
  }
}


 // ====== SIZING BRAIN ‚Äì C√ÅLCULO LOCAL DO GERENCIADOR DE RISCO ======
function recalcSizingBrainLocal() {
  if (!sbEls.card) return;

  function num(el) {
    if (!el) return 0;
    const raw = (el.value || '').toString().replace(',', '.');
    const v = Number(raw);
    return Number.isFinite(v) ? v : 0;
  }

  const account = num(sbEls.accountBalance);    // Capital real da conta
  const lev     = num(sbEls.leverage);         // Alavancagem x
  const tradeCap= num(sbEls.tradeCapital);     // Capital em uso neste trade
  const riskPct = num(sbEls.riskPercentInput); // Risco m√°x. por trade (% conta)
  const entry   = num(sbEls.entryPrice);       // Pre√ßo de entrada
  const atr     = num(sbEls.atrValue);         // ATR atual ($)
  const multStop= num(sbEls.atrMultStop) || 1; // Mult ATR STOP
  const multTake= num(sbEls.atrMultTake) || (multStop * 2); // Mult ATR TAKE

  // lado: long / short
  let side = 'long';
  if (sbEls.sideRadios && sbEls.sideRadios.length) {
    sbEls.sideRadios.forEach(r => {
      if (r.checked) side = r.value;
    });
  }

  const statusEl = sbEls.status;
  function setStatus(msg) {
    if (statusEl) statusEl.textContent = msg;
  }

  // valida√ß√µes b√°sicas
  if (!account || !riskPct || !entry || !atr || !multStop) {
    setStatus('Preencha capital, risco, pre√ßo de entrada, ATR e multiplicadores para calcular.');
    return;
  }

  // dist√¢ncia do stop e do alvo em d√≥lares por share
  const stopDist = atr * multStop;
  const takeDist = atr * multTake;

  // base de capital para limitar o tamanho (EM USO se tiver, sen√£o conta √ó alavancagem, sen√£o s√≥ conta)
  let baseCapital = 0;
  if (tradeCap > 0) {
    baseCapital = tradeCap;
  } else if (account > 0 && lev > 0) {
    baseCapital = account * lev;
  } else {
    baseCapital = account;
  }

  // risco m√°ximo em dinheiro (por trade) baseado % da conta real
  const maxRiskMoney = account * (riskPct / 100);

  // tamanho de posi√ß√£o pelo risco e pelo capital
  const sharesByRisk    = maxRiskMoney / stopDist;
  const sharesByCapital = baseCapital && entry ? baseCapital / entry : sharesByRisk;
  let shares = Math.floor(Math.min(sharesByRisk, sharesByCapital));

  if (!Number.isFinite(shares) || shares <= 0) {
    setStatus('Verifique os valores: o risco em d√≥lares precisa ser maior que a dist√¢ncia do stop.');
    return;
  }

  // pre√ßos de stop e take
  const stopPrice = side === 'short'
    ? entry + stopDist
    : entry - stopDist;

  const takePrice = side === 'short'
    ? entry - takeDist
    : entry + takeDist;

  // risco real com a quantidade ajustada
  const realRiskMoney = shares * stopDist;
  const realRiskPct   = account ? (realRiskMoney / account) * 100 : 0;

  // ==== atualiza os textos do card ====
  if (sbEls.outStopDistance)
    sbEls.outStopDistance.textContent = `Dist√¢ncia do STOP: ${stopDist.toFixed(2)} USD`;

  if (sbEls.outStopPrice)
    sbEls.outStopPrice.textContent = `Stop Loss sugerido: ${stopPrice.toFixed(2)}`;

  if (sbEls.outTakePrice)
    sbEls.outTakePrice.textContent = `Take Profit sugerido: ${takePrice.toFixed(2)}`;

  if (sbEls.outPositionSize)
    sbEls.outPositionSize.textContent = `Qtd sugerida: ${shares.toFixed(0)}`;

  if (sbEls.outRiskDollar)
    sbEls.outRiskDollar.textContent = `Risco aprox.: $ ${realRiskMoney.toFixed(2)}`;

    if (sbEls.outRiskPercent)
    sbEls.outRiskPercent.textContent =
      `Risco % trade / conta: ${realRiskPct.toFixed(2)}%`;

  setStatus(
    `Ok: ${shares.toFixed(0)} shares, risco ‚âà ${realRiskPct.toFixed(2)}% (${realRiskMoney.toFixed(2)} USD).`
  );

  // NOVO ¬∑ Term√¥metro offline do gerenciador de risco
  const sbMeterFill  = document.getElementById('sb-meter-fill');
  const sbMeterLabel = document.getElementById('sb-meter-label');
  if (sbMeterFill && sbMeterLabel) {
    // ratio = quanto do risco planejado voc√™ est√° usando
    const ratio = riskPct > 0 ? realRiskPct / riskPct : 0; // 1 = exatamente o risco que voc√™ planejou
    let score   = ratio * 100;                             // transforma em "porcentagem de uso"
    score       = Math.max(0, Math.min(130, score));       // trava para n√£o explodir
    const width = Math.max(8, Math.min(100, score));       // largura da barra

    sbMeterFill.style.width = width.toFixed(0) + '%';

    sbMeterFill.classList.remove('safe', 'warn', 'danger');
    if (ratio <= 0.6) {
      sbMeterFill.classList.add('safe');    // bem conservador
    } else if (ratio <= 1.0) {
      sbMeterFill.classList.add('warn');    // perto do limite planejado
    } else {
      sbMeterFill.classList.add('danger');  // acima do risco planejado
    }

    sbMeterLabel.textContent =
      (currentLang === 'en'
        ? `Risk usage ${realRiskPct.toFixed(2)}% (plan ${riskPct.toFixed(2)}%)`
        : `Uso de risco ${realRiskPct.toFixed(2)}% (alvo ${riskPct.toFixed(2)}%)`);
  }

  // Alimenta o bloco de baixo (Aaron Pine) com a dist√¢ncia do stop em USD/share
  if (els.sizingStopInput) {
    els.sizingStopInput.value = stopDist.toFixed(2);
    if (typeof updateSizingPhrase === 'function') {
      updateSizingPhrase();
    }
  }
}
   
// conecta o bot√£o "Recalcular Sizing" ao c√°lculo local
if (sbEls.calcBtn) {
  sbEls.calcBtn.addEventListener('click', function (ev) {
    ev.preventDefault();
    recalcSizingBrainLocal();
  });
}


// liga o toggle dos bot√µes PT / EN
const langToggleEl = document.getElementById('lang-toggle');
if (langToggleEl) {
  langToggleEl.addEventListener('click', (ev) => {
    const btn = ev.target.closest('.lang-btn');
    if (!btn) return;

    const lang = btn.getAttribute('data-lang');
    if (!lang) return;

    langToggleEl.querySelectorAll('.lang-btn').forEach((b) =>
      b.classList.remove('active')
    );
    btn.classList.add('active');

    applyLang(lang);
  });
}

// idioma inicial (puxa do localStorage via currentLang)
applyLang(currentLang);


// garante que roda depois que o DOM existe
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initAaron9);
} else {
  initAaron9();
}

   // ================== GARIMPO DE HOJE - DADOS EXEMPLO ==================
let lastGarimpoToday = null;

function updateGarimpoTodayCard(data) {
  lastGarimpoToday = data || null;

  const tickerEl = document.getElementById('garimpo-ticker');
  const profileEl = document.getElementById('garimpo-profile');
  const gapEl = document.getElementById('garimpo-gap');
  const pmEl = document.getElementById('garimpo-premarket');
  const atrEl = document.getElementById('garimpo-atr');
  const confEl = document.getElementById('garimpo-confidence');

  if (!tickerEl) return;

  const d = data || {};
  const lang = (window.currentLang === 'en' ? 'en' : 'pt');

  const profile =
    (d.profile && typeof d.profile === 'object')
      ? (d.profile[lang] || d.profile.pt || '‚Äî')
      : (d.profile || '‚Äî');

  tickerEl.textContent = d.ticker || '‚Äî';
  if (profileEl) profileEl.textContent = profile;
  if (gapEl) gapEl.textContent = d.gapPct || '‚Äî';
  if (pmEl) pmEl.textContent = d.preMarketRatio || '‚Äî';
  if (atrEl) atrEl.textContent = d.atrPct || '‚Äî';
  if (confEl) confEl.textContent = d.confidence || '‚Äî';
}

// chamada inicial (vazio at√© chegar JSON do n8n)
updateGarimpoTodayCard(null);


// ================== GARIMPO DE HOJE - TEXTOS PT/EN =================
if (typeof I18N !== 'undefined' && I18N.pt && I18N.en) {
  Object.assign(I18N.pt, {
    garimpo_badge: 'Garimpo de Hoje',
    garimpo_best_label: 'Melhor ativo para hoje',
    garimpo_comment:
      'Hoje este √© o ativo com melhor combina√ß√£o de fluxo, liquidez e volatilidade para o seu perfil.',
    garimpo_metric_gap: 'Gap',
    garimpo_metric_premarket: 'Pr√©-market vs m√©dia',
    garimpo_metric_atr: 'ATR% (volatilidade)',
    garimpo_metric_confidence: 'Confian√ßa do c√©rebro',
    garimpo_btn_full: 'Ver p√°gina do garimpo',
  });

  Object.assign(I18N.en, {
    garimpo_badge: "Today's Mining Pick",
    garimpo_best_label: 'Best stock to trade today',
    garimpo_comment:
      "Today this is the asset with the best combination of flow, liquidity and volatility for your profile.",
    garimpo_metric_gap: 'Gap',
    garimpo_metric_premarket: 'Pre-market vs avg.',
    garimpo_metric_atr: 'ATR% (volatility)',
    garimpo_metric_confidence: "Brain's confidence",
    garimpo_btn_full: 'Open full mining page',
  });
}

    function openGarimpoPage() {
  // Se o arquivo da p√°gina com os 4 quadros se chamar garimpo.html
  window.location.href = 'garimpo.html';
}


// ================== FIM GARIMPO DE HOJE ==================
</script>
<script>
/* ===================== MATCHER PICKER (AUTO PILOT LOOK) ===================== */
(function matcherPicker_addOnly(){
  if (window.__AARON_MATCHER_PICKER_INSTALLED__) return;
  window.__AARON_MATCHER_PICKER_INSTALLED__ = true;

  const DEFAULT_SYMBOLS = ['NVDA','TSLA','AMD','AAPL','MSFT','AMZN','META','GOOGL','NFLX','SPY','QQQ','IWM','PLTR'];

  const SYMBOLS =
    (Array.isArray(window.AARON_SYMBOLS) && window.AARON_SYMBOLS.length)
      ? window.AARON_SYMBOLS
      : DEFAULT_SYMBOLS;

  function injectStyles(){
    const id = "aaron-matcher-picker-style";
    if (document.getElementById(id)) return;

    const style = document.createElement("style");
    style.id = id;
    style.textContent = `
      /* ====== MATCHER com o mesmo ‚ÄúDNA‚Äù do AUTOPILOT v2 ====== */
      #matcher-picker.autopilot-v2{
        padding: 14px;
        border: 1px solid rgba(148,163,184,0.18);
        background:
          radial-gradient(1200px 500px at 20% 0%, rgba(56,189,248,0.10), transparent 60%),
          radial-gradient(900px 420px at 85% 10%, rgba(34,197,94,0.08), transparent 55%),
          rgba(2,6,23,0.35);
      }

      #matcher-picker .ap2-top{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-bottom:10px;
      }

      #matcher-picker .ap2-sub{
        margin-top:2px;
        font-size:0.78rem;
        opacity:0.75;
      }

      #matcher-picker .ap2-controls{
        display:flex;
        align-items:center;
        gap:10px;
      }

      #matcher-picker .ap2-sizing{
        margin: 10px 0 12px 0;
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(148,163,184,0.16);
        background: rgba(0,0,0,0.18);
        box-shadow: inset 0 0 0 1px rgba(2,6,23,0.15);
      }

      #matcher-picker .ap2-input-row{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      @media (max-width: 520px){
        #matcher-picker .ap2-input-row{ grid-template-columns: 1fr; }
      }

      #matcher-picker .ap2-field{
        display:flex;
        flex-direction: column;
        gap: 6px;
      }

      #matcher-picker .ap2-label{
        font-size: 0.72rem;
        opacity: .78;
        letter-spacing: .08em;
        text-transform: uppercase;
      }

      #matcher-picker .ap2-input{
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148,163,184,0.20);
        background: rgba(2,6,23,0.35);
        color: rgba(226,232,240,0.96);
        outline: none;
      }

      #matcher-picker .ap2-input:focus{
        border-color: rgba(34,211,238,0.45);
        box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
      }

      /* select com cara ‚Äúpremium‚Äù (seta discreta) */
      #matcher-picker select.ap2-input{
        appearance:none;
        padding-right: 34px;
        background-image:
          linear-gradient(45deg, transparent 50%, rgba(148,163,184,0.85) 50%),
          linear-gradient(135deg, rgba(148,163,184,0.85) 50%, transparent 50%);
        background-position:
          calc(100% - 16px) 50%,
          calc(100% - 11px) 50%;
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }

      /* evita cortar o popup */
#matcher-picker.autopilot-v2{ overflow: visible; }

/* for√ßa dark widgets quando poss√≠vel */
#matcher-picker{ color-scheme: dark; }

/* esconde o select nativo */
#matcher-picker .ap2-field{ position:relative; }
#matcher-picker .mp-native-select{
  position:absolute;
  width:1px; height:1px;
  opacity:0;
  pointer-events:none;
}

/* dropdown custom (lista bonita) */
#matcher-picker .ap2-select{ position:relative; }
#matcher-picker .ap2-select-btn{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  cursor:pointer;
}
#matcher-picker #mp-symbol-text{
  font-weight: 900;
  letter-spacing: .04em;
}

/* caret */
#matcher-picker .ap2-caret{
  width: 9px; height: 9px;
  transform: rotate(45deg);
  border-right: 2px solid rgba(148,163,184,0.85);
  border-bottom: 2px solid rgba(148,163,184,0.85);
  opacity: .9;
  margin-right: 2px;
}
#matcher-picker .ap2-select.open .ap2-caret{
  transform: rotate(-135deg);
}

/* popup */
#matcher-picker .ap2-pop{
  position:absolute;
  left:0; right:0;
  top: calc(100% + 8px);
  z-index: 99999;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.22);
  background: rgba(2,6,23,0.92);
  backdrop-filter: blur(10px);
  box-shadow:
    0 18px 50px rgba(0,0,0,0.55),
    inset 0 0 0 1px rgba(56,189,248,0.10);
  display:none;
}
#matcher-picker .ap2-select.open .ap2-pop{ display:block; }

#matcher-picker .ap2-select-search{
  width:100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148,163,184,0.20);
  background: rgba(15,23,42,0.55);
  color: rgba(226,232,240,0.96);
  outline:none;
}
#matcher-picker .ap2-select-search:focus{
  border-color: rgba(34,211,238,0.45);
  box-shadow: 0 0 0 4px rgba(34,211,238,0.10);
}

#matcher-picker .ap2-list{
  margin-top: 8px;
  max-height: 260px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap: 6px;
  padding-right: 4px;
}

#matcher-picker .ap2-opt{
  width:100%;
  text-align:left;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148,163,184,0.10);
  background: rgba(15,23,42,0.22);
  color: rgba(226,232,240,0.95);
  cursor:pointer;
  font-weight: 800;
  letter-spacing: .06em;
  transition: transform .08s ease, background .12s ease, border-color .12s ease;
}
#matcher-picker .ap2-opt:hover{
  background: rgba(56,189,248,0.12);
  border-color: rgba(56,189,248,0.26);
}
#matcher-picker .ap2-opt:active{ transform: translateY(1px); }

#matcher-picker .ap2-opt.active{
  background: rgba(34,197,94,0.12);
  border-color: rgba(34,197,94,0.32);
}

/* scrollbar (chrome) */
#matcher-picker .ap2-list::-webkit-scrollbar{ width: 10px; }
#matcher-picker .ap2-list::-webkit-scrollbar-thumb{
  background: rgba(148,163,184,0.22);
  border-radius: 999px;
}


      #matcher-picker .mp-hint{
        margin-top:10px;
        font-size: 11px;
        opacity: .85;
        color: rgba(148,163,184,0.90);
      }

      #matcher-picker .ap2-bottom{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
      }

      /* ap-btn existe global, mas o ‚Äúpremium‚Äù do autopilot √© ID-scoped.
         Ent√£o replicamos o ajuste aqui tamb√©m: */
      #matcher-picker .ap-btn{
        border-radius: 14px;
        padding: 9px 12px;
        letter-spacing: .6px;
        background: rgba(15,23,42,0.25);
        border-color: rgba(148,163,184,0.28);
      }

      #matcher-picker .ap-btn:active{
        transform: translateY(1px);
      }

      /* alinha o ‚ÄúPre√ßo‚Äù como no print */
      #matcher-picker #mp-price{
        text-align:right;
        font-weight:900;
      }
    `;
    document.head.appendChild(style);
  }

  function buildBlock(){
    const row = document.createElement("div");
    row.id = "matcher-picker-row";

    row.innerHTML = `
      <section id="matcher-picker" class="decision-card autopilot-v2" aria-label="Matcher Symbol Picker">
        <div class="ap2-top">
          <div>
            <div class="decision-title">MATCHER ‚Ä¢ SYMBOL</div>
            <div class="ap2-sub">Escolha 1 ativo para enviar ao workflow X</div>
          </div>

          <div class="ap2-controls">
            <div class="badge-outline" title="Somente sele√ß√£o (n√£o altera o painel)">
              <span class="dot"></span>
              <span>Selector</span>
            </div>
          </div>
        </div>

        <div class="ap2-sizing">
          <div class="ap2-input-row">
            <div class="ap2-field">
  <label class="ap2-label" for="mp-symbol-btn">Ativo</label>

  <!-- select real (mant√©m compatibilidade), mas invis√≠vel -->
  <select id="mp-symbol" class="ap2-input mp-native-select" aria-hidden="true" tabindex="-1"></select>

  <!-- dropdown bonito -->
  <div class="ap2-select" id="mp-symbol-dd">
    <button id="mp-symbol-btn"
            class="ap2-input ap2-select-btn"
            type="button"
            aria-haspopup="listbox"
            aria-expanded="false">
      <span id="mp-symbol-text">‚Äî</span>
      <span class="ap2-caret" aria-hidden="true"></span>
    </button>

    <div id="mp-symbol-pop" class="ap2-pop" role="listbox" aria-label="Ativos">
      <input id="mp-symbol-search"
             class="ap2-select-search"
             type="text"
             placeholder="Buscar..."
             autocomplete="off" />
      <div class="ap2-list" id="mp-symbol-list"></div>
    </div>
  </div>
</div>


            <div class="ap2-field">
              <label class="ap2-label" for="mp-price">Pre√ßo</label>
              <input id="mp-price" class="ap2-input" type="text" value="‚Äî" readonly />
            </div>
          </div>

          <div class="mp-hint">Evento: <code>aaron:symbolSelected</code></div>
        </div>

        <div class="ap2-bottom">
          <button class="ap-btn" id="mp-copy" type="button">Copiar s√≠mbolo</button>
        </div>
      </section>
    `;
    return row;
  }

  function getQuote(symbol){
    const q = (window.AARON_QUOTES && window.AARON_QUOTES[symbol]) ? window.AARON_QUOTES[symbol] : null;
    if (q && typeof q.price === "number") return q.price;

    const p = window.__AARON_LAST_PANEL_JSON__;
    if (p){
      const pSym = (p.symbol || p.ticker || (p.trade && p.trade.symbol) || (p.execution && p.execution.symbol));
      const pPrice = p.price ?? p.last_price ?? (p.trade && (p.trade.price || p.trade.last_price));
      if (pSym && String(pSym).toUpperCase().includes(symbol) && typeof pPrice === "number") return pPrice;
    }
    return null;
  }

  function refreshPrice(priceEl, symbol){
    const v = getQuote(symbol);
    priceEl.value = (typeof v === "number") ? v.toFixed(2) : "‚Äî";
  }

  function emit(symbol, priceEl){
    localStorage.setItem("aaron_selected_symbol", symbol);
    window.AARON_SELECTED_SYMBOL = symbol;

    window.dispatchEvent(new CustomEvent("aaron:symbolSelected", { detail: { symbol } }));
    refreshPrice(priceEl, symbol);
  }

  function install(){
    injectStyles();
    if (document.getElementById("matcher-picker-row")) return;

    const row = buildBlock();

    // √¢ncora: COLUNA DIREITA, antes do primeiro card (Resumo institucional)
    const cols = document.querySelectorAll("main.layout > section.column");
    const rightCol = (cols && cols.length >= 2) ? cols[1] : null;
    if (!rightCol) return;

    const firstCard = rightCol.querySelector(".card, .decision-card") || rightCol.firstElementChild;
    if (firstCard) firstCard.insertAdjacentElement("beforebegin", row);
    else rightCol.appendChild(row);

    const sel = row.querySelector("#mp-symbol");
    const priceEl = row.querySelector("#mp-price");
    const copyBtn = row.querySelector("#mp-copy");

    SYMBOLS.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sel.appendChild(opt);
    });

    const saved = localStorage.getItem("aaron_selected_symbol");
    if (saved && SYMBOLS.includes(saved)) sel.value = saved;

    sel.addEventListener("change", () => emit(sel.value, priceEl));

    // ===== dropdown bonito (espelha o <select>) =====
const dd = row.querySelector("#mp-symbol-dd");
const btn = row.querySelector("#mp-symbol-btn");
const txt = row.querySelector("#mp-symbol-text");
const search = row.querySelector("#mp-symbol-search");
const list = row.querySelector("#mp-symbol-list");

function closeDD(){
  dd.classList.remove("open");
  btn.setAttribute("aria-expanded", "false");
}

function openDD(){
  dd.classList.add("open");
  btn.setAttribute("aria-expanded", "true");
  search.value = "";
  renderOptions("");
  setTimeout(() => search.focus(), 0);
}

function renderOptions(filter){
  const f = String(filter || "").trim().toUpperCase();
  list.innerHTML = "";
  SYMBOLS
    .filter(s => !f || s.includes(f))
    .forEach(s => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "ap2-opt" + (s === sel.value ? " active" : "");
      b.setAttribute("role", "option");
      b.setAttribute("aria-selected", s === sel.value ? "true" : "false");
      b.textContent = s;
      b.addEventListener("click", () => {
        sel.value = s;           // espelha no select real
        txt.textContent = s;     // atualiza UI
        emit(s, priceEl);        // mant√©m teu comportamento
        closeDD();
      });
      list.appendChild(b);
    });
}

btn.addEventListener("click", () => {
  dd.classList.contains("open") ? closeDD() : openDD();
});

btn.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " " || e.key === "ArrowDown") {
    e.preventDefault();
    openDD();
  }
  if (e.key === "Escape") {
    e.preventDefault();
    closeDD();
  }
});

search.addEventListener("input", () => renderOptions(search.value));
search.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    e.preventDefault();
    closeDD();
    btn.focus();
  }
});

// fecha clicando fora
document.addEventListener("pointerdown", (e) => {
  if (!dd.contains(e.target)) closeDD();
}, { capture: true });

// inicializa texto + lista
txt.textContent = sel.value || "‚Äî";
renderOptions("");
// ===== /dropdown bonito =====


    copyBtn.addEventListener("click", () => {
      const symbol = sel.value;
      navigator.clipboard?.writeText(symbol).then(() => {
        copyBtn.textContent = "Copiado ‚úì";
        setTimeout(() => copyBtn.textContent = "Copiar s√≠mbolo", 900);
      }).catch(() => {
        const ta = document.createElement("textarea");
        ta.value = symbol;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      });
    });

    emit(sel.value, priceEl);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", install);
  } else {
    install();
  }
})();
</script>



</body>
</html>