<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>AARON 9 – Painel Institucional em Tempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --card: #020617;
      --card-border: #1f2937;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.12);
      --danger: #f97373;
      --success: #4ade80;
      --text-soft: #9ca3af;
      --text-main: #e5e7eb;
      --error: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
  margin: 0;
  padding: 0;
  background: #020617;
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* wrapper principal da página */
.app-shell {
  min-height: 100vh;
  display: flex;
  justify-content: flex-start;  /* fica encostado à esquerda */
}

.app-inner {
  width: 100%;
  max-width: 100%;              /* tira o limite de 1680px */
  margin: 16px 24px 32px 24px;  /* margens finas só pra não colar na borda */
}


 .page {
  flex: 1;
  max-width: 1480px;          /* largura máxima do painel */
  width: 100%;
  margin: 16px auto 32px auto;/* auto nas laterais = CENTRALIZA */
  display: flex;
  flex-direction: column;
  gap: 10px;
}



    /* TOPO / HEADER */

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(34, 211, 238, 0.12), transparent 55%);
      border: 1px solid rgba(31, 41, 55, 0.95);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.85);
      position: relative;
      overflow: hidden;
    }

    .top-bar::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0 0, rgba(34, 211, 238, 0.3), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(59, 130, 246, 0.25), transparent 60%);
      opacity: 0.75;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .top-left,
    .top-right {
      position: relative;
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 14px;
      align-items: center;
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--text-soft);
    }

    .brand-title span {
      color: var(--accent);
    }

    .status-dot-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(248, 113, 113, 0.12);
      border: 1px solid rgba(248, 113, 113, 0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #fecaca;
    }

    .status-dot-live::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97373;
      box-shadow: 0 0 14px rgba(239, 68, 68, 0.9);
    }

    .pill-small {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .pill-small strong {
      color: var(--text-main);
      font-weight: 500;
      margin-left: 3px;
    }

    .pill-state {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.8);
      background: rgba(8, 47, 73, 0.85);
      color: #e0f2fe;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      gap: 6px;
      white-space: nowrap;
    }

    .pill-state::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22d3ee;
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.9);
    }

    .pill-soft {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.85);
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .pill-soft strong {
      color: var(--text-main);
      font-weight: 500;
      margin-left: 4px;
    }

    .pill-soft-accent {
      border-color: rgba(34, 211, 238, 0.85);
      color: #e0f2fe;
    }

    .btn-refresh {
      position: relative;
      z-index: 1;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.7);
      background: radial-gradient(circle at top, rgba(34, 211, 238, 0.2), rgba(15, 23, 42, 0.9));
      color: #e0f2fe;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      cursor: pointer;
    }

    .btn-refresh::before {
      content: "⟳";
      font-size: 12px;
    }

    .btn-refresh[disabled] {
      opacity: 0.5;
      cursor: default;
    }
        .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      margin-right: 6px;
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 999px;
      cursor: pointer;
    }

    .lang-btn.active {
      background: rgba(34, 211, 238, 0.16);
      color: #e0f2fe;
    }


    /* BANNER ERRO */

    .error-banner {
      display: none;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(248, 113, 113, 0.8);
      background: rgba(127, 29, 29, 0.3);
      color: #fecaca;
      font-size: 12px;
    }

    .error-banner strong {
      color: #fee2e2;
    }

    /* LAYOUT PRINCIPAL */

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 12px;
      align-items: flex-start;
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      position: relative;
      border-radius: 16px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(3, 7, 18, 0.98));
      border: 1px solid rgba(30, 64, 175, 0.9);
      box-shadow:
        0 18px 42px rgba(15, 23, 42, 0.95),
        0 0 28px rgba(15, 23, 42, 0.9);
      padding: 12px 14px;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(34, 211, 238, 0.12), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card-header {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge-outline {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      gap: 6px;
    }

    .badge-outline.green {
      border-color: rgba(74, 222, 128, 0.8);
      color: #bbf7d0;
    }

    .badge-outline.red {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    .badge-outline span.dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: currentColor;
      box-shadow: 0 0 10px currentColor;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
      gap: 10px;
    }

    .panel-section {
      position: relative;
      z-index: 1;
      padding: 10px 10px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(30, 64, 175, 0.8);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
      margin-bottom: 8px;
    }

    .panel-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .panel-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      color: var(--text-main);
      background: rgba(15, 23, 42, 0.9);
      white-space: nowrap;
    }

    .pill-green {
      border-color: rgba(74, 222, 128, 0.8);
      color: var(--success);
    }

    .pill-red {
      border-color: rgba(248, 113, 113, 0.8);
      color: var(--danger);
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      margin-bottom: 2px;
    }

    /* === DIREÇÃO COM FLECHA === */
    .direction-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .arrow-badge {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px rgba(34, 211, 238, 0.7);
      font-size: 24px;
      font-weight: 700;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .arrow-badge.arrow-up {
      border-color: rgba(74, 222, 128, 0.9);
      box-shadow: 0 0 22px rgba(74, 222, 128, 0.8);
      color: #4ade80;
    }

    .arrow-badge.arrow-down {
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 0 22px rgba(248, 113, 113, 0.85);
      color: #f97373;
    }

    .direction-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    .direction-text strong {
      font-size: 13px;
    }

    .text-soft {
      color: var(--text-soft);
    }
    /* ====== AARON 9 – COLUNA DIREITA (DECISION PANEL) ====== */

.decision-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.decision-card {
  background: var(--card, #020617);
  border-radius: 18px;
  border: 1px solid var(--card-border, #1f2937);
  padding: 16px 18px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.75);
}

/* títulos e textos pequenos */
.decision-title {
  font-size: 0.75rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-soft, #9ca3af);
  margin-bottom: 8px;
}

.decision-label-strong {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-main, #e5e7eb);
}

/* radar de direção */
.radar-header {
  display: flex;
  align-items: center;
  gap: 12px;
}

.radar-circle {
  width: 54px;
  height: 54px;
  border-radius: 999px;
  border: 2px solid #f97373;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
}

.radar-circle.buy {
  border-color: var(--accent, #22d3ee);
}

.radar-percent {
  font-size: 0.9rem;
  color: var(--text-soft, #9ca3af);
}

/* barrinhas horizontal (a favor x contra, etc.) */
.decision-bar {
  position: relative;
  width: 100%;
  height: 6px;
  border-radius: 999px;
  background: rgba(148, 163, 184, 0.18);
  overflow: hidden;
}

.decision-bar-fill {
  position: absolute;
  inset: 0;
  width: 70%; /* será ajustado depois com JS ou no backend */
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
}

.decision-bar-fill-danger {
  position: absolute;
  inset: 0;
  width: 30%;
  border-radius: inherit;
  background: linear-gradient(90deg, #f97373, #facc15);
}

/* pill do estado (NO TRADE / GO FULL etc.) */
.decision-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.16em;
  text-transform: uppercase;
}

.decision-pill.go-full {
  background: rgba(248, 113, 113, 0.16);
  color: #fecaca;
}

.decision-pill.scalp {
  background: rgba(56, 189, 248, 0.16);
  color: #bae6fd;
}

.decision-pill.wait {
  background: rgba(234, 179, 8, 0.16);
  color: #facc15;
}

.decision-pill.no-trade {
  background: rgba(148, 163, 184, 0.16);
  color: #cbd5f5;
}

/* checklist de padrões */
.checklist-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.check-pill {
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 0.8rem;
  border: 1px solid rgba(148, 163, 184, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.check-pill.on {
  border-color: rgba(45, 212, 191, 0.9);
  background: rgba(34, 197, 94, 0.12);
  color: #bbf7d0;
}

/* pattern radar + pullback */
.pattern-layout {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
  gap: 12px;
}

.pattern-box {
  border-radius: 14px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  padding: 8px 10px;
  font-size: 0.78rem;
}

.pattern-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.pullback-highlight {
  font-size: 0.78rem;
  margin-top: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(34, 197, 94, 0.08);
  border: 1px solid rgba(34, 197, 94, 0.4);
}

/* responsivo: em telas estreitas essa coluna vira full-width */
@media (max-width: 1024px) {
  .decision-column {
    margin-top: 16px;
  }
}
/* ====== HERO STATUS (MODO CEGO) ====== */

.status-hero {
  background: radial-gradient(circle at top left, rgba(34,197,94,0.18), rgba(15,23,42,1));
  border-radius: 20px;
  border: 1px solid rgba(34,197,94,0.7);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
}

.status-hero-label {
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(148,163,184,0.9);
}

.status-hero-main {
  font-size: 1.35rem;
  font-weight: 700;
  color: #e5e7eb;
}

.status-hero-sub {
  font-size: 0.8rem;
  color: var(--text-soft, #9ca3af);
}

/* bolha da direita (GO FULL / WAIT etc.) */
.status-hero-badge {
  min-width: 88px;
  text-align: center;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.18em;
  text-transform: uppercase;
}

/* cores por estado */
.status-buy {
  background: radial-gradient(circle at top left, rgba(34,197,94,0.22), #020617);
  border-color: rgba(34,197,94,0.8);
}

.status-sell {
  background: radial-gradient(circle at top left, rgba(248,113,113,0.22), #020617);
  border-color: rgba(248,113,113,0.9);
}

.status-wait {
  background: radial-gradient(circle at top left, rgba(234,179,8,0.22), #020617);
  border-color: rgba(234,179,8,0.9);
}

.status-no-trade {
  background: radial-gradient(circle at top left, rgba(148,163,184,0.22), #020617);
  border-color: rgba(148,163,184,0.9);
}

/* cores da badge */
.status-hero-badge.buy { background: rgba(34,197,94,0.18); color:#bbf7d0; }
.status-hero-badge.sell { background: rgba(248,113,113,0.18); color:#fecaca; }
.status-hero-badge.wait { background: rgba(234,179,8,0.18); color:#facc15; }
.status-hero-badge.no-trade { background: rgba(148,163,184,0.18); color:#e5e7eb; }

/* piscando leve para EXECUTAR AGORA */
.blink-hero {
  animation: heroPulse 1.4s ease-in-out infinite;
}

@keyframes heroPulse {
  0%   { transform: scale(1); box-shadow: 0 0 0 0 rgba(248,113,113,0.7); }
  50%  { transform: scale(1.01); box-shadow: 0 0 0 12px rgba(248,113,113,0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(248,113,113,0); }
}

/* ====== PATTERN DRAWINGS (PADRÃO DO DIA / MOMENTO) ====== */

.pattern-canvas {
  background: rgba(15,23,42,0.9);
  border-radius: 10px;
  padding: 4px 6px;
  margin-bottom: 6px;
  border: 1px solid rgba(148,163,184,0.35);
}

.pattern-svg {
  width: 100%;
  height: 34px;
}

.prob-phrase {
  font-size: 0.76rem;
  margin-top: 4px;
  color: var(--text-soft, #9ca3af);
}

.prob-phrase.favor {
  color: #bbf7d0;
}

.prob-phrase.contra {
  color: #fecaca;
}
    /* ====== ESTRUTURA RECENTE — HH / HL / LH / LL ====== */

.structure-wrapper {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.structure-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.structure-chip {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.55);
  background: rgba(15, 23, 42, 0.95);
  font-size: 0.78rem;
}

.structure-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: var(--text-soft);
}

.structure-status {
  font-weight: 500;
  color: var(--text-main);
}

.structure-dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: #4b5563;
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 1);
  margin-left: 6px;
}

.structure-dot.on {
  background: #fb7185;
  box-shadow: 0 0 10px rgba(248, 113, 113, 0.85);
}

/* ZigZag / Market Structure */

.structure-zigzag-title {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.structure-zigzag-box {
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.96);
  padding: 4px 6px;
}

.structure-zigzag-svg {
  width: 100%;
  height: 40px;
}

/* ====== GERENCIADOR DE RISCO · ATR ====== */

.risk-card {
  background: var(--card);
  border-radius: 18px;
  border: 1px solid var(--card-border);
  padding: 14px 16px;
  margin-bottom: 14px;
  box-shadow: 0 18px 40px rgba(15,23,42,0.7);
}

.risk-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.risk-title {
  font-size: 0.9rem;
  font-weight: 600;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: var(--text-soft);
}

.risk-subtitle {
  font-size: 0.75rem;
  color: var(--text-soft);
}

.risk-toggle {
  border-radius: 999px;
  padding: 4px 12px;
  border: 1px solid var(--accent);
  background: transparent;
  color: var(--accent);
  font-size: 0.75rem;
  cursor: pointer;
}

.risk-toggle:hover {
  background: var(--accent-soft);
}

.risk-body {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 12px;
}

.risk-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.risk-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-soft);
}

.risk-group input,
.risk-group select {
  background: #020617;
  border-radius: 10px;
  border: 1px solid #1f2937;
  padding: 6px 8px;
  font-size: 0.78rem;
  color: var(--text-main);
}

.risk-group input:focus,
.risk-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(34,211,238,0.35);
}

.risk-actions {
  grid-column: 1 / -1;
  display: flex;
  justify-content: flex-start;
  margin-top: 4px;
}

.risk-actions button {
  border-radius: 999px;
  padding: 6px 16px;
  border: none;
  background: var(--accent);
  color: #020617;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
}

.risk-results {
  grid-column: 1 / -1;
  margin-top: 8px;
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 12px;
}

.risk-result-label {
  font-size: 0.72rem;
  color: var(--text-soft);
}

.risk-result-value {
  font-size: 0.9rem;
  font-weight: 600;
}

.risk-result-value.small {
  font-size: 0.78rem;
  opacity: 0.8;
}
    /* ====== TOGGLE DE IDIOMA PT / EN ====== */
    .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.45);
      margin-right: 12px;
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      cursor: pointer;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .lang-btn.active {
      background: rgba(34, 211, 238, 0.18);
      color: var(--accent);
    }
    /* ====== PULLBACK BRAIN – UX AVANÇADO ====== */

.pullback-header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 6px;
}

.pullback-status-block {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.pullback-status-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
}

.pullback-status-main {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--text-main);
}

.pullback-meta-block {
  text-align: right;
  font-size: 0.76rem;
  color: var(--text-soft);
}

.pullback-tag-row {
  display: flex;
  gap: 6px;
  margin-top: 4px;
  justify-content: flex-end;
}

.pullback-tag {
  border-radius: 999px;
  padding: 3px 8px;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  border: 1px solid rgba(148,163,184,0.5);
  background: rgba(15,23,42,0.9);
  white-space: nowrap;
}

.pullback-tag.side-buy {
  border-color: rgba(34,197,94,0.9);
  color: #bbf7d0;
}

.pullback-tag.side-sell {
  border-color: rgba(248,113,113,0.9);
  color: #fecaca;
}

.pullback-tag.side-neutral {
  border-color: rgba(148,163,184,0.8);
  color: #e5e7eb;
}

.pullback-tag.stage {
  border-color: rgba(56,189,248,0.9);
  color: #bae6fd;
}

/* termômetro horizontal */

.pullback-meter {
  margin-top: 8px;
  margin-bottom: 8px;
}

.pullback-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.pullback-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.pullback-meter-fill {
  position: absolute;
  inset: 0;
  width: 40%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

.pullback-meter-fill.neutral {
  background: linear-gradient(90deg, #eab308, #f97316);
}

.pullback-meter-fill.danger {
  background: linear-gradient(90deg, #f97373, #fb7185);
}

/* já existia, mas este bloco usa muito: */
.pullback-highlight {
  font-size: 0.78rem;
  margin-top: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(34, 197, 94, 0.08);
  border: 1px solid rgba(34, 197, 94, 0.4);
}
    /* ====== SIZING BRAIN – GESTÃO DE CAPITAL DO DIA ====== */

.sizing-header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 6px;
}

.sizing-main-numbers {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.sizing-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-soft);
}

.sizing-target-value {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--accent);
}

.sizing-secondary-numbers {
  font-size: 0.76rem;
  color: var(--text-soft);
  text-align: right;
}

.sizing-tag-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
  margin-bottom: 6px;
}

.sizing-tag {
  border-radius: 999px;
  padding: 3px 9px;
  font-size: 0.7rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  border: 1px solid rgba(148,163,184,0.6);
  background: rgba(15,23,42,0.9);
  white-space: nowrap;
}

.sizing-tag.profile-conservative {
  border-color: rgba(56,189,248,0.9);
  color: #bae6fd;
}

.sizing-tag.profile-normal {
  border-color: rgba(34,197,94,0.9);
  color: #bbf7d0;
}

.sizing-tag.profile-aggressive {
  border-color: rgba(234,179,8,0.9);
  color: #fef9c3;
}

.sizing-tag.style-daytrade {
  border-color: rgba(94,234,212,0.9);
  color: #a5f3fc;
}

.sizing-tag.style-swing {
  border-color: rgba(129,140,248,0.9);
  color: #e0e7ff;
}

.sizing-tag.style-momentum {
  border-color: rgba(251,146,60,0.9);
  color: #fed7aa;
}

.sizing-tag.style-noedge {
  border-color: rgba(148,163,184,0.9);
  color: #e5e7eb;
}

.sizing-meter {
  margin-top: 4px;
  margin-bottom: 6px;
}

.sizing-meter-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.72rem;
  color: var(--text-soft);
  margin-bottom: 4px;
}

.sizing-meter-bar {
  position: relative;
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(31,41,55,0.9);
  overflow: hidden;
}

.sizing-meter-fill {
  position: absolute;
  inset: 0;
  width: 40%;
  border-radius: inherit;
  background: linear-gradient(90deg, #22c55e, #facc15);
  transition: width 0.25s ease-out;
}

.sizing-comment {
  margin-top: 4px;
  font-size: 0.78rem;
  color: var(--text-main);
  background: rgba(15,23,42,0.85);
  border-radius: 10px;
  padding: 6px 8px;
  border: 1px dashed rgba(148,163,184,0.6);
}

    /* --- SIZING BRAIN · inputs de capital/risco/stop + frases --- */

.sizing-inputs {
  margin-top: 6px;
  margin-bottom: 6px;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
}

.sizing-input {
  display: flex;
  flex-direction: column;
  gap: 3px;
  font-size: 0.75rem;
}

.sizing-input label {
  color: var(--text-soft);
  text-transform: none;
  letter-spacing: 0.02em;
}

.sizing-input input {
  border-radius: 999px;
  border: 1px solid rgba(31,41,55,0.9);
  background: #020617;
  padding: 5px 10px;
  font-size: 0.8rem;
  color: var(--text-main);
}

.sizing-input input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}

.sizing-phrase {
  margin-top: 2px;
  margin-bottom: 6px;
  font-size: 0.8rem;
  line-height: 1.35;
}

.sizing-phrase-main {
  color: var(--text-main);
}

.sizing-phrase-detail {
  color: var(--text-soft);
  margin-top: 2px;
}

/* responsivo */
@media (max-width: 900px) {
  .sizing-inputs {
    grid-template-columns: 1fr;
  }
}

/* === SIZING BRAIN – GERENCIADOR DE RISCO === */
.sizing-brain-card {
  border: 1px solid var(--card-border);
  border-radius: 16px;
  padding: 16px 20px;
  background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.4));
  box-shadow: 0 0 40px rgba(15, 23, 42, 0.8);
}

.sizing-brain-card .card-header h2 {
  margin: 0;
  font-size: 1.1rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.sizing-brain-card .card-subtitle {
  margin: 4px 0 0;
  font-size: 0.75rem;
  color: var(--text-soft);
}

.sb-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px 16px;
  margin-top: 12px;
}

.sb-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sb-field label {
  font-size: 0.8rem;
  color: var(--text-soft);
}

.sb-field input {
  background: #020617;
  border-radius: 10px;
  border: 1px solid var(--card-border);
  padding: 6px 8px;
  color: var(--text-main);
  font-size: 0.9rem;
}

.sb-field input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.3);
}

.sb-hint {
  font-size: 0.7rem;
  color: var(--text-soft);
}

.sb-divider {
  margin: 14px 0;
  border: none;
  border-top: 1px dashed rgba(148, 163, 184, 0.4);
}

.sb-side-toggle {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.8rem;
}

.sb-side-toggle label {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.sb-side-toggle input[type="radio"] {
  accent-color: var(--accent);
}

.sb-results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-top: 8px;
}

.sb-result-block h3 {
  margin: 0 0 6px;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-soft);
}

.sb-result-main {
  font-size: 1rem;
  font-weight: 600;
  margin: 2px 0;
}

.sb-result-sub {
  font-size: 0.8rem;
  margin: 2px 0;
  color: var(--text-soft);
}

.sb-actions {
  margin-top: 14px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.primary-btn {
  border-radius: 999px;
  padding: 6px 14px;
  border: 1px solid var(--accent);
  background: radial-gradient(circle at top, var(--accent-soft), transparent);
  color: var(--accent);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
}

.primary-btn:hover {
  filter: brightness(1.1);
}

.sb-status {
  font-size: 0.75rem;
  color: var(--text-soft);
}



  </style>
</head>

<body>
  <div class="page">
    <!-- ====== TOPO ====== -->
    <header class="top-bar">
  <div class="top-left">
    <div class="brand-title">
      <span>AARON 9</span>&nbsp;INSTITUTIONAL PANEL
    </div>

    <div class="status-dot-live" data-i18n="top.live_feed">
      LIVE FEED
    </div>

    <div class="pill-small">
      <span data-i18n="top.symbol">Símbolo</span>
      <strong id="symbol-label">—</strong>
    </div>

    <div class="pill-small">
      <span data-i18n="top.timeframe">Timeframe</span>
      <strong id="timeframe-label">—</strong>
    </div>

    <div class="pill-small">
      <span data-i18n="top.session">Sessão</span>
      <strong id="session-label">—</strong>
    </div>
  </div>

  <div class="top-right">
    <!-- TOGGLE PT / EN -->
    <div id="lang-toggle" class="lang-toggle">
      <button type="button" class="lang-btn active" data-lang="pt">PT</button>
      <button type="button" class="lang-btn" data-lang="en">EN</button>
    </div>

    <div class="pill-state" id="state-pill">
      AGUARDANDO
    </div>

    <div class="pill-soft">
      <span data-i18n="top.last_update">Última atualização:</span>
      <strong id="last-update-label">—</strong>
    </div>

    <button class="btn-refresh" id="btn-refresh" data-i18n="top.refresh">
      ATUALIZAR
    </button>
  </div>
</header>


    <div id="error-banner" class="error-banner">
      <strong>Erro ao carregar painel.</strong> Verifique o n8n / webhook e tente novamente.
    </div>

    <!-- ====== LAYOUT PRINCIPAL ====== -->
    <main class="layout">
      <!-- ====== COLUNA ESQUERDA: TV + PADRÕES ====== -->
      <section class="column">
           <!-- ====== GERENCIADOR DE RISCO · ATR ====== -->
<section class="risk-card" id="atr-risk-panel">
  <div class="risk-header">
    <div>
      <div class="risk-title" data-i18n="risk.title">
  Gerenciador de risco · ATR
</div>
<div class="risk-subtitle" data-i18n="risk.subtitle">
  Ajuste os parâmetros do ATR e calcule risco / reward da operação.
</div>
...
<button
  type="button"
  class="risk-toggle"
  id="atr-risk-toggle"
  data-i18n="risk.toggle_open"
>
  Abrir
</button>


  <div class="risk-body" id="atr-risk-body" style="display:none;">
    <div class="risk-group">
      <div class="risk-label">Length</div>
      <input id="atr-length-input" type="number" value="14" min="1" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Smoothing</div>
      <select id="atr-smoothing-input">
        <option value="RMA" selected>RMA</option>
        <option value="SMA">SMA</option>
        <option value="EMA">EMA</option>
        <option value="WMA">WMA</option>
      </select>
    </div>

    <div class="risk-group">
      <div class="risk-label">Multiplier</div>
      <input id="atr-multiplier-input" type="number" step="0.1" value="2.3" />
    </div>

    <div class="risk-group">
      <div class="risk-label">ATR atual</div>
      <input id="atr-value-input" type="number" step="0.01" placeholder="ex: 1.25" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Capital da posição ($)</div>
      <input id="atr-capital-input" type="number" step="100" placeholder="ex: 100000" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Preço de entrada</div>
      <input id="atr-entry-input" type="number" step="0.01" placeholder="ex: 177" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Risco por trade (%)</div>
      <input id="atr-riskpct-input" type="number" step="0.1" value="1" />
    </div>

    <div class="risk-group">
      <div class="risk-label">Lado</div>
      <select id="atr-side-input">
        <option value="buy">Compra</option>
        <option value="sell">Venda</option>
      </select>
    </div>

    <div class="risk-actions">
      <button id="atr-calc-btn" type="button">Calcular risco</button>
    </div>

    <div class="risk-results">
      <div>
        <div class="risk-result-label">Distância do stop (ATR × mult)</div>
        <div class="risk-result-value" id="atr-stop-distance">—</div>
      </div>
      <div>
        <div class="risk-result-label">Qtd. sugerida de ações</div>
        <div class="risk-result-value" id="atr-shares">—</div>
      </div>
      <div>
        <div class="risk-result-label">Risco aproximado</div>
        <div class="risk-result-value" id="atr-risk-money">—</div>
      </div>
      <div>
        <div class="risk-result-label">Alvo 2R · 3R (aprox.)</div>
        <div class="risk-result-value" id="atr-reward-2r">—</div>
        <div class="risk-result-value small" id="atr-reward-3r">—</div>
      </div>
    </div>
  </div>
</section>

      <!-- SIZING BRAIN – GERENCIADOR DE RISCO -->


      
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title" data-i18n="card.tv_title">
  Painel de Preço em Tempo Real
</div>
<div class="card-subtitle" data-i18n="card.tv_sub">
  TradingView + Estrutura do Dia
</div>

            </div>
            <div class="badge-outline green">
              <span class="dot"></span>
              Fluxo
              <span id="flow-label">Neutro</span>
            </div>
          </div>

         

          <!-- TRADINGVIEW -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Gráfico em Tempo Real</div>
              <div class="pill-soft pill-soft-accent">
                Fonte: TradingView
              </div>
            </div>
            <div style="border-radius: 10px; overflow: hidden; border: 1px solid rgba(15,23,42,0.9); min-height: 420px;">
             <div class="tradingview-widget-container" style="height: 430px;">
  <div id="aaron9-tv-chart" style="height: 430px;"></div>
</div>

            </div>
          </div>
        </div>
                  <!-- ===== NOVO: Estrutura recente + Market Structure ===== -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Estrutura recente</div>
            </div>

            <div class="structure-wrapper">
              <!-- Chips HH / HL / LH / LL -->
              <div class="structure-grid">
                <div class="structure-chip" id="structure-hh">
                  <span class="structure-label">HH</span>
                  <span>
                    <span class="structure-status" id="structure-hh-status">off</span>
                    <span class="structure-dot" id="structure-hh-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-hl">
                  <span class="structure-label">HL</span>
                  <span>
                    <span class="structure-status" id="structure-hl-status">off</span>
                    <span class="structure-dot" id="structure-hl-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-lh">
                  <span class="structure-label">LH</span>
                  <span>
                    <span class="structure-status" id="structure-lh-status">ativo</span>
                    <span class="structure-dot on" id="structure-lh-dot"></span>
                  </span>
                </div>

                <div class="structure-chip" id="structure-ll">
                  <span class="structure-label">LL</span>
                  <span>
                    <span class="structure-status" id="structure-ll-status">ativo</span>
                    <span class="structure-dot on" id="structure-ll-dot"></span>
                  </span>
                </div>
              </div>

              <!-- ZigZag / Market Structure -->
              <div class="structure-zigzag">
                <div class="structure-zigzag-title">
                  Market structure · últimos candles
                </div>
                <div class="structure-zigzag-box">
                  <svg
                    id="structure-zigzag-svg"
                    class="structure-zigzag-svg"
                    viewBox="0 0 100 40"
                    preserveAspectRatio="none"
                  >
                    <polyline
                      id="structure-zigzag-poly"
                      points="0,30 15,12 30,26 45,10 60,24 75,8 90,22 100,14"
                      fill="none"
                      stroke="rgba(248,113,113,0.9)"
                      stroke-width="2.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </div>
            </div>
          </div>
          <!-- ===== /Estrutura recente ===== -->

       <!-- ===== SIZING BRAIN – ABAIXO DO TRADEVIEW ===== -->

<!-- ===== SIZING BRAIN – GERENCIADOR + CAPITAL DO DIA (ABAIXO DO TRADEVIEW) ===== -->
<section class="card sizing-brain-card" id="sizing-brain-card">
  <div class="card-header">
    <h2>Sizing Brain – Gerenciador de Risco & Gestão de capital do dia</h2>
    <p class="card-subtitle">
      ATR • Capital em uso • Stop • Take Profit • Qtd sugerida · Gestão de capital do dia
    </p>
  </div>

  <div class="card-body">
    <!-- BLOCO 1 · GERENCIADOR DE RISCO (MESMO DE CIMA) -->
    <div class="sb-grid">
      <div class="sb-field">
        <label for="sb-account-balance">Capital real da conta (USD)</label>
        <input id="sb-account-balance" type="number" step="0.01" value="25000" />
      </div>

      <div class="sb-field">
        <label for="sb-leverage">Alavancagem (buying power x)</label>
        <input id="sb-leverage" type="number" step="0.1" value="4" />
        <small id="sb-buying-power-info" class="sb-hint">Buying power ≈ $100.000</small>
      </div>

      <div class="sb-field">
        <label for="sb-trade-capital">Capital em uso neste trade (USD)</label>
        <input id="sb-trade-capital" type="number" step="0.01" value="50000" />
        <small class="sb-hint">Pode ser menor que o buying power se quiser ser conservador.</small>
      </div>

      <div class="sb-field">
        <label for="sb-risk-percent">Risco máx. por trade (% da conta)</label>
        <input id="sb-risk-percent" type="number" step="0.1" value="1" />
        <small class="sb-hint">Ex: 1% em uma conta de 25k = $250 de risco.</small>
      </div>
    </div>

    <hr class="sb-divider" />

    <div class="sb-grid">
      <div class="sb-field">
        <label for="sb-entry-price">Preço de entrada</label>
        <input id="sb-entry-price" type="number" step="0.01" value="100" />
      </div>

      <div class="sb-field">
        <label for="sb-atr-value">ATR atual ($)</label>
        <input id="sb-atr-value" type="number" step="0.01" value="1.2" />
      </div>

      <div class="sb-field">
        <label for="sb-atr-mult-stop">Multiplicador ATR STOP</label>
        <input id="sb-atr-mult-stop" type="number" step="0.1" value="1.5" />
        <small class="sb-hint">Stop em ATR (ex: 1.5x ATR).</small>
      </div>

      <div class="sb-field">
        <label for="sb-atr-mult-take">Multiplicador ATR TAKE</label>
        <input id="sb-atr-mult-take" type="number" step="0.1" value="3" />
        <small class="sb-hint">Take profit em ATR (ex: 3x ATR).</small>
      </div>

      <div class="sb-field">
        <label>Direção</label>
        <div class="sb-side-toggle">
          <label>
            <input type="radio" name="sb-side" value="long" checked />
            <span>Compra / CALL</span>
          </label>
          <label>
            <input type="radio" name="sb-side" value="short" />
            <span>Venda / PUT</span>
          </label>
        </div>
      </div>
    </div>

    <hr class="sb-divider" />

    <div class="sb-results-grid">
      <div class="sb-result-block">
        <h3>Stop & Alvo (ATR)</h3>
        <p id="sb-stop-distance" class="sb-result-main">Distância do STOP: –</p>
        <p id="sb-stop-price" class="sb-result-sub">Stop Loss sugerido: –</p>
        <p id="sb-take-price" class="sb-result-sub">Take Profit sugerido: –</p>
      </div>

      <div class="sb-result-block">
        <h3>Qtd & Risco</h3>
        <p id="sb-position-size" class="sb-result-main">Qtd sugerida: –</p>
        <p id="sb-risk-dollar" class="sb-result-sub">Risco aprox.: –</p>
        <p id="sb-risk-percent" class="sb-result-sub">Risco % trade / conta: –</p>
      </div>
    </div>

    <div class="sb-actions">
      <button id="sb-calcular" class="primary-btn">Recalcular Sizing</button>
      <span id="sb-status" class="sb-status">
        Ajuste os valores e clique em “Recalcular Sizing”.
      </span>
    </div>

    <!-- DIVISOR ENTRE GERENCIADOR E CAPITAL DO DIA -->
    <hr class="sb-divider" />

    <!-- BLOCO 2 · GESTÃO DE CAPITAL DO DIA (O MESMO QUE FICAVA ABAIXO DO TRADEVIEW) -->

    <div class="decision-title" data-i18n="sizing.title">
      Sizing Brain · Gestão de capital do dia
    </div>

    <!-- HEADER: números principais -->
    <div class="sizing-header-row">
      <div class="sizing-main-numbers">
        <div class="sizing-label">
          <span data-i18n="sizing.target_label">Alvo razoável hoje</span>
        </div>
        <div class="sizing-target-value" id="sizing-target">
          0.8–1.4%
        </div>
      </div>

      <div class="sizing-secondary-numbers">
        <div>
          <span data-i18n="sizing.max_dd">Máx. perda</span>:
          <strong id="sizing-max-dd">0.8%</strong>
        </div>
        <div>
          <span data-i18n="sizing.risk_trade">Risco / trade</span>:
          <strong id="sizing-risk-trade">0.25%</strong>
        </div>
        <div>
          <span data-i18n="sizing.trades">Trades A+</span>:
          <strong id="sizing-trades-count">3</strong>
        </div>
      </div>
    </div>

    <!-- TAGS: perfil + estilo -->
    <div class="sizing-tag-row">
      <span id="sizing-profile-tag" class="sizing-tag profile-normal">
        Normal
      </span>
      <span id="sizing-style-tag" class="sizing-tag style-daytrade">
        Day trade tendencial
      </span>
    </div>

    <!-- TERMÔMETRO -->
    <div class="sizing-meter">
      <div class="sizing-meter-label">
        <span data-i18n="sizing.conservative">Conservador</span>
        <span id="sizing-meter-label">Uso de risco 40%</span>
        <span data-i18n="sizing.aggressive">Agressivo</span>
      </div>
      <div class="sizing-meter-bar">
        <div
          id="sizing-meter-fill"
          class="sizing-meter-fill"
          style="width:40%;"
        ></div>
      </div>
    </div>

    <!-- Inputs tipo Aaron Pine -->
    <div class="sizing-inputs">
      <div class="sizing-input">
        <label for="sizing-account-real-input">
          Capital REAL da conta (USD)
        </label>
        <input
          id="sizing-account-real-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 10000"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-use-input">
          Capital EM USO neste trade (USD)
        </label>
        <input
          id="sizing-use-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 10000"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-leverage-input">
          Alavancagem (×)
        </label>
        <input
          id="sizing-leverage-input"
          type="number"
          inputmode="decimal"
          step="0.1"
          placeholder="ex: 4"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-risk-input">
          Risco por trade (%)
        </label>
        <input
          id="sizing-risk-input"
          type="number"
          inputmode="decimal"
          step="0.1"
          placeholder="ex: 0.5"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-stop-input">
          Distância do stop (USD por share)
        </label>
        <input
          id="sizing-stop-input"
          type="number"
          inputmode="decimal"
          step="0.01"
          placeholder="ex: 1.20"
        />
      </div>

      <div class="sizing-input">
        <label for="sizing-fixedqty-input">
          Qtd fixa (ações) – opcional
        </label>
        <input
          id="sizing-fixedqty-input"
          type="number"
          inputmode="decimal"
          placeholder="ex: 100"
        />
      </div>
    </div>

    <!-- Frases + comentário -->
    <div class="sizing-phrase">
      <div id="sizing-phrase-main" class="sizing-phrase-main">
        Digite Capital REAL, EM USO, risco % e stop para ver o tamanho sugerido
        da posição.
      </div>
      <div id="sizing-phrase-detail" class="sizing-phrase-detail"></div>
    </div>

    <div class="sizing-comment" id="sizing-comment">
      Hoje o fluxo permite buscar algo em torno de 0.8–1.2% se você focar em 2–3
      trades A+. Acima disso já entra zona de ganância; abaixo disso ainda é um
      dia ok se você seguiu o plano.
    </div>
  </div>
</section>



      </section>

      <!-- ====== COLUNA DIREITA: RESUMO + RISCO ====== -->
      <section class="column">
        <div class="card">
  <div class="card-header">
    <div>
      <div class="card-title" data-i18n="summary.title">Resumo institucional</div>
      <div class="card-subtitle" data-i18n="summary.subtitle">Leitura consolidada do AARON 9</div>
    </div>
    <div class="badge-outline">
      <span class="dot"></span>
      <span data-i18n="summary.risk_mgmt">Gestão de risco</span>
    </div>
  </div>

<!-- ====== AARON 9 – COLUNA DIREITA (DECISION PANEL) ====== -->
<div class="decision-column">

  <!-- RADAR VISUAL DE DIREÇÃO -->
   <!-- RADAR VISUAL DE DIREÇÃO -->
  <section class="decision-card">
    <div class="decision-title" data-i18n="radar.day_title">Direção geral do dia</div>
    <div class="radar-header">
      <div id="direction-day-arrow" class="radar-circle">
        <!-- seta pra baixo ou pra cima -->
        ↓
      </div>
      <div>
        <!-- label forte da direção do dia -->
        <div id="trend-day-pill" class="decision-label-strong">Baixa forte</div>
        <!-- texto de % + descrição -->
        <div id="direction-day-text" class="radar-percent">
          70% · baseada em tendência, volatilidade e memória A8/A9.
        </div>
      </div>
    </div>

    <hr style="border: none; border-top: 1px solid rgba(148,163,184,0.18); margin: 12px 0;" />

    <div class="decision-title" data-i18n="radar.now_title">Direção prevista · 1–3 candles</div>
    <div class="radar-header">
      <div id="direction-now-arrow" class="radar-circle buy">
        ↑
      </div>
      <div>
        <div id="trend-now-pill" class="decision-label-strong">Baixa</div>
        <div id="direction-now-text" class="radar-percent">
          65% · fluxo geral puxa movimentos de baixa. Contexto favorece vendas.
        </div>
      </div>
    </div>
  </section>

<!-- HERO STATUS – MODO CEGO -->
<section id="hero-block" class="status-hero status-sell blink-hero">
  <div>
    <div class="status-hero-label">Modo cego – decisão atual</div>
    <div id="hero-main" class="status-hero-main">EXECUTAR VENDA</div>
    <div id="hero-sub" class="status-hero-sub">
      Cenário forte de venda na janela institucional. Pullback em zona, risco moderado.
    </div>
  </div>
  <div id="hero-badge" class="status-hero-badge sell">
    GO FULL
  </div>
</section>
<!-- MODO CEREBRO 2 / NARRADOR -->
<section id="hero-block-2" class="status-hero status-sell blink-hero">
  <div>
    <div class="status-hero-label">Modo avançado – leitura do contexto</div>
    <div id="hero2-main" class="status-hero-main">COMPRA EM CONTINUAÇÃO</div>
    <div id="hero2-sub" class="status-hero-sub">
      Aqui vai a leitura detalhada do cenário (continuação ou reversão, padrões, etc.).
    </div>
  </div>
  <div id="hero2-badge" class="status-hero-badge sell">
    GO FULL
  </div>
</section>


  <!-- RESUMO INSTITUCIONAL / VEREDITO -->
  <section class="decision-card">
    <div class="decision-title">Resumo institucional</div>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px;">
  <span id="hero-mode-pill" class="decision-pill go-full">GO FULL</span>
  <span id="hero-side-label" class="decision-label-strong">VENDA</span>
</div>


    <div id="hero-summary-text" style="font-size:0.8rem; margin-bottom:10px; color:var(--text-soft);">
  Continuação muito provável. Fluxo bem alinhado com a direção atual. Operar a favor é mais seguro que contra.
</div>


    <div style="font-size:0.78rem; margin-bottom:4px;">A favor: 78%</div>
    <div class="decision-bar">
      <div class="decision-bar-fill" style="width:78%;"></div>
    </div>

    <div style="font-size:0.78rem; margin:10px 0 4px;">Contra: 22%</div>
    <div class="decision-bar">
      <div class="decision-bar-fill-danger" style="width:22%;"></div>
    </div>
<div class="prob-phrase favor">
  Continuação muito provável; fluxo bem alinhado com a direção atual. Operar a favor é mais seguro que ir contra.
</div>

<div class="prob-phrase contra">
  Probabilidade moderada de reação contra ainda existe; evite alavancagem exagerada e respeite o stop.
</div>

    <div style="display:flex; gap:10px; margin-top:12px; font-size:0.78rem;">
      <div>
        <div class="decision-title" style="margin-bottom:2px;">Risco</div>
        <div>Moderado</div>
      </div>
      <div>
        <div class="decision-title" style="margin-bottom:2px;">Contexto</div>
        <div>Vulcão · 7:30–8:45</div>
      </div>
      <div>
        <div class="decision-title" style="margin-bottom:2px;">Execução</div>
        <div>Executar venda</div>
      </div>
    </div>
  </section>
    <!-- PULLBACK BRAIN · CÉREBRO ESPECIAL DE PULLBACK -->
  <section class="decision-card" id="pullback-brain-card">
    <div class="decision-title" data-i18n="pullback.title">
      Pullback Brain · Zona de respiro
    </div>

    <!-- HEADER: status + tags -->
    <div class="pullback-header-row">
      <div class="pullback-status-block">
        <div class="pullback-status-label">Status</div>
        <div id="pullback-status" class="pullback-status-main">
          Aguardando pullback...
        </div>
      </div>

      <div class="pullback-meta-block">
        <div>
          <span data-i18n="pullback.depth">Profundidade</span>:
          <strong id="pullback-depth">—</strong>
        </div>
        <div>
          <span data-i18n="pullback.quality">Qualidade</span>:
          <strong id="pullback-quality">—</strong>
        </div>

        <div class="pullback-tag-row">
          <span id="pullback-side-tag" class="pullback-tag side-neutral">
            NEUTRO
          </span>
          <span id="pullback-stage-tag" class="pullback-tag stage">
            Aguardando
          </span>
        </div>
      </div>
    </div>

    <!-- TERMÔMETRO / CONFIANÇA DO PULLBACK -->
    <div class="pullback-meter">
      <div class="pullback-meter-label">
        <span>Somente respiro</span>
        <span id="pullback-meter-label">Confiança 40%</span>
        <span>Reversão forte</span>
      </div>
      <div class="pullback-meter-bar">
        <div
          id="pullback-meter-fill"
          class="pullback-meter-fill neutral"
          style="width:40%;"
        ></div>
      </div>
    </div>

    <!-- TEXTO "HUMANO" DO CÉREBRO DE PULLBACK -->
    <div class="pullback-highlight" id="pullback-highlight-box">
      <div id="pullback-headline" style="font-weight:600; margin-bottom:4px;">
        Pullback ainda saudável dentro da tendência.
      </div>
      <div id="pullback-text" style="font-size:0.8rem;">
        Ainda não há um pullback claro.  
        O mercado ainda não ofereceu um pullback limpo na direção principal.
        Deixe o preço respirar e espere estrutura.
      </div>
    </div>
  </section>

   


  <!-- CHECKLIST DE PADRÕES -->
  <section class="decision-card">
    <div class="decision-title">Checklist de padrões</div>
    <div class="checklist-grid">
      <div class="check-pill on">Rompimento</div>
      <div class="check-pill">Continuação</div>
      <div class="check-pill">Reversão (ausente)</div>
      <div class="check-pill on">Divergência</div>
      <div class="check-pill">Exaustão</div>
      <div class="check-pill">Volume normal</div>
    </div>
  </section>

  <!-- PATTERN RADAR + CHECK PULLBACK -->
  <section class="decision-card">
  <div class="decision-title">Pattern radar · estrutura</div>

  <div class="pattern-layout" style="margin-top:6px;">

    <!-- PADRÃO DO DIA -->
    <div class="pattern-box">
      <div class="decision-title" style="margin-bottom:4px;">Padrão do dia</div>

      <div class="pattern-canvas">
        <!-- Desenho simbólico do padrão do dia (ex.: canal de baixa) -->
        <svg class="pattern-svg" viewBox="0 0 100 36">
          <polyline
            points="0,10 20,16 40,20 60,24 80,28 100,32"
            fill="none"
            stroke="rgba(248,113,113,0.9)"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

           <div id="pattern-day-label" class="pattern-name">Canal de baixa moderada</div>
      <div id="pattern-day-detail">
        Preço respeitando topos e fundos descendentes durante o dia. Favorece operações a favor da tendência de baixa.
      </div>


    <!-- PADRÃO DO MOMENTO (últimos 50 candles) -->
    <div class="pattern-box">
      <div class="decision-title" style="margin-bottom:4px;">Padrão do momento · últimos 50 candles</div>

      <div class="pattern-canvas">
        <!-- Desenho simbólico do padrão do momento (ex.: range / zigue-zague) -->
        <svg class="pattern-svg" viewBox="0 0 100 36">
          <polyline
            points="0,26 15,10 30,24 45,12 60,22 75,8 90,20 100,14"
            fill="none"
            stroke="rgba(56,189,248,0.9)"
            stroke-width="2.2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

           <div id="pattern-now-label" class="pattern-name">Range / consolidação ativa</div>
      <div id="pattern-now-detail">
        Mercado alternando entre suporte e resistência nos últimos candles. Melhor aguardar rompimento ou pullback bem claro.
      </div>

    </div>

  </div>


    <!-- Check de pullback / respiro -->
    <div class="pullback-highlight">
      <div style="font-weight:600; margin-bottom:4px;">Check de pullback</div>
      <div style="font-size:0.78rem;">
        ATR do candle atual: <strong>0.85</strong> · Profundidade: <strong>0.96 ATR</strong><br />
        Tendência: <strong>Baixa forte</strong> · Estrutura: <strong>LH</strong><br />
        Pullback dentro da faixa ideal. Continuação provável se o contexto se mantiver.
      </div>
    </div>
  </section>

</div>

          <!-- Comentário principal -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Comentário do Painel</div>
            </div>
            <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
              <div id="summary-text" style="font-size: 12px; line-height: 1.5; color: var(--text-main);">
                Aguardando primeiro alerta do TradingView para montar o painel...
              </div>
            </div>
          </div>

          <!-- Risco + Contexto -->
          <div class="grid-2">
            <div class="panel-section">
              <div class="panel-section-header">
                <div class="panel-section-title">Risco</div>
              </div>
              <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                <div class="pill" id="risk-pill">Neutro</div>
                <div id="risk-text" style="font-size: 12px; color: var(--text-soft);">
                  —
                </div>
              </div>
            </div>

            <div class="panel-section">
              <div class="panel-section-header">
                <div class="panel-section-title">Contexto</div>
              </div>
              <div class="row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                <div id="context-text" style="font-size: 12px; color: var(--text-soft);">
                  —
                </div>
              </div>
            </div>
          </div>

          <!-- Execução -->
          <div class="panel-section">
            <div class="panel-section-header">
              <div class="panel-section-title">Execução</div>
            </div>
            <div id="execution-text" style="font-size: 12px; color: var(--text-soft);">
              —
            </div>
          </div>
        </div>
      </section>
    </main>
      </div> <!-- /.page -->
    </div>   <!-- /.app-inner -->
  </div>     <!-- /.app-shell -->

  <script>
// ======= CONFIG PAINEL (JSON) =======
const PANEL_URL = 'https://jjjnogueira.app.n8n.cloud/webhook/18a1acd9-f615-4939-a6a2-5d45df087c49';
const REFRESH_MS = 60000; // 1 minuto

const els = {
  errorBanner: document.getElementById('error-banner'),
  btnRefresh: document.getElementById('btn-refresh'),
  state: document.getElementById('state-pill'),
  symbol: document.getElementById('symbol-label'),
  timeframe: document.getElementById('timeframe-label'),
  session: document.getElementById('session-label'),
  lastUpdate: document.getElementById('last-update-label'),
  flow: document.getElementById('flow-label'),
  trendDayPill: document.getElementById('trend-day-pill'),
  trendNowPill: document.getElementById('trend-now-pill'),
  dirDayArrow: document.getElementById('direction-day-arrow'),
  dirNowArrow: document.getElementById('direction-now-arrow'),
  patternDayLabel: document.getElementById('pattern-day-label'),
  patternDayDetail: document.getElementById('pattern-day-detail'),
  patternNowLabel: document.getElementById('pattern-now-label'),
  patternNowDetail: document.getElementById('pattern-now-detail'),
  summary: document.getElementById('summary-text'),
  riskPill: document.getElementById('risk-pill'),
  riskText: document.getElementById('risk-text'),
  contextText: document.getElementById('context-text'),
  executionText: document.getElementById('execution-text'),
  directionDayText: document.getElementById('direction-day-text'),
  directionNowText: document.getElementById('direction-now-text'),

  // HERO / MODO CEGO
  heroBlock: document.getElementById('hero-block'),
  heroMain: document.getElementById('hero-main'),
  heroSub: document.getElementById('hero-sub'),
  heroBadge: document.getElementById('hero-badge'),
  heroModePill: document.getElementById('hero-mode-pill'),
  heroSideLabel: document.getElementById('hero-side-label'),
  heroSummary: document.getElementById('hero-summary-text'),

  // Estrutura recente (HH / HL / LH / LL)
  structureHHStatus: document.getElementById('structure-hh-status'),
  structureHLStatus: document.getElementById('structure-hl-status'),
  structureLHStatus: document.getElementById('structure-lh-status'),
  structureLLStatus: document.getElementById('structure-ll-status'),
  structureHHDot: document.getElementById('structure-hh-dot'),
  structureHLDot: document.getElementById('structure-hl-dot'),
  structureLHDot: document.getElementById('structure-lh-dot'),
  structureLLDot: document.getElementById('structure-ll-dot'),

  // Pullback Brain
  pullbackStatus: document.getElementById('pullback-status'),
  pullbackDepth: document.getElementById('pullback-depth'),
  pullbackQuality: document.getElementById('pullback-quality'),
  pullbackHeadline: document.getElementById('pullback-headline'),
  pullbackText: document.getElementById('pullback-text'),
  pullbackHighlightBox: document.getElementById('pullback-highlight-box'),
  pullbackSideTag: document.getElementById('pullback-side-tag'),
  pullbackStageTag: document.getElementById('pullback-stage-tag'),
  pullbackMeterFill: document.getElementById('pullback-meter-fill'),
  pullbackMeterLabel: document.getElementById('pullback-meter-label'),

       // Sizing Brain
  sizingTarget: document.getElementById('sizing-target'),
  sizingMaxDD: document.getElementById('sizing-max-dd'),
  sizingRiskTrade: document.getElementById('sizing-risk-trade'),
  sizingTradesCount: document.getElementById('sizing-trades-count'),
  sizingProfileTag: document.getElementById('sizing-profile-tag'),
  sizingStyleTag: document.getElementById('sizing-style-tag'),
  sizingMeterFill: document.getElementById('sizing-meter-fill'),
  sizingMeterLabel: document.getElementById('sizing-meter-label'),
  sizingComment: document.getElementById('sizing-comment'),

  // Sizing Brain – inputs e frases (lógica tipo Aaron Pine)
  sizingAccountRealInput: document.getElementById('sizing-account-real-input'),
  sizingUseInput: document.getElementById('sizing-use-input'),
  sizingLeverageInput: document.getElementById('sizing-leverage-input'),
  sizingRiskInput: document.getElementById('sizing-risk-input'),
  sizingStopInput: document.getElementById('sizing-stop-input'),
  sizingFixedQtyInput: document.getElementById('sizing-fixedqty-input'),
  sizingPhraseMain: document.getElementById('sizing-phrase-main'),
  sizingPhraseDetail: document.getElementById('sizing-phrase-detail'),

};

   // ====== SIZING BRAIN – CAMPOS DO CARD COMPLETO ======
const sbEls = {
  card: document.getElementById('sizing-brain-card'),
  accountBalance: document.getElementById('sb-account-balance'),
  leverage: document.getElementById('sb-leverage'),
  tradeCapital: document.getElementById('sb-trade-capital'),
  riskPercentInput: document.querySelector('input#sb-risk-percent'),
  entryPrice: document.getElementById('sb-entry-price'),
  atrValue: document.getElementById('sb-atr-value'),
  atrMultStop: document.getElementById('sb-atr-mult-stop'),
  atrMultTake: document.getElementById('sb-atr-mult-take'),
  sideRadios: document.querySelectorAll('input[name="sb-side"]'),

  outStopDistance: document.getElementById('sb-stop-distance'),
  outStopPrice: document.getElementById('sb-stop-price'),
  outTakePrice: document.getElementById('sb-take-price'),
  outPositionSize: document.getElementById('sb-position-size'),
  outRiskDollar: document.getElementById('sb-risk-dollar'),
  outRiskPercent: document.querySelector('p#sb-risk-percent'),

  calcBtn: document.getElementById('sb-calcular'),
  status: document.getElementById('sb-status'),
};
 

// dados atuais do "cérebro de pullback" para re-renderizar quando trocar PT/EN
let lastPullbackBrain = null;
let lastSizingBrain = null;


// ====== GERENCIADOR DE RISCO · ATR (FRONTEND) ======
const atrEls = {
  panel: document.getElementById('atr-risk-panel'),
  toggleBtn: document.getElementById('atr-risk-toggle'),
  body: document.getElementById('atr-risk-body'),
  length: document.getElementById('atr-length-input'),
  smoothing: document.getElementById('atr-smoothing-input'),
  mult: document.getElementById('atr-multiplier-input'),
  atrValue: document.getElementById('atr-value-input'),
  capital: document.getElementById('atr-capital-input'),
  entry: document.getElementById('atr-entry-input'),
  riskPercent: document.getElementById('atr-riskpct-input'),
  side: document.getElementById('atr-side-input'),
  outDistance: document.getElementById('atr-stop-distance'),
  outShares: document.getElementById('atr-shares'),
  outRisk: document.getElementById('atr-risk-money'),
  outReward2R: document.getElementById('atr-reward-2r'),
  outReward3R: document.getElementById('atr-reward-3r'),
  calcBtn: document.getElementById('atr-calc-btn'),
};

// abre / fecha o card
if (atrEls.toggleBtn && atrEls.body) {
  atrEls.toggleBtn.addEventListener('click', () => {
    const hidden =
      atrEls.body.style.display === 'none' || atrEls.body.style.display === '';
    atrEls.body.style.display = hidden ? 'grid' : 'none';
    atrEls.toggleBtn.textContent = hidden ? 'Fechar' : 'Abrir';
  });
}

// cálculo do risco baseado no ATR digitado
function updateAtrRisk() {
  if (!atrEls.atrValue || !atrEls.capital || !atrEls.entry) return;

  const atr = parseFloat(atrEls.atrValue.value || '0');
  const mult = parseFloat(atrEls.mult.value || '1');
  const capital = parseFloat(atrEls.capital.value || '0');
  const entry = parseFloat(atrEls.entry.value || '0');
  const riskPct = parseFloat(atrEls.riskPercent.value || '1');

  if (!atr || !capital || !entry) return;

  const stopDist = atr * mult;
  const riskPerShare = stopDist;

  const sharesByCapital = capital / entry;
  const sharesByRisk = (capital * (riskPct / 100)) / riskPerShare;
  const shares = Math.min(sharesByCapital, sharesByRisk);

  const riskMoney = shares * riskPerShare;
  const reward2R = riskMoney * 2;
  const reward3R = riskMoney * 3;

  if (atrEls.outDistance) atrEls.outDistance.textContent = stopDist.toFixed(2);
  if (atrEls.outShares) atrEls.outShares.textContent = shares.toFixed(0);
  if (atrEls.outRisk) atrEls.outRisk.textContent = '$ ' + riskMoney.toFixed(2);
  if (atrEls.outReward2R)
    atrEls.outReward2R.textContent = '$ ' + reward2R.toFixed(2);
  if (atrEls.outReward3R)
    atrEls.outReward3R.textContent = '$ ' + reward3R.toFixed(2);
}

if (atrEls.calcBtn) {
  atrEls.calcBtn.addEventListener('click', (e) => {
    e.preventDefault();
    updateAtrRisk();
  });
}

// Preenche ATR + preço de entrada a partir do JSON (panel + raw)
function prefillAtrFromPanel(panel, raw) {
  if (!panel || !atrEls) return;

  const atrBlock = panel.atr || panel.atr_info;
  const indicators = raw && raw.indicators ? raw.indicators : {};

  // ATR
  if (atrBlock && atrBlock.value != null && atrEls.atrValue) {
    atrEls.atrValue.value = Number(atrBlock.value).toFixed(2);
  } else if (typeof indicators.atr === 'number' && atrEls.atrValue) {
    atrEls.atrValue.value = indicators.atr.toFixed(2);
  }

  if (atrBlock && atrBlock.length != null && atrEls.length) {
    atrEls.length.value = atrBlock.length;
  }
  if (atrBlock && atrBlock.smoothing && atrEls.smoothing) {
    atrEls.smoothing.value = atrBlock.smoothing;
  }
  if (atrBlock && atrBlock.multiplier != null && atrEls.mult) {
    atrEls.mult.value = atrBlock.multiplier;
  }

  // PREÇO DE ENTRADA
  let entry =
    panel.entry_price ||
    panel.reference_price ||
    panel.price_now ||
    panel.last_price ||
    (raw && raw.candle && raw.candle.close);

  if (entry != null && atrEls.entry) {
    atrEls.entry.value = Number(entry).toFixed(2);
  }
}

function safeText(el, value, fallback = '—') {
  if (!el) return;
  el.textContent =
    value === undefined || value === null || value === ''
      ? fallback
      : String(value);
}

function setArrow(el, dir) {
  if (!el) return;
  el.classList.remove('arrow-up', 'arrow-down');
  let symbol = '↕';
  if (dir === 'up' || dir === 'UP' || dir === 'alta' || dir === 'ALTA') {
    el.classList.add('arrow-up');
    symbol = '↑';
  } else if (dir === 'down' || dir === 'DOWN' || dir === 'baixa' || dir === 'BAIXA') {
    el.classList.add('arrow-down');
    symbol = '↓';
  }
  el.textContent = symbol;
}

function setPillTrend(el, dir, label) {
  if (!el) return;
  el.classList.remove('pill-green', 'pill-red');
  let txt = label || 'Neutro';

  if (!dir) {
    el.textContent = txt;
    return;
  }

  const d = String(dir).toLowerCase();

  if (d.includes('alta') || d === 'up') {
    el.classList.add('pill-green');
    if (!label) txt = 'Fluxo de alta';
  } else if (d.includes('baixa') || d === 'down') {
    el.classList.add('pill-red');
    if (!label) txt = 'Fluxo de baixa';
  }

  el.textContent = txt;
}

function setRiskPill(level) {
  if (!els.riskPill) return;
  const el = els.riskPill;
  el.classList.remove('pill-green', 'pill-red');
  let txt = 'Neutro';

  if (!level) {
    el.textContent = txt;
    return;
  }

  const l = String(level).toLowerCase();

  if (l.includes('alto') || l.includes('high')) {
    el.classList.add('pill-red');
    txt = 'Risco Alto';
  } else if (l.includes('baixo') || l.includes('low')) {
    el.classList.add('pill-green');
    txt = 'Risco Baixo';
  } else {
    txt = level;
  }

  el.textContent = txt;
}

function applyHeroDecision(executionText, summaryText) {
  if (!els.heroBlock) return;

  const block = els.heroBlock;
  const badge = els.heroBadge;
  const pill = els.heroModePill;
  const main = els.heroMain;
  const sub = els.heroSub;
  const side = els.heroSideLabel;
  const heroSummary = els.heroSummary;

  const baseText = executionText || 'AGUARDAR / OBSERVAR';
  const t = baseText.toLowerCase();

  let mode = 'wait';
  if (t.includes('compra') || t.includes('buy')) mode = 'buy';
  else if (t.includes('venda') || t.includes('sell')) mode = 'sell';

  block.classList.remove('status-buy', 'status-sell', 'status-wait');
  if (mode === 'buy') block.classList.add('status-buy');
  else if (mode === 'sell') block.classList.add('status-sell');
  else block.classList.add('status-wait');

  if (badge) {
    badge.textContent = mode === 'wait' ? 'WAIT' : 'GO FULL';
  }

  if (pill) {
    pill.classList.remove('go-full', 'wait', 'no-trade', 'scalp');
    if (mode === 'wait') {
      pill.classList.add('wait');
      pill.textContent = 'WAIT';
    } else {
      pill.classList.add('go-full');
      pill.textContent = 'GO FULL';
    }
  }

  if (main) main.textContent = baseText.toUpperCase();

  const fallbackSummary =
    'Aguardando leitura completa do painel para decidir.';
  const finalSummary = summaryText || fallbackSummary;

  if (sub) sub.textContent = finalSummary;
  if (heroSummary) heroSummary.textContent = finalSummary;

  if (side) {
    if (mode === 'buy') side.textContent = 'COMPRA';
    else if (mode === 'sell') side.textContent = 'VENDA';
    else side.textContent = '—';
  }
}

// Atualiza os chips HH/HL/LH/LL a partir do JSON
function updateStructureUI(struct) {
  const map = [
    { key: 'hh', status: els.structureHHStatus, dot: els.structureHHDot },
    { key: 'hl', status: els.structureHLStatus, dot: els.structureHLDot },
    { key: 'lh', status: els.structureLHStatus, dot: els.structureLHDot },
    { key: 'll', status: els.structureLLStatus, dot: els.structureLLDot },
  ];

  map.forEach(({ key, status, dot }) => {
    if (!status || !dot) return;

    let rawVal =
      struct &&
      (struct[key] ??
        struct[key.toUpperCase()] ??
        struct['recent_' + key] ??
        struct['last_' + key]);

    let label = 'off';
    let active = false;

    if (typeof rawVal === 'string') {
      const v = rawVal.toLowerCase();
      if (
        v.includes('ativo') ||
        v.includes('on') ||
        v.includes('true') ||
        v.includes('active')
      ) {
        active = true;
      }
      if (v) label = rawVal;
    } else if (typeof rawVal === 'boolean') {
      active = rawVal;
      label = rawVal ? 'ativo' : 'off';
    }

    status.textContent = label;
    if (active) dot.classList.add('on');
    else dot.classList.remove('on');
  });
}

// Atualiza o desenho do ZigZag, se o JSON mandar pontos
function updateStructureZigzag(panel) {
  const poly = document.getElementById('structure-zigzag-poly');
  if (!poly || !panel) return;

  const pts =
    panel.structure_points ||
    panel.zigzag_points ||
    panel.market_structure_points;

  if (!Array.isArray(pts) || pts.length === 0) return;

  const n = pts.length;
  const step = n > 1 ? 100 / (n - 1) : 100;

  const svgPoints = pts.map((v, i) => {
    const yNorm = Math.max(0, Math.min(1, Number(v))); // 0–1
    const x = (step * i).toFixed(2);
    const y = (30 - yNorm * 20).toFixed(2); // faixa 10–30 no SVG
    return `${x},${y}`;
  });

  poly.setAttribute('points', svgPoints.join(' '));
}

// ====== PULLBACK BRAIN – FUNÇÃO GLOBAL ======
function updatePullbackBrain(data) {
  lastPullbackBrain = data || null;

  if (!els.pullbackStatus) return;

  // helpers para classe do termômetro
  function setMeter(score, tone) {
    const fill = els.pullbackMeterFill;
    const label = els.pullbackMeterLabel;
    if (!fill || !label) return;

    let v = Number(score);
    if (!Number.isFinite(v)) v = 40; // fallback
    v = Math.max(0, Math.min(100, v));

    fill.style.width = v.toFixed(0) + '%';

    fill.classList.remove('neutral', 'danger');
    if (tone === 'red' || tone === 'danger') {
      fill.classList.add('danger');
    } else if (tone === 'yellow' || tone === 'neutral') {
      fill.classList.add('neutral');
    }

    label.textContent =
      (currentLang === 'en' ? 'Confidence ' : 'Confiança ') +
      v.toFixed(0) +
      '%';
  }

  function setSideTag(side) {
    const tag = els.pullbackSideTag;
    if (!tag) return;

    const s = (side || '').toString().toLowerCase();
    tag.classList.remove('side-buy', 'side-sell', 'side-neutral');

    if (s === 'buy' || s === 'compra') {
      tag.classList.add('side-buy');
      tag.textContent = currentLang === 'en' ? 'BUY PULLBACK' : 'COMPRA';
    } else if (s === 'sell' || s === 'venda') {
      tag.classList.add('side-sell');
      tag.textContent = currentLang === 'en' ? 'SELL PULLBACK' : 'VENDA';
    } else {
      tag.classList.add('side-neutral');
      tag.textContent = currentLang === 'en' ? 'NEUTRAL' : 'NEUTRO';
    }
  }

  function setStageTag(stageTitle) {
    const tag = els.pullbackStageTag;
    if (!tag) return;

    const txt =
      stageTitle ||
      (currentLang === 'en' ? 'Waiting' : 'Aguardando');
    tag.textContent = txt;
  }

  // ===== CASO SEM DADOS (estado neutro) =====
  if (!data || Object.keys(data).length === 0) {
    els.pullbackStatus.textContent =
      currentLang === 'en' ? 'Waiting for pullback...' : 'Aguardando pullback...';

    if (els.pullbackDepth) els.pullbackDepth.textContent = '—';
    if (els.pullbackQuality) els.pullbackQuality.textContent = '—';

    if (els.pullbackHeadline) {
      els.pullbackHeadline.textContent =
        currentLang === 'en'
          ? 'No clear pullback yet.'
          : 'Ainda não há um pullback claro.';
    }

    if (els.pullbackText) {
      els.pullbackText.textContent =
        currentLang === 'en'
          ? 'The market has not offered a clean pullback in the main direction yet. Let price breathe and wait for structure.'
          : 'O mercado ainda não ofereceu um pullback limpo na direção principal. Deixe o preço respirar e espere estrutura.';
    }

    if (els.pullbackHighlightBox) {
      els.pullbackHighlightBox.style.background = 'rgba(15,23,42,0.7)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(148,163,184,0.4)';
    }

    setSideTag(null);
    setStageTag(null);
    setMeter(40, 'neutral');
    return;
  }

  // ===== campos numéricos / status =====
  const depthAtr = data.depth_atr ?? data.atr_depth ?? null;
  const quality = data.quality ?? data.grade ?? null;
  const tone = (data.tone || '').toLowerCase();
  const side = data.side || data.direction || null;
  const score = data.score ?? data.confidence ?? 40;

  // título principal (usa state_title_pt/en se tiver)
  const statusTitle =
    (currentLang === 'en'
      ? (data.state_title_en || data.status_en || data.state_title || data.status)
      : (data.state_title_pt || data.status_pt || data.state_title || data.status)) ||
    (currentLang === 'en'
      ? 'Pullback detected'
      : 'Pullback detectado');

  els.pullbackStatus.textContent = statusTitle;

  if (els.pullbackDepth) {
    els.pullbackDepth.textContent =
      depthAtr != null ? depthAtr.toFixed(2) + ' ATR' : '—';
  }

  if (els.pullbackQuality) {
    els.pullbackQuality.textContent = quality || '—';
  }

  setSideTag(side);

  // estágio (1..7 – aquelas frases que fizemos: tendência, pullback fraco, reversão, etc.)
  const stageTitle =
    (currentLang === 'en'
      ? (data.stage_title_en || data.stage_title)
      : (data.stage_title_pt || data.stage_title)) || null;
  setStageTag(stageTitle);

  // ===== textos em PT / EN vindos do backend =====
  const headline =
    (currentLang === 'en'
      ? (data.headline_en || data.headline)
      : (data.headline_pt || data.headline)) ||
    (currentLang === 'en'
      ? 'Healthy pullback inside the main trend.'
      : 'Pullback saudável dentro da tendência principal.');

  const body =
    (currentLang === 'en'
      ? (data.text_en || data.text)
      : (data.text_pt || data.text)) ||
    (currentLang === 'en'
      ? 'AARON 9 sees this pullback as aligned with the main direction. Focus on trades with the trend and avoid fighting the move.'
      : 'O AARON 9 vê este pullback como alinhado com a direção principal. Foque em operações a favor e evite brigar com o movimento.');

  if (els.pullbackHeadline) els.pullbackHeadline.textContent = headline;
  if (els.pullbackText) els.pullbackText.textContent = body;

  // ===== cor do bloco (verde / amarelo / vermelho) =====
  if (els.pullbackHighlightBox) {
    if (tone === 'red' || tone === 'danger') {
      els.pullbackHighlightBox.style.background = 'rgba(248,113,113,0.06)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(248,113,113,0.6)';
    } else if (tone === 'yellow' || tone === 'neutral') {
      els.pullbackHighlightBox.style.background = 'rgba(234,179,8,0.06)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(234,179,8,0.6)';
    } else {
      // default = saudável / ok
      els.pullbackHighlightBox.style.background = 'rgba(34,197,94,0.08)';
      els.pullbackHighlightBox.style.borderColor = 'rgba(34,197,94,0.4)';
    }
  }

  // termômetro de confiança / “risco de reversão”
  setMeter(score, tone);
}

  


// ====== SIZING BRAIN – frases baseadas em Capital EM USO + Alavancagem ======
function updateSizingPhrase() {
  const accEl = els.sizingAccountRealInput;
  const useEl = els.sizingUseInput;
  const levEl = els.sizingLeverageInput;
  const riskEl = els.sizingRiskInput;
  const stopEl = els.sizingStopInput;
  const fixedEl = els.sizingFixedQtyInput;
  const mainEl = els.sizingPhraseMain;
  const detailEl = els.sizingPhraseDetail;

  if (!accEl || !useEl || !levEl || !riskEl || !stopEl || !mainEl || !detailEl) {
    return;
  }

  function numFromInput(el) {
    if (!el) return 0;
    const raw = (el.value || '').toString().replace(',', '.');
    const n = Number(raw);
    return Number.isFinite(n) ? n : 0;
  }

  const capitalReal = numFromInput(accEl);
  const capitalUso  = numFromInput(useEl);
  const leverage    = numFromInput(levEl);
  const riskPct     = numFromInput(riskEl);
  const stopUsd     = numFromInput(stopEl);
  const fixedQty    = Math.floor(numFromInput(fixedEl));

  // === LÓGICA TIPO AARON PINE ===
  // 1) Se Capital EM USO > 0 → base = EM USO
  // 2) Senão, se Capital REAL > 0 e alavancagem > 0 → base = REAL × alavancagem
  // 3) Senão, se Capital REAL > 0 → base = REAL
  let baseCapital = 0;

  if (capitalUso > 0) {
    baseCapital = capitalUso;
  } else if (capitalReal > 0 && leverage > 0) {
    baseCapital = capitalReal * leverage;
  } else if (capitalReal > 0) {
    baseCapital = capitalReal;
  }

  const baseMsg =
    currentLang === 'en'
      ? 'Type account capital, capital in use, risk % and stop distance to see the suggested position size.'
      : 'Digite capital real, capital em uso, risco % e stop para ver o tamanho sugerido da posição.';

  if (!baseCapital || !riskPct || !stopUsd) {
    mainEl.textContent = baseMsg;
    detailEl.textContent = '';
    return;
  }

  const riskMoney  = baseCapital * (riskPct / 100);
  const sharesRisk = Math.floor(riskMoney / stopUsd);

  if (!Number.isFinite(sharesRisk) || sharesRisk <= 0) {
    mainEl.textContent =
      currentLang === 'en'
        ? 'Check the values. The risk in dollars must be greater than the stop distance.'
        : 'Verifique os valores. O risco em dólares precisa ser maior que a distância do stop.';
    detailEl.textContent = '';
    return;
  }

  function fmtUSD(v) {
    return v.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    });
  }

  // Mensagem principal
  if (currentLang === 'en') {
    mainEl.textContent =
      'Base capital: ' +
      fmtUSD(baseCapital) +
      '. With ' +
      riskPct.toFixed(2) +
      '% risk per trade, max risk is about ' +
      fmtUSD(riskMoney) +
      ' per trade.';
  } else {
    mainEl.textContent =
      'Base de cálculo: ' +
      fmtUSD(baseCapital) +
      '. Com risco de ' +
      riskPct.toFixed(2) +
      '% por trade, o risco máximo por trade é de aproximadamente ' +
      fmtUSD(riskMoney) +
      '.';
  }

  // Detalhe – comparação com Qtd fixa (se existir)
  if (fixedQty > 0) {
    const aboveSafe = fixedQty > sharesRisk;

    if (currentLang === 'en') {
      detailEl.textContent =
        'With a stop at ' +
        stopUsd.toFixed(2) +
        ' USD per share, the risk-based safe size is around ' +
        sharesRisk +
        ' shares. Your fixed size is ' +
        fixedQty +
        ' shares, which is ' +
        (aboveSafe ? 'ABOVE' : 'within') +
        ' the safe size.';
    } else {
      detailEl.textContent =
        'Com o stop a ' +
        stopUsd.toFixed(2) +
        ' USD por share, o tamanho seguro pelo risco fica em torno de ' +
        sharesRisk +
        ' shares. Sua quantidade fixa é ' +
        fixedQty +
        ' shares, o que está ' +
        (aboveSafe ? 'ACIMA' : 'dentro') +
        ' do tamanho considerado seguro.';
    }
  } else {
    if (currentLang === 'en') {
      detailEl.textContent =
        'With a stop at ' +
        stopUsd.toFixed(2) +
        ' USD per share, the suggested position size is around ' +
        sharesRisk +
        ' shares. You can round down if you want to be more conservative.';
    } else {
      detailEl.textContent =
        'Com o stop a ' +
        stopUsd.toFixed(2) +
        ' USD por share, o tamanho de posição sugerido é de cerca de ' +
        sharesRisk +
        ' shares. Você pode arredondar para baixo se quiser ser mais conservador.';
    }
  }
}

// Eventos para recalcular quando digitar
['input', 'change'].forEach(function (evt) {
  if (els.sizingAccountRealInput)
    els.sizingAccountRealInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingUseInput)
    els.sizingUseInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingLeverageInput)
    els.sizingLeverageInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingRiskInput)
    els.sizingRiskInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingStopInput)
    els.sizingStopInput.addEventListener(evt, updateSizingPhrase);
  if (els.sizingFixedQtyInput)
    els.sizingFixedQtyInput.addEventListener(evt, updateSizingPhrase);
});


// ====== SIZING BRAIN – FUNÇÃO GLOBAL ======
function updateSizingBrain(data) {
  lastSizingBrain = data || null;

  if (!els.sizingTarget) return;

  function fmtPct(v) {
    const n = Number(v);
    if (!Number.isFinite(n)) return null;
    return n.toFixed(1) + '%';
  }

  // sempre que chegar dado novo (ou trocar idioma), recalcula frase
  updateSizingPhrase();

  function setProfileTag(profile) {
    const tag = els.sizingProfileTag;
    if (!tag) return;

    const p = (profile || '').toString().toLowerCase();
    tag.classList.remove(
      'profile-conservative',
      'profile-normal',
      'profile-aggressive'
    );

    if (p.includes('conserv')) {
      tag.classList.add('profile-conservative');
      tag.textContent =
        currentLang === 'en' ? 'Conservative' : 'Conservador';
    } else if (p.includes('agress') || p.includes('aggress')) {
      tag.classList.add('profile-aggressive');
      tag.textContent =
        currentLang === 'en' ? 'Aggressive' : 'Agressivo';
    } else {
      tag.classList.add('profile-normal');
      tag.textContent =
        currentLang === 'en' ? 'Normal' : 'Normal';
    }
  }

  function setStyleTag(style, labelPt, labelEn) {
    const tag = els.sizingStyleTag;
    if (!tag) return;

    const s = (style || '').toString().toLowerCase();
    tag.classList.remove(
      'style-daytrade',
      'style-swing',
      'style-momentum',
      'style-noedge'
    );

    let txt =
      currentLang === 'en'
        ? (labelEn || '')
        : (labelPt || '');

    if (!txt) {
      if (s.includes('day')) {
        txt =
          currentLang === 'en'
            ? 'Trend day trade'
            : 'Day trade tendencial';
      } else if (s.includes('swing')) {
        txt =
          currentLang === 'en'
            ? 'Swing trade'
            : 'Swing trade';
      } else if (s.includes('momentum') || s.includes('scalp')) {
        txt =
          currentLang === 'en'
            ? 'Momentum / scalp'
            : 'Momentum / scalp';
      } else {
        txt =
          currentLang === 'en'
            ? 'No clear edge'
            : 'Sem edge claro';
      }
    }

    if (s.includes('day')) {
      tag.classList.add('style-daytrade');
    } else if (s.includes('swing')) {
      tag.classList.add('style-swing');
    } else if (s.includes('momentum') || s.includes('scalp')) {
      tag.classList.add('style-momentum');
    } else {
      tag.classList.add('style-noedge');
    }

    tag.textContent = txt;
  }

  function setMeter(score) {
    const fill = els.sizingMeterFill;
    const label = els.sizingMeterLabel;
    if (!fill || !label) return;

    let v = Number(score);
    if (!Number.isFinite(v)) v = 40;
    v = Math.max(0, Math.min(100, v));

    fill.style.width = v.toFixed(0) + '%';
    label.textContent =
      (currentLang === 'en' ? 'Risk usage ' : 'Uso de risco ') +
      v.toFixed(0) +
      '%';
  }

  // ===== estado neutro (sem dados do backend) =====
  if (!data || Object.keys(data).length === 0) {
    if (els.sizingTarget) els.sizingTarget.textContent = '0.8–1.2%';
    if (els.sizingMaxDD) els.sizingMaxDD.textContent = '0.8%';
    if (els.sizingRiskTrade) els.sizingRiskTrade.textContent = '0.25%';
    if (els.sizingTradesCount) els.sizingTradesCount.textContent = '3';

    setProfileTag('normal');
    setStyleTag('day_trade', null, null);
    setMeter(40);

    if (els.sizingComment) {
      els.sizingComment.textContent =
        currentLang === 'en'
          ? 'Today you can think in terms of a realistic 0.8–1.2% if you focus on 2–3 A+ trades and respect your max daily loss.'
          : 'Hoje você pode pensar em algo em torno de 0.8–1.2% se focar em 2–3 trades A+ e respeitar sua perda máxima do dia.';
    }

    return;
  }

  // ===== com dados do backend (sizing_brain) =====
  const profile      = data.profile;
  const style        = data.style_today;
  const styleLabelPt = data.style_label_pt;
  const styleLabelEn = data.style_label_en;

  const tMin    = data.target_min_pct   ?? data.recommended_target_min_pct;
  const tMax    = data.target_max_pct   ?? data.recommended_target_max_pct;
  const tSingle = data.target_pct       ?? data.recommended_target_pct;

  const maxDD        = data.max_dd_pct         ?? data.recommended_max_dd_pct;
  const riskPerTrade = data.risk_per_trade_pct ?? data.recommended_risk_per_trade_pct;
  const tradesCount  = data.trades_count       ?? data.recommended_trades_count;
  const score        = data.score              ?? data.risk_usage_score ?? 40;

  // alvo
  let targetText = '';
  const tMinFmt    = fmtPct(tMin);
  const tMaxFmt    = fmtPct(tMax);
  const tSingleFmt = fmtPct(tSingle);

  if (tMinFmt && tMaxFmt) targetText = `${tMinFmt}–${tMaxFmt}`;
  else if (tSingleFmt)    targetText = tSingleFmt;

  if (!targetText) {
    targetText = currentLang === 'en' ? 'Auto' : 'Automático';
  }

  if (els.sizingTarget) els.sizingTarget.textContent = targetText;
  if (els.sizingMaxDD && fmtPct(maxDD)) {
    els.sizingMaxDD.textContent = fmtPct(maxDD);
  }
  if (els.sizingRiskTrade && fmtPct(riskPerTrade)) {
    els.sizingRiskTrade.textContent = fmtPct(riskPerTrade);
  }
  if (els.sizingTradesCount && tradesCount != null) {
    els.sizingTradesCount.textContent = String(tradesCount);
  }

  setProfileTag(profile);
  setStyleTag(style, styleLabelPt, styleLabelEn);
  setMeter(score);

  const comment =
    currentLang === 'en'
      ? (data.comment_en || data.comment || '')
      : (data.comment_pt || data.comment || '');

  if (els.sizingComment) {
    if (comment) {
      els.sizingComment.textContent = comment;
    } else {
      els.sizingComment.textContent =
        currentLang === 'en'
          ? 'Sizing Brain suggests focusing on A+ setups only, with a realistic target for the day and a strict daily loss limit.'
          : 'O Sizing Brain sugere focar apenas em setups A+, com alvo realista para o dia e limite de perda diária bem definido.';
    }
  }
}



// ====== LOAD PANEL (agora usando data.panel + data.raw) ======
async function loadPanel(showSpinner) {
  if (!PANEL_URL) return;
  try {
    if (els.errorBanner) els.errorBanner.style.display = 'none';
    if (els.btnRefresh && showSpinner) els.btnRefresh.disabled = true;

    const res = await fetch(PANEL_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);

    const data = await res.json();
    const panel = data.panel || data;
    const raw = data.raw || {};

    // Preenche ATR + preço de entrada
    prefillAtrFromPanel(panel, raw);

    const statusGeral = panel.status_geral || {};
    const aiAdvisor = panel.ai_advisor || {};
    const patterns = panel.patterns || {};
    const patternDay = patterns.day || {};
    const patternShort = patterns.short || {};
    const meta = panel.meta || {};

    // "cérebro" de pullback vindo do n8n
    const pullbackBrain =
      panel.pullback_brain ||
      panel.pullbackBrain ||
      panel.pullback ||
      {};
    updatePullbackBrain(pullbackBrain);

        const sizingBrain =
      panel.sizing_brain ||
      panel.sizingBrain ||
      panel.capital_brain ||
      {};
    updateSizingBrain(sizingBrain);


    // Cabeçalho
    safeText(els.symbol, panel.symbol || raw.symbol || '—');
    safeText(
      els.timeframe,
      panel.timeframe ||
        raw.timeframe ||
        panel.timeframe_label ||
        '—'
    );
    safeText(
      els.session,
      panel.session || raw.session || panel.session_label || '—'
    );

    const micro = panel.microcontexto || {};
    const flowLabel = panel.flow_label || panel.flow || micro.direcao;
    safeText(els.flow, flowLabel || 'Neutro');

    const stateText =
      (panel.status && (panel.status.label || panel.status.state)) ||
      statusGeral.tendencia ||
      'ONLINE';
    safeText(els.state, stateText);

    const ts = meta.panel_ts || meta.timestamp || panel.timestamp || raw.time;
    if (els.lastUpdate) {
      if (!ts) {
        els.lastUpdate.textContent = 'sem timestamp';
      } else {
        try {
          const d =
            typeof ts === 'number'
              ? new Date(ts)
              : new Date(String(ts));
          els.lastUpdate.textContent = d.toLocaleString('pt-BR', {
            timeZone: 'America/Denver',
          });
        } catch (e) {
          els.lastUpdate.textContent = String(ts);
        }
      }
    }

    // Padrões / Direções
    const patternDayName =
      panel.pattern_day ||
      panel.pattern_of_day ||
      patternDay.name;
    const patternDayDesc =
      panel.pattern_day_detail ||
      panel.pattern_of_day_detail ||
      patternDay.desc;

    const patternNowName =
      panel.pattern_now ||
      panel.pattern_of_moment ||
      patternShort.name;
    const patternNowDesc =
      panel.pattern_now_detail ||
      panel.pattern_of_moment_detail ||
      patternShort.desc;

    safeText(els.patternDayLabel, patternDayName || '-');
    safeText(els.patternDayDetail, patternDayDesc || '—');
    safeText(els.patternNowLabel, patternNowName || '-');
    safeText(els.patternNowDetail, patternNowDesc || '—');

    setArrow(
      els.dirDayArrow,
      panel.direction_day ||
        panel.direction_of_day ||
        micro.direcao
    );
    setArrow(
      els.dirNowArrow,
      panel.direction_now ||
        panel.direction_of_moment ||
        micro.direcao
    );

    setPillTrend(
      els.trendDayPill,
      panel.direction_day || panel.direction_of_day || micro.direcao,
      panel.trend_day_label
    );
    setPillTrend(
      els.trendNowPill,
      panel.direction_now ||
        panel.direction_of_moment ||
        micro.direcao,
      panel.trend_now_label
    );

    // =======================================================
    // TEXTO DINÂMICO: DIREÇÃO DO DIA / 1–3 CANDLES
    // =======================================================

    let dayProb   = panel.direction_day_prob;
    let dayDetail = panel.direction_day_detail;
    let nowProb   = panel.direction_now_prob;
    let nowDetail = panel.direction_now_detail;

    // fallback usando prob_favor / prob_contra
    if ((!dayProb && !dayDetail) || (!nowProb && !nowDetail)) {
      const forecast = panel.ai_forecast || {};
      const probFavor  = Number(panel.prob_favor  ?? forecast.prob_continuacao ?? NaN);
      const probContra = Number(panel.prob_contra ?? forecast.prob_contra      ?? NaN);

      if (!Number.isNaN(probFavor) && !Number.isNaN(probContra)) {
        // --- DIA ---
        if (!dayProb && !dayDetail) {
          if (probFavor >= probContra) {
            dayProb = probFavor;
            dayDetail =
              `Continuação a favor: ${probFavor}% · Contra: ${probContra}%.`;
          } else {
            dayProb = probContra;
            dayDetail =
              `Maior chance de contra-movimento: ${probContra}% · Continuação: ${probFavor}%.`;
          }
        }

        // --- MOMENTO (1–3 candles) ---
        if (!nowProb && !nowDetail) {
          if (probFavor >= probContra) {
            nowProb = probFavor;
            nowDetail =
              `Curto prazo favorece continuação (${probFavor}% vs ${probContra}% de contra).`;
          } else {
            nowProb = probContra;
            nowDetail =
              `Curto prazo favorece contra-movimento (${probContra}% vs ${probFavor}% de continuação).`;
          }
        }
      }
    }

    if (els.directionDayText && (dayProb || dayDetail)) {
      els.directionDayText.textContent =
        (dayProb ? dayProb + '% · ' : '') + (dayDetail || '');
    }

    if (els.directionNowText && (nowProb || nowDetail)) {
      els.directionNowText.textContent =
        (nowProb ? nowProb + '% · ' : '') + (nowDetail || '');
    }

    // Estrutura recente: HH / HL / LH / LL
    const structureRecent =
      panel.structure_recent ||
      panel.recent_structure ||
      panel.market_structure ||
      (panel.structure && panel.structure.recent) ||
      null;

    updateStructureUI(structureRecent);
    updateStructureZigzag(panel);

    // Textos principais
    const finalSummary =
      panel.summary ||
      panel.painel_terminal ||
      '—';

    const riskLevel =
      panel.risk_level ||
      aiAdvisor.risco;

    const riskComment =
      panel.risk_comment ||
      aiAdvisor.motivo ||
      '—';

    const contextComment =
      panel.context_comment ||
      panel.painel_terminal ||
      '—';

    const executionPlan =
      panel.execution_plan ||
      '—';

    safeText(els.summary, finalSummary);
    setRiskPill(riskLevel);
    safeText(els.riskText, riskComment);
    safeText(els.contextText, contextComment);
    safeText(els.executionText, executionPlan);

    // MODO CEGO usa os mesmos textos
    applyHeroDecision(executionPlan, finalSummary);

  } catch (err) {
    console.error('Erro ao carregar painel', err);
    if (els.errorBanner) {
      els.errorBanner.style.display = 'block';
      els.errorBanner.innerHTML =
        '<strong>Erro ao carregar painel.</strong> Verifique o webhook "aaron9-json" no n8n e tente novamente.';
    }
  } finally {
    if (els.btnRefresh) els.btnRefresh.disabled = false;
  }
}

// ====== INICIALIZAÇÃO ======
function initAaron9() {
  // cria o gráfico do TradingView UMA VEZ
  if (window.TradingView) {
    new TradingView.widget({
      container_id: 'aaron9-tv-chart',

      // padrão inicial (pode ser NVDA na NASDAQ)
      symbol: 'NASDAQ:NVDA',
      interval: '1',               // começa em 1m
      timezone: 'America/Denver',  // horário de Utah
      theme: 'dark',
      style: '1',
      autosize: true,
      locale: 'en',

      withdateranges: false,
      hide_top_toolbar: false,
      hide_side_toolbar: false,
      allow_symbol_change: true,

      disabled_features: [],
      enabled_features: [],
    });
  }

  // botão ATUALIZAR
  if (els.btnRefresh) {
    els.btnRefresh.addEventListener('click', function () {
      loadPanel(true);
    });
  }

  // primeira carga + auto refresh do painel
  loadPanel(false);
  setInterval(() => loadPanel(false), REFRESH_MS);
}

// ================ TOGGLE DE IDIOMA PT / EN ==================

const I18N = {
  pt: {
    // TOPO
    'top.live_feed': 'FEED AO VIVO',
    'top.symbol': 'Símbolo',
    'top.timeframe': 'Timeframe',
    'top.session': 'Sessão',
    'top.last_update': 'Última atualização:',
    'top.refresh': 'ATUALIZAR',

    // RISCO · ATR
    'risk.title': 'Gerenciador de risco · ATR',
    'risk.subtitle': 'Ajuste os parâmetros do ATR e calcule risco / reward da operação.',
    'risk.toggle_open': 'Abrir',
    'risk.toggle_close': 'Fechar',

    // CARD TRADINGVIEW
    'card.tv_title': 'Painel de Preço em Tempo Real',
    'card.tv_sub': 'TradingView + Estrutura do Dia',

    // RESUMO INSTITUCIONAL
    'summary.title': 'Resumo institucional',
    'summary.subtitle': 'Leitura consolidada do AARON 9',
    'summary.risk_mgmt': 'Gestão de risco',

    // RADAR
    'radar.day_title': 'Direção geral do dia',
    'radar.now_title': 'Direção prevista · 1–3 candles',

    // OUTROS
    'comment.title': 'Comentário do Painel',
    'panel.risk_title': 'Risco',
    'panel.context_title': 'Contexto',
    'panel.execution_title': 'Execução',

    // PULLBACK
    'pullback.title': 'Pullback Brain · Zona de respiro',
    'pullback.depth': 'Profundidade',
    'pullback.quality': 'Qualidade',

        // SIZING BRAIN
    'sizing.title': 'Sizing Brain · Gestão de capital do dia',
    'sizing.target_label': 'Alvo razoável hoje',
    'sizing.max_dd': 'Máx. perda',
    'sizing.risk_trade': 'Risco / trade',
    'sizing.trades': 'Trades A+',
    'sizing.conservative': 'Conservador',
    'sizing.aggressive': 'Agressivo',

  },

  en: {
    // TOP
    'top.live_feed': 'LIVE FEED',
    'top.symbol': 'Symbol',
    'top.timeframe': 'Timeframe',
    'top.session': 'Session',
    'top.last_update': 'Last update:',
    'top.refresh': 'REFRESH',

    // RISK · ATR
    'risk.title': 'Risk manager · ATR',
    'risk.subtitle': 'Adjust ATR parameters and calculate trade risk / reward.',
    'risk.toggle_open': 'Open',
    'risk.toggle_close': 'Close',

    // TRADINGVIEW CARD
    'card.tv_title': 'Real-Time Price Panel',
    'card.tv_sub': 'TradingView + Daily Structure',

    // SUMMARY
    'summary.title': 'Institutional summary',
    'summary.subtitle': 'Consolidated reading from AARON 9',
    'summary.risk_mgmt': 'Risk management',

    // RADAR
    'radar.day_title': 'Overall direction of the day',
    'radar.now_title': 'Expected direction · 1–3 candles',

    // OTHERS
    'comment.title': 'Panel commentary',
    'panel.risk_title': 'Risk',
    'panel.context_title': 'Context',
    'panel.execution_title': 'Execution',

    // PULLBACK
    'pullback.title': 'Pullback Brain · Pullback zone',
    'pullback.depth': 'Depth',
    'pullback.quality': 'Quality',

        // SIZING BRAIN
    'sizing.title': 'Sizing Brain · Daily capital plan',
    'sizing.target_label': 'Reasonable target today',
    'sizing.max_dd': 'Max loss',
    'sizing.risk_trade': 'Risk / trade',
    'sizing.trades': 'A+ trades',
    'sizing.conservative': 'Conservative',
    'sizing.aggressive': 'Aggressive',

  },
};

let currentLang = 'pt';

function applyLang(lang) {
  const dict = I18N[lang] || I18N.pt;
  currentLang = lang;

  // troca TODO elemento com data-i18n
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    const txt = dict[key];
    if (txt) el.textContent = txt;
  });

  // pill de estado (AGUARDANDO / WAITING)
  const statePill = document.getElementById('state-pill');
  if (statePill) {
    statePill.textContent = lang === 'en' ? 'WAITING' : 'AGUARDANDO';
  }

  // botão refresh
  const btnRefresh = document.getElementById('btn-refresh');
  if (btnRefresh) {
    btnRefresh.textContent =
      dict['top.refresh'] || (lang === 'en' ? 'REFRESH' : 'ATUALIZAR');
  }

  // texto de "Abrir / Fechar" do card ATR, se já estiver aberto
  const atrToggle = document.getElementById('atr-risk-toggle');
  const atrBody = document.getElementById('atr-risk-body');
  if (atrToggle && atrBody) {
    const isOpen = atrBody.style.display && atrBody.style.display !== 'none';
    if (isOpen) {
      atrToggle.textContent =
        dict['risk.toggle_close'] || (lang === 'en' ? 'Close' : 'Fechar');
    } else {
      atrToggle.textContent =
        dict['risk.toggle_open'] || (lang === 'en' ? 'Open' : 'Abrir');
    }
  }

  // re-renderiza o Pullback Brain no idioma atual
        if (typeof updatePullbackBrain === 'function') {
    updatePullbackBrain(lastPullbackBrain);
  }
  if (typeof updateSizingBrain === 'function') {
    updateSizingBrain(lastSizingBrain);
  }
  if (typeof updateSizingPhrase === 'function') {
    updateSizingPhrase();
  }
}

 // ====== SIZING BRAIN – CÁLCULO LOCAL DO GERENCIADOR DE RISCO ======
function recalcSizingBrainLocal() {
  if (!sbEls.card) return;

  function num(el) {
    if (!el) return 0;
    const raw = (el.value || '').toString().replace(',', '.');
    const v = Number(raw);
    return Number.isFinite(v) ? v : 0;
  }

  const account = num(sbEls.accountBalance);    // Capital real da conta
  const lev     = num(sbEls.leverage);         // Alavancagem x
  const tradeCap= num(sbEls.tradeCapital);     // Capital em uso neste trade
  const riskPct = num(sbEls.riskPercentInput); // Risco máx. por trade (% conta)
  const entry   = num(sbEls.entryPrice);       // Preço de entrada
  const atr     = num(sbEls.atrValue);         // ATR atual ($)
  const multStop= num(sbEls.atrMultStop) || 1; // Mult ATR STOP
  const multTake= num(sbEls.atrMultTake) || (multStop * 2); // Mult ATR TAKE

  // lado: long / short
  let side = 'long';
  if (sbEls.sideRadios && sbEls.sideRadios.length) {
    sbEls.sideRadios.forEach(r => {
      if (r.checked) side = r.value;
    });
  }

  const statusEl = sbEls.status;
  function setStatus(msg) {
    if (statusEl) statusEl.textContent = msg;
  }

  // validações básicas
  if (!account || !riskPct || !entry || !atr || !multStop) {
    setStatus('Preencha capital, risco, preço de entrada, ATR e multiplicadores para calcular.');
    return;
  }

  // distância do stop e do alvo em dólares por share
  const stopDist = atr * multStop;
  const takeDist = atr * multTake;

  // base de capital para limitar o tamanho (EM USO se tiver, senão conta × alavancagem, senão só conta)
  let baseCapital = 0;
  if (tradeCap > 0) {
    baseCapital = tradeCap;
  } else if (account > 0 && lev > 0) {
    baseCapital = account * lev;
  } else {
    baseCapital = account;
  }

  // risco máximo em dinheiro (por trade) baseado % da conta real
  const maxRiskMoney = account * (riskPct / 100);

  // tamanho de posição pelo risco e pelo capital
  const sharesByRisk    = maxRiskMoney / stopDist;
  const sharesByCapital = baseCapital && entry ? baseCapital / entry : sharesByRisk;
  let shares = Math.floor(Math.min(sharesByRisk, sharesByCapital));

  if (!Number.isFinite(shares) || shares <= 0) {
    setStatus('Verifique os valores: o risco em dólares precisa ser maior que a distância do stop.');
    return;
  }

  // preços de stop e take
  const stopPrice = side === 'short'
    ? entry + stopDist
    : entry - stopDist;

  const takePrice = side === 'short'
    ? entry - takeDist
    : entry + takeDist;

  // risco real com a quantidade ajustada
  const realRiskMoney = shares * stopDist;
  const realRiskPct   = account ? (realRiskMoney / account) * 100 : 0;

  // ==== atualiza os textos do card ====
  if (sbEls.outStopDistance)
    sbEls.outStopDistance.textContent = `Distância do STOP: ${stopDist.toFixed(2)} USD`;

  if (sbEls.outStopPrice)
    sbEls.outStopPrice.textContent = `Stop Loss sugerido: ${stopPrice.toFixed(2)}`;

  if (sbEls.outTakePrice)
    sbEls.outTakePrice.textContent = `Take Profit sugerido: ${takePrice.toFixed(2)}`;

  if (sbEls.outPositionSize)
    sbEls.outPositionSize.textContent = `Qtd sugerida: ${shares.toFixed(0)}`;

  if (sbEls.outRiskDollar)
    sbEls.outRiskDollar.textContent = `Risco aprox.: $ ${realRiskMoney.toFixed(2)}`;

  if (sbEls.outRiskPercent)
    sbEls.outRiskPercent.textContent =
      `Risco % trade / conta: ${realRiskPct.toFixed(2)}%`;

  setStatus(
    `Ok: ${shares.toFixed(0)} shares, risco ≈ ${realRiskPct.toFixed(2)}% (${realRiskMoney.toFixed(2)} USD).`
  );

  // Alimenta o bloco de baixo (Aaron Pine) com a distância do stop em USD/share
  if (els.sizingStopInput) {
    els.sizingStopInput.value = stopDist.toFixed(2);
    if (typeof updateSizingPhrase === 'function') {
      updateSizingPhrase();
    }
  }
}
   


// liga o toggle dos botões PT / EN
const langToggleEl = document.getElementById('lang-toggle');
if (langToggleEl) {
  langToggleEl.addEventListener('click', (ev) => {
    const btn = ev.target.closest('.lang-btn');
    if (!btn) return;

    const lang = btn.getAttribute('data-lang');
    if (!lang) return;

    langToggleEl.querySelectorAll('.lang-btn').forEach((b) =>
      b.classList.remove('active')
    );
    btn.classList.add('active');

    applyLang(lang);
  });
}

// idioma inicial = PT
applyLang('pt');

// garante que roda depois que o DOM existe
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initAaron9);
} else {
  initAaron9();
}
</script>

</body>
</html>
